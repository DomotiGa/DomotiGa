' Gambas class file

' Description:
' CDomotica.class
' Support for Heino Peter's Domotica modules.

' Development Status:
' Just started.

' Links:
' http://www.elektor.nl/products/books/home/domotica.12267.lynkx
' http://www.domoticaforum.eu/forum.asp?FORUM_ID=30

' DomotiGa - an open source home automation program.
' Copyright(C) 2009 Ron Klinkien

' Read file called COPYING for license details.

PROPERTY Port AS String
PROPERTY DomoticaDebug AS Boolean

PRIVATE sPort AS String
PRIVATE bDomoticaDebug AS Boolean

PUBLIC hDomotica AS NEW SerialPort

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' open serial port
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
PUBLIC FUNCTION Connect() AS Boolean

  ' try to close the port
  TRY hDomotica.Close

  ' get a new one
  hDomotica = NEW Serialport AS "Domotica"

  WITH hDomotica
    .PortName = sPort
    .Speed = 9600
    .Parity = 0
    .DataBits = 8
    .StopBits = 1
    .Open()
  END WITH

  ' all ok
  RETURN TRUE

CATCH ' some errors
  Main.WriteLog("Domotica Error: " & ERROR.Text)
  RETURN FALSE

END

PUBLIC SUB Domotica_Read()

  DIM sData AS Byte

  READ #hDomotica, sData

END

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' close port
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
PUBLIC FUNCTION Disconnect() AS Boolean

  ' try to close the connection
  TRY hDomotica.Close
  Main.WriteLog("Domotica serial port close.")

  ' all ok
  RETURN TRUE

CATCH ' some errors
  Main.WriteLog("Domotica Error: " & ERROR.Text)
  RETURN FALSE

END

' implement properties
FUNCTION Port_Read() AS String

  RETURN sPort

END

SUB Port_Write(Value AS String)

  sPort = Value

END

PRIVATE FUNCTION DomoticaDebug_Read() AS Boolean

  RETURN bDomoticaDebug

END

PRIVATE SUB DomoticaDebug_Write(Value AS Boolean)

  bDomoticaDebug = Value

END

