' Gambas class file

' Description:
' FSettingsPachube.class
' Settings form for Pachube EEML upload.

' Development Status:
' Just started.

' Links:
' www.pachube.com

' DomotiGa - an open source home automation program.
' Copyright (C) Ron Klinkien, The Netherlands.

' Read file called COPYING for license details.

PUBLIC iCurRow AS Integer

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' initialize buttons and fill in current values
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
PUBLIC SUB Form_Open()

  ME.Move(FMain.X + 50, FMain.Y + 70)

  chkEnabled.Value = Main.bPachubeEnabled
  txtFeed.Text = Main.iPachubeFeed
  txtPushTime.Text = Main.iPachubePushTime
  txtAPIKey.Text = Main.sPachubeAPIKey
  chkDebug.Value = Main.bPachubeDebug

  IF Main.bPachubeEnabled = FALSE THEN
    txtFeed.Enabled = FALSE
    txtAPIKey.Enabled = FALSE
    txtPushTime.Enabled = FALSE
    tbvPachubeDevices.Enabled = FALSE
    btnUpload.Enabled = FALSE
    chkDebug.Enabled = FALSE
  END IF
  FillPachubeDevices()

END

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' fill tableview with current devices
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
PUBLIC SUB FillPachubeDevices()

  DIM rResult AS Result
  DIM iRows, iCount AS Integer

  rResult = Main.hDB.Exec("SELECT * FROM devices_pachube")
  IF NOT rResult THEN
    Message.Info(("Error: table 'devices_pachube' not found!"))
    RETURN
  END IF

  iRows = rResult.Count
  WITH tbvPachubeDevices
    .Columns.Count = 5
    .Rows.Count = iRows
    .Columns[0].Title = ("Id")
    .Columns[0].Width = 25
    .Columns[1].Title = ("ID")
    .Columns[1].Width = 25
    .Columns[2].Title = ("Tags")
    .Columns[2].Width = 200
    .Columns[3].Title = ("Value")
    .Columns[3].Width = 60
    .Columns[4].Title = ("Units")
    .Columns[4].Width = 60
  END WITH

  FOR iCount = 0 TO rResult.Max
    tbvPachubeDevices[iCount, 0].Text = rResult!id
    tbvPachubeDevices[iCount, 1].Text = rResult!datastreamid
    tbvPachubeDevices[iCount, 2].Text = rResult!tags
    IF rResult!deviceid AND rResult!value THEN
      tbvPachubeDevices[iCount, 3].Text = Devices.GetCurrentValueForDevice(rResult!deviceid, rResult!value)
    END IF
    IF Len(rResult!units) THEN tbvPachubeDevices[iCount, 4].Text = rResult!units & "(" & rResult!devicelabel & ")"
    rResult.MoveNext
  NEXT

END

PUBLIC SUB btnCancel_Click()

  ME.Close

END

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' load defaults from database
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
PUBLIC SUB btnDefaults_Click()

  DIM rResult AS Result

  rResult = Main.GetSettingTable("pachube", TRUE) ' get defaults
  IF rResult.Count THEN
    chkEnabled.Value = rResult!enabled
    txtFeed.Text = rResult!feed
    txtAPIKey.Text = rResult!apikey
    txtPushTime.Text = rResult!pushtime
    chkDebug.Value = rResult!debug
  END IF
  btnSave.Enabled = TRUE

END

PUBLIC SUB chkEnabled_Click()

  txtFeed.Enabled = chkEnabled.Value
  txtAPIKey.Enabled = chkEnabled.Value
  txtPushTime.Enabled = chkEnabled.Value
  chkDebug.Enabled = chkEnabled.Value
  tbvPachubeDevices.Enabled = chkEnabled.Value
  btnUpload.Enabled = chkEnabled.Value
  btnSave.Enabled = TRUE

END

PUBLIC SUB txtFeed_KeyPress()

  btnSave.Enabled = TRUE

END

PUBLIC SUB txtAPIKey_KeyPress()

  btnSave.Enabled = TRUE

END

PUBLIC SUB txtPushTime_KeyPress()

  btnSave.Enabled = TRUE

END

PUBLIC SUB chkDebug_Click()

  btnSave.Enabled = TRUE

END

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' save new settings
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
PUBLIC SUB btnSave_Click()

  DIM rResult AS Result

  ' save new Pachube settings
  rResult = Main.hDB.Exec("UPDATE settings_pachube SET debug = &1, feed = &2, apikey = &3, pushtime = &4, enabled = &5 WHERE id = 1", chkDebug.Value, txtFeed.Text, txtAPIKey.Text, txtPushTime.Text, chkEnabled.Value)
  rResult = Main.GetSettingTable("pachube") ' reload settings
  IF rResult.Count THEN
    Main.bPachubeEnabled = rResult!enabled
    Main.iPachubeFeed = rResult!feed
    Main.sPachubeAPIKey = rResult!apikey
    Main.iPachubePushTime = rResult!pushtime
    Main.bPachubeDebug = rResult!debug
  END IF
  IF Main.bServer THEN
    Main.Restart_Pachube()
  ELSE
    XMLClient.ModuleRestart("Pachube")
  END IF
  ME.Close

END

PUBLIC SUB btnUpload_Click()

  Pachube.UploadPachubeData()

END

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' open entry for editing
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
PUBLIC SUB tbvPachubeDevices_DblClick()

  iCurRow = tbvPachubeDevices.Row
  ' open pachube device editor window
  FEditPachubeDevices.Show()

END

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' view pachube's feed
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
PUBLIC SUB btnWeb_Click()

  Desktop.Open("http://www.pachube.com/feeds/" & txtFeed.Text)

END
