' Gambas class file

' Description:
' FEditUsers.class
' Manage users, needed for future authentication and bluetooth proximity support.

' Development Status:
' Adding, deleting and editing user information is working.

' DomotiGa - an open source home automation program.
' Copyright (C) Ron Klinkien, The Netherlands.

' Read file called COPYING for license details.

Private sPasswd As String

Public Sub Form_Open()

  Dim hTextBoxPassword As TextBox = DataControl2.Children[0]
  Dim hTextBoxLastLogin As TextBox = DataControl6.Children[0]

  Me.Move(FMain.X + 50, FMain.Y + 70)

  ' allows users to maintain their own private data
  If Main.bUserisAdmin Then
    DataSource1.Filter = ""
  Else
    DataSource1.Filter = Subst("username = '&1'", Main.sActiveUser)
    DataControl1.Enabled = False
    DataControl5.Enabled = False
    Me.Title = "Edit User Account"
  Endif

  With DataBrowser1.View
    .Columns[0].Text = ("Id")
    .Columns[0].Width = 28
    .Columns[1].Text = ("User Name")
    .Columns[1].Width = 80
    .Columns[2].Text = ("Full Name")
    .Columns[2].Width = 110
    .Columns[3].Text = ("Admin")
    .Columns[3].Width = 50
    .Columns[4].Text = ("Last Login")
    .Columns[4].Width = 120
    .Columns[5].Text = ("E-mail")
    .Columns[5].Width = 120
    .Columns[6].Text = ("Comments")
  End With
  hTextBoxPassword.Password = True
  hTextBoxLastLogin.ReadOnly = True

End

Public Sub DataControl2_GotFocus()

  sPasswd = DataControl2.Value
  DataControl2.Value = ""

End

Public Sub DataControl2_Validate(Value As Variant)

  Dim sSalt, sMD5 As String
  Dim rResult As Result

  ' need to check if user has admin power or user's name is same as DataControl1.Value
  If Comp(Main.sActiveUser, DataControl1.Value) <> 0 Then
    If Not Main.bUserisAdmin Then DataControl2.Value = ""
  Endif
  If Comp(sPasswd, DataControl2.Value) And Comp(DataControl2.Value, "") <> 0 Then
    sMD5 = Crypt.MD5(DataControl2.Value)
    sSalt = Right$(Left$(sMD5, 11), 8)
    sMD5 = Right$(sMD5, 22)
    ' make sure DB users table knows about the cookie column
    Try rResult = Main.hDB.Exec("SELECT cookie FROM users")
    If Not rResult Then Try Main.hDB.Exec("ALTER TABLE users ADD COLUMN cookie VARCHAR(64) DEFAULT ''")
      If Comp(Main.sActiveUser, DataControl1.Value) <> 0 Then
        Message(("User '") & DataControl1.Value & ("' has to reset other private info (email password, etc.) when logging in."))
        Try Main.hDB.Exec("UPDATE users SET cookie = '' WHERE username = &1", DataControl1.Value)
      Else
      If Len(Main.sActiveUserCookie) > 0 Then ' put old cookie with new crypt key in DB
        Main.hDB.Exec("UPDATE users SET cookie = AES_ENCRYPT(&1,&2) WHERE username = &3", Main.sActiveUserCookie, Crypt.MD5(DataControl2.Value, Right(sMD5, 8)), DataControl1.Value)
      Endif
    Endif
    DataControl2.Value = "MD5" & sSalt & sMD5
  Endif
  If Comp(DataControl2.Value, "") == 0 Then DataControl2.Value = sPasswd
  sPasswd = ""

End

Public Sub btnClose_Click()

  Me.Close

End
