' Gambas class file

' Description:
' FEditUsers.class
' Manage users, needed for future authentication and bluetooth proximity support.

' Development Status:
' Adding, deleting and editing user information is working.

' DomotiGa - an open source home automation program.
' Copyright (C) Ron Klinkien, The Netherlands.

' Read file called COPYING for license details.

PRIVATE sPasswd AS String

PUBLIC SUB Form_Open()

  DIM hTextBoxPassword AS TextBox = DataControl2.Children[0]
  DIM hTextBoxLastLogin AS TextBox = DataControl6.Children[0]

  ME.Move(FMain.X + 50, FMain.Y + 70)

  ' allows users to maintain their own private data
  IF Main.bUserisAdmin THEN
    DataSource1.Filter = ""
  ELSE
    DataSource1.Filter = Subst("username = '&1'", Main.sActiveUser)
    DataControl1.Enabled = FALSE
    DataControl5.Enabled = FALSE
    ME.Title = "Edit User Account"
  ENDIF

  ' [GB2:DBGV] WITH DataBrowser1.GridView
  WITH DataBrowser1.View
    .Columns[0].Text = ("Id")
    .Columns[0].Width = 28
    .Columns[1].Text = ("User Name")
    .Columns[1].Width = 80
    .Columns[2].Text = ("Full Name")
    .Columns[2].Width = 110
    .Columns[3].Text = ("Admin")
    .Columns[3].Width = 50
    .Columns[4].Text = ("Last Login")
    .Columns[4].Width = 120
    .Columns[5].Text = ("E-mail")
    .Columns[5].Width = 120
    .Columns[6].Text = ("Comments")
  END WITH
  hTextBoxPassword.Password = TRUE
  hTextBoxLastLogin.ReadOnly = TRUE

END

PUBLIC SUB DataControl2_GotFocus()

  sPasswd = DataControl2.Value
  DataControl2.Value = ""

END

PUBLIC SUB DataControl2_Validate(Value AS Variant)

  DIM sSalt, sMD5 AS String
  DIM rResult AS Result

  ' need to check if user has admin power or user's name is same as DataControl1.Value
  IF Comp(Main.sActiveUser, DataControl1.Value) <> 0 THEN
    IF NOT Main.bUserisAdmin THEN DataControl2.Value = ""
  ENDIF
  IF Comp(sPasswd, DataControl2.Value) AND Comp(DataControl2.Value, "") <> 0 THEN
    sMD5 = Crypt.MD5(DataControl2.Value)
    sSalt = Right$(Left$(sMD5, 11), 8)
    sMD5 = Right$(sMD5, 22)
    ' make sure DB users table knows about the cookie column
    TRY rResult = Main.hDB.Exec("SELECT cookie FROM users")
    IF NOT rResult THEN TRY Main.hDB.Exec("ALTER TABLE users ADD COLUMN cookie VARCHAR(64) DEFAULT ''")
      IF Comp(Main.sActiveUser, DataControl1.Value) <> 0 THEN
        Message(("User '") & DataControl1.Value & ("' has to reset other private info (email password, etc.) when logging in."))
        TRY Main.hDB.Exec("UPDATE users SET cookie = '' WHERE username = &1", DataControl1.Value)
      ELSE
      IF Len(Main.sActiveUserCookie) > 0 THEN ' put old cookie with new crypt key in DB
        Main.hDB.Exec("UPDATE users SET cookie = AES_ENCRYPT(&1,&2) WHERE username = &3", Main.sActiveUserCookie, Crypt.MD5(DataControl2.Value, Right(sMD5, 8)), DataControl1.Value)
      ENDIF
    ENDIF
    DataControl2.Value = "MD5" & sSalt & sMD5
  ENDIF
  IF Comp(DataControl2.Value, "") == 0 THEN DataControl2.Value = sPasswd
  sPasswd = ""

END

PUBLIC SUB btnClose_Click()

  ME.Close

END
