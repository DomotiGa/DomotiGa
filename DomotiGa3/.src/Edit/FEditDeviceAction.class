' Gambas class file

' Description:
' FEditDeviceAction.class
' Manage users, needed for future authentication and bluetooth proximity support.

' Development Status:
' Adding, deleting and editing user information is working.

' DomotiGa - an open source home automation program.
' Copyright (C) Ron Klinkien, The Netherlands.

' Read file called COPYING for license details.
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' Module/Class specific variables
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public LogLabel As String = "[FEditDevAction]"

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' Variables
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private $bDebug As Boolean
Private rRes As Result

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' Initiate form on opening
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Public Sub Form_Open()
 
 Dim idx As Integer
 Me.Move(FMain.X + 50, FMain.Y + 70)

DataSource1.Filter = ""
DataSource1.Refresh()
''set debug on
$bDebug = 1  
' Set DataBrwEditDevAction column headers And width
LayoutDataBrowserEDA()
' Set editable columns
EditableDataBrowserEDA()
' fill combobox with all actions; order by id is needed to use id afterwards in update statements.
rRes = Main.hDB.Exec("SELECT id, name FROM actions ORDER BY id")
  For Each rRes
    ComboBox1.Add(rRes!name)
    ComboBox2.Add(rRes!name)
  Next

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' Set DatabrowserADA column headers and width
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Private Sub LayoutDataBrowserEDA()

  Dim headers As String[] = ["dev ID", "Dev Name", "Switchable", "Dimable", "Action On ID", "Action On Name", "Action Off ID", "Action Off Name"]
  Dim widths As Integer[] = [28, 200, 35, 35, 28, 150, 28, 150]
  Dim idx As Integer

  If $bDebug And (widths.Count <> headers.count) Then Main.WriteDebugLog(LogLabel & "Programmer cannot count.")
' fill databrowser column headers and column width.
  For idx = 0 To headers.Max
    DataBrowserEDA.View.Columns[idx].Title = headers[idx]
    DataBrowserEDA.View.Columns[idx].Width = widths[idx]
  Next

End
' not used function
' set editable columns
Private Sub EditableDataBrowserEDA()
Dim tblvw As Tableview
'd_id
'd_name
'd_switchable
'd_dimable
'd_action_on_id
'aon_name
'd_action_off_id
'aoff_name
  'DataBrowserEDA.Editable = True
  'tblvw = DataBrowserEDA.View 
  'tblvw.Edit([1, 2, 3], 1)
End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' Define save button actions of databrowser
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub DataBrowserEDA_Save()
  
  Dim x As Integer
  'noop
  
  
End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' Define save button actions
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub btSave_Click()
Dim devid, rowid As Integer
Dim sSQL, sSQLOn, sSQLOff As String

 'get device id
    ' Show that row as being selected
    ' (do not forget to set mode=single on gridview)
    '' tblview.mode = 1 'single
  ' set columnid = 0 and rowid = selected row.
  rowid = DataBrowserEDA.View.Row
  DataBrowserEDA.View.Column = 0
  ' grab contend of selected cell and convert to integer.
  devid = Val(DataBrowserEDA.View.Current.Text)

 'update DatabrowserEDA and db
  Main.hDB.Exec("UPDATE `devices` SET `action_on_id` = &1, `action_off_id` = &2 WHERE `devices`.`id` = &3", ComboBox1.Index, ComboBox2.Index, devid)
  'sSQLOn = "UPDATE `devices` SET `action_on_id` = " & ComboBox1.Index & " WHERE `devices`.`id` =" & devid & ";"
  'Main.hDB.Exec(sSQLOn)
  'sSQLOff = "UPDATE `devices` SET `action_off_id` = " & ComboBox2.Index & " WHERE `devices`.`id` =" & devid & ";"
  'Main.hDB.Exec(sSQLOff)
  DataSource1.Filter = ""
  DataSource1.Refresh()
  LayoutDataBrowserEDA()
End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' Define refresh button actions
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub btRefresh_Click()

' refresh data of form with initial db values.
  DataSource1.Filter = ""
  DataSource1.Refresh()
  LayoutDataBrowserEDA()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' if a row is selected in databrowserEDA, select correct action in comboboxes
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' Public Sub DataBrowserEDA_Event()
' 
' Dim iSelectedrow As Integer
'   ' if a row is selected, adapt compboboxes with same info.
'   ' @on action
'   If (DataBrowserEDA.View.Row <> 0) Or (DataBrowserEDA.View.Row <> iSelectedrow) Then
'     'x = DataBrowserEDA.View.Row
'     ' set column to action_on_id
'     DataBrowserEDA.View.Column = 4
'     ' set combobox1 (on_id) to cel info of action_on_id
'     ComboBox1.Index = Val(DataBrowserEDA.View.Current.Text)
'     '@ off action
'     ' set column to action_off_id
'     DataBrowserEDA.View.Column = 6
'     ' set combobox1 (on_id) to cel info of action_on_id
'     ComboBox2.Index = Val(DataBrowserEDA.View.Current.Text)
'     iSelectedrow = DataBrowserEDA.View.Row 
'   Else
'     'do nothing
'     
'   Endif
' 
' End
