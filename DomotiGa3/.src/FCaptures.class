' Gambas class file

' Description:
' FImages.class
' Captured images viewer, see VideoServer.module for more.

' Development Status:
' Working.

' DomotiGa - an open source home automation program.
' Copyright (C) Ron Klinkien, The Netherlands.

' Read file called COPYING for license details.

PRIVATE iCam AS Integer
PRIVATE iMaxId AS Integer
PRIVATE iMinId AS Integer
PRIVATE iCurId AS Integer

PUBLIC SUB Form_Open()

 ' give focus to first field
 btnCam1.SetFocus
 
  InitData()

END

PUBLIC SUB InitData()

  DIM rResult AS Result

  GetLastImageNo()

  iCurId = iMaxId

  IF Main.bVideoServerEnabled THEN
    IF Main.sVideoServerChannel1 THEN
      btnCam1.Enabled = TRUE
      btnCapture.Enabled = TRUE
      btnCam1.Text = Main.sVideoServerChannel1
    END IF
    IF Main.sVideoServerChannel2 THEN
      btnCam2.Enabled = TRUE
      btnCapture.Enabled = TRUE
      btnCam2.Text = Main.sVideoServerChannel2
    END IF
    IF Main.sVideoServerChannel3 THEN
      btnCam3.Enabled = TRUE
      btnCapture.Enabled = TRUE
      btnCam3.Text = Main.sVideoServerChannel3
    END IF
    IF Main.sVideoServerChannel4 THEN
      btnCam4.Enabled = TRUE
      btnCapture.Enabled = TRUE
      btnCam4.Text = Main.sVideoServerChannel4
    END IF
  END IF

  ShowCapture(iCurId)

END

PRIVATE SUB GetLastImageNo()

  DIM rResult AS Result

  rResult = Main.hDB.Exec("SELECT id,stamp FROM " & Main.hDB.Quote("capture_camera" & iCam) & " ORDER BY id DESC LIMIT 1")
  IF rResult.Count = 0 THEN
    iMaxId = 0
  ELSE
    iMaxId = rResult!id
  END IF

  Slider1.MaxValue = iMaxId
  Slider1.Step = (iMaxId - iMinId) / 10
  Slider1.PageStep = (iMaxId - iMinId) / 10

END

PRIVATE SUB GetFirstImageNo()

  DIM rResult AS Result

  rResult = Main.hDB.Exec("SELECT id,stamp FROM " & Main.hDB.Quote("capture_camera" & iCam) & " ORDER BY id LIMIT 1")
  IF rResult.Count = 0 THEN
    iMinId = 0
  ELSE
    iMinId = rResult!id
  END IF

  Slider1.MinValue = iMinId
  GetFirstImageNo()
  Slider1.Value = iMaxId

END

PRIVATE SUB ShowCapture(iId AS Integer)

  DIM rResult AS Result
  DIM sTempFile AS String = Temp() & ".jpg"
  DIM pUnavail AS Picture = Picture.Load("images/unavail.gif")

  rResult = Main.hDB.Exec("SELECT id,stamp,image FROM " & Main.hDB.Quote("capture_camera" & iCam) & " WHERE id = &1", iId)

  txtCurImg.Text = iId
  txtTotalImg.Text = iMaxId

  IF rResult.Count = 0 THEN
    PictureBox1.Picture = pUnavail
    txtStamp.Text = ("Unavailable")
    RETURN
  END IF

  txtStamp.Text = Format$(rResult!stamp, "yyyy-mm-dd hh:nn:ss")
  File.Save(sTempFile, rResult!image.Data)
  TRY PictureBox1.Picture = Picture.Load(sTempFile)
  IF ERROR THEN PictureBox1.Picture = pUnavail
  IF Exist(sTempFile) THEN KILL sTempFile

END

PUBLIC SUB btnPrev_Click()

  IF iCurId - 1 >= iMinId THEN
    iCurId = iCurId - 1
    ShowCapture(iCurId)
  END IF

END

PUBLIC SUB btnNext_Click()

  IF iCurId + 1 <= iMaxId THEN
    iCurId = iCurId + 1
    ShowCapture(iCurId)
  END IF

END

PUBLIC SUB btnFirst_Click()

  iCurId = iMinId
  ShowCapture(iCurId)

END

PUBLIC SUB btnLast_Click()

  iCurId = iMaxId
  ShowCapture(iCurId)

END

PUBLIC SUB btnCam1_Click()

  iCam = 0
  InitData()

END

PUBLIC SUB btnCam2_Click()

  iCam = 1
  InitData()

END

PUBLIC SUB btnCam3_Click()

  iCam = 2
  InitData()

END

PUBLIC SUB btnCam4_Click()

  iCam = 3
  InitData()

END

PUBLIC SUB btnCapture_Click()

  VideoServer.Grab(iCam)
  InitData()

END

PUBLIC SUB Slider1_Change()

  iCurId = Slider1.Value
  ShowCapture(iCurId)

END

PUBLIC SUB btnDelete_Click()

  DIM rResult AS Result

  SELECT Message.Question(("Are you sure you want to delete this image?"), ("Yes"), ("No"))
    CASE 1
    rResult = Main.hDB.Exec("DELETE FROM " & Main.hDB.Quote("capture_camera" & iCam) & " WHERE id = &1", iCurId)
    InitData()
  END SELECT

END
