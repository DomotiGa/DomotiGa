' Gambas class file

' Description:
' FSplashScreen.class

' DomotiGa - an open source home automation program.
' Copyright (C) Ron Klinkien, The Netherlands.

' Read file called COPYING for license details.

Public tStartup As Timer
Private bAuthOk As Boolean
Private iCountLogin As Integer

Public Sub _new()

  tStartup = New Timer As "tStartup"
  tStartup.Delay = 100
  tStartup.Enabled = True

End

Public Sub Form_Open()

  lblVersion.Text = "version " & Main.sProgramVersion
  Me.Height = 180
  Panel1.Height = 165
  prbStatus.Y = 120
  lblStatus.Y = 135
  txtCopyright.Text = "Copyright (C) 2008-" & Year(Now) & " Ron Klinkien"

End

Public Sub tStartup_Timer()

  tStartup.Enabled = False
  If Main.bLogout Then
    Login()
  Else
    StartProgram()
  Endif

End

Private Sub StartProgram()

  SetProgressValue(0)

  lblStatus.Text = ("Checking directory structure ...")
  SetProgressValue(20)
  Wait 0.05
  Main.Setup_BroadcastAddrs()
  Main.Setup_Logfiles()
  Main.DisplayProgramInfo()
  Main.CreateDirectoryTree()

  lblStatus.Text = ("Loading configuration ...")
  SetProgressValue(40)
  lblStatus.Text = ("Connecting to database ...")
  Wait 0.05
  If Not Main.ConnectDatabase() Then FInstallDBWizard.ShowModal

  ' update database
  SetProgressValue(50)
  lblStatus.Text = ("Updating database ...")
  Wait 0.05
  Main.UpdateDatabase()

  SetProgressValue(60)
  lblStatus.Text = ("Loading modules ...")
  Wait 0.05
  Main.Setup()

  SetProgressValue(80, ("Starting main program ..."))

  ' update house status
  If Main.bServer Then
    If Not Main.GlobalVar["House_Mode"] Then Main.SetGlobalVar("House_Mode", "normal")
    If Len(Main.GlobalVar["Mute"]) < 1 Then Main.SetGlobalVar("Mute", False)
    Main.ChangeHouseMode(Main.GlobalVar["House_Mode"])
    Main.ChangeMuteMode(Main.GlobalVar["Mute"])
  Endif

  If Main.GlobalVar["EmailCount"] Then Main.iNewMails = Main.GlobalVar["EmailCount"]
  If Main.GlobalVar["CallCount"] Then Main.iNewCalls = Main.GlobalVar["CallCount"]
  If Main.GlobalVar["VoiceMailCount"] Then Main.iNewVoicemails = Main.GlobalVar["VoiceMailCount"]

  Main.WriteLog(("Entering main program loop."))
  SetProgressValue(100, ("Entering main program loop ..."))
  Wait 0.05

  ' program startup
  Main.UpdateGlobalVars()
  Main.Check_for_Action()
  Main.SetupTimers() ' start timers
  FMain.txtTime.Text = Format$(Now(), "d mmmm h:nn")

  If Main.bAuthEnabled Then
    Login()
  Else
    bAuthOk = True
    Me.Close
  Endif

End

Public Sub Login()

  Me.Height = 260
  Panel1.Height = 246
  lblStatus.Y = 215
  Label1.Visible = True
  Label2.Visible = True
  txtUser.Visible = True
  txtPassword.Visible = True
  btnLogin.Visible = True
  prbStatus.Visible = False
  btnLogin.Enabled = True
  iCountLogin = 0
  lblStatus.Text = ("Please authenticate yourself.")

  If Main.GlobalVar["Last_User"] Then
    txtUser.Text = Main.GlobalVar["Last_User"]
    txtPassword.SetFocus()
  Endif

End

Public Sub SetProgressValue(iValue As Integer, Optional sStatus As String)

  If iValue > 100 Then iValue = 100
  If iValue < 0 Then iValue = 0

  prbStatus.Value = iValue / 100
  If sStatus Then lblStatus.Text = sStatus

End

Public Sub btnLogin_Click()

  Enter()

End

Private Sub Enter()

  If Not txtUser.Text Then
    lblStatus.Text = ("Please specify a Username.")
  Else
    If CheckAuth() Then
      bAuthOk = True
      Me.Close
    Else
      lblStatus.Text = ("Sorry wrong Username and/or Password!")
      ' and only allow three failures to login
    Endif
  Endif

End

Private Sub CheckAuth() As Boolean

  Dim rResult As Result
  Dim sSalt, sHash, sType As String

  ' add column cookie if DB table has not got it
  Try rResult = Main.hDB.Exec("SELECT cookie FROM users")
  If Not rResult Then Try Main.hDB.Exec("ALTER TABLE users ADD COLUMN cookie VARCHAR(64) DEFAULT ''")

  Try rResult = Main.hDB.Exec("SELECT username, password, id, admin, cookie FROM users WHERE username = &1", txtUser.Text)
  If rResult.Count Then
    If (Len(rResult!password) = 33) And (Left$(rResult!password, 3) = "MD5") Then
      sSalt = Left$(rResult!password, 11)
      sType = "MD5" ' Left$(sSalt, 3)
      sSalt = Right$(sSalt, 8)
      sHash = Right$(Crypt.MD5(txtPassword.Text, sSalt), 22)
    Else
      sHash = rResult!password
    Endif
    If rResult!password = (sType & sSalt & sHash) Then
      Main.GlobalVar["Last_User"] = txtUser.Text
      Main.sActiveUser = txtUser.Text
      Main.sActiveUserID = rResult!id
      If Len(rResult!cookie) < 1 Then ' we have to init the cookie; the decrypted cookie will never change
      ' in DB the cookie is encrypted with MD5 (MD5 hash seed) hash of current password
      ' we avoid sending user password over to DB, but the crypt key is however communicated in clear!
      ' the cookie will protect private user info within the DB
      Try Main.hDB.Exec("UPDATE users SET cookie = AES_ENCRYPT(&1,&2) WHERE username = &3", Crypt.MD5(txtPassword.Text), Crypt.MD5(txtPassword.Text, Right(sHash, 8)), txtUser.Text)
      Endif
      Try rResult = Main.hDB.Exec("SELECT AES_DECRYPT(cookie,&1) AS cookie, admin FROM users WHERE username = &2", Crypt.MD5(txtPassword.Text, Right(sHash, 8)), txtUser.Text)
      Main.sActiveUserCookie = rResult!cookie ' the crypt key for private user info in the DB

      If rResult!admin Then
        Main.WriteLog(("Logged in as '") & txtUser.Text & ("' (Administrator)."))
        Main.bUserisAdmin = True  ' hide non admin menu's
      Else
        Main.WriteLog(("Logged in as '") & txtUser.Text & ("' (User)."))
        Main.bUserisAdmin = False
        FMain.MenuEdit.Visible = False
        FMain.MenuDevices.Visible = False
        FMain.MenuSetup.Visible = False
        FMain.MenuTools.Visible = False
        FMain.MenuThermostats.Visible = False
        FMain.MenuEvents.Visible = False
      End If
      FMain.pbUser.Visible = True
      FMain.txtUser.Text = LCase$(txtUser.Text)
      rResult = Main.hDB.Exec("UPDATE users SET lastlogin = &1 WHERE username = &2", Format(Now(), "yyyy-mm-dd hh:nn:ss"), txtUser.Text)
      FMain.MenuLogout.Visible = True
      FMain.MenuEditUser.Visible = True
      Return True
    Endif
  Endif
  Inc iCountLogin
  If iCountLogin > 3 Then
     Main.WriteLog("User &1 entered invalid password.", txtUser.Text)
     Message(("Invalid password, too many tries, exit program!"))
     Main.CloseAll()
     FMain.Close
  Endif
  Return False

End

Public Sub Form_Close()

  If bAuthOk = False Then Stop Event

End
