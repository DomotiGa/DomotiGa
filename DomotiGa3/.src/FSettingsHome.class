' Gambas class file

' Description:
' FSettingsHome.class
' Settings form for HomeScreen related items.

' Development Status:
' Works.

' DomotiGa - an open source home automation program.
' Copyright (C) Ron Klinkien, The Netherlands.

' Read file called COPYING for license details.

PRIVATE bRestartClicked AS Boolean
PUBLIC hToolButton AS ToolButton

PUBLIC SUB Form_Open()

  ME.Move(FMain.X + 50, FMain.Y + 70)

  LoadConfig(FALSE)
  btnSave.Enabled = FALSE

END

PRIVATE SUB DeleteEntry(sName AS String)

  SELECT CASE Left(sName, 4)
    CASE "LIST"
      TRY ListViewTopics.Remove(Mid(sName, 6))
    CASE "TOP "
      TRY ListViewTop.Remove(Mid(sName, 6))
    CASE "LEFT"
      TRY ListViewLeft.Remove(Mid(sName, 6))
    CASE "RIGH"
      TRY ListViewRight.Remove(Mid(sName, 6))
    CASE "BOTT"
      TRY ListViewBottom.Remove(Mid(sName, 6))
  END SELECT

END

PRIVATE SUB CreateEntry(sName AS String, oCont AS ListView)

  IF NOT oCont.Exist(Mid(sName, 6)) THEN
    TRY oCont.Add(Mid(sName, 6), Mid(sName, 6))
  ENDIF

END

PUBLIC SUB ListViewTopics_MouseDrag()

  ListViewTopics.Drag("LIST-" & ListViewTopics.key)

END

PUBLIC SUB ListViewTop_MouseDrag()

  ListViewTop.Drag("TOP -" & ListViewTop.key)

END

PUBLIC SUB ListViewLeft_MouseDrag()

  ListViewLeft.Drag("LEFT-" & ListViewLeft.key)

END

PUBLIC SUB ListViewRight_MouseDrag()

  ListViewRight.Drag("RIGH-" & ListViewRight.key)

END

PUBLIC SUB ListViewBottom_MouseDrag()

  ListViewBottom.Drag("BOTT-" & ListViewBottom.key)

END

PUBLIC SUB ListViewTop_Drop()

  IF NOT (Left(Drag.Data, 4) = "TOP ") THEN
    CreateEntry(Drag.Data, ListViewTop)
    DeleteEntry(Drag.Data)
    btnSave.Enabled = TRUE
  ENDIF

END

PUBLIC SUB ListViewLeft_Drop()

  IF NOT (Left(Drag.Data, 4) = "LEFT") THEN
    CreateEntry(Drag.Data, ListViewLeft)
    DeleteEntry(Drag.Data)
    btnSave.Enabled = TRUE
  ENDIF

END

PUBLIC SUB ListViewRight_Drop()

  IF NOT (Left(Drag.Data, 4) = "RIGH") THEN
    CreateEntry(Drag.Data, ListViewRight)
    DeleteEntry(Drag.Data)
    btnSave.Enabled = TRUE
  ENDIF

END

PUBLIC SUB ListViewBottom_Drop()

  IF NOT (Left(Drag.Data, 4) = "BOTT") THEN
    CreateEntry(Drag.Data, ListViewBottom)
    DeleteEntry(Drag.Data)
    btnSave.Enabled = TRUE
  ENDIF

END

PUBLIC SUB ListViewTopics_Drop()

  IF NOT (Left(Drag.Data, 4) = "LIST") THEN
    CreateEntry(Drag.Data, ListViewTopics)
    DeleteEntry(Drag.Data)
    btnSave.Enabled = TRUE
  ENDIF

END

PUBLIC SUB btnCancel_Click()

  ME.Close

END

PUBLIC SUB btnDefaults_Click()

  LoadConfig(TRUE)

END

PUBLIC SUB LoadConfig(bDefault AS Boolean)

  DIM rResult AS Result
  DIM aPanel AS String[]
  DIM sItem AS String

  CreateEntry("LIST-TagLine", ListViewTopics)
  CreateEntry("LIST-Power Usage", ListViewTopics)
  CreateEntry("LIST-House Mode", ListViewTopics)
  CreateEntry("LIST-Outside", ListViewTopics)
  CreateEntry("LIST-Weather Comment", ListViewTopics)

  CreateEntry("LIST-Thermostat", ListViewTopics)
  CreateEntry("LIST-Inside", ListViewTopics)
  CreateEntry("LIST-Main log", ListViewTopics)
  CreateEntry("LIST-Weather", ListViewTopics)
  CreateEntry("LIST-Temperature Control", ListViewTopics)
  CreateEntry("LIST-All Heating", ListViewTopics)
  CreateEntry("LIST-Alarm", ListViewTopics)
  CreateEntry("LIST-Event Thermostat", ListViewTopics)

  rResult = Main.GetSettingTable("main", bDefault) ' get defaults
  IF rResult.Count THEN
    ListViewTop.Clear
    aPanel = Split(rResult!hometoppanel, "|")
    FOR EACH sItem IN aPanel
      CreateEntry("TOP -" & sItem, ListViewTop)
      DeleteEntry("LIST-" & sItem)
    NEXT
    ListViewLeft.Clear
    aPanel = Split(rResult!homeleftpanel, "|")
    FOR EACH sItem IN aPanel
      CreateEntry("LEFT-" & sItem, ListViewLeft)
      DeleteEntry("LIST-" & sItem)
    NEXT
    ListViewRight.Clear
    aPanel = Split(rResult!homerightpanel, "|")
    FOR EACH sItem IN aPanel
      CreateEntry("RIGH-" & sItem, ListViewRight)
      DeleteEntry("LIST-" & sItem)
    NEXT
    ListViewBottom.Clear
    aPanel = Split(rResult!homebottompanel, "|")
    FOR EACH sItem IN aPanel
      CreateEntry("BOTT-" & sItem, ListViewBottom)
      DeleteEntry("LIST-" & sItem)
    NEXT
  ENDIF
  btnSave.Enabled = TRUE

END

PUBLIC SUB btnSave_Click()

  DIM rResult AS Result
  DIM iCount AS Integer
  DIM sPanelTop, sPanelLeft, sPanelRight, sPanelBottom AS String

  IF ListViewTop.Count > 0 THEN
    ListViewTop.MoveFirst
    sPanelTop &= ListViewTop.Item.Text
    FOR iCount = 1 TO ListViewTop.Count - 1
      ListViewTop.MoveNext
      sPanelTop &= "|" & ListViewTop.Item.Text
    NEXT
  ENDIF

  IF ListViewLeft.Count > 0 THEN
    ListViewLeft.MoveFirst
    sPanelLeft &= ListViewLeft.Item.Text
    FOR iCount = 1 TO ListViewLeft.Count - 1
      ListViewLeft.MoveNext
      sPanelLeft &= "|" & ListViewLeft.Item.Text
    NEXT
  ENDIF

  IF ListViewRight.Count > 0 THEN
    ListViewRight.MoveFirst
    sPanelRight &= ListViewRight.Item.Text
    FOR iCount = 1 TO ListViewRight.Count - 1
      ListViewRight.MoveNext
      sPanelRight &= "|" & ListViewRight.Item.Text
    NEXT
  ENDIF

  IF ListViewBottom.Count > 0 THEN
    ListViewBottom.MoveFirst
    sPanelBottom &= ListViewBottom.Item.Text
    FOR iCount = 1 TO ListViewBottom.Count - 1
      ListViewBottom.MoveNext
      sPanelBottom &= "|" & ListViewBottom.Item.Text
    NEXT
  ENDIF

  rResult = Main.hDB.Exec("UPDATE settings_main SET hometoppanel = &1, homeleftpanel = &2, homerightpanel = &3, homebottompanel = &4 WHERE id = 1", sPanelTop, sPanelLeft, sPanelRight, sPanelBottom)
  btnCancel_Click

END
