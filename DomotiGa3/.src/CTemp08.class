' Gambas class file

' Description:
' CTemp08.class
' Support for Midon's TEMP08 1-wire interface.

' Development Status:
' Working, but only temp sensors implemented tested yet.

' DomotiGa - an open source home automation program.
' Copyright (C) Ron Klinkien, The Netherlands.

' Read file called COPYING for license details.

PROPERTY Port AS String
PROPERTY Baud AS String
PROPERTY Temp08Debug AS Boolean

PRIVATE sPort AS String
PRIVATE sBaud AS String
PRIVATE bTemp08Debug AS Boolean

PUBLIC hTemp08 AS NEW SerialPort
PUBLIC tTemp08 AS NEW Timer

PUBLIC sBuffer AS String

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' open serial port
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
PUBLIC FUNCTION Connect() AS Boolean

  ' try to close the port
  TRY hTemp08.Close

  ' get a new one
  hTemp08 = NEW Serialport AS "Temp08"

  WITH hTemp08
    .PortName = sPort
    .Speed = sBaud
    .Parity = 0
    .DataBits = 8
    .StopBits = 1
    .Open()
  END WITH

  ' start poll timer for Temp08 status LED
  tTemp08 = NEW Timer AS "tTemp08LED"
  tTemp08.Delay = 250
  tTemp08.Stop

  ' all ok
  RETURN TRUE

CATCH ' some errors
  Main.WriteLog(("Temp08 Error: ") & ERROR.Text)
  RETURN FALSE

END

PUBLIC SUB Temp08_Read()

  DIM sData AS String

  TRY READ #hTemp08, sData, 1
  IF ERROR THEN Main.WriteDebugLog(("[Temp08] Error reading data from serial port! -> ") & Error.Text)
  IF sData = Chr(10) THEN ' buffer until newline then parse
    IF Len(sBuffer) > 1 THEN ParseLine(sBuffer)
    sBuffer = NULL
  ELSE
    sBuffer &= sData
  END IF

END

PUBLIC SUB ParseLine(sStr AS String)

  DIM iDeviceId AS Integer
  DIM aScan AS String[]

  Main.ControlLed("OneWire", "On")
  IF Main.bServer THEN tTemp08.Start

  ' example output
  ' SUN 00:36:20
  ' Reading Sensors...
  ' Voltage #01[4 D0000004FC78A26] = 00.32 V 04.98 V
  ' Temp #01[4D0000004FC78A26]=23.75C
  ' Temp #02[150008013A024910]=22.43C
  ' Temp #03[7A0008014A6BC310]=22.68C

  IF bTemp08Debug THEN Main.WriteDebugLog("[Temp08] " & sStr)

  ' Temp08 temp sensor support
  IF Mid$(sStr, 1, 4) = "Temp" THEN
    IF bTemp08Debug THEN Main.WriteDebugLog(("[Temp08] We got DS1820 temperature data."))
    aScan = Scan(sStr, "*[[]*]=*")
    IF aScan.Count = 3 THEN
      iDeviceId = Devices.Find(aScan[1], Devices.FindInterface("Midon TEMP08"), "DS18B20")
      IF iDeviceId THEN Devices.ValueUpdate(iDeviceId, LTrim(Left(aScan[2], -2)), "", "", "")
    END IF
  END IF
  ' put support for other sensortypes here

END

PUBLIC SUB tTemp08LED_Timer()

  Main.ControlLed("OneWire", "Off")
  tTemp08.Stop

END

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' close port
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
PUBLIC FUNCTION Disconnect() AS Boolean

  ' try to close the connection
  TRY hTemp08.Close
  Main.WriteLog(("Temp08 serial port close."))

  ' all ok
  RETURN TRUE

CATCH ' some errors
  Main.WriteLog(("Temp08 Error: ") & ERROR.Text)
  RETURN FALSE

END

' implement properties
FUNCTION Port_Read() AS String

  RETURN sPort

END

SUB Port_Write(Value AS String)

  sPort = Value

END

PRIVATE FUNCTION Baud_Read() AS String

  RETURN sBaud

END

PRIVATE SUB Baud_Write(Value AS String)

  sBaud = Value

END

PRIVATE FUNCTION Temp08Debug_Read() AS Boolean

  RETURN bTemp08Debug

END

PRIVATE SUB Temp08Debug_Write(Value AS Boolean)

  bTemp08Debug = Value

END
