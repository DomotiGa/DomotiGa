' Gambas class file

' Description:
' CRFXComRX.class
' Connect to RFXCom receiver interface via tcp socket or serial port.

' Development Status:
' Used RFXCom's RFReceiver source code as template.

' DomotiGa - an open source home automation program.
' Copyright (C) Ron Klinkien, The Netherlands.

' Read file called COPYING for license details.

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' Module/Class specific variables
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public PluginName As String = "RFXComRX"
Public PluginFriendlyName As String = "RFXCom Receiver"
Public PluginVersion As String = "1.00"
Public PluginAuthor As String = "Ron Klinkien"
Public PluginProtocols As String[]
Public PluginMaxInstances As Integer = 1

Public KeyName As String
Public LogLabel As String = "[RFXComRX] "
Public InterfaceId As Integer
Public Instance As Integer
Public IsRunning As Boolean
Public ErrorText As String
Public ErrorWhere As String

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' Private Variables
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private $bEnabled As Boolean
Private $sTCPHost As String
Private $iTCPPort As Integer
Private $sInterface As String
Private $sSerPort As String
Private $sBaud As String
Private $bDebug As Boolean
Private $bRelayEnabled As Boolean
Private $iRelayPort As Integer
Private $bGlobalX10 As Boolean

Public hMySocket As CSocket
Public hMySerial As CSerialPort
Public hRFXComRXRelay As New ServerSocket
Public hRelayRXClient As Object[]
Public hRelayRXSocket As New Socket

Const SWVERS As Byte = &H20
Const MODEHS As Byte = &H21
Const MODEKOP As Byte = &H23
Const MODEARC As Byte = &H24
Const MODEBD As Byte = &H25
Const DISHE As Byte = &H28
Const MODEB32 As Byte = &H29
Const ENALL As Byte = &H2A
Const MODEVAR As Byte = &H2C
Const DISARC As Byte = &H2D
Const DISKOP As Byte = &H2E
Const DISX10 As Byte = &H2F
Const MODEVISONIC As Byte = &H40
Const MODENOXLAT As Byte = &H41
Const MODEVISAUX As Byte = &H42
Const DISOREGON As Byte = &H43
Const DISATI As Byte = &H44
Const DISVIS As Byte = &H45
Const DISSOMFY As Byte = &H46
Const DISEU As Byte = &H47

Private bSlave As Boolean
Public bFirstByte As Boolean = True
Private Protocol As Byte = MODEVAR
Private RecBuf As New Byte[30]
Private RecBytes As Byte
Private RecBits As Byte
Private bMessage As Boolean = False
Private iByteCount As Integer = 0
Private sMessage As String
Public bSimulate As Boolean
Public bWaitforAck As Boolean
Public bVersion As Boolean
Private bCmdHeader As Byte
Private iSupplyVoltage As Integer
Private sTemperature As Single

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' Mandatory subroutine for each Module/Class to initialize:
' - The cPlugin[x].Settings are copied into local variables
' - Port/Connection will be started (any errors caught)
' - Any other code per Class
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub StartPlugin(cPl As CPluginEntry)

  KeyName = cPl.KeyName
  Instance = cPl.Instance
  If Instance <> 1 Then LogLabel = Replace(LogLabel, "] ", "#" & Instance & "] ")

  ' Copy configuration items locally
  $bEnabled = cPl.Settings["enabled"]
  $sTCPHost = cPl.Settings["tcphost"]
  $iTCPPort = cPl.Settings["tcpport"]
  $sInterface = cPl.Settings["type"]
  $sSerPort = cPl.Settings["serialport"]
  $sBaud = cPl.Settings["baudrate"]
  $bRelayEnabled = cPl.Settings["relayenabled"]
  $iRelayPort = cPl.Settings["relayport"]
  $bGlobalX10 = cPl.Settings["globalx10"]
  $bDebug = cPl.Settings["debug"]

  InterfaceId = Devices.FindInterface("RFXCom Receiver")
  If InterfaceId = 0 Then
    ErrorText = "Required InterfaceId can't be retrieved from the database!"
    Main.WriteLog(LogLabel & "ERROR: " & ErrorText)
    IsRunning = False
    Return
  Endif

  ' Connect/Initialize connection
  If InStr($sInterface, "tcp") Then
    ConnectTCP()
  Else
    ConnectSerial()
  Endif

  ' Previously in the code it was check if the RFXComTX object was created, but
  ' that was useless for TCP connections (they never fail while the TCP will setup)

  ' Start RFXCom Relaying
  If $bRelayEnabled Then
    If StartRelay() Then
      Main.WriteLog(LogLabel & "Relay listening for client on port " & $iRelayPort)
    Else
      Main.WriteLog(LogLabel & "ERROR: Relay FAILED to listen on port " & $iRelayPort)
    Endif
  Else
    Main.WriteLog(LogLabel & "Relay disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' Mandatory sub for each Module/Class to stop
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub StopPlugin()

  Try Disconnect()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' connect to the host:port
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Function ConnectTCP(Optional bFirstStart As Boolean = True) As Boolean

  Dim iReconnectRetry As Integer = 0

  ' try to close the connection
  Try hMySocket.Close
  Try iReconnectRetry = hMySocket.ReconnectRetry

  ' get a new one - but also pass on our previous reconnect counter
  hMySocket = New CSocket(iReconnectRetry) As "MySocket"

  hMySocket.DataType = &HFF + gb.Byte
  hMySocket.Connect($sTCPHost, $iTCPPort)

  ' Write to main logfile we are trying to connect
  If bFirstStart Then Main.WriteLog(LogLabel & PluginFriendlyName & " TCP interface connecting to " & $sTCPHost & ":" & $iTCPPort)

  ' Don't set IsRunning=True, this has to be done in _Ready 

  ' All went ok
  Return True

Catch ' some errors
  Main.WriteLog(LogLabel & "ERROR: " & PluginFriendlyName & " TCP interface FAILED to connect to " & $sTCPHost & ":" & $iTCPPort)
  Main.WriteLog(LogLabel & "ERROR: " & Error.Text)
  IsRunning = False
  ErrorText = Error.Text
  ErrorWhere = Error.Where

  Return False

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' connect to the serial port
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Function ConnectSerial() As Boolean

  Dim iReconnectRetry As Integer = 0

  ' try to close the port
  Try hMySerial.Close
  Try iReconnectRetry = hMySerial.ReconnectRetry

  ' get a new one - but store the retry counter between new instances
  hMySerial = New CSerialPort(iReconnectRetry) As "MySerial"

  With hMySerial
    .DataType = &HFF + gb.Byte ' Byte[]
    .PortName = $sSerPort
    .Speed = $sBaud
    .Parity = 0
    .DataBits = 8
    .StopBits = 1
    .FlowControl = 0
    .Open()
  End With

  ' Write to main logfile we connected successfully
  Main.WriteLog(LogLabel & PluginFriendlyName & " serial interface connected to port " & $sSerPort)
  IsRunning = True

  ProtocolSetup("MODEVAR")

  ' All went ok
  Return True

Catch ' some errors
  Main.WriteLog(LogLabel & "ERROR: " & PluginFriendlyName & " serial interface FAILED to connect to port " & $sSerPort)
  Main.WriteLog(LogLabel & "ERROR: " & Error.Text)
  IsRunning = False
  ErrorText = Error.Text
  ErrorWhere = Error.Where

  Return False

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' disconnect from the host
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Function Disconnect() As Boolean

  ' try to close the connection
  Try hMySocket.Close
  Try hMySerial.Close
  Try hRFXComRXRelay.Close
  Try hRelayRXClient.Remove

  If InStr($sInterface, "tcp") Then
    Main.WriteLog(LogLabel & PluginFriendlyName & " TCP connection closed.")
  Else
    Main.WriteLog(LogLabel & PluginFriendlyName & " Port closed.")
  Endif

  ' all ok
  Return True

Finally
  IsRunning = False
  ErrorText = ""
  ErrorWhere = ""

Catch
  Main.WriteLog(LogLabel & "ERROR: " & Error.Text)
  Return False

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' Socket closed by remote
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub MySocket_Closed()

  Main.WriteLog(LogLabel & "ERROR: TCP socket closed by peer.")

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' host ip address found
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub MySocket_Found()

  Log.Plugin_DNS_Found(LogLabel, $sTCPHost)

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' error while connected/connecting to tcp host
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub MySocket_Error(sMsg As String)

  Main.WriteLog(LogLabel & "ERROR: " & sMsg)

  IsRunning = False
  ErrorText = sMsg

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' received data from the tcp port
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub MySocket_Read(vVar As Variant)

  Dim bData As Byte

  If vVar Then
    For Each bData In vVar
      If bSimulate = False Then ProcessReceivedChar(bData)
    Next
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' tcp socket is connected
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub MySocket_Ready()

  Main.WriteLog(LogLabel & "TCP interface connected.")
  IsRunning = True

  ProtocolSetup("MODEVAR")

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' Called when we should reconnect to the tcp host
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub MySocket_Reconnect()

  ConnectTCP()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' Handle errors
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub MySerial_Error(sMsg As String)

  Main.WriteDebugLog(LogLabel & "ERROR: " & sMsg)

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' got data from serialport
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub MySerial_Read(vVar As Variant)

  Dim bData As Byte

  If vVar Then
    For Each bData In vVar
      If bSimulate = False Then ProcessReceivedChar(bData)
    Next
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' Handle reconnect(s)
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub MySerial_Reconnect()

  ' ReConnect/Initialize connection
  ConnectSerial()

End

Public Function StartRelay() As Boolean

  hRFXComRXRelay = New ServerSocket As "RFXComRXRelay"
  hRFXComRXRelay.Type = Net.Internet
  hRFXComRXRelay.Port = $iRelayPort
  ' we start listening for max 1 connection
  hRFXComRXRelay.Listen(1)

  If hRFXComRXRelay.Status = Net.Active Then
    hRelayRXClient = New Object[]
    ' all ok
    Return True
  Else
    Return False
  Endif

End

Public Sub RFXComRXRelay_Connection(sHost As String)

  hRelayRXSocket = New Socket As "RelayRXSocket"
  ' accept client
  If hRFXComRXRelay.Status <= Net.Inactive Then Return
  If $bDebug Then Main.WriteDebugLog(LogLabel & "Relay Connection request from client " & sHost)

  hRelayRXSocket = hRFXComRXRelay.Accept()
  hRelayRXClient.Add(hRelayRXSocket)
  If $bDebug Then
    If hRelayRXSocket.Status = Net.Connected Then Main.WriteLog(LogLabel & "Relay client connection from ip address " & hRelayRXSocket.RemoteHost & " (" & DNS.ResolveHost(hRelayRXSocket.RemoteHost) & " ) accepted.")
  Endif

End

Public Sub RFXComRXRelay_Read()

    Dim sBuf As Byte
    Dim bAck As Byte = &H2C

    If Last.Status <> Net.Connected Then Return
    Try sBuf = Read #Last, Lof(Last)

    If sBuf = &HF0 Then
      bCmdHeader = sBuf
    Else If bCmdHeader Then ' got command from relay client, reply with fake answer
      Write #Last, bAck As Byte
      Main.WriteDebugLog(LogLabel & "Relay Client " & Last.RemoteHost & " has sent command " & Hex(bCmdHeader) & Hex(sBuf) & ", replied with fake ACK.")
      bCmdHeader = 0
    Endif

End

Public Sub RFXComRXRelay_Error()

  ' handle error
  Select Case hRFXComRXRelay.Status
    Case Net.CannotCreateSocket
      Main.WriteDebugLog(LogLabel & "Relay The system does not allow to create a socket.")
    Case Net.CannotBindSocket
      Main.WriteDebugLog(LogLabel & "Relay cannot bind socket.")
    Case Net.CannotListen
      Main.WriteDebugLog(LogLabel & "Relay cannot listen on port.")
  End Select

End

Public Sub RFXComRXRelay_Closed()

  Main.WriteLog(LogLabel & "Relay client connection closed.")
  hRelayRXClient.Remove(hRelayRXClient.Find(Last))

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' ask for interface firmware version
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Function GetVersion()

  Dim b As New Byte[2]

  b[0] = &HF0
  b[1] = SWVERS

  bFirstByte = True
  bVersion = True
  SendCommand(b)
  bVersion = True
  bWaitforAck = False
  If $bDebug Then Main.WriteDebugLogChars(("Version request to receiver => F020\n"), 0)

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' protocol commands
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Function ProtocolSetup(sType As String)

  Dim b As New Byte[2]
  Dim sText As String

  b[0] = &HF0

  Select UCase(sType)
    Case "ALL"
      b[1] = ENALL
      sText = ("Enable ALL RF")
    Case "OREGON"
      b[1] = DISOREGON
      sText = ("Disable Oregon")
    Case "X10"
      b[1] = DISX10
      sText = ("Disable X10")
    Case "KOPPLA"
      b[1] = DISKOP
      sText = ("Disable Koppla")
    Case "ARC"
      b[1] = DISARC
      sText = ("Disable ARC")
    Case "ATI"
      b[1] = DISATI
      sText = ("Disable ATI")
    Case "VISONIC"
      b[1] = DISVIS
      sText = ("Disable Visonic")
    Case "HEUK"
      b[1] = DISHE
      sText = ("Disable HomeEasy UK")
    Case "HEEU"
      b[1] = DISEU
      sText = ("Disable HomeEasy EU")
    Case "SOMFY"
      b[1] = DISSOMFY
      sText = ("Disable Somfy")
    Case "MODEVAR"
      b[1] = MODEVAR
      sText = ("Variable Mode")
  End Select

  SendCommand(b)
  If $bDebug Then Main.WriteDebugLogChars(LogLabel & sText & " => F0" & Hex(b[1]) & "\n")

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' send a command to the interface
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Function SendCommand(bBuffer As Byte[])

  ' Write the complete string - not byte-for-byte
  If $sInterface = "tcp" Then
    hMySocket.Write(bBuffer)
  Else
    hMySerial.Write(bBuffer)
  Endif

  bWaitforAck = True

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' inject packet into parser.
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Simulate(sPacket As String)

  Dim iCnt, iCnt2 As Integer

  bFirstByte = True
  If $bDebug Then Main.WriteDebugLog(LogLabel & "RFXCom receiver Simulate String: " & sPacket)

  RecBits = Val("&H" & Mid(sPacket, 1, 2)) And &H7F
  iCnt = Lsr(RecBits, 3)

  If (RecBits And &H7) Then
    iCnt += 1
  Endif

  If bVersion Or If (iCnt = (Len(sPacket) / 2) - 1) Then
    For iCnt2 = 1 To Len(sPacket) Step 2
      ProcessReceivedChar(Val("&H" & Mid(sPacket, iCnt2, 2)))
    Next
  Else
   bFirstByte = True
   If $bDebug Then Main.WriteDebugLog(LogLabel & "1st byte doesn't correspond with packet length!")
  Endif
  bSimulate = False

End Sub

Private Sub ProcessReceivedChar(bTemp As Byte)

  ' relay incoming data to relay port
  If $bRelayEnabled Then Try Write #hRelayRXSocket, bTemp As Byte

  If bFirstByte = True Then
    bFirstByte = False
    iByteCount = 0
    If $bDebug Then Main.WriteDebugLogChars(LogLabel & "", 0)
  Endif

  If $bDebug Then Main.WriteDebugLogChars(Hex(bTemp, 2), 1)
  Main.ControlLed("RFXCom", "On")

  If bWaitforAck = False Then
    If bVersion Then ' display version?
      RecBuf[iByteCount] = bTemp
      If iByteCount = 3 Then
        bMessage = True
      Endif
    Else
      Select Case Protocol
        Case MODEVAR, MODEVISONIC, MODENOXLAT, MODEARC
          If iByteCount = 15 Then
            RecBuf[iByteCount - 1] = bTemp
            bMessage = True
          Else If iByteCount = 0 Then
            RecBits = bTemp And &H7F
            If (bTemp And &H80) = 0 Then
              bSlave = False
            Else
              bSlave = True
            Endif
            If (RecBits And &H7) = 0 Then
              RecBytes = Lsr(RecBits, 3)
            Else
              RecBytes = Lsr(RecBits, 3) + 1
            Endif
          Else If iByteCount = RecBytes Then
            RecBuf[iByteCount - 1] = bTemp
            iByteCount -= 1
            bMessage = True
          Else
            RecBuf[iByteCount - 1] = bTemp
          Endif
        Case MODEB32
          RecBuf[iByteCount] = bTemp
          If iByteCount = 3 Then
            bMessage = True
          Endif
        Case MODEKOP
          RecBuf[iByteCount] = bTemp
          If iByteCount = 2 Then
            bMessage = True
          Endif
      End Select
    Endif
    Inc iByteCount
  Else
    bMessage = True
  Endif
  If bMessage Then
    Display_Message()
  Endif
  Main.ControlLed("RFXCom", "Off")

End

Private Sub Display_Message()

  Dim iParity As Integer
  Dim bRFXSensor, bRFXPower, bSRFXPower As Boolean

  bMessage = False
  bFirstByte = True

  If Not bWaitforAck Then
    If iByteCount = 4 Then
      iParity = Not (Lsr((RecBuf[0] And &HF0), 4) + (RecBuf[0] And &HF) + Lsr(RecBuf[1], 4) + (RecBuf[1] And &HF) + Lsr(RecBuf[2], 4) + (RecBuf[2] And &HF) + Lsr(RecBuf[3], 4)) And &HF
      If (iParity = (RecBuf[3] And &HF)) And (RecBuf[0] + (RecBuf[1] Xor &HF) = &HFF) Then
        bRFXSensor = True
      Endif
    Else If RecBits = 48 Then
      iParity = Not (Lsr(RecBuf[0], 4) + (RecBuf[0] And &HF) + Lsr(RecBuf[1], 4) + (RecBuf[1] And &HF) + Lsr(RecBuf[2], 4) + (RecBuf[2] And &HF) + Lsr(RecBuf[3], 4) + (RecBuf[3] And &HF) + Lsr(RecBuf[4], 4) + (RecBuf[4] And &HF) + Lsr(RecBuf[5], 4)) And &HF
      If (iParity = (RecBuf[5] And &HF)) And (RecBuf[0] + (RecBuf[1] Xor &HF) = &HFF) Then
        bRFXPower = True
      Else If (iParity = (RecBuf[5] And &HF)) Then
        bSRFXPower = True
      Endif
    Endif

    If bVersion Then ' display version?
      bVersion = False
      RecBits = 0
      If $bDebug Then
        Main.WriteDebugLogChars(" Version", True)
        If RecBuf[0] = Asc("M") Or RecBuf[0] = &H1 Then
          Main.WriteDebugLogChars(" Master=" & Hex(RecBuf[1], 2) & "\n", True)
          If iByteCount > 3 Then
            If RecBuf[2] = Asc("S") Then
              Main.WriteDebugLogChars(" Slave=" & Hex(RecBuf[3], 2) & "\n", True)
            Else
              Main.WriteDebugLogChars(Hex(RecBuf[2], 2), True)
            Endif
          Endif
        Else If RecBuf[0] = Asc("S") Or RecBuf[0] = &H81 Then
          Main.WriteDebugLogChars(" Slave=" & Hex(RecBuf[1], 2) & "\n", True)
          If iByteCount > 3 Then
            If RecBuf[2] = Asc("M") Then
              Main.WriteDebugLogChars(" Master=" & Hex(RecBuf[3], 2) & "\n", True)
            Else
              Main.WriteDebugLogChars(Hex(RecBuf[2], 2), True)
            Endif
          Endif
        Else
          Main.WriteDebugLogChars(" " & Hex(RecBuf[0], 2), True)
          If iByteCount > 3 Then
            If RecBuf[1] = Asc("S") Or RecBuf[0] = &H81 Then
              Main.WriteDebugLogChars(" Slave=" & Hex(RecBuf[2], 2) & "\n", True)
            Else If RecBuf[1] = Asc("M") Or RecBuf[0] = &H1 Then
              Main.WriteDebugLogChars(" Master=" & Hex(RecBuf[2], 2) & "\n", True)
            Else
              Main.WriteDebugLogChars(" " & Hex(RecBuf[1], 2), True)
            Endif
          Else If iByteCount = 3 Then
            Main.WriteDebugLogChars(" " & Hex(RecBuf[1], 2), True)
          Endif
        Endif
      Endif
    Else If Protocol = MODEARC Then
      ProcessARC()
    Else If Protocol = MODEKOP Then
      ' ProcessKoppla()
    Else If bRFXSensor Then
      ProcessRFXSensor()
    Else If bRFXPower Then
      ProcessRFXMeter()
    Else If bSRFXPower Then
      ' ProcessSRFXMeter()
    Else If Protocol = MODEVISONIC Then
      ' ProcessVisonic(RecBits)
    Else If Protocol = MODENOXLAT Then
      If RecBits = 36 Or RecBits = 66 Or RecBits = 72 Then
        ' ProcessVisonic(RecBits)
      Else If RecBits > 59 Then
        If ProcessOregon(RecBits) = False Then
        ' ProcessVisonic(RecBits)
        Endif
      Else
        ProcessX(RecBits)
      Endif
    Else If Protocol = MODEVAR And RecBits = 20 Then
      ProcessAti()
    Else If Protocol = MODEVAR And RecBits = 21 Then
      ProcessAtiPlus()
    Else If Protocol = MODEVAR And (RecBits = 12 Or RecBits = 34 Or RecBits = 38) Then
      ProcessHE()
    Else If Protocol = MODEVAR And RecBits = 47 Then
      ' ProcessCheaperTronics()
    Else If Protocol = MODEVAR And (RecBits = 56 Or RecBits > 59) Then
      ProcessOregon(RecBits)
    Else
      ProcessX(RecBits)
    Endif

    If (Protocol = MODEVAR Or Protocol = MODENOXLAT) And RecBits <> 0 Then
      Main.ControlLed("RFXCom", "Off")
      If $bDebug Then
        If bSlave Then
          Main.WriteDebugLogChars(" bits=" & Str(RecBits) & " from SLAVE\n", True)
        Else
          Main.WriteDebugLogChars(" bits=" & Str(RecBits) & "\n", True)
        Endif
      Endif
    Endif
  Else
    If $bDebug Then Main.WriteDebugLogChars(" ACK\n", False)
  Endif
  bWaitforAck = False

End

Private Sub ProcessRFXSensor()

  Dim iBarometer, iDeviceId As Integer
  Dim sMeasuredValue, sHumidity As Single
  Dim sType As String

  Select Case (RecBuf[0] And &H3)
    Case 0
      sType = "]T"
    Case 1
      sType = "]Z"
    Case 2
      sType = "]V"
    Case 3
      sType = "]?"
  End Select
  If $bDebug Then
    Main.WriteDebugLogChars(" RFXSENSOR[" & (RecBuf[0] * 256 + RecBuf[1]) & sType, True)
    Main.WriteDebugLogChars(" RFXSensor", True)
    Main.WriteDebugLogChars(" addr:" & Hex(RecBuf[0], 2), True)
    Main.WriteDebugLogChars(Hex(RecBuf[1], 2), True)
    Main.WriteDebugLogChars(" ID:" & CStr(RecBuf[1] + (RecBuf[0] * 256)) & " ", True)
  Endif
  If (RecBuf[3] And &H10) <> 0 Then
    If $bDebug Then
      Select Case RecBuf[2]
        Case &H81
          Main.WriteDebugLogChars((" Error: No 1-Wire device connected"), True)
        Case &H82
          Main.WriteDebugLogChars((" Error: 1-Wire ROM CRC error"), True)
        Case &H83
          Main.WriteDebugLogChars((" Error: 1-Wire device connected is not a DS1820"), True)
        Case &H84
          Main.WriteDebugLogChars((" Error: No end of read signal received from 1-Wire device"), True)
        Case &H85
          Main.WriteDebugLogChars((" Error: 1-Wire device Scratchpad CRC error"), True)
        Case &H1
          Main.WriteDebugLogChars((" Info: address incremented"), True)
        Case &H2
          Main.WriteDebugLogChars((" Info: battery low"), True)
        Case Else
          Main.WriteDebugLogChars((" Unknown Info/Error code!"), True)
      End Select
    Endif
  Else
    ' temperature sensor
    If (RecBuf[0] And &H3) = 0 Then
      sMeasuredValue = RecBuf[2] + ((Lsr(RecBuf[3], 5)) * 0.125)
      If sMeasuredValue > 200 Then
        sMeasuredValue = 0 - (256 - sMeasuredValue)
      Endif
      If $bDebug Then Main.WriteDebugLogChars(("Temp:") & CStr(sMeasuredValue) & "°C | " & CStr((sMeasuredValue) * 1.8 + 32) & "°F", True)
      sTemperature = sMeasuredValue
      ' find device id
      iDeviceId = Devices.Find(Instance, "RFXSENSOR[" & (RecBuf[0] * 256 + RecBuf[1]) & sType, InterfaceId, "RFXSENSOR TEMP")
      ' update value
      If iDeviceId Then
        If Main.sTemperature = "°C" Then
          ' temp °C
          Devices.ValueUpdate(iDeviceId, 1, CStr(sMeasuredValue), Devices.ValueType_Temperature) 
        Else
          ' temp °F
          Devices.ValueUpdate(iDeviceId, 1, CStr((sMeasuredValue) * 1.8 + 32), Devices.ValueType_Temperature)
        Endif
      Endif
    ' barometer, humidity or A/D sensor
    Else If (RecBuf[0] And &H3) = 1 Then
      sMeasuredValue = Lsr((RecBuf[2] * 256 + RecBuf[3]), 5)
      ' it is assumed that only one RFXSensor is active!
      ' for correct processing you need to save the temp and voltage for each sensor
      ' and use this in the checks and calculations.
      If iSupplyVoltage <> 0 Then
        sHumidity = (((sMeasuredValue / iSupplyVoltage) - 0.16) / 0.0062)
        iBarometer = ((sMeasuredValue / iSupplyVoltage) + 0.095) / 0.0009
      Else
        If $bDebug Then
          Main.WriteDebugLogChars(("\nNot yet able to calculate the right RH and barometric pressure values."), True)
          Main.WriteDebugLogChars(("\nSupply Voltage not yet available! Now 4.7V assumed. Reset the RFXSensor or wait. (max. 80min)"), True)
        Endif
        sHumidity = (((sMeasuredValue / 470) - 0.16) / 0.0062)
        iBarometer = ((sMeasuredValue / 470) + 0.095) / 0.0009
      Endif
      If sTemperature <> 0 Then
        sHumidity = Round(sHumidity / (1.0546 - 0.00216 * sTemperature))
      Else
        If iSupplyVoltage <> 0 Then
          If $bDebug Then
            Main.WriteDebugLogChars(("\nNot yet able to calculate the right RH and barometric pressure values."), True)
          Endif
        Endif
          If $bDebug Then Main.WriteDebugLogChars(("\nTemperature not yet available! Now 25°C assumed. Reset the RFXSensor or wait. (max. 80min)"), True)
          sHumidity = Round(sHumidity / (1.0546 - 0.00216 * 25))
      Endif
      If iSupplyVoltage = 0 Or sTemperature = 0 Then
        '
      Endif
      ' find device id
      iDeviceId = Devices.Find(Instance, "RFXSENSOR[" & (RecBuf[0] * 256 + RecBuf[1]) & sType, InterfaceId, "RFXSENSOR BARO")
      If iDeviceId Then
        Select Devices.FindDeviceTypeDescriptionForDeviceId(iDeviceId)
          Case "Barometric Sensor"
            ' baro in hPa
            Devices.ValueUpdate(iDeviceId, 1, CStr(iBarometer))
          Case "A/D Sensor"
            ' a/d in volt
            Devices.ValueUpdate(iDeviceId, 1, CStr(sMeasuredValue / 100))
          Case "Humidity Sensor"
            ' hum in %
            Devices.ValueUpdate(iDeviceId, 1, CStr(sHumidity), Devices.ValueType_Humidity)
          Case Else
            Devices.ValueUpdate(iDeviceId, 1, CStr(sMeasuredValue))
        End Select
      Endif
      If $bDebug Then
        Main.WriteDebugLogChars((" RH:") & CStr(sHumidity) & "%", True)
        Main.WriteDebugLogChars((" Barometer:") & CStr(iBarometer) & "hPa", True)
        Main.WriteDebugLogChars((" A/D voltage:") & CStr(sMeasuredValue / 100), True)
      Endif
    ' supply voltage sensor
    Else If (RecBuf[0] And &H3) = 2 Then
        iSupplyVoltage = Lsr((RecBuf[2] * 256 + RecBuf[3]), 5)
        If $bDebug Then Main.WriteDebugLogChars("Supply Voltage:" & CStr(iSupplyVoltage / 100), True)
        ' find device id
        iDeviceId = Devices.Find(Instance, "RFXSENSOR[" & (RecBuf[0] * 256 + RecBuf[1]) & sType, InterfaceId, "RFXSENSOR SUPPLY")
        ' update value
        If iDeviceId Then
          ' supply voltage
          Devices.ValueUpdate(iDeviceId, 1, Str(iSupplyVoltage / 100))
        Endif
    Else If (RecBuf[0] And &H3) = 3 Then
        If (RecBuf[3] And &H20) = 0 Then
          If $bDebug Then
            Main.WriteDebugLogChars("ZAP25:" & CStr(Round((5 / 1024) * (RecBuf[2] * 2 + (Lsr(RecBuf[3], 7))) / 0.033, 2) & "A"), True)
            Main.WriteDebugLogChars("ZAP50:" & CStr(Round((5 / 1024) * (RecBuf[2] * 2 + (Lsr(RecBuf[3], 7))) / 0.023, 2) & "A"), True)
            Main.WriteDebugLogChars("ZAP100:" & CStr(Round((5 / 1024) * (RecBuf[2] * 2 + (Lsr(RecBuf[3], 7))) / 0.019, 2) & "A"), True)
          Endif
        Else
          If $bDebug Then Main.WriteDebugLogChars(("Voltage=") & CStr(RecBuf[2] * 2), True)
        Endif
    Endif
  Endif

End

Private Sub ProcessARC()

  Dim Group, Unit As Byte
  Dim sHouseCode, sValue As String
  Dim iCnt, iDeviceId As Integer

  If iByteCount = 3 Then
    Group = ((Lsr((RecBuf[1] And &H40), 5)) Or (Lsr((RecBuf[1] And &H10), 4))) + 1
    Unit = ((Lsr((RecBuf[1] And &H4), 1)) Or (RecBuf[1] And &H1)) + 1
    sHouseCode = Chr(((Lsr((RecBuf[2] And &H40), 3)) Or (Lsr((RecBuf[2] And &H10), 2)) Or (Lsr((RecBuf[2] And &H4), 1)) Or (RecBuf[2] And &H1)) + &H41)
    If RecBuf[1] = &HFF Then
      Select Case RecBuf[0]
        Case &H54
          sMessage = (" GROUP Housecode=") & sHouseCode & (" Command: ON")
          svalue = "On"
        Case &H14
          sMessage = (" GROUP Housecode=") & sHouseCode & (" Command: OFF")
          sValue = "Off"
        Case &H55
          sMessage = (" GROUP Housecode=") & sHouseCode & (" Command: Button released")
        Case Else
      End Select
    Else
      Select Case RecBuf[0]
        Case &H54
          sMessage = (" Housecode=") & sHouseCode & (" Group=") & Str(Group) & (" Unit=") & Str(Unit) & (" Command: ON")
        Case &H14
          sMessage = (" Housecode=") & sHouseCode & (" Group=") & Str(Group) & (" Unit=") & Str(Unit) & (" Command: OFF")
        Case &H55
          sMessage = (" Housecode=") & sHouseCode & (" Group=") & Str(Group) & (" Unit=") & Str(Unit) & (" Command: Button released")
        Case Else
      End Select
    Endif
  Else If iByteCount = 8 Or iByteCount = 9 Then
    sMessage = (" HomeEasy code=")
    For iCnt = 0 To (iByteCount - 1)
      sMessage = sMessage & Hex(RecBuf[iCnt], 2)
    Next
  Else
    sMessage = (" Unknown code=")
    For iCnt = 0 To (iByteCount - 1)
      sMessage = sMessage & Hex(RecBuf[iCnt], 2)
    Next
  Endif
  ' find device id
  iDeviceId = Devices.Find(Instance, sHouseCode & Right("0" & Unit, 2), InterfaceId, "ARC")
  ' update value
  If iDeviceId Then Devices.ValueUpdate(iDeviceId, 1, sValue)
  If $bDebug Then Main.WriteDebugLogChars(sMessage & " bits=" & RecBits, 1)

End

Private Sub ProcessAti()

  Dim iRemote, iDeviceId As Integer
  Dim sCommand As String

  If RecBuf[0] > RecBuf[1] Then
    iRemote = RecBuf[0] - RecBuf[1]
  Else
    iRemote = (RecBuf[0] + &H100&) - RecBuf[1]
  Endif

  If $bDebug Then
    Main.WriteDebugLogChars(" ATI[" & (Lsr(RecBuf[2], 4)) & "]C Remote type=", 1)

    Select Case iRemote
      Case &HC5
        Main.WriteDebugLogChars("ATI Remote Wonder", 1)
      Case &HD5
        Main.WriteDebugLogChars("Medion", 1)
      Case Else
        Main.WriteDebugLogChars("Unknown remote:" & Hex(iRemote), 1)
    End Select
    Main.WriteDebugLogChars(" Channel=" & Str(Lsr(RecBuf[2], 4)), 1)
  Endif

  Select Case RecBuf[1]
    Case &H0
      If iRemote = &HC5 Then
        sCommand = "Key-a"
      Else
        sCommand = "Mute"
      Endif
    Case &H1
      sCommand = "Key-b"
    Case &H2
      sCommand = "Power"
    Case &H3
      sCommand = "Tv"
    Case &H4
      sCommand = "Dvd"
    Case &H5
      If iRemote = &HC5 Then
        sCommand = "Web"
      Else
        sCommand = "Photo"
      Endif
    Case &H6
      If iRemote = &HC5 Then
        sCommand = "Guide"
      Else
        sCommand = "Music"
      Endif
    Case &H7
      sCommand = "Drag"
    Case &H8
      If iRemote = &HC5 Then
        sCommand = "Vol+"
      Else
        sCommand = "Vol-"
      Endif
    Case &H9
      If iRemote = &HC5 Then
        sCommand = "Vol-"
      Else
        sCommand = "Vol+"
      Endif
    Case &HA
      sCommand = "Mute"
    Case &HB
      sCommand = "Chan+"
    Case &HC
      sCommand = "Chan-"
    Case &HD
      sCommand = "Key-1"
    Case &HE
      sCommand = "Key-2"
    Case &HF
      sCommand = "Key-3"
    Case &H10
      sCommand = "Key-4"
    Case &H11
      sCommand = "Key-5"
    Case &H12
      sCommand = "Key-6"
    Case &H13
      sCommand = "Key-7"
    Case &H14
      sCommand = "Key-8"
    Case &H15
      sCommand = "Key-9"
    Case &H16
      sCommand = "Txt"
    Case &H17
      sCommand = "Key-0"
    Case &H18
      sCommand = "Snapshot"
    Case &H19
      If iRemote = &HC5 Then
        sCommand = "Key-c"
      Else
        sCommand = "Dvd-menu"
      Endif
    Case &H1A
      sCommand = "Cursor-up"
    Case &H1B
      If iRemote = &HC5 Then
        sCommand = "Key-d"
      Else
        sCommand = "Setup"
      Endif
    Case &H1C
      sCommand = "Tv-radio"
    Case &H1D
      sCommand = "Cursor-left"
    Case &H1E
      sCommand = "Ok"
    Case &H1F
      sCommand = "Cursor-right"
    Case &H20
      sCommand = "Return"
    Case &H21
      sCommand = "Key-e"
    Case &H22
      sCommand = "Cursor-down"
    Case &H23
      sCommand = "Key-f"
    Case &H24
      sCommand = "Rewind"
    Case &H25
      sCommand = "Play"
    Case &H26
      sCommand = "Fast-forward"
    Case &H27
      sCommand = "Record"
    Case &H28
      sCommand = "Stop"
    Case &H29
      sCommand = "Pause"
    Case &H2C
      sCommand = "Tv"
    Case &H2D
      sCommand = "Vcr"
    Case &H2E
      sCommand = "Radio"
    Case &H2F
      sCommand = "Tv-preview"
    Case &H30
      sCommand = "Channel-list"
    Case &H31
      sCommand = "Video-desktop"
    Case &H32
      sCommand = "Red"
    Case &H33
      sCommand = "Green"
    Case &H34
      sCommand = "Yellow"
    Case &H35
      sCommand = "Blue"
    Case &H36
      sCommand = "Rename-tab"
    Case &H37
      sCommand = "Snapshot"
    Case &H38
      sCommand = "Edit-image"
    Case &H39
      sCommand = "Full-screen"
    Case &H3A
      sCommand = "Dvd-audio"
    Case &H70
      sCommand = "Mouse-left"
    Case &H71
      sCommand = "Mouse-right"
    Case &H72
      sCommand = "Mouse-up"
    Case &H73
      sCommand = "Mouse-down"
    Case &H74
      sCommand = "Mouse-up-left"
    Case &H75
      sCommand = "Mouse-up-right"
    Case &H76
      sCommand = "Mouse-down-right"
    Case &H77
      sCommand = "Mouse-down-left"
    Case &H78
      sCommand = "Key-v"
    Case &H79
      sCommand = "Key-v-end"
    Case &H7C
      sCommand = "Key-x"
    Case &H7D
      sCommand = "Key-x-end"
    Case Else
      sCommand = "Unknown"
  End Select
  If $bDebug Then Main.WriteDebugLogChars(" Command=" & sCommand, 1)

  iDeviceId = Devices.Find(Instance, "ATI[" & (Lsr(RecBuf[2], 4)) & "]C", InterfaceId, "ATI REMOTE WONDER")
  If iDeviceId Then Devices.ValueUpdate(iDeviceId, 1, Str(sCommand))

End

Private Sub ProcessAtiPlus()

  Dim iRemote, iDeviceId As Integer
  Dim sCommand As String

  If RecBuf[0] > RecBuf[1] Then
    iRemote = RecBuf[0] - RecBuf[1]
  Else
    iRemote = (RecBuf[0] + &H100&) - RecBuf[1]
  Endif

  If $bDebug Then
    Main.WriteDebugLogChars(" ATIPLUS[" & (Lsr(RecBuf[2], 4)) & "]C Remote type=", 1)

    Select Case iRemote
      Case &HC5
        Main.WriteDebugLogChars("ATI Remote Wonder Plus", 1)
      Case Else
        Main.WriteDebugLogChars("Unknown remote:" & Hex(iRemote), 1)
    End Select
    Main.WriteDebugLogChars(" Channel=" & Str(Lsr(RecBuf[2], 4)), 1)

    If (RecBuf[1] And &H80) = 0 Then
      Main.WriteDebugLogChars(" Even ", 1)
    Else
      Main.WriteDebugLogChars(" Odd ", 1)
    Endif
  Endif

  Select Case (RecBuf[1] And &H7F)
    Case &H0
      sCommand = "Key-a"
    Case &H1
      sCommand = "Key-b"
    Case &H2
      sCommand = "Power"
    Case &H3
      sCommand = "Tv"
    Case &H4
      sCommand = "Dvd"
    Case &H5
      sCommand = "?"
    Case &H6
      sCommand = "Guide"
    Case &H7
      sCommand = "Drag"
    Case &H8
      sCommand = "Vol+"
    Case &H9
      sCommand = "Vol-"
    Case &HA
      sCommand = "Mute"
    Case &HB
      sCommand = "Chan+"
    Case &HC
      sCommand = "Chan-"
    Case &HD
      sCommand = "Key-1"
    Case &HE
      sCommand = "Key-2"
    Case &HF
      sCommand = "Key-3"
    Case &H10
      sCommand = "Key-4"
    Case &H11
      sCommand = "Key-5"
    Case &H12
      sCommand = "Key-6"
    Case &H13
      sCommand = "Key-7"
    Case &H14
      sCommand = "Key-8"
    Case &H15
      sCommand = "Key-9"
    Case &H16
      sCommand = "Txt"
    Case &H17
      sCommand = "Key-0"
    Case &H18
      sCommand = "Setup-menu"
    Case &H19
      sCommand = "Key-c"
    Case &H1A
      sCommand = "Cursor-up"
    Case &H1B
      sCommand = "Key-d"
    Case &H1C
      sCommand = "Fm"
    Case &H1D
      sCommand = "Cursor-left"
    Case &H1E
      sCommand = "Ok"
    Case &H1F
      sCommand = "Cursor-right"
    Case &H20
      sCommand = "Max-restore-window"
    Case &H21
      sCommand = "Key-e"
    Case &H22
      sCommand = "Cursor-down"
    Case &H23
      sCommand = "Key-f"
    Case &H24
      sCommand = "Rewind"
    Case &H25
      sCommand = "Play"
    Case &H26
      sCommand = "Fast-forward"
    Case &H27
      sCommand = "Record"
    Case &H28
      sCommand = "Stop"
    Case &H29
      sCommand = "Pause"
    Case &H2A
      sCommand = "Tv2"
    Case &H2B
      sCommand = "Clock"
    Case &H2C
      sCommand = "Key-i"
    Case &H2D
      sCommand = "Ati"
    Case &H2E
      sCommand = "Radio"
    Case &H2F
      sCommand = "Tv-preview"
    Case &H30
      sCommand = "Channel-list"
    Case &H31
      sCommand = "Video-desktop"
    Case &H32
      sCommand = "Red"
    Case &H33
      sCommand = "Green"
    Case &H34
      sCommand = "Yellow"
    Case &H35
      sCommand = "Blue"
    Case &H36
      sCommand = "Rename-tab"
    Case &H37
      sCommand = "Snapshot"
    Case &H38
      sCommand = "Edit-image"
    Case &H39
      sCommand = "Full-screen"
    Case &H3A
      sCommand = "Dvd-audio"
    Case &H70
      sCommand = "Mouse-left"
    Case &H71
      sCommand = "Mouse-right"
    Case &H72
      sCommand = "Mouse-up"
    Case &H73
      sCommand = "Mouse-down"
    Case &H74
      sCommand = "Mouse-up-left"
    Case &H75
      sCommand = "Mouse-up-right"
    Case &H76
      sCommand = "Mouse-down-right"
    Case &H77
      sCommand = "Mouse-down-left"
    Case &H78
      sCommand = "Left-mouse-button"
    Case &H79
      sCommand = "Key-v-end"
    Case &H7C
      sCommand = "Right-mouse-button"
    Case &H7D
      sCommand = "Key-x-end"
    Case Else
      sCommand = "Unknown"
  End Select
  If $bDebug Then Main.WriteDebugLogChars(" Command=" & sCommand, 1)

  iDeviceId = Devices.Find(Instance, "ATIPLUS[" & (Lsr(RecBuf[2], 4)) & "]C", InterfaceId, "ATI WONDER PLUS")
  If iDeviceId Then Devices.ValueUpdate(iDeviceId, 1, Str(sCommand))

End

Private Sub ProcessHE()

  Dim sText, sDevice As String
  Dim iDeviceId As Integer

  If RecBits <> 12 Then
    sDevice = Hex(Lsr(RecBuf[0], 6)) & Hex((Lsl(RecBuf[0], 2) Or Lsr(RecBuf[1], 6)) And &HFF) & Hex((Lsl(RecBuf[1], 2) Or Lsr(RecBuf[2], 6)) And &HFF) & Hex((Lsl(RecBuf[2], 2) Or Lsr(RecBuf[3], 6)) And &HFF)
    If $bDebug Then
      Main.WriteDebugLogChars(" HE Device=" & sDevice, True)
      Main.WriteDebugLogChars(" Unit=" & CStr((RecBuf[3] And &HF) + 1), True)
    Endif
    If RecBits = 34 Then
      Select Case RecBuf[3] And &H30
        Case &H0
          sText = "OFF"
          iDeviceId = Devices.Find(Instance, sDevice & CStr((RecBuf[3] And &HF) + 1), InterfaceId, "HEUK")
          If iDeviceId Then Devices.ValueUpdate(iDeviceId, 1, "Off")
        Case &H10
          sText = "ON"
          iDeviceId = Devices.Find(Instance, sDevice & CStr((RecBuf[3] And &HF) + 1), InterfaceId, "HEUK")
          If iDeviceId Then Devices.ValueUpdate(iDeviceId, 1, "On")
        Case &H20
          sText = "GROUP OFF"
          iDeviceId = Devices.Find(Instance, sDevice & CStr((RecBuf[3] And &HF) + 1), InterfaceId, "HEUK")
          If iDeviceId Then Devices.ValueUpdate(iDeviceId, 1, "Off")
        Case &H30
          sText = "GROUP ON"
          iDeviceId = Devices.Find(Instance, sDevice & CStr((RecBuf[3] And &HF) + 1), InterfaceId, "HEUK")
          If iDeviceId Then Devices.ValueUpdate(iDeviceId, 1, "On")
      End Select
      If $bDebug Then Main.WriteDebugLogChars(" " & sText, True)
    Else
      If $bDebug Then
        Select Case RecBuf[4] And &HC
          Case &H0
            Main.WriteDebugLogChars((" Error: preset record length without preset bits set"), True)
          Case &H4
              If (RecBuf[3] And &H20) = &H0 Then
              Main.WriteDebugLogChars((" Preset command,"), True)
            Else
              Main.WriteDebugLogChars((" Preset group command,"), True)
            Endif
          Case &H8, &HC
            Main.WriteDebugLogChars((" Reserved (unexpected)"), True)
        End Select
        Main.WriteDebugLogChars((" Level=") & CStr((Lsr(RecBuf[4], 4)) + 1), True)
      Endif
    Endif
  Endif

End

Private Sub ProcessRFXMeter()

  Dim sMeasuredValue As String
  Dim iDeviceId As Integer
  Dim sTemp As String

  If $bDebug Then
    Main.WriteDebugLogChars(" RFXMeter[" & (RecBuf[0] * 256 + RecBuf[1]) & "]M", True)
    Main.WriteDebugLogChars(" addr:" & Hex(RecBuf[0], 2) & Hex(RecBuf[1]), 1)
    Main.WriteDebugLogChars(" ID:" & Format(Str(RecBuf[1] + (RecBuf[0] * 256)), "00") & " ", True)
  Endif
  Select Case RecBuf[5] And &HF0
    Case &H0
      sMeasuredValue = ((RecBuf[4] * 65536) + (RecBuf[2] * 256) + RecBuf[3])
      If $bDebug Then
        Main.WriteDebugLogChars("RFXMeter: " & Str(sMeasuredValue), True)
        Main.WriteDebugLogChars("; RFXPower: " & Str(sMeasuredValue / 100) & " kWh", True)
        Main.WriteDebugLogChars("; RFXPower-Module: " & Str(sMeasuredValue / 1000) & " kWh", True)
      Endif
      iDeviceId = Devices.Find(Instance, "RFXMETER[" & (RecBuf[0] * 256 + RecBuf[1]) & "]M", InterfaceId, "RFXMETER")
      If iDeviceId Then Devices.ValueUpdate(iDeviceId, 1, CStr(sMeasuredValue))
    Case &H10
      sTemp = ("Interval: ")
      Select Case RecBuf[2]
        Case &H1
          sTemp = sTemp & ("30 seconds")
        Case &H2
          sTemp = sTemp & ("1 minute")
        Case &H4
          sTemp = sTemp & ("6 minutes")
        Case &H8
          sTemp = sTemp & ("12 minutes")
        Case &H10
          sTemp = sTemp & ("15 minutes")
        Case &H20
          sTemp = sTemp & ("30 minutes")
        Case &H40
          sTemp = sTemp & ("45 minutes")
        Case &H80
          sTemp = sTemp & ("60 minutes")
        Case Else
          sTemp = sTemp & ("illegal value")
      End Select
      If $bDebug Then Main.WriteDebugLogChars(sTemp, True)
    Case &H20
      Select Case (RecBuf[4] And &HC0)
        Case &H0
          sTemp = ("Input-0 ")
        Case &H40
          sTemp = ("Input-1 ")
        Case &H80
          sTemp = ("Input-2 ")
        Case Else
          sTemp = ("Error, unknown input ")
      End Select
      sMeasuredValue = (((RecBuf[4] And &H3F) * 65536) + (RecBuf[2] * 256) + RecBuf[3]) / 1000
      If $bDebug Then
        Main.WriteDebugLogChars(("Calibration: ") & sMeasuredValue & "msec ", True)
        Main.WriteDebugLogChars(sTemp, True)
        If sMeasuredValue <> 0 Then
          Main.WriteDebugLogChars("RFXPower= " & Round(1 / ((16 * sMeasuredValue) / (3600000 / 100)), 3) & "kW", 1)
          Main.WriteDebugLogChars(" RFXPwr= " & Round(1 / ((16 * sMeasuredValue) / (3600000 / 62.5)), 3) & "|" & Round((1 / ((16 * sMeasuredValue) / (3600000 / 62.5))) * 1.917, 3) & "kW", 1)
        Endif
      Endif
    Case &H30
      If $bDebug Then Main.WriteDebugLogChars(("New address set"))
    Case &H40
      Select Case (RecBuf[4] And &HC0)
        Case &H0
          If $bDebug Then Main.WriteDebugLogChars(("Counter for Input-0 will be set to zero within 5 seconds OR push MODE button for next command."))
        Case &H40
          If $bDebug Then Main.WriteDebugLogChars(("Counter for Input-1 will be set to zero within 5 seconds OR push MODE button for next command."))
        Case &H80
          If $bDebug Then Main.WriteDebugLogChars(("Counter for Input-2 will be set to zero within 5 seconds OR push MODE button for next command."))
        Case Else
          If $bDebug Then Main.WriteDebugLogChars(("Error, unknown input "))
      End Select
    Case &H50
      sMeasuredValue = Lsr(RecBuf[2], 4) * 100000 + (RecBuf[2] And &HF) * 10000 + Lsr(RecBuf[3], 4) * 1000 + (RecBuf[3] And &HF) * 100 + Lsr(RecBuf[4], 4) * 10 + (RecBuf[4] And &HF)
      If $bDebug Then
        Main.WriteDebugLogChars(("Push MODE push button within 5 seconds to increment the 1st digit."))
        Main.WriteDebugLogChars(("Counter value = ") & Format(sMeasuredValue, "00000"))
      Endif
    Case &H60
      sMeasuredValue = Lsr(RecBuf[2], 4) * 100000 + (RecBuf[2] And &HF) * 10000 + Lsr(RecBuf[3], 4) * 1000 + (RecBuf[3] And &HF) * 100 + Lsr(RecBuf[4], 4) * 10 + (RecBuf[4] And &HF)
      If $bDebug Then
        Main.WriteDebugLogChars(("Push MODE push button within 5 seconds to increment the 2nd digit."))
        Main.WriteDebugLogChars(("Counter value = ") & Format(sMeasuredValue, "00000"))
      Endif
    Case &H70
      sMeasuredValue = Lsr(RecBuf[2], 4) * 100000 + (RecBuf[2] And &HF) * 10000 + Lsr(RecBuf[3], 4) * 1000 + (RecBuf[3] And &HF) * 100 + Lsr(RecBuf[4], 4) * 10 + (RecBuf[4] And &HF)
      If $bDebug Then
        Main.WriteDebugLogChars(("Push MODE push button within 5 seconds to increment the 3rd digit."))
        Main.WriteDebugLogChars(("Counter value = ") & Format(sMeasuredValue, "00000"))
      Endif
    Case &H80
      sMeasuredValue = Lsr(RecBuf[2], 4) * 100000 + (RecBuf[2] And &HF) * 10000 + Lsr(RecBuf[3], 4) * 1000 + (RecBuf[3] And &HF) * 100 + Lsr(RecBuf[4], 4) * 10 + (RecBuf[4] And &HF)
      If $bDebug Then
        Main.WriteDebugLogChars(("Push MODE push button within 5 seconds to increment the 4th digit."))
        Main.WriteDebugLogChars(("Counter value = ") & Format(sMeasuredValue, "00000"))
      Endif
    Case &H90
      sMeasuredValue = Lsr(RecBuf[2], 4) * 100000 + (RecBuf[2] And &HF) * 10000 + Lsr(RecBuf[3], 4) * 1000 + (RecBuf[3] And &HF) * 100 + Lsr(RecBuf[4], 4) * 10 + (RecBuf[4] And &HF)
      If $bDebug Then
        Main.WriteDebugLogChars(("Push MODE push button within 5 seconds to increment the 5th digit."))
        Main.WriteDebugLogChars(("Counter value = ") & Format(sMeasuredValue, "00000"))
      Endif
    Case &HA0
      SMeasuredValue = Lsr(RecBuf[2], 4) * 100000 + (RecBuf[2] And &HF) * 10000 + Lsr(RecBuf[3], 4) * 1000 + (RecBuf[3] And &HF) * 100 + Lsr(RecBuf[4], 4) * 10 + (RecBuf[4] And &HF)
      If $bDebug Then
        Main.WriteDebugLogChars(("Push MODE push button within 5 seconds to increment the 6th digit."))
        Main.WriteDebugLogChars(("Counter value = ") & Format(sMeasuredValue, "00000"))
      Endif
    Case &HB0
      Select Case RecBuf[4]
        Case &H0
          If $bDebug Then Main.WriteDebugLogChars(("Counter for Input-0 reset to zero."))
        Case &H40
          If $bDebug Then Main.WriteDebugLogChars(("Counter for Input-1 reset to zero."))
        Case &H80
          If $bDebug Then Main.WriteDebugLogChars(("Counter for Input-2 reset to zero."))
        Case Else
          If $bDebug Then Main.WriteDebugLogChars(("protocol error."))
      End Select
    Case &HC0
      If $bDebug Then Main.WriteDebugLogChars(("Enter SET INTERVAL RATE mode within 5 seconds OR push MODE button for next command."))
    Case &HD0
      Select Case (RecBuf[4] And &HC0)
        Case &H0
          If $bDebug Then Main.WriteDebugLogChars(("Enter CALIBRATION mode for Input-0 within 5 seconds OR push MODE button for next command."))
        Case &H40
          If $bDebug Then Main.WriteDebugLogChars(("Enter CALIBRATION mode for Input-1 within 5 seconds OR push MODE button for next command."))
        Case &H80
          If $bDebug Then Main.WriteDebugLogChars(("Enter CALIBRATION mode for Input-2 within 5 seconds OR push MODE button for next command."))
        Case Else
          If $bDebug Then Main.WriteDebugLogChars(("Error, unknown input "))
      End Select
    Case &HE0
      If $bDebug Then Main.WriteDebugLogChars(("Enter SET ADDRESS mode within 5 seconds OR push MODE button for next command."))
    Case &HF0
      If RecBuf[2] < &H40 Then
        If $bDebug Then Main.WriteDebugLogChars(("RFXPower Identification,"), True)
      Else If RecBuf[2] < &H80 Then
        If $bDebug Then Main.WriteDebugLogChars(("RFXWater Identification,"), True)
      Else If RecBuf[2] < &HC0 Then
        If $bDebug Then Main.WriteDebugLogChars(("RFXGas Identification,"), True)
      Else
        If $bDebug Then Main.WriteDebugLogChars(("RFXMeter Identification,"), True)
      Endif
      If $bDebug Then Main.WriteDebugLogChars((" Firmware Version: ") & Hex(RecBuf[2]))
      If $bDebug Then Main.WriteDebugLogChars((", Interval rate: "), True)
      Select Case RecBuf[3]
        Case &H1
          If $bDebug Then Main.WriteDebugLogChars(("30 seconds"), True)
        Case &H2
          If $bDebug Then Main.WriteDebugLogChars(("1 minute"), True)
        Case &H4
          If $bDebug Then Main.WriteDebugLogChars(("6 minutes"), True)
        Case &H8
          If $bDebug Then Main.WriteDebugLogChars(("12 minutes"), True)
        Case &H10
          If $bDebug Then Main.WriteDebugLogChars(("15 minutes"), True)
        Case &H20
          If $bDebug Then Main.WriteDebugLogChars(("30 minutes"), True)
        Case &H40
          If $bDebug Then Main.WriteDebugLogChars(("45 minutes"), True)
        Case &H80
          If $bDebug Then Main.WriteDebugLogChars(("60 minutes"), True)
        Case Else
          If $bDebug Then Main.WriteDebugLogChars(("illegal value"), True)
    End Select
    Case Else
      If $bDebug Then Main.WriteDebugLogChars(("illegal packet type"), True)
  End Select

End

Private Function BatteryIndication() As String

  If (RecBuf[4] And &H4) = 0 Then
    If $bDebug Then Main.WriteDebugLogChars((" Battery OK"), True)
    Return "OK"
  Else
    If $bDebug Then Main.WriteDebugLogChars((" Battery Empty"), True)
    Return "Empty"
  Endif

End

Private Function ProcessOregon(bRecBits As Byte) As Boolean

  Dim sCelsius, sUv, sWeight, sLb, sStlb, sStlbr, sTrain, sTrainRate, sSpeed, sDd, sMm, sYy, sCt1, sCt2, sCt3 As Single
  Dim lCt4 As Float
  Dim bOregon As Boolean = False
  Dim iDeviceId, iCnt, iDirection As Integer
  Dim sUvText, sWrText, sBatt, sForecast, sWrSpeed, sWrAvgSpeed, sWrDirection, Hr, Mn, Sc, sDay As String

  ' TEMP1 Oregon THR128,THx138
  If RecBuf[0] = &HA And RecBuf[1] = &H4D And bRecBits >= 72 Then
    bOregon = True
    If $bDebug Then
      Main.WriteDebugLogChars(" TEMP1[" & CStr((RecBuf[3]) * 256 + ((Lsr(RecBuf[2], 4)) And &H7)) & "] THR128,THx138", True)
      WrChannel()
      Main.WriteDebugLogChars(" addr:" & Hex(RecBuf[3], 2), True)
    Endif
    If ((RecBuf[5] And &HF0) < &HA0) And ((RecBuf[5] And &HF) < &HA) And ((RecBuf[4] And &HF0) < &HA0) Then
      If $bDebug Then Main.WriteDebugLogChars(" temp:", 1)
      If (RecBuf[6] And &H8) = 0 Then
        sCelsius = CSingle(Hex(RecBuf[5])) + CSingle(Hex(Lsr(RecBuf[4], 4))) / 10
      Else
        sCelsius = 0 - (CSingle(Hex(RecBuf[5])) + CSingle(Hex(Lsr(RecBuf[4], 4))) / 10)
      Endif
      If $bDebug Then Main.WriteDebugLogChars(Format(CStr(sCelsius), "0.#") & "°C | " & Format(CStr(sCelsius * 1.8 + 32), ".##") & "°F", True)
    Else
      If $bDebug Then Main.WriteDebugLogChars((" wrong value in temperature field=") & Hex(RecBuf[5]) & "." & Hex(Lsr(RecBuf[4], 4)), True)
    Endif
    sBatt = BatteryIndication()
    If Checksum8() Then
      ' find device id
      iDeviceId = Devices.Find(Instance, "TEMP1[" & CStr((RecBuf[3]) * 256 + ((Lsr(RecBuf[2], 4)) And &H7)) & "]", InterfaceId, "TEMP1")
      ' update value & battery status
      If iDeviceId Then
        If Main.sTemperature = "°C" Then
          ' temp °C
          Devices.ValueUpdate(iDeviceId, 1, Format(CStr(sCelsius), "0.#"), Devices.ValueType_Temperature)
        Else
          ' temp °F
          Devices.ValueUpdate(iDeviceId, 1, Format(CStr(sCelsius * 1.8 + 32), ".##"), Devices.ValueType_Temperature)
        Endif
        Devices.Battery(iDeviceId, sBatt)
      Endif
    Endif

  ' TEMP2 Oregon THRN132N,THWR288,AW131
  Else If RecBuf[0] = &HEA And RecBuf[1] = &H4C And bRecBits >= 60 Then
    bOregon = True
    If $bDebug Then
      Main.WriteDebugLogChars(" TEMP2[" & CStr((RecBuf[3]) * 256 + ((Lsr(RecBuf[2], 4)) And &H7)) & "] THN132N,THWR288,AW131", True)
      WrChannel()
      Main.WriteDebugLogChars(" addr:" & Hex(RecBuf[3], 2), True)
    Endif
    If ((RecBuf[5] And &HF0) < &HA0) And ((RecBuf[5] And &HF) < &HA) And ((RecBuf[4] And &HF0) < &HA0) Then
      If $bDebug Then Main.WriteDebugLogChars(" temp:", 1)
      If (RecBuf[6] And &H8) = 0 Then
        sCelsius = (RecBuf[6] And &H1) * 100 + CSingle(Hex(RecBuf[5])) + CSingle(Hex(Lsr(RecBuf[4], 4))) / 10
      Else
        sCelsius = 0 - (CSingle(Hex(RecBuf[5]))) + CSingle(Hex(Lsr(RecBuf[4], 4)) / 10)
      Endif
      If $bDebug Then Main.WriteDebugLogChars(Format(CStr(sCelsius), "0.#") & "°C | " & Format(CStr(sCelsius * 1.8 + 32), ".##") & "°F", True)
    Endif
    sBatt = BatteryIndication()
    If ChecksumW() Then
      ' find device id
      iDeviceId = Devices.Find(Instance, "TEMP2[" & CStr((RecBuf[3]) * 256 + ((Lsr(RecBuf[2], 4)) And &H7)) & "]", InterfaceId, "TEMP2")
      ' update value & battery status
      If iDeviceId Then
        If Main.sTemperature = "°C" Then
          ' temp °C
          Devices.ValueUpdate(iDeviceId, 1, Format(CStr(sCelsius), "0.#"), Devices.ValueType_Temperature)
        Else
          ' temp °F
          Devices.ValueUpdate(iDeviceId, 1, Format(CStr(sCelsius * 1.8 + 32), ".##"), Devices.ValueType_Temperature)
        Endif
        Devices.Battery(iDeviceId, sBatt)
      Endif
    Endif

  ' TEMP3 Oregon THWR800
  Else If RecBuf[0] = &HCA And RecBuf[1] = &H48 And bRecBits >= 60 Then
    bOregon = True
    If $bDebug Then
      Main.WriteDebugLogChars(" TEMP3[" & CStr(RecBuf[3] * 256 + ((Lsr(RecBuf[2], 4)) And &H7)) & "] THWR800", True)
      WrChannel()
      Main.WriteDebugLogChars(" addr:" & Hex(RecBuf[3], 2), True)
      Main.WriteDebugLogChars(" temp:", True)
    Endif
    If (RecBuf[6] And &H8) = 0 Then
      sCelsius = CSingle(Hex(RecBuf[5])) + CSingle(Hex(Lsr(RecBuf[4], 4))) / 10
    Else
      sCelsius = 0 - (CSingle(Hex(RecBuf[5])) + CSingle(Hex(Lsr(RecBuf[4], 4))) / 10)
    Endif
    If $bDebug Then Main.WriteDebugLogChars(Format(CStr(sCelsius), "0.#") & "°C | " & Format(CStr(sCelsius * 1.8 + 32), ".##") & "°F", True)
    sBatt = BatteryIndication()
    If ChecksumW() Then
      ' find device id
      iDeviceId = Devices.Find(Instance, "TEMP3[" & CStr(RecBuf[3] * 256 + ((Lsr(RecBuf[2], 4)) And &H7)) & "]", InterfaceId, "TEMP3")
      ' update value & battery status
      If iDeviceId Then
        If Main.sTemperature = "°C" Then
          ' temp °C
          Devices.ValueUpdate(iDeviceId, 1, Format(CStr(sCelsius), "0.#"), Devices.ValueType_Temperature)
        Else
          ' temp °F
          Devices.ValueUpdate(iDeviceId, 1, Format(CStr(sCelsius * 1.8 + 32), ".##"), Devices.ValueType_Temperature)
        Endif
        Devices.Battery(iDeviceId, sBatt)
      Endif
    Endif

  ' TEMP4 Oregon RTHN318
  Else If (RecBuf[0] And &HF) = &HA And RecBuf[1] = &HDC And bRecBits >= 64 Then
    bOregon = True
    If $bDebug Then
      Main.WriteDebugLogChars(" TEMP4[" & CStr(RecBuf[3] * 256 + ((Lsr(RecBuf[2], 4)) And &H7)) & "] RTHN318", True)
      WrChannel3()
      Main.WriteDebugLogChars(" addr:" & Hex(RecBuf[3], 2), True)
      Main.WriteDebugLogChars(" temp:", True)
    Endif
    If (RecBuf[6] And &H8) = 0 Then
      sCelsius = CSingle(Hex(RecBuf[5])) + CSingle(Hex(Lsr(RecBuf[4], 4))) / 10
    Else
      sCelsius = 0 - (CSingle(Hex(RecBuf[5])) + CSingle(Hex(Lsr(RecBuf[4], 4))) / 10)
    Endif
    If $bDebug Then Main.WriteDebugLogChars(Format(CStr(sCelsius), "0.#") & "°C | " & Format(CStr(sCelsius * 1.8 + 32), ".##") & "°F", True)
    sBatt = BatteryIndication()
    If ChecksumW() Then
      ' find device id
      iDeviceId = Devices.Find(Instance, "TEMP4[" & CStr(RecBuf[3] * 256 + ((Lsr(RecBuf[2], 4)) And &H7)) & "]", InterfaceId, "TEMP4")
      ' update value & battery status
      If iDeviceId Then
        If Main.sTemperature = "°C" Then
          ' temp °C
          Devices.ValueUpdate(iDeviceId, 1, Format(CStr(sCelsius), "0.#"), Devices.ValueType_Temperature)
        Else
          ' temp °F
          Devices.ValueUpdate(iDeviceId, 1, Format(CStr(sCelsius * 1.8 + 32), ".##"), Devices.ValueType_Temperature)
        Endif
        Devices.Battery(iDeviceId, sBatt)
      Endif
    Endif

  ' TH1 Oregon THGN122N,THGR122NX,THGR228N,THGR268
  Else If RecBuf[0] = &H1A And RecBuf[1] = &H2D And bRecBits >= 72 Then
    bOregon = True
    If $bDebug Then
      Main.WriteDebugLogChars(" TH1[" & CStr(RecBuf[3] * 256 + (Lsr(RecBuf[2], 4) And &H7)) & "] THGN122N,THGR122NX,THGR228N,THGR268", True)
      WrChannel()
      Main.WriteDebugLogChars(" addr:" & Hex(RecBuf[3], 2), True)
      Main.WriteDebugLogChars(" temp:", True)
    Endif
    If (RecBuf[6] And &H8) = 0 Then
      sCelsius = CSingle(Hex(RecBuf[5])) + CSingle(Hex(Lsr(RecBuf[4], 4))) / 10
    Else
      sCelsius = 0 - (CSingle(Hex(RecBuf[5])) + CSingle(Hex(Lsr(RecBuf[4], 4))) / 10)
    Endif
    If $bDebug Then
      Main.WriteDebugLogChars(Format(CStr(sCelsius), "0.#") & "°C | " & Format(CStr(sCelsius * 1.8 + 32), ".##") & "°F", True)
      Main.WriteDebugLogChars(" hum:" & Right(Hex(((Lsl(RecBuf[7], 4)) And &HF0) + ((Lsr(RecBuf[6], 4)) And &HF)), 2), True)
    Endif
    sWrText = WrHum(RecBuf[7] And &HC0)
    sBatt = BatteryIndication()
    If Checksum8() Then
      ' find device id
      iDeviceId = Devices.Find(Instance, "TH1[" & CStr(RecBuf[3] * 256 + (Lsr(RecBuf[2], 4) And &H7)) & "]", InterfaceId, "TH1")
      ' update values & battery status
      If iDeviceId Then
        If Main.sTemperature = "°C" Then
          ' temp °C, hum %, hum text
          Devices.ValueUpdate(iDeviceId, 1, Format(CStr(sCelsius), "0.#"), Devices.ValueType_Temperature)
        Else
          ' temp °F, hum %, hum text
          Devices.ValueUpdate(iDeviceId, 1, Format(CStr(sCelsius * 1.8 + 32), ".##"), Devices.ValueType_Temperature)
        Endif
        Devices.ValueUpdate(iDeviceId, 2, Right(Hex(((Lsl(RecBuf[7], 4)) And &HF0) + ((Lsr(RecBuf[6], 4)) And &HF)), 2))
        Devices.ValueUpdate(iDeviceId, 3, sWrText)
        Devices.Battery(iDeviceId, sBatt)
      Endif
    Endif

  ' TH2 Oregon THGR810
  Else If RecBuf[0] = &HFA And RecBuf[1] = &H28 And bRecBits >= 72 Then
    bOregon = True
    If $bDebug Then
      Main.WriteDebugLogChars(" TH2[" & CStr(RecBuf[3] * 256 + (Lsr(RecBuf[2], 4))) & "] THGR810", True)
      WrChannel3()
      Main.WriteDebugLogChars(" addr:" & Hex(RecBuf[3], 2), True)
      Main.WriteDebugLogChars(" temp:", 1)
    Endif
    If (RecBuf[6] And &H8) = 0 Then
      sCelsius = CSingle(Hex(RecBuf[5])) + CSingle(Hex(Lsr(RecBuf[4], 4))) / 10
    Else
      sCelsius = 0 - (CSingle(Hex(RecBuf[5])) + CSingle(Hex(Lsr(RecBuf[4], 4))) / 10)
    Endif
    If $bDebug Then
      Main.WriteDebugLogChars(Format(CStr(sCelsius), "0.#") & "°C | " & Format(CStr(sCelsius * 1.8 + 32), ".##") & "°F", True)
      Main.WriteDebugLogChars(" hum:" & Right(Hex(((Lsl(RecBuf[7], 4)) And &HF0) + ((Lsr(RecBuf[6], 4)) And &HF)), 2), True)
    Endif
    sWrText = WrHum(RecBuf[7] And &HC0)
    sBatt = BatteryIndication()
    If Checksum8() Then
      ' find device id
      iDeviceId = Devices.Find(Instance, "TH2[" & CStr(RecBuf[3] * 256 + (Lsr(RecBuf[2], 4))) & "]", InterfaceId, "TH2")
      ' update values & battery status
      If iDeviceId Then
        If Main.sTemperature = "°C" Then
          ' temp °C, hum %, hum text
          Devices.ValueUpdate(iDeviceId, 1, Format(CStr(sCelsius), "0.#"), Devices.ValueType_Temperature)
        Else
          ' temp °F, hum %, hum text
          Devices.ValueUpdate(iDeviceId, 1, Format(CStr(sCelsius * 1.8 + 32), ".##"), Devices.ValueType_Temperature)
        Endif
        Devices.ValueUpdate(iDeviceId, 2, Right(Hex(((Lsl(RecBuf[7], 4)) And &HF0) + ((Lsr(RecBuf[6], 4)) And &HF)), 2))
        Devices.ValueUpdate(iDeviceId, 3, sWrText)
        Devices.Battery(iDeviceId, sBatt)
      Endif
    Endif

  ' TH3 Oregon RTGR328N
  Else If (RecBuf[0] And &HF) = &HA And RecBuf[1] = &HCC And bRecBits >= 72 Then
    bOregon = True
    If $bDebug Then
      Main.WriteDebugLogChars(" TH3[" & CStr(RecBuf[3] * 256 + (Lsr(RecBuf[2], 4))) & "] RTGR328N", True)
      WrChannel3()
      Main.WriteDebugLogChars(" counter:" & CStr(Lsr(RecBuf[0], 4)), True)
      Main.WriteDebugLogChars(" addr:" & Hex(RecBuf[3], 2), True)
      Main.WriteDebugLogChars(" temp:", True)
    Endif
    If (RecBuf[6] And &H8) = 0 Then
      sCelsius = CSingle(Hex(RecBuf[5])) + CSingle(Hex(Lsr(RecBuf[4], 4))) / 10
    Else
      sCelsius = 0 - (CSingle(Hex(RecBuf[5])) + CSingle(Hex(Lsr(RecBuf[4], 4))) / 10)
    Endif
    If $bDebug Then
      Main.WriteDebugLogChars(Format(CStr(sCelsius), "0.#") & "°C | " & Format(CStr(sCelsius * 1.8 + 32), "0.##") & "°F", True)
      Main.WriteDebugLogChars(" hum:" & Right(Hex(((Lsl(RecBuf[7], 4)) And &HF0) + ((Lsr(RecBuf[6], 4)) And &HF)), 2), True)
    Endif
    sWrText = WrHum(RecBuf[7] And &HC0)
    sBatt = BatteryIndication()
    If Checksum8() Then
      ' find device id
      iDeviceId = Devices.Find(Instance, "TH3[" & CStr(RecBuf[3] * 256 + (Lsr(RecBuf[2], 4))) & "]", InterfaceId, "TH3")
      ' update values & battery status
      If iDeviceId Then
        If Main.sTemperature = "°C" Then
          ' temp °C, hum %, hum text
          Devices.ValueUpdate(iDeviceId, 1, Format(CStr(sCelsius), "0.#"), Devices.ValueType_Temperature)
        Else
          ' temp °F, hum %, hum text
          Devices.ValueUpdate(iDeviceId, 1, Format(CStr(sCelsius * 1.8 + 32), ".##"), Devices.ValueType_Temperature)
        Endif
        Devices.ValueUpdate(iDeviceId, 2, Right(Hex(((Lsl(RecBuf[7], 4)) And &HF0) + ((Lsr(RecBuf[6], 4)) And &HF)), 2))
        Devices.ValueUpdate(iDeviceId, 3, sWrText)
        Devices.Battery(iDeviceId, sBatt)
      Endif
    Endif

  ' TH4 Oregon THGR328
  Else If RecBuf[0] = &HCA And RecBuf[1] = &H2C And bRecBits >= 72 Then
    bOregon = True
    If $bDebug Then
      Main.WriteDebugLogChars(" TH4[" & CStr(RecBuf[3] * 256 + ((Lsr(RecBuf[2], 4)) And &H7)) & "] THGR328", True)
      WrChannel()
      Main.WriteDebugLogChars(" counter:" & CStr(Lsr(RecBuf[0], 4)), True)
      Main.WriteDebugLogChars(" addr:" & Hex(RecBuf[3], 2), True)
      Main.WriteDebugLogChars(" temp:", True)
    Endif
    If (RecBuf[6] And &H8) = 0 Then
      sCelsius = CSingle(Hex(RecBuf[5])) + CSingle(Hex(Lsr(RecBuf[4], 4))) / 10
    Else
      sCelsius = 0 - (CSingle(Hex(RecBuf[5])) + CSingle(Hex(Lsr(RecBuf[4], 4))) / 10)
    Endif
    If $bDebug Then
      Main.WriteDebugLogChars(Format(CStr(sCelsius), "0.#") & "°C | " & Format(CStr(sCelsius * 1.8 + 32), "0.##") & "°F", True)
      Main.WriteDebugLogChars(" hum:" & Right(Hex(((Lsl(RecBuf[7], 4)) And &HF0) + ((Lsr(RecBuf[6], 4)) And &HF)), 2), True)
    Endif
    sWrText = WrHum(RecBuf[7] And &HC0)
    sBatt = BatteryIndication()
    If Checksum8() Then
      ' find device id
      iDeviceId = Devices.Find(Instance, "TH4[" & CStr(RecBuf[3] * 256 + ((Lsr(RecBuf[2], 4)) And &H7)) & "]", InterfaceId, "TH4")
      ' update values & battery status
      If iDeviceId Then
        If Main.sTemperature = "°C" Then
          ' temp °C, hum %, hum text
          Devices.ValueUpdate(iDeviceId, 1, Format(CStr(sCelsius), "0.#"), Devices.ValueType_Temperature)
        Else
          ' temp °F, hum %, hum text
          Devices.ValueUpdate(iDeviceId, 1, Format(CStr(sCelsius * 1.8 + 32), ".##"), Devices.ValueType_Temperature)
        Endif
        Devices.ValueUpdate(iDeviceId, 2, Right(Hex(((Lsl(RecBuf[7], 4)) And &HF0) + ((Lsr(RecBuf[6], 4)) And &HF)), 2))
        Devices.ValueUpdate(iDeviceId, 3, sWrText)
        Devices.Battery(iDeviceId, sBatt)
      Endif
    Endif

  ' TH5 Oregon WTGR800
  Else If RecBuf[0] = &HFA And RecBuf[1] = &HB8 And bRecBits >= 72 Then
    bOregon = True
    If $bDebug Then
      Main.WriteDebugLogChars(" TH5[" & CStr(RecBuf[3] * 256) & "] WTGR800", True)
      Main.WriteDebugLogChars(" addr:" & Hex(RecBuf[3], 2), True)
      Main.WriteDebugLogChars(" temp:", True)
    Endif
    If (RecBuf[6] And &H8) = 0 Then
      sCelsius = CSingle(Hex(RecBuf[5])) + CSingle(Hex(Lsr(RecBuf[4], 4))) / 10
    Else
      sCelsius = 0 - (CSingle(Hex(RecBuf[5])) + CSingle(Hex(Lsr(RecBuf[4], 4))) / 10)
    Endif
    If $bDebug Then
      Main.WriteDebugLogChars(Format(CStr(sCelsius), "0.#") & "°C | " & Format(CStr(sCelsius * 1.8 + 32), "0.##") & "°F", True)
      Main.WriteDebugLogChars(" hum:" & Right(Hex(((Lsl(RecBuf[7], 4)) And &HF0) + ((Lsr(RecBuf[6], 4)) And &HF)), 2), True)
    Endif
    sWrText = WrHum(RecBuf[7] And &HC0)
    sBatt = WrBattery()
    If Checksum8() Then
      ' find device id
      iDeviceId = Devices.Find(Instance, "TH5[" & CStr(RecBuf[3] * 256) & "]", InterfaceId, "TH5")
      ' update values & battery status
      If iDeviceId Then
        If Main.sTemperature = "°C" Then
          ' temp °C, hum %, hum text
          Devices.ValueUpdate(iDeviceId, 1, Format(CStr(sCelsius), "0.#"), Devices.ValueType_Temperature)
        Else
          ' temp °F, hum %, hum text
          Devices.ValueUpdate(iDeviceId, 1, Format(CStr(sCelsius * 1.8 + 32), ".##"), Devices.ValueType_Temperature)
        Endif
        Devices.ValueUpdate(iDeviceId, 2, Right(Hex(((Lsl(RecBuf[7], 4)) And &HF0) + ((Lsr(RecBuf[6], 4)) And &HF)), 2))
        Devices.ValueUpdate(iDeviceId, 3, sWrText)
        Devices.Battery(iDeviceId, sBatt)
      Endif
    Endif

  ' TH6 Oregon THGR918
  Else If RecBuf[0] = &H1A And RecBuf[1] = &H3D And bRecBits >= 72 Then
    bOregon = True
    If $bDebug Then
      Main.WriteDebugLogChars(" TH6[" & CStr(RecBuf[3] * 256 + ((Lsr(RecBuf[2], 4)) And &H7)) & "] THGR918/228", True)
      WrChannel()
      Main.WriteDebugLogChars(" addr:" & Hex(RecBuf[3], 2), True)
      Main.WriteDebugLogChars(" temp:", True)
    Endif
    If (RecBuf[6] And &H8) = 0 Then
      sCelsius = CSingle(Hex(RecBuf[5])) + CSingle(Hex(Lsr(RecBuf[4], 4))) / 10
    Else
      sCelsius = 0 - (CSingle(Hex(RecBuf[5])) + CSingle(Hex(Lsr(RecBuf[4], 4))) / 10)
    Endif
    If $bDebug Then
      Main.WriteDebugLogChars(Format(CStr(sCelsius), "0.#") & "°C | " & Format(CStr(sCelsius * 1.8 + 32), "0.##") & "°F", True)
      Main.WriteDebugLogChars(" hum:" & Right(Hex(((Lsl(RecBuf[7], 4)) And &HF0) + ((Lsr(RecBuf[6], 4)) And &HF)), 2), True)
    Endif
    sWrText = WrHum(RecBuf[7] And &HC0)
    sBatt = WrBattery()
    If Checksum8() Then
      ' find device id
      iDeviceId = Devices.Find(Instance, "TH6[" & CStr(RecBuf[3] * 256 + ((Lsr(RecBuf[2], 4)) And &H7)) & "]", InterfaceId, "TH6")
      ' update values & battery status
      If iDeviceId Then
        If Main.sTemperature = "°C" Then
          ' temp °C, hum %, hum text
          Devices.ValueUpdate(iDeviceId, 1, Format(CStr(sCelsius), "0.#"), Devices.ValueType_Temperature)
        Else
          ' temp °F, hum %, hum text
          Devices.ValueUpdate(iDeviceId, 1, Format(CStr(sCelsius * 1.8 + 32), ".##"), Devices.ValueType_Temperature)
        Endif
        Devices.ValueUpdate(iDeviceId, 2, Right(Hex(((Lsl(RecBuf[7], 4)) And &HF0) + ((Lsr(RecBuf[6], 4)) And &HF)), 2), Devices.ValueType_Humidity)
        Devices.ValueUpdate(iDeviceId, 3, sWrText)
        Devices.Battery(iDeviceId, sBatt)
      Endif
    Endif

  ' THB1 Oregon BTHR918
  Else If RecBuf[0] = &H5A And RecBuf[1] = &H5D And bRecBits >= 88 Then
    bOregon = True
    If $bDebug Then
      Main.WriteDebugLogChars(" THB1[" & CStr(RecBuf[3] * 256 + ((Lsr(RecBuf[2], 4)) And &H7)) & "] BTHR918", True)
      WrChannel()
      Main.WriteDebugLogChars(" addr:" & Hex(RecBuf[3], 2), True)
      Main.WriteDebugLogChars(" temp:", 1)
    Endif
    If (RecBuf[6] And &H8) = 0 Then
      sCelsius = CSingle(Hex(RecBuf[5])) + CSingle(Hex(Lsr(RecBuf[4], 4))) / 10
    Else
      sCelsius = 0 - (CSingle(Hex(RecBuf[5])) + CSingle(Hex(Lsr(RecBuf[4], 4))) / 10)
    Endif
    If $bDebug Then
      Main.WriteDebugLogChars(Format(CStr(sCelsius), "0.#") & "°C | " & Format(CStr(sCelsius * 1.8 + 32), "0.##") & "°F", True)
      Main.WriteDebugLogChars(" hum:" & Right(Hex(((Lsl(RecBuf[7], 4)) And &HF0) + ((Lsr(RecBuf[6], 4)) And &HF)), 2), True)
    Endif
    sWrText = WrHum(RecBuf[7] And &HC0)
    If $bDebug Then Main.WriteDebugLogChars(" baro:" & CStr(RecBuf[8] + 795) & "hPa", True)
    sForecast = WrForecast(RecBuf[9] And &HF)
    sBatt = BatteryIndication()
    If Checksum10() Then
      ' find device id
      iDeviceId = Devices.Find(Instance, "THB1[" & CStr(RecBuf[3] * 256 + ((Lsr(RecBuf[2], 4)) And &H7)) & "]", InterfaceId, "THB1")
      ' update values & battery status
      If iDeviceId Then
        If Main.sTemperature = "°C" Then
          ' temp °C, hum %, baro hPa, forecast
          Devices.ValueUpdate(iDeviceId, 1, Format(CStr(sCelsius), "0.#"), Devices.ValueType_Temperature)
        Else
          ' temp °F, hum %, baro hPa, forecast
          Devices.ValueUpdate(iDeviceId, 1, Format(CStr(sCelsius * 1.8 + 32), "0.##"), Devices.ValueType_Temperature)
        Endif
        Devices.ValueUpdate(iDeviceId, 2, Right(Hex(((Lsl(RecBuf[7], 4)) And &HF0) + ((Lsr(RecBuf[6], 4)) And &HF)), 2), Devices.ValueType_Humidity)
        Devices.ValueUpdate(iDeviceId, 3, CStr(RecBuf[8] + 795))
        Devices.ValueUpdate(iDeviceId, 4, sForecast)
        Devices.Battery(iDeviceId, sBatt)
      Endif
    Endif

  ' THB2 Oregon BTHR918N,BTHR968
  Else If RecBuf[0] = &H5A And RecBuf[1] = &H6D And bRecBits >= 88 Then
    bOregon = True
    If $bDebug Then
      Main.WriteDebugLogChars(" THB2[" & CStr(RecBuf[3] * 256 + ((Lsr(RecBuf[2], 4)) And &H7)) & "] BTHR918N,BTHR968", True)
      WrChannel()
      Main.WriteDebugLogChars(" addr:" & Hex(RecBuf[3], 2), True)
      Main.WriteDebugLogChars(" temp:", True)
    Endif
    If (RecBuf[6] And &H8) = 0 Then
      sCelsius = CSingle(Hex(RecBuf[5])) + CSingle(Hex(Lsr(RecBuf[4], 4))) / 10
    Else
      sCelsius = 0 - (CSingle(Hex(RecBuf[5])) + CSingle(Hex(Lsr(RecBuf[4], 4))) / 10)
    Endif
    If $bDebug Then
      Main.WriteDebugLogChars(Format(CStr(sCelsius), "0.#") & "°C | " & Format(CStr(sCelsius * 1.8 + 32), ".##") & "°F", True)
      Main.WriteDebugLogChars(" hum:" & Right(Hex(((Lsl(RecBuf[7], 4)) And &HF0) + ((Lsr(RecBuf[6], 4)) And &HF)), 2), True)
    Endif
    sWrText = WrHum(RecBuf[7] And &HC0)
    If $bDebug Then Main.WriteDebugLogChars(" baro:" & CStr(CSingle(RecBuf[8]) + 856) & "hPa", True)
    sForecast = WrForecast(Lsr(RecBuf[9], 4))
    sBatt = BatteryIndication()
    If Checksum10() Then
      ' find device id
      iDeviceId = Devices.Find(Instance, "THB2[" & CStr(RecBuf[3] * 256 + ((Lsr(RecBuf[2], 4)) And &H7)) & "]", InterfaceId, "THB2")
      ' update values & battery status
      If iDeviceId Then
        If Main.sTemperature = "°C" Then
          ' temp °C, hum %, baro hPa, forecast
          Devices.ValueUpdate(iDeviceId, 1, Format(CStr(sCelsius), "0.#"), Devices.ValueType_Temperature)
        Else
          ' temp °F, hum %, baro hPa, forecast
          Devices.ValueUpdate(iDeviceId, 1, Format(CStr(sCelsius * 1.8 + 32), ".##"), Devices.ValueType_Temperature)
        Endif
        Devices.ValueUpdate(iDeviceId, 2, Right(Hex(((Lsl(RecBuf[7], 4)) And &HF0) + ((Lsr(RecBuf[6], 4)) And &HF)), 2), Devices.ValueType_Humidity)
        Devices.ValueUpdate(iDeviceId, 3, CStr(CSingle(RecBuf[8]) + 856))
        Devices.ValueUpdate(iDeviceId, 4, sForecast)
        Devices.Battery(iDeviceId, sBatt)
      Endif
    Endif

  ' RAIN1 Oregon RGR126,RGR682,RGR918
  Else If RecBuf[0] = &H2A And RecBuf[1] = &H1D And bRecBits >= 80 Then
    bOregon = True
    If $bDebug Then
      Main.WriteDebugLogChars(" RAIN1[" & CStr(RecBuf[3] * 256) & "] RGR126/682/918", True)
      Main.WriteDebugLogChars(" addr:" & Hex(RecBuf[3], 2), 1)
    Endif
    sTrainRate = (CSingle(Hex(RecBuf[5])) * 10 + CSingle(Hex((Lsr(RecBuf[4], 4)) And &HF)))
    If $bDebug Then Main.WriteDebugLogChars(" rain fall " & CStr(sTrainRate) & " mm/hr", True)
    sTrain = (CSingle(Hex(RecBuf[8] And &HF)) * 1000 + CSingle(Hex(RecBuf[7])) * 10 + CSingle(Hex(Lsr(RecBuf[6], 4))))
    If $bDebug Then
      Main.WriteDebugLogChars(" total rain cnt " & CStr(sTrain) & " mm", True)
      Main.WriteDebugLogChars(" flip cnt " & Hex(RecBuf[6] And &HF), True)
    Endif
    sBatt = BatteryIndication()
    If Checksum2() Then
      ' find device id
      iDeviceId = Devices.Find(Instance, "RAIN1[" & CStr(RecBuf[3] * 256) & "]", InterfaceId, "RAIN1")
      ' update values & battery status
      If iDeviceId Then
        ' rain rate mm/hr, total rain mm, flip count
        Devices.ValueUpdate(iDeviceId, 1, Format(CStr(sTrainRate), "0.#"))
        Devices.ValueUpdate(iDeviceId, 2, Format(CStr(sTrain), "0.##"))
        Devices.ValueUpdate(iDeviceId, 3, Hex(RecBuf[6] And &HF))
        Devices.Battery(iDeviceId, sBatt)
      Endif
    Endif

  ' RAIN2 Oregon PCR800
  Else If RecBuf[0] = &H2A And RecBuf[1] = &H19 And bRecBits >= 84 Then
    bOregon = True
    If $bDebug Then
      Main.WriteDebugLogChars(" RAIN2[" & CStr(RecBuf[3] * 256) & "] PCR800", True)
      Main.WriteDebugLogChars(" addr:" & Hex(RecBuf[3], 2), True)
    Endif
    sTrainRate = (CSingle(Hex(RecBuf[5])) / 10) + (CSingle(Hex((Lsr(RecBuf[4], 4)) And &HF)) / 100) + (CSingle(Hex((RecBuf[6] And &HF))) / 1000)
    If $bDebug Then Main.WriteDebugLogChars(" rain fall rate: " & Format(CStr(sTrainRate), "0.00") & " inch/hr | " & Format(CStr(sTrainRate * 25.4), "0.00") & " mm/hr", True)
    sTrain = (CSingle(Hex(RecBuf[7]))) / 100 + CSingle(Hex(Lsr(RecBuf[6], 4)) / 1000) + (CSingle(Hex(RecBuf[9] And &HF)) * 100 + CSingle(Hex(RecBuf[8])))
    If $bDebug Then Main.WriteDebugLogChars(" total rain cnt: " & Format(CStr(sTrain), "0.00") & " inch | " & Format(CStr(sTrain * 25.4), "0.00") & " mm", True)
    sBatt = BatteryIndication()
    If ChecksumR() Then
      ' find device id
      iDeviceId = Devices.Find(Instance, "RAIN2[" & CStr(RecBuf[3] * 256) & "]", InterfaceId, "RAIN2")
      ' update values & battery status
      If iDeviceId Then
        If Main.sTemperature = "°C" Then
          ' rain rate mm/hr, total rain mm
          Devices.ValueUpdate(iDeviceId, 1, Format(CStr(sTrainRate * 25.4), "0.00"))
          Devices.ValueUpdate(iDeviceId, 2, Format(CStr(sTrain * 25.4), "0.00"))
        Else
          ' rain rate inch/hr, total rain inch
          Devices.ValueUpdate(iDeviceId, 1, Format(CStr(sTrainRate), "0.00"))
          Devices.ValueUpdate(iDeviceId, 2, Format(CStr(sTrain), "0.00"))
        Endif
        Devices.Battery(iDeviceId, sBatt)
      Endif
    Endif

  ' WIND1 Oregon WTGR800
  Else If RecBuf[0] = &H1A And RecBuf[1] = &H99 And bRecBits >= 80 Then
    bOregon = True
    If $bDebug Then
      Main.WriteDebugLogChars(" WIND1[" & CStr(RecBuf[3] * 256) & "] WTGR800", True)
      Main.WriteDebugLogChars(" addr:" & Hex(RecBuf[3], 2), 1)
    Endif
    iDirection = CSingle(Lsr(RecBuf[4], 4)) * 22.5
    If $bDebug Then Main.WriteDebugLogChars(" direction " & CStr(iDirection) & "°", True)
    sWrDirection = WrDirection(iDirection)
    sSpeed = (CSingle(Hex(RecBuf[7] And &HF)) * 10) + (CSingle(Hex(RecBuf[6])) / 10)
    sWrSpeed = WrSpeed(sSpeed)
    sSpeed = CSingle(Hex(RecBuf[8])) + (CSingle(Hex((Lsr(RecBuf[7], 4)) And &HF)) / 10)
    If $bDebug Then Main.WriteDebugLogChars(" av.", True)
    sWrAvgSpeed = WrSpeed(sSpeed)
    sBatt = BatteryIndication()
    If Checksum9() Then
      ' find device id
      iDeviceId = Devices.Find(Instance, "WIND1[" & CStr(RecBuf[3] * 256) & "]", InterfaceId, "WIND1")
      ' update values & battery status
      If iDeviceId Then
        ' direction °, direction text, speed m/s, avg speed m/s
        Devices.ValueUpdate(iDeviceId, 1, CStr(iDirection))
        Devices.ValueUpdate(iDeviceId, 2, sWrDirection)
        Devices.ValueUpdate(iDeviceId, 3, Format(CStr(sWrSpeed), "0.##"))
        Devices.ValueUpdate(iDeviceId, 4, Format(CStr(sWrAvgSpeed), "0.##"))
        Devices.Battery(iDeviceId, sBatt)
      Endif
    Endif

  ' WIND2 Oregon WGR800
  Else If RecBuf[0] = &H1A And RecBuf[1] = &H89 And bRecBits >= 80 Then
    bOregon = True
    If $bDebug Then
      Main.WriteDebugLogChars(" WIND2[" & CStr(RecBuf[3] * 256) & "] WGR800", True)
      Main.WriteDebugLogChars(" addr:" & Hex(RecBuf[3], 2), True)
    Endif
    iDirection = CSingle(Lsr(RecBuf[4], 4)) * 22.5
    If $bDebug Then Main.WriteDebugLogChars(" direction " & CStr(iDirection) & "°", True)
    sWrDirection = WrDirection(iDirection)
    sSpeed = (CSingle(Hex(RecBuf[7] And &HF)) * 10) + (CSingle(Hex(RecBuf[6])) / 10)
    sWrSpeed = WrSpeed(sSpeed)
    sSpeed = CSingle(Hex(RecBuf[8])) + (CSingle(Hex((Lsr(RecBuf[7], 4)) And &HF)) / 10)
    If $bDebug Then Main.WriteDebugLogChars(" av.", 1)
    sWrAvgSpeed = WrSpeed(sSpeed)
    sBatt = BatteryIndication()
    If Checksum9() Then
      ' find device id
      iDeviceId = Devices.Find(Instance, "WIND2[" & CStr(RecBuf[3] * 256) & "]", InterfaceId, "WIND2")
      ' update values & battery status
      If iDeviceId Then
        ' direction °, direction text, speed m/s, avg speed m/s
        Devices.ValueUpdate(iDeviceId, 1, CStr(iDirection))
        Devices.ValueUpdate(iDeviceId, 2, sWrDirection)
        Devices.ValueUpdate(iDeviceId, 3, Format(CStr(sWrSpeed), "0.##"))
        Devices.ValueUpdate(iDeviceId, 4, Format(CStr(sWrAvgSpeed), "0.##"))
        Devices.Battery(iDeviceId, sBatt)
      Endif
    Endif

  ' WIND3 Oregon STR918,WGR918
  Else If RecBuf[0] = &H3A And RecBuf[1] = &HD And bRecBits >= 80 Then
    bOregon = True
    If $bDebug Then
      Main.WriteDebugLogChars(" WIND3[" & CStr(RecBuf[3] * 256) & "] STR918,WGR918", True)
      Main.WriteDebugLogChars(" addr:" & Hex(RecBuf[3], 2), True)
    Endif
    iDirection = (CSingle(Hex(RecBuf[5])) * 10) + CSingle(Hex(Lsr(RecBuf[4], 4)))
    If $bDebug Then Main.WriteDebugLogChars(" direction " & CStr(iDirection) & "°", True)
    sWrDirection = WrDirection(iDirection)
    sSpeed = (CSingle(Hex(RecBuf[7] And &HF)) * 10) + (CSingle(Hex(RecBuf[6])) / 10)
    sWrSpeed = WrSpeed(sSpeed)
    sSpeed = CSingle(Hex(RecBuf[8])) + (CSingle(Hex((Lsr(RecBuf[7], 4)) And &HF)) / 10)
    If $bDebug Then Main.WriteDebugLogChars(" av.", True)
    sWrAvgSpeed = WrSpeed(sSpeed)
    sBatt = WrBattery()
    If Checksum9() Then
      ' find device id
      iDeviceId = Devices.Find(Instance, "WIND3[" & CStr(RecBuf[3] * 256) & "]", InterfaceId, "WIND3")
      ' update values & battery status
      If iDeviceId Then
        ' direction °, direction text, speed m/s, avg speed m/s
        Devices.ValueUpdate(iDeviceId, 1, CStr(iDirection))
        Devices.ValueUpdate(iDeviceId, 2, sWrDirection)
        Devices.ValueUpdate(iDeviceId, 3, Format(CStr(sWrSpeed), "0.##"))
        Devices.ValueUpdate(iDeviceId, 4, Format(CStr(sWrAvgSpeed), "0.##"))
        Devices.Battery(iDeviceId, sBatt)
      Endif
    Endif

  ' UV1 Oregon UVR138,UV138
  Else If RecBuf[0] = &HEA And RecBuf[1] = &H7C And bRecBits >= 60 Then
    bOregon = True
    If $bDebug Then
      Main.WriteDebugLogChars(" UV1[" & CStr(RecBuf[3] * 256) & "] UVN128,UV138 ", True)
      Main.WriteDebugLogChars(" addr:" & Hex(RecBuf[3], 2), True)
    Endif
    sUv = CSingle(Hex(RecBuf[5] And &HF)) * 10 + CSingle(Hex(Lsr(RecBuf[4], 4)))
    If $bDebug Then Main.WriteDebugLogChars(" UV factor:" & CStr(sUv) & " Level:", True)
    If sUv < 3 Then
      sUvText = ("Low")
    Else If sUv < 6 Then
      sUvText = ("Medium")
    Else If sUv < 8 Then
      sUvText = ("High")
    Else If sUv < 11 Then
      sUvText = ("Very high")
    Else
      sUvText = ("Dangerous")
    Endif
    If $bDebug Then Main.WriteDebugLogChars(" " & sUVText & " ", True)
    sBatt = BatteryIndication()
    If ChecksumW() Then
      ' find device id
      iDeviceId = Devices.Find(Instance, "UV1[" & CStr(RecBuf[3] * 256) & "]", InterfaceId, "UV1")
      ' update values & battery status
      If iDeviceId Then
        ' uv level, uv text
        Devices.ValueUpdate(iDeviceId, 1, CStr(sUv), Devices.ValueType_UV)
        Devices.ValueUpdate(iDeviceId, 2, sUvText)
        Devices.Battery(iDeviceId, sBatt)
      Endif
    Endif

  ' UV2 Oregon UVN800
  Else If RecBuf[0] = &HDA And RecBuf[1] = &H78 And bRecBits >= 64 Then
    bOregon = True
    If $bDebug Then
      Main.WriteDebugLogChars(" UV2[" & CStr(RecBuf[3] * 256) & "] UVN800", True)
      Main.WriteDebugLogChars(" addr:" & Hex(RecBuf[3], 2), True)
    Endif
    sUv = CSingle(Lsr(RecBuf[4], 4))
    If $bDebug Then Main.WriteDebugLogChars(" UV factor:" & CStr(sUv) & " Level:", True)
    If sUv < 3 Then
      sUvText = ("Low")
    Else If sUv < 6 Then
      sUvText = ("Medium")
    Else If sUv < 8 Then
      sUvText = ("High")
    Else If sUv < 11 Then
      sUvText = ("Very high")
    Else
      sUvText = ("Dangerous")
    Endif
    If $bDebug Then Main.WriteDebugLogChars(" " & sUVText & " ", True)
    sBatt = BatteryIndication()
    If Checksum7() Then
      ' find device id
      iDeviceId = Devices.Find(Instance, "UV2[" & CStr(RecBuf[3] * 256) & "]", InterfaceId, "UV2")
      ' update values & battery status
      If iDeviceId Then
        ' uv level, uv text
        Devices.ValueUpdate(iDeviceId, 1, CStr(sUv), Devices.ValueType_UV)
        Devices.ValueUpdate(iDeviceId, 2, sUvText)
        Devices.Battery(iDeviceId, sBatt)
      Endif
    Endif

  ' DT1 Oregon RTGR328 Date and Time
  Else If (RecBuf[0] And &HF) = &HA And RecBuf[1] = &HEC And bRecBits >= 96 Then
    bOregon = True
    If $bDebug Then
      Main.WriteDebugLogChars(" DT1[" & CStr(RecBuf[3] * 256 + (Lsr(RecBuf[2], 4))) & "] RTGR328 Date and Time", 1)
      WrChannel3()
      Main.WriteDebugLogChars(" addr:" & Hex(RecBuf[3], 2), True)
    Endif
    Hr = Right("0" & CStr(CSingle(RecBuf[7] And &HF) * 10 + CSingle(Lsr(RecBuf[6], 4))), 2)
    Mn = Right("0" & CStr(CSingle(RecBuf[6] And &HF) * 10 + CSingle(Lsr(RecBuf[5], 4))), 2)
    Sc = Right("0" & CStr(CSingle(RecBuf[5] And &HF) * 10 + CSingle(Lsr(RecBuf[4], 4))), 2)
    If $bDebug Then Main.WriteDebugLogChars(" time=" & CStr(Hr) & ":" & CStr(Mn) & ":" & CStr(Sc), True)
    Select Case RecBuf[9] And &H7
      Case 0
        sDay = ("Sunday")
      Case 1
        sDay = ("Monday")
      Case 2
        sDay = ("Tuesday")
      Case 3
        sDay = ("Wednesday")
      Case 4
        sDay = ("Thursday")
      Case 5
        sDay = ("Friday")
      Case 6
        sDay = ("Saterday")
      Case Else
        sDay = ("day error")
    End Select
    If $bDebug Then Main.WriteDebugLogChars(" " & sDay, True)
    sDd = CSingle(RecBuf[8] And &HF) * 10 + CSingle(Lsr(RecBuf[7], 4))
    sMm = CSingle(Lsr(RecBuf[8], 4))
    sYy = CSingle(RecBuf[10] And &HF) * 10 + CSingle(Lsr(RecBuf[9], 4)) + 2000
    If $bDebug Then Main.WriteDebugLogChars(" " & sDd & "-" & sMm & "-" & sYy, True)
    If Checksum11() Then
      iDeviceId = Devices.Find(Instance, "DT1[" & CStr(RecBuf[3] * 256 + (Lsr(RecBuf[2], 4))) & "]", InterfaceId, "DT1")
      If iDeviceId Then
        ' hour:min:sec, date, weekday
        Devices.ValueUpdate(iDeviceId, 1, CStr(Hr) & ":" & CStr(Mn) & ":" & CStr(Sc))
        Devices.ValueUpdate(iDeviceId, 2, sDd & "-" & sMm & "-" & sYy)
        Devices.ValueUpdate(iDeviceId, 3, sDay)
      Endif
    Endif

  ' WEIGHT1 Oregon BWR101,BWR102
  Else If bRecBits = 56 Then
    bOregon = True
    If $bDebug Then Main.WriteDebugLogChars(" WEIGHT1[" & CStr(Lsr(RecBuf[1], 4)) & "] BWR101,BWR102", True)
    If IsDigit(Hex(RecBuf[4])) And If IsDigit(Hex(Lsr(RecBuf[3], 4))) Then
      If $bDebug Then Main.WriteDebugLogChars(" addr:" & Hex(Lsr(RecBuf[1], 4)), True)
      Try sWeight = CSingle(Hex(RecBuf[5] And &H1)) * 100 + CSingle(Hex(RecBuf[4])) + CSingle(Hex(Lsr(RecBuf[3], 4))) / 10
      If Not Error
        sLb = sWeight * 2.2
        sStlb = Round(sLb / 14)
        sStlbr = sLb - sStlb * 14
        If $bDebug Then
          Main.WriteDebugLogChars(" Weight: " & Format(CStr(sWeight), "0.#") & " kg | " & Format(CStr(sLb), "0.#") & " lb | " & CStr(sStlb) & ": " & Format(CStr(sStlbr), "0.#") & " st-lb", True)
          Main.WriteDebugLogChars(" Unknown byte=" & CStr(Hex(RecBuf[3] And &HF)) & CStr(Hex(Lsr(RecBuf[2], 4))), True)
        Endif
        If Not (((RecBuf[0] And &HF0) = (RecBuf[5] And &HF0)) And ((RecBuf[1] And &HF) = (RecBuf[6] And &HF))) Then
          If $bDebug Then Main.WriteDebugLogChars(" Checksum error", True)
        Else If Lsr(RecBuf[1], 4)
          ' find device id
          iDeviceId = Devices.Find(Instance, "WEIGHT1[" & CStr(Lsr(RecBuf[1], 4)) & "]", InterfaceId, "WEIGHT1")
          ' update values
          If iDeviceId Then
            If Main.sTemperature = "°C" Then
              ' weigth in kg
              Devices.ValueUpdate(iDeviceId, 1, Format(CStr(sWeight), "0.#"), Devices.ValueType_Weight)
            Else
              ' weight in lb
              Devices.ValueUpdate(iDeviceId, 1, Format(CStr(sLb), "0.#"), Devices.ValueType_Weight)
            Endif
          Endif
        Endif
      Endif
    Else
      If $bDebug Then Main.WriteDebugLogChars(" ERROR: weight value is not a decimal value.", True)
    Endif

  ' WEIGHT2 Oregon GR101
  Else If (RecBuf[0] And &HF) = &H3 And bRecBits = 64 Then
    bOregon = True
    If $bDebug Then
      Main.WriteDebugLogChars(" WEIGHT2[" & CStr(Lsr(RecBuf[1], 4)) & "] GR101 ", True)
      For iCnt = 7 To 0 Step -1
        If $bDebug Then Main.WriteDebugLogChars(Format(CStr(RecBuf[iCnt]), "0.#"), True)
      Next
    Endif
    sWeight = ((RecBuf[4] And &HF) * 4096) + (RecBuf[3] * 16) + (Lsr(RecBuf[2], 4))
    If $bDebug Then Main.WriteDebugLogChars(" Weight: " & CStr(sWeight) & " = " & Format(CStr(sWeight / 400.8), "0.#") & " kg", True)
    ' find device id
    iDeviceId = Devices.Find(Instance, "WEIGHT2[" & CStr(Lsr(RecBuf[1], 4)) & "]", InterfaceId, "WEIGHT2")
    ' update values
    If iDeviceId Then
      If Main.sTemperature = "°C" Then
        ' weigth in kg
        Devices.ValueUpdate(iDeviceId, 1, Format(CStr(sWeight / 400.8), "0.#"), Devices.ValueType_Weight)
      Else
        ' weight in lb
        Devices.ValueUpdate(iDeviceId, 1, Format(CStr(sWeight), "0.#"), Devices.ValueType_Weight)
      Endif
    Endif

  ' ELEC1 cent-a-meter
  Else If (RecBuf[0] = &HEA And (RecBuf[1] And &HC0) = &H0) And bRecBits >= 64 Then
    bOregon = True
    If $bDebug Then
      Main.WriteDebugLogChars(" ELEC1[" & CStr(RecBuf[2] * 256) & "] Cent-a-Meter", True)
      Main.WriteDebugLogChars(" addr:" & Hex(RecBuf[2], 2), True)
      Main.WriteDebugLogChars(" counter:" & CSingle(RecBuf[1] And &HF), True)
    Endif
    sCt1 = (CSingle(RecBuf[3]) + CSingle((RecBuf[4] And &H3) * 256)) / 10
    sCt2 = (CSingle((Lsr(RecBuf[4], 2)) And &H3F) + CSingle((RecBuf[5] And &HF) * 64)) / 10
    sCt3 = (CSingle((Lsr(RecBuf[5], 4)) And &HF) + CSingle((RecBuf[6] And &H3F) * 16)) / 10
    If $bDebug Then
      Main.WriteDebugLogChars(" CT1:" & CStr(sCt1) & " Ampere", True)
      Main.WriteDebugLogChars(" CT2:" & CStr(sCt2) & " Ampere", True)
      Main.WriteDebugLogChars(" CT3:" & CStr(sCt3) & " Ampere", True)
    Endif
    If (RecBuf[1] And &H10) = 0 Then
      If $bDebug Then Main.WriteDebugLogChars((" Battery OK"), True)
      sBatt = "OK"
    Else
      If $bDebug Then Main.WriteDebugLogChars((" Battery Empty"), True)
      sBatt = "Empty"
    Endif
    If (RecBuf[4] And &H40) = &H40 Then
      If $bDebug Then Main.WriteDebugLogChars((" Check pressed"), True)
    Endif
    If ChecksumE() Then
      ' find device id
      iDeviceId = Devices.Find(Instance, "ELEC1[" & CStr(RecBuf[2] * 256) & "]", InterfaceId, "ELEC1")
      ' update values & battery status
      If iDeviceId Then
        ' ct1 amp, ct2 amp, ct3 amp
        Devices.ValueUpdate(iDeviceId, 1, Format(CStr(sCt1), ".###"))
        Devices.ValueUpdate(iDeviceId, 2, Format(CStr(sCt2), ".###"))
        Devices.ValueUpdate(iDeviceId, 3, Format(CStr(sCt3), ".###"))
        Devices.Battery(iDeviceId, sBatt)
      Endif
    Endif

  ' ELEC2 OWL CM119
  Else If (RecBuf[0] = &H1A Or RecBuf[0] = &H2A Or RecBuf[0] = &H3A) And bRecBits = 108 Then
    bOregon = True
    If $bDebug Then
      Main.WriteDebugLogChars(" ELEC2[" & CStr(RecBuf[2] * 256) & "] OWL CM119", True)
      Select Case (RecBuf[0] And &HF0)
        Case &H10
          Main.WriteDebugLogChars(" CH 1", 1)
        Case &H20
          Main.WriteDebugLogChars(" CH 2", 1)
        Case &H30
          Main.WriteDebugLogChars(" CH 3", 1)
        Case Else
          Main.WriteDebugLogChars(" CH ? = " & Hex(Lsr(RecBuf[0], 4) And &HF), True)
      End Select
      Main.WriteDebugLogChars(" addr:" & Hex(RecBuf[2], 2), True)
      Main.WriteDebugLogChars(" counter:" & CSingle(RecBuf[1] And &HF), True)
    Endif
    sCt1 = CSingle((RecBuf[5] And &HF) * 65536) + CSingle(RecBuf[4] * 256) + CSingle(RecBuf[3])
    lCt4 = Lsl(CLong(RecBuf[10]), 36)
    lCt4 += Lsl(CLong(RecBuf[9]), 28)
    lCt4 += Lsl(CLong(RecBuf[8]), 20)
    lCt4 += Lsl(CLong(RecBuf[7]), 12)
    lCt4 += Lsl(CLong(RecBuf[6]), 4)
    lCt4 += (Lsr(CLong(RecBuf[5]), 4) And &HF)
    lCt4 = lCt4 / 223000

    If $bDebug Then
      Main.WriteDebugLogChars(" Now:" & CStr(sCt1 / 1000) & "kW", True)
      Main.WriteDebugLogChars(" Total:" & Format(lCt4, ".###") & "kWh", True)
    Endif
    If Checksum12() Then
      ' find device id
      iDeviceId = Devices.Find(Instance, "ELEC2[" & CStr(RecBuf[2] * 256) & "]", InterfaceId, "OWL CM119")
      ' update values & battery status
      If iDeviceId Then
        ' power usage total in kWh and now in Watt
        Devices.ValueUpdate(iDeviceId, 1, Format(lCt4, ".###"))
        Devices.ValueUpdate(iDeviceId, 2, CStr(sCt1))
      Endif
    Endif
  Endif
  Return bOregon

Catch
  Main.WriteDebugLog(LogLabel & "ERROR: Parsing Oregon data packet: " & DisplayPacket(RecBuf) & " '" & Error.Text & "' at '" & Error.Where & "'")

End

Private Sub DisplayPacket(bBuf As Byte[]) As String

  Dim sMsg As String
  Dim iCnt As Integer

  For iCnt = 0 To bBuf.Max
    sMsg &= Hex(bBuf[iCnt], 2)
  Next
  Return sMsg

Catch
  Main.WriteDebugLog(LogLabel & "ERROR: Display data packet: '" & Error.Text & "' at '" & Error.Where & "'")

End

Private Sub WrChannel3()

  Main.WriteDebugLogChars(" CH " & (Lsr(RecBuf[2], 4)), True)

End

Private Sub WrChannel()

  Dim sChan As String
  Dim sVal As Integer

  Select Case (RecBuf[2] And &H70)
    Case &H10
      sChan = "CH 1"
      sVal = 1
    Case &H20
      sChan = "CH 2"
      sVal = 2
    Case &H40
      sChan = "CH 3"
      sVal = 4
    Case Else
      sChan = "CH ? = " & Hex(RecBuf[2], 2)
      sVal = 0
  End Select
  Main.WriteDebugLogChars(" " & sChan, True)

End

Private Sub WrHum(Hum As Byte) As String

  Dim sVerbose As String

  Select Case Hum
    Case &H0
      sVerbose = ("Normal")
    Case &H40
      sVerbose = ("Comfort")
    Case &H80
      sVerbose = ("Dry")
    Case &HC0
      sVerbose = ("Wet")
  End Select
  If $bDebug Then Main.WriteDebugLogChars(" " & sVerbose, True)
  Return sVerbose

End

Private Sub WrForecast(bForecast As Byte) As String

  Dim sMsg As String

  Select Case bForecast
    Case &HC
      sMsg = ("Sunny")
    Case &H6
      sMsg = ("Partly")
    Case &H2
      sMsg = ("Cloudy")
    Case &H3
      sMsg = ("Rain")
    Case Else
      sMsg = "??"
  End Select
  If $bDebug Then Main.WriteDebugLogChars(" " & sMsg & " ", True)
  Return sMsg

End

Private Sub WrDirection(iDirection As Integer) As String

  Dim sDir As String

  If iDirection > 348.75 Or iDirection < 11.26 Then
    sDir = "N"
  Else If iDirection < 33.76 Then
    sDir = "NNE"
  Else If iDirection < 56.26 Then
    sDir = "NE"
  Else If iDirection < 78.76 Then
    sDir = "ENE"
  Else If iDirection < 101.26 Then
    sDir = "E"
  Else If iDirection < 123.76 Then
    sDir = "ESE"
  Else If iDirection < 146.26 Then
    sDir = "SE"
  Else If iDirection < 168.76 Then
    sDir = "SSE"
  Else If iDirection < 191.26 Then
    sDir = "S"
  Else If iDirection < 213.76 Then
    sDir = "SSW"
  Else If iDirection < 236.26 Then
    sDir = "SW"
  Else If iDirection < 258.76 Then
    sDir = "WSW"
  Else If iDirection < 281.26 Then
    sDir = "W"
  Else If iDirection < 303.76 Then
    sDir = "WNW"
  Else If iDirection < 326.26 Then
    sDir = "NW"
  Else
    sDir = "NNW"
  Endif
  If $bDebug Then Main.WriteDebugLogChars(" " & sDir & " ", True)
  Return sDir

End

Private Sub WrSpeed(sSpeed As Single) As String

  Dim sSpd As String

  If $bDebug Then
    Main.WriteDebugLogChars(" speed " & CStr(sSpeed) & " m/sec", True)
    If sSpeed < 0.2 Then
      sSpd = "0"
    Else If sSpeed < 1.6 Then
      sSpd = "1"
    Else If sSpeed < 3.4 Then
      sSpd = "2"
    Else If sSpeed < 5.5 Then
      sSpd = "3"
    Else If sSpeed < 8 Then
      sSpd = "4"
    Else If sSpeed < 10.8 Then
      sSpd = "5"
    Else If sSpeed < 13.9 Then
      sSpd = "6"
    Else If sSpeed < 17.2 Then
      sSpd = "7"
    Else If sSpeed < 20.8 Then
      sSpd = "8"
    Else If sSpeed < 25.4 Then
      sSpd = "9"
    Else If sSpeed < 28.5 Then
      sSpd = "10"
    Else If sSpeed < 32.7 Then
      sSpd = "11"
    Else
      sSpd = "12"
    Endif
    Main.WriteDebugLogChars(" " & sSpd & " Bft ", True)
  Endif
  Return CStr(sSpeed)

End

Private Sub WrBattery() As String

  Dim sMsg As String

  Select Case (RecBuf[4] And &HF)
    Case 0
      sMsg = "100%"
    Case 1
      sMsg = "90%"
    Case 2
      sMsg = "80%"
    Case 3
      sMsg = "70%"
    Case 4
      sMsg = "60%"
    Case 5
      sMsg = "50%"
    Case 6
      sMsg = "40%"
    Case 7
      sMsg = "30%"
    Case 8
      sMsg = "20%"
    Case 9
      sMsg = "10%"
  End Select
  If $bDebug Then Main.WriteDebugLogChars((" Battery ") & sMsg, True)
  Return sMsg

End

Private Sub Checksum2() As Boolean

  Dim Checksum As Short

  Checksum = Cs8()
  Checksum += RecBuf[8] And &HF
  Checksum = (Checksum - ((Lsr(RecBuf[8], 4) And &HF) + ((Lsl(RecBuf[9], 4)) And &HF0))) And &HFF
  If Checksum <> 0 Then
    If $bDebug Then Main.WriteDebugLogChars((" Checksum Error"), True)
    Return False
  Else
    Return True
  Endif

End

Private Sub Checksum7() As Boolean

  Dim Checksum As Short

  Checksum = (Lsr(RecBuf[0], 4) And &HF) '+ (RecBuf[0] AND &HF)
  Checksum += (Lsr(RecBuf[1], 4) And &HF) + (RecBuf[1] And &HF)
  Checksum += (Lsr(RecBuf[2], 4) And &HF) + (RecBuf[2] And &HF)
  Checksum += (Lsr(RecBuf[3], 4) And &HF) + (RecBuf[3] And &HF)
  Checksum += (Lsr(RecBuf[4], 4) And &HF) + (RecBuf[4] And &HF)
  Checksum += (Lsr(RecBuf[5], 4) And &HF) + (RecBuf[5] And &HF)
  Checksum += (Lsr(RecBuf[6], 4) And &HF) + (RecBuf[6] And &HF)
  Checksum = (Checksum - RecBuf[7]) And &HFF
  If Checksum <> 0 Then
    If $bDebug Then Main.WriteDebugLogChars((" Checksum Error"), True)
    Return False
  Else
    Return True
  Endif

End

Private Sub Checksum8() As Boolean

  Dim Checksum As Short

  Checksum = Cs8()
  Checksum = (Checksum - RecBuf[8]) And &HFF
  If Checksum <> 0 Then
    If $bDebug Then Main.WriteDebugLogChars((" Checksum Error"), True)
    Return False
  Else
    Return True
  Endif

End

Private Sub ChecksumW() As Boolean

  Dim Checksum As Short

  Checksum = (Lsr(RecBuf[0], 4) And &HF) '+ (RecBuf[0] AND &HF)
  Checksum += (Lsr(RecBuf[1], 4) And &HF) + (RecBuf[1] And &HF)
  Checksum += (Lsr(RecBuf[2], 4) And &HF) + (RecBuf[2] And &HF)
  Checksum += (Lsr(RecBuf[3], 4) And &HF) + (RecBuf[3] And &HF)
  Checksum += (Lsr(RecBuf[4], 4) And &HF) + (RecBuf[4] And &HF)
  Checksum += (Lsr(RecBuf[5], 4) And &HF) + (RecBuf[5] And &HF)
  Checksum += (RecBuf[6] And &HF)
  Checksum = (Checksum - ((Lsr(RecBuf[6], 4) And &HF) + (Lsl(RecBuf[7], 4) And &HF0))) And &HFF
  If Checksum <> 0 Then
    If $bDebug Then Main.WriteDebugLogChars((" Checksum Error"), True)
    Return False
  Else
    Return True
  Endif

End

Private Sub Checksum9() As Boolean

  Dim Checksum As Short

  Checksum = Cs8()
  Checksum += (Lsr(RecBuf[8], 4) And &HF) + (RecBuf[8] And &HF)
  Checksum = (Checksum - RecBuf[9]) And &HFF
  If Checksum <> 0 Then
    If $bDebug Then Main.WriteDebugLogChars((" Checksum Error"), True)
    Return False
  Else
    Return True
  Endif

End

Private Sub Checksum10() As Boolean

  Dim Checksum As Short

  Checksum = Cs8()
  Checksum += (Lsr(RecBuf[8], 4) And &HF) + (RecBuf[8] And &HF)
  Checksum += (Lsr(RecBuf[9], 4) And &HF) + (RecBuf[9] And &HF)
  Checksum = (Checksum - RecBuf[10]) And &HFF
  If Checksum <> 0 Then
    If $bDebug Then Main.WriteDebugLogChars((" Checksum Error"), True)
    Return False
  Else
    Return True
  Endif

End

Private Sub Checksum11() As Boolean

  Dim Checksum As Short

  Checksum = Cs8()
  Checksum += (Lsr(RecBuf[8], 4) And &HF) + (RecBuf[8] And &HF)
  Checksum += (Lsr(RecBuf[9], 4) And &HF) + (RecBuf[9] And &HF)
  Checksum += (Lsr(RecBuf[10], 4) And &HF) + (RecBuf[10] And &HF)
  Checksum = (Checksum - RecBuf[11]) And &HFF
  If Checksum <> 0 Then
    If $bDebug Then Main.WriteDebugLogChars((" Checksum Error"), True)
    Return False
  Else
    Return True
  Endif

End

Private Sub Checksum12() As Boolean

  Dim Checksum As Short

  Checksum = (Lsr(RecBuf[1], 4) And &HF) + (RecBuf[1] And &HF)
  Checksum += (Lsr(RecBuf[2], 4) And &HF) + (RecBuf[2] And &HF)
  Checksum += (Lsr(RecBuf[3], 4) And &HF) + (RecBuf[3] And &HF)
  Checksum += (Lsr(RecBuf[4], 4) And &HF) + (RecBuf[4] And &HF)
  Checksum += (Lsr(RecBuf[5], 4) And &HF) + (RecBuf[5] And &HF)
  Checksum += (Lsr(RecBuf[6], 4) And &HF) + (RecBuf[6] And &HF)
  Checksum += (Lsr(RecBuf[7], 4) And &HF) + (RecBuf[7] And &HF)
  Checksum += (Lsr(RecBuf[8], 4) And &HF) + (RecBuf[8] And &HF)
  Checksum += (Lsr(RecBuf[9], 4) And &HF) + (RecBuf[9] And &HF)
  Checksum += (Lsr(RecBuf[10], 4) And &HF) + (RecBuf[10] And &HF)
  Checksum += (RecBuf[11] And &HF)
  Checksum = (Checksum - (Lsl((RecBuf[12] And &HF), 4)) - (Lsr(RecBuf[11], 4) And &HF)) And &HFF
  If Checksum <> 0 Then
    If $bDebug Then Main.WriteDebugLogChars((" Checksum Error"), True)
    Return False
  Else
    Return True
  Endif

End

Private Sub ChecksumE() As Boolean

  Dim Checksum As Short

  CheckSum = (Lsr(RecBuf[0], 4) And &HF) + (RecBuf[0] And &HF)
  CheckSum += (Lsr(RecBuf[1], 4) And &HF) + (RecBuf[1] And &HF)
  CheckSum += (Lsr(RecBuf[2], 4) And &HF) + (RecBuf[2] And &HF)
  CheckSum += (Lsr(RecBuf[3], 4) And &HF) + (RecBuf[3] And &HF)
  CheckSum += (Lsr(RecBuf[4], 4) And &HF) + (RecBuf[4] And &HF)
  CheckSum += (Lsr(RecBuf[5], 4) And &HF) + (RecBuf[5] And &HF)
  CheckSum += (Lsr(RecBuf[6], 4) And &HF) + (RecBuf[6] And &HF)
  CheckSum = (CheckSum - RecBuf[7]) And &HFF
  If Checksum <> &H18 Then
    If $bDebug Then Main.WriteDebugLogChars((" Checksum Error"), True)
    Return False
  Else
    Return True
  Endif

End

Private Sub ChecksumR() As Boolean

  Dim Checksum As Byte

  Checksum = Cs8()
  Checksum += (Lsr(RecBuf[8], 4) And &HF) + (RecBuf[8] And &HF)
  Checksum += (RecBuf[9] And &HF)
  Checksum = (Checksum - ((Lsr(RecBuf[9], 4) And &HF) + (Lsl(RecBuf[10], 4) And &HF0))) And &HFF
  If Checksum <> 0 Then
    If $bDebug Then Main.WriteDebugLogChars((" Checksum Error"), True)
    Return False
  Else
    Return True
  Endif

End

Private Function Cs8() As Byte

  Dim CheckSum As Byte

  CheckSum = (Lsr(RecBuf[0], 4) And &HF) ' + (RecBuf[0] AND &HF)
  CheckSum += (Lsr(RecBuf[1], 4) And &HF) + (RecBuf[1] And &HF)
  CheckSum += (Lsr(RecBuf[2], 4) And &HF) + (RecBuf[2] And &HF)
  CheckSum += (Lsr(RecBuf[3], 4) And &HF) + (RecBuf[3] And &HF)
  CheckSum += (Lsr(RecBuf[4], 4) And &HF) + (RecBuf[4] And &HF)
  CheckSum += (Lsr(RecBuf[5], 4) And &HF) + (RecBuf[5] And &HF)
  CheckSum += (Lsr(RecBuf[6], 4) And &HF) + (RecBuf[6] And &HF)
  CheckSum += (Lsr(RecBuf[7], 4) And &HF) + (RecBuf[7] And &HF)
  Return CheckSum

End

Private Function ProcessX(bRecBits As Byte) As Boolean

  Dim sAddr, sAddr2, sValue, sValue2, sType As String
  Dim iHsAddr, iDeviceId As Integer
  Dim bLowBatt, bUnknown As Boolean

  If ((RecBuf[0] Xor RecBuf[1]) = &HFF) And (RecBuf[0] = &HEE) Then
    ' ProcessRFRemote()
  Else If RecBuf[3] = 0 And (RecBuf[2] And &HF) = 0 Then
    ProcessAtiPlus()
  Else If ((RecBuf[0] Xor RecBuf[1]) = &HFF) And ((RecBuf[2] Xor RecBuf[3]) = &HFF) Then
    ProcessX10()
  Else If bRecBits = 32 And ((RecBuf[0] Xor RecBuf[1]) = &HFE) And ((RecBuf[2] Xor RecBuf[3]) = &HFF) Then
    ' ProcessDM10()
  Else If (RecBuf[0] = ((RecBuf[1] And &HF0) + (&HF - (RecBuf[1] And &HF)))) And ((RecBuf[2] Xor RecBuf[3]) = &HFF) Then
    ProcessX10Security()
  Else If ((RecBuf[2] Xor RecBuf[3]) = &HFF) Then
    sAddr = "[" & Hex(RecBuf[0], 2) & Hex(RecBuf[1], 2) & Hex(RecBuf[4], 2) & "]S"
    sAddr2 = sAddr & " / " & (RecBuf[0] * 256 + RecBuf[1])
    sType = "DWS"
    Select Case RecBuf[2]
      Case &H44
        sValue = "Open"
        sValue2 = "Tamper"
        If $bDebug Then Main.WriteDebugLogChars(" " & sType & sAddr2 & (" Visonic door sensor Alert + Tamper"), True)
      Case &HC4
        sValue = "Closed"
        sValue2 = "Tamper"
        If $bDebug Then Main.WriteDebugLogChars(" " & sType & sAddr2 & (" Visonic door sensor Normal + Tamper)"), True)
      Case &H4
        sValue = "Open"
        If $bDebug Then Main.WriteDebugLogChars(" " & sType & sAddr2 & (" Visonic door sensor Alert"), True)
      Case &H5
        bLowBatt = True
        sValue = "Open"
        If $bDebug Then Main.WriteDebugLogChars(" " & sType & sAddr2 & (" Visonic door sensor Alert (battery low)"), True)
      Case &H84
        sValue = "Closed"
        If $bDebug Then Main.WriteDebugLogChars(" " & sType & sAddr2 & (" Visonic door sensor Normal"), True)
      Case &H85
        bLowBatt = True
        sValue = "Closed"
        If $bDebug Then Main.WriteDebugLogChars(" " & sType & sAddr2 & (" Visonic door sensor Normal (battery low)"), True)
      Case &H4C
        sValue = "Motion"
        sValue2 = "Tamper"
        sType = "MOTION"
        If $bDebug Then Main.WriteDebugLogChars(" " & sType & sAddr2 & (" Visonic motion sensor Alert + Tamper"), True)
      Case &HCC
        sValue = "No Motion"
        sValue2 = "Tamper"
        sType = "MOTION"
        If $bDebug Then Main.WriteDebugLogChars(" " & sType & sAddr2 & (" Visonic motion sensor Normal + Tamper)"), True)
      Case &HC
        sValue = "Motion"
        sType = "MOTION"
        If $bDebug Then Main.WriteDebugLogChars(" " & sType & sAddr2 & (" Visonic motion sensor Alert"), True)
      Case &HD
        bLowBatt = True
        sValue = "Motion"
        sType = "MOTION"
        If $bDebug Then Main.WriteDebugLogChars(" " & sType & sAddr2 & (" Visonic motion sensor Alert (battery low)"), True)
      Case &H8C
        sValue = "No Motion"
        sType = "MOTION"
        If $bDebug Then Main.WriteDebugLogChars(" " & sType & sAddr2 & (" Visonic motion sensor Normal"), True)
      Case &H8D
        bLowBatt = True
        sValue = "No Motion"
        sType = "MOTION"
        If $bDebug Then Main.WriteDebugLogChars(" " & sType & sAddr2 & (" Visonic motion sensor Normal (battery low)"), True)
      Case &HE0
        If RecBuf[0] = &HFF Then
          If $bDebug Then Main.WriteDebugLogChars((" Master receiver jamming detected"), True)
        Else If RecBuf[0] = &H0 Then
          If $bDebug Then Main.WriteDebugLogChars((" Slave receiver jamming detected"), True)
        Else
          If $bDebug Then Main.WriteDebugLogChars((" Unknown data packet received"), True)
          bUnknown = True
        Endif
      Case &HF8
        If RecBuf[0] = &HFF Then
          If $bDebug Then Main.WriteDebugLogChars((" Master receiver end jamming detected"), True)
        Else If RecBuf[0] = &H0 Then
          If $bDebug Then Main.WriteDebugLogChars((" Slave receiver end jamming detected"), True)
        Else
          If $bDebug Then Main.WriteDebugLogChars((" unknown cmd!"), True)
          bUnknown = True
        Endif
      Case &H2
        sType = "REMOTE"
        sValue = "Arm Away"
        If $bDebug Then Main.WriteDebugLogChars(" " & sType & sAddr2 & (" Visonic keyfob ARM Away (max)"), True)
      Case &HE
        sType = "REMOTE"
        sValue = "Arm Home"
        If $bDebug Then Main.WriteDebugLogChars(" " & sType & sAddr2 & (" Visonic keyfob ARM Home (min)"), True)
      Case &H22
        sType = "REMOTE"
        sValue = "Panic"
        If $bDebug Then Main.WriteDebugLogChars(" " & sType & sAddr2 & (" Visonic keyfob Panic"), True)
      Case &H42
        sType = "REMOTE"
        sValue = "Lights On"
        If $bDebug Then Main.WriteDebugLogChars(" " & sType & sAddr2 & (" Visonic keyfob Lights On"), True)
      Case &H82
        sType = "REMOTE"
        sValue = "Disarm"
        If $bDebug Then Main.WriteDebugLogChars(" " & sType & sAddr2 & (" Visonic keyfob Disarm"), True)
      Case Else
        If $bDebug Then Main.WriteDebugLogChars((" Unknown data packet received"), True)
        bUnknown = True
    End Select

    If $bDebug Then
      iHsAddr = CreateHsAddr()
      If Protocol = MODEB32 Then
        Main.WriteDebugLogChars(" addr:" & Hex(RecBuf[0], 2), True)
        Main.WriteDebugLogChars(" ID:" & Right("    " & CStr(iHsAddr), 5), True)
      Else
        Main.WriteDebugLogChars(" addr:" & Hex(RecBuf[0], 2), True)
        Main.WriteDebugLogChars(Hex(RecBuf[1], 2), True)
        Main.WriteDebugLogChars(Hex(RecBuf[4], 2), True)
        Main.WriteDebugLogChars(" " & Hex(RecBuf[4], 2), True)
        Main.WriteDebugLogChars(" ID:" & Right("    " & CStr(iHsAddr), 5), True)
      Endif
    Endif

    If Not bUnknown Then
      If Not sValue2 Then sValue2 = "Secure"
      iDeviceId = Devices.Find(Instance, sType & sAddr, InterfaceId, sType)
      If iDeviceId Then
        Devices.ValueUpdate(iDeviceId, 1, sValue)
        Devices.ValueUpdate(iDeviceId, 2, sValue2)
        If bLowBatt Then
          Devices.Battery(iDeviceId, ("Low"))
        Else
          Devices.Battery(iDeviceId, ("OK"))
        Endif
      Endif
    Endif

  Else If Protocol = MODEVAR Or Protocol = MODENOXLAT Then
    If bRecBits = 32 And RecBuf[0] = &H52 And RecBuf[1] = &H46 Then
      If $bDebug Then
        Select Case RecBuf[2]
          Case &H58
            Main.WriteDebugLogChars(" RFXSensor Type-1,", True)
          Case &H32
            Main.WriteDebugLogChars(" RFXSensor Type-2,", True)
          Case &H33
            Main.WriteDebugLogChars(" RFXSensor Type-3,", True)
          Case &H34
            Main.WriteDebugLogChars(" RFXVamp,", True)
          Case Else
            Main.WriteDebugLogChars((" Unknown RFXSensor,"), True)
        End Select
      Endif
      If RecBuf[2] <> &H34 Then
        If $bDebug Then
          If (RecBuf[3] And &H80) = 0 Then
            Main.WriteDebugLogChars((" Fast sampling mode,"), True)
          Else
            Main.WriteDebugLogChars((" Slow sampling mode,"), True)
          Endif
        Endif
      Endif
      If $bDebug Then Main.WriteDebugLogChars(" version:" & CStr(RecBuf[3] And &H7F) & ",", True)
    Else If bRecBits = 40 And RecBuf[0] = &H53 And RecBuf[1] = &H45 And RecBuf[2] = &H4E Then
      If $bDebug Then
        Main.WriteDebugLogChars(" Sensor " & Hex(RecBuf[3]) & " type=", True)
        Select Case RecBuf[4]
          Case &H26
            Main.WriteDebugLogChars("DS2438", True)
          Case &H28
            Main.WriteDebugLogChars("DS18B20", True)
          Case Else
            Main.WriteDebugLogChars(("unknown 1-Wire sensor"), True)
         End Select
      Endif
    Else If bRecBits = 48 Then
      If $bDebug Then Main.WriteDebugLogChars((" Noise or a 1-Wire sensor internal address! "), True)
    Else If ((RecBuf[2] And &HC0) = &H0) And (bRecBits = 24 Or bRecBits = 44) Then
      ProcessDigimax()
    Else
      If $bDebug Then Main.WriteDebugLogChars((" Noise or an unknown data packet received! "), True)
    Endif
  Else
    If $bDebug Then Main.WriteDebugLogChars((" ProcessX(): Unknown data packet received! "), True)
  Endif

End

Private Sub ProcessX10()

  Dim bRecBytes As Byte
  Dim sHouse, sUnit, sValue As String
  Dim iDeviceId As Integer

  sMessage = " "

  Select Case (RecBuf[0] And &HF0)
    Case &H60
      sMessage &= "A"
      sHouse = "A"
    Case &H70
      sMessage &= "B"
      sHouse = "B"
    Case &H40
      sMessage &= "C"
      sHouse = "C"
    Case &H50
      sMessage &= "D"
      sHouse = "D"
    Case &H80
      sMessage &= "E"
      sHouse = "E"
    Case &H90
      sMessage &= "F"
      sHouse = "F"
    Case &HA0
      sMessage &= "G"
      sHouse = "G"
    Case &HB0
      sMessage &= "H"
      sHouse = "H"
    Case &HE0
      sMessage &= "I"
      sHouse = "I"
    Case &HF0
      sMessage &= "J"
      sHouse = "J"
    Case &HC0
      sMessage &= "K"
      sHouse = "K"
    Case &HD0
      sMessage &= "L"
      sHouse = "L"
    Case &H0
      sMessage &= "M"
      sHouse = "M"
    Case &H10
      sMessage &= "N"
      sHouse = "N"
    Case &H20
      sMessage &= "O"
      sHouse = "O"
    Case &H30
      sMessage &= "P"
      sHouse = "P"
    Case Else
      sMessage &= ("Unknown unit-")
  End Select
  Select Case RecBuf[2]
    Case &H80
      sMessage &= ("-All lights off")
    Case &H90
      sMessage &= ("-All lights on")
    Case &H88
      sMessage &= ("-Bright")
    Case &H98
      sMessage &= ("-Dim")
    Case Else
      If (RecBuf[2] And &H10) = 0 Then
        bRecBytes = 0
      Else
        bRecBytes = &H1
      Endif
      If (RecBuf[2] And &H8) <> 0 Then
        bRecBytes += &H2
      Endif
      If (RecBuf[2] And &H40) <> 0 Then
        bRecBytes += &H4
      Endif
      If (RecBuf[0] And &H4) <> 0 Then
        bRecBytes += &H8
      Endif
      Inc bRecBytes
      sMessage &= Trim(Str(bRecBytes))
      sUnit = Trim(Str(bRecBytes))
      If (RecBuf[2] And &H1) = 1 Then
        sMessage &= ("-Prog Koppla (non X10)")
      Else If (RecBuf[2] And &H20) = 0 Then
        sMessage &= "-On"
        sValue = "On"
      Else
        sMessage &= "-Off"
        sValue = "Off"
      Endif
  End Select

  If $bGlobalX10 Then
    iDeviceId = Devices.FindAll(Instance, sHouse & Right("0" & sUnit, 2), 9999, "X10")
  Else
    iDeviceId = Devices.Find(Instance, sHouse & Right("0" & sUnit, 2), InterfaceId, "X10")
  Endif
  If iDeviceId Then
    Select Devices.FindDeviceTypeDescriptionForDeviceId(iDeviceId)
      Case "Motion Sensor"
        ' Marmitek MS13E motion sensor part
        If sValue = "On" Then sValue = "Motion"
        If sValue = "Off" Then sValue = "No Motion"
      Case "Light Sensor"
        ' Marmitek MS13E dark/light sensor part
        If sValue = "On" Then sValue = "Dark"
        If sValue = "Off" Then sValue = "Light"
    End Select
    Devices.ValueUpdate(iDeviceId, 1, sValue)
  Endif

  If $bDebug Then Main.WriteDebugLogChars(sMessage, True)

End

Private Sub ProcessX10Security()

  Dim iHsAddr, iDeviceId As Integer
  Dim sValue, sValue2, sType, sAddr, sAddr2, sDevType As String
  Dim bLowBatt As Boolean

  sAddr = "[" & Hex(RecBuf[0], 2) & Hex(RecBuf[1], 2) & Hex(RecBuf[4], 2) & "]S"
  sAddr2 = sAddr & " / " & CStr(RecBuf[0] * 256 + RecBuf[1])
  sType = "X10SecDW"
  Select Case RecBuf[2]
    Case &H0
      sValue = "Open"
      If $bDebug Then Main.WriteDebugLogChars(" " & sType & sAddr2 & (" DS10/90 Alert (max delay)"), True)
    Case &H1
      sValue = "Open"
      bLowBatt = True
      If $bDebug Then Main.WriteDebugLogChars(" " & sType & sAddr2 & (" DS10/90 Alert (max delay, batt low)"), True)
    Case &H40
      sValue = "Open"
      sValue2 = "Tamper"
      If $bDebug Then Main.WriteDebugLogChars(" " & sType & sAddr2 & (" DS90 Alert + Tamper (max delay)"), True)
    Case &H44
      sValue = "Open"
      sValue2 = "Tamper"
      If $bDebug Then Main.WriteDebugLogChars(" " & sType & sAddr2 & (" Visonic or DS90 Alert + Tamper"), True)
    Case &HC0
      sValue = "Closed"
      sValue2 = "Tamper"
      If $bDebug Then Main.WriteDebugLogChars(" " & sType & sAddr2 & (" DS90 Normal + Tamper (max delay)"), True)
    Case &HC4
      sValue = "Closed"
      sValue2 = "Tamper"
      If $bDebug Then Main.WriteDebugLogChars(" " & sType & sAddr2 & (" Visonic or DS90 Normal + Tamper)"), True)
    Case &H4
      sValue = "Open"
      If $bDebug Then Main.WriteDebugLogChars(" " & sType & sAddr2 & (" Visonic or DS10/90 Alert "), True)
    Case &H5
      sValue = "Open"
      bLowBatt = True
      If $bDebug Then Main.WriteDebugLogChars(" " & sType & sAddr2 & (" Visonic or DS10/90 Alert (battery low)"), True)
    Case &H80
      sValue = "Closed"
      If $bDebug Then Main.WriteDebugLogChars(" " & sType & sAddr2 & (" DS10/90 Normal (max delay)"), True)
    Case &H81
      sValue = "Closed"
      bLowBatt = True
      If $bDebug Then Main.WriteDebugLogChars(" " & sType & sAddr2 & (" DS10/90 Normal (max delay, batt low)"), True)
    Case &H84
      sValue = "Closed"
      If $bDebug Then Main.WriteDebugLogChars(" " & sType & sAddr2 & (" Visonic or DS10/90 Normal"), True)
    Case &H85
      sValue = "Closed"
      bLowBatt = True
      If $bDebug Then Main.WriteDebugLogChars(" " & sType & sAddr2 & (" Visonic or DS10/90 Normal (battery low)"), True)
    Case &HC
      sValue = "Motion"
      sType = "X10SecMotion"
      If $bDebug Then Main.WriteDebugLogChars(" " & sType & sAddr2 & (" Visonic or MS10/20/90 Alert "), True)
    Case &H8C
      sValue = "No Motion"
      sType = "X10SecMotion"
      If $bDebug Then Main.WriteDebugLogChars(" " & sType & sAddr2 & (" Visonic or MS10/20/90 Normal"), True)
    Case &H20
      If $bDebug Then Main.WriteDebugLogChars((" MS20 Dark sensor"), True)
      sValue2 = "Dark"
    Case &H4C
      sValue = "Motion"
      sValue2 = "Tamper"
      sType = "X10SecMotion"
      If $bDebug Then Main.WriteDebugLogChars(" " & sType & sAddr2 & (" Visonic or MS90 Alert + Tamper"), True)
    Case &HCC
      sValue = "No Motion"
      sValue2 = "Tamper"
      sType = "X10SecMotion"
      If $bDebug Then Main.WriteDebugLogChars(" " & sType & sAddr2 & (" Visonic or MS90 Normal + Tamper"), True)
    Case &HD
      sValue = "Motion"
      sType = "X10SecMotion"
      If $bDebug Then Main.WriteDebugLogChars(" " & sType & sAddr2 & (" Visonic or MS90 Alert (battery low)"), True)
      bLowBatt = True
    Case &H8D
      sValue = "No Motion"
      sType = "X10SecMotion"
      If $bDebug Then Main.WriteDebugLogChars(" " & sType & sAddr2 & (" Visonic or MS90 Normal (battery low)"), True)
      bLowBatt = True
    Case &HE0
      If RecBuf[0] = &HFF Then
        If $bDebug Then Main.WriteDebugLogChars((" Master receiver jamming detected"), True)
      Else If RecBuf[0] = &H0 Then
        If $bDebug Then Main.WriteDebugLogChars((" Slave receiver jamming detected"), True)
      Else
        sValue = "Motion"
        sType = "DM10"
        sAddr = CStr(RecBuf[0] * 256 + RecBuf[1]) & "]GF"
        If $bDebug Then Main.WriteDebugLogChars(" " & sType & sAddr & (" DM10 Motion"), True)
      Endif
    Case &HF0
      sValue = "Dark"
      sType = "DM10"
      sAddr = CStr(RecBuf[0] * 256 + RecBuf[1]) & "]GF"
      If $bDebug Then Main.WriteDebugLogChars(" " & sType & sAddr & (" DM10 Darkness detected"), True)
    Case &HF8
      If RecBuf[0] = &HFF Then
        If $bDebug Then Main.WriteDebugLogChars(" Master receiver end jamming detected", True)
      Else If RecBuf[0] = &H0 Then
        If $bDebug Then Main.WriteDebugLogChars(" Slave receiver end jamming detected", True)
      Else
        sValue = "Light"
        sType = "DM10"
        sAddr = CStr(RecBuf[0] * 256 + RecBuf[1]) & "]GF"
        If $bDebug Then Main.WriteDebugLogChars(" " & sType & sAddr & (" DM10 Light detected"), True)
      Endif
    Case &H6
      sValue = "Arm Away"
      sType = "X10SecRemote"
      If $bDebug Then Main.WriteDebugLogChars(" " & sType & sAddr & (" KR10/SH624 ARM Away (min)"), True)
    Case &H26
      sValue = "Panic"
      sType = "X10SecRemote"
      If $bDebug Then Main.WriteDebugLogChars(" " & sType & sAddr & (" Visonic or KR10/Smoke Panic"), True)
    Case &H46
      sType = "X10SecRemote"
      iDeviceId = Devices.Find(Instance, sType & sAddr, InterfaceId, sType)
      If iDeviceId Then
        sDevType = Devices.FindDeviceTypeNameForDeviceId(iDeviceId)
      Endif
      If sDevType = "Marmitek KR18" Then
        sValue = "Light B On"
        If $bDebug Then Main.WriteDebugLogChars(" " & sType & sAddr & (" KR18 Light B On"), True)
      Else
        sValue = "Lights On"
        If $bDebug Then Main.WriteDebugLogChars(" " & sType & sAddr & (" KR10 Lights On"), True)
      Endif
    Case &H86
      sValue = "Disarm"
      sType = "X10SecRemote"
      If $bDebug Then Main.WriteDebugLogChars(" " & sType & sAddr & (" KR10 Disarm"), True)
    Case &HC6
      sType = "X10SecRemote"
      iDeviceId = Devices.Find(Instance, sType & sAddr, InterfaceId, sType)
      If iDeviceId Then
        sDevType = Devices.FindDeviceTypeNameForDeviceId(iDeviceId)
      Endif
      If sDevType = "Marmitek KR18" Then
        sValue = "Light B Off"
        If $bDebug Then Main.WriteDebugLogChars(" " & sType & sAddr & (" KR18 Light B Off"), True)
      Else
        sValue = "Lights Off"
        If $bDebug Then Main.WriteDebugLogChars(" " & sType & sAddr & (" KR10 Lights Off"), True)
      Endif
    Case &H2
      sValue = "Arm Away"
      sType = "X10SecRemote"
      If $bDebug Then Main.WriteDebugLogChars(" " & sType & sAddr & (" Visonic or SH624 ARM Away (max)"), True)
    Case &H3
      sValue = "Panic"
      sType = "X10SecRemote"
      If $bDebug Then Main.WriteDebugLogChars(" " & sType & sAddr & (" SH624 Panic"), True)
    Case &HA
      sValue = "Arm Home"
      sType = "X10SecRemote"
      If $bDebug Then Main.WriteDebugLogChars(" " & sType & sAddr & (" SH624 ARM Home (max)"), True)
    Case &HE
      sValue = "Arm Home"
      sType = "X10SecRemote"
      If $bDebug Then Main.WriteDebugLogChars(" " & sType & sAddr & (" Visonic or SH624 ARM Home (min)"), True)
    Case &H22
      sValue = "Panic"
      sType = "X10SecRemote"
      If $bDebug Then Main.WriteDebugLogChars(" " & sType & sAddr & (" SH624 Panic "), True)
    Case &H42
      sType = "X10SecRemote"
      iDeviceId = Devices.Find(Instance, sType & sAddr, InterfaceId, sType)
      If iDeviceId Then
        sDevType = Devices.FindDeviceTypeNameForDeviceId(iDeviceId)
      Endif
      If sDevType = "Marmitek KR18" Then
        sValue = "Light A On"
        If $bDebug Then Main.WriteDebugLogChars(" " & sType & sAddr & (" KR18 Light A On"), True)
      Else
        sValue = "Lights On"
        If $bDebug Then Main.WriteDebugLogChars(" " & sType & sAddr & (" Visonic or SH624 Lights On"), True)
      Endif
    Case &H82
      sValue = "Disarm"
      sType = "X10SecRemote"
      If $bDebug Then Main.WriteDebugLogChars(" " & sType & sAddr & (" Visonic or SH624 Disarm"), True)
    Case &HC2
      sType = "X10SecRemote"
      iDeviceId = Devices.Find(Instance, sType & sAddr, InterfaceId, sType)
      If iDeviceId Then
        sDevType = Devices.FindDeviceTypeNameForDeviceId(iDeviceId)
      Endif
      If sDevType = "Marmitek KR18" Then
        sValue = "Light A Off"
        If $bDebug Then Main.WriteDebugLogChars(" " & sType & sAddr & (" KR18 Light A Off"), True)
      Else
        sValue = "Lights Off"
        If $bDebug Then Main.WriteDebugLogChars(" " & sType & sAddr & (" SH624 Lights Off"), True)
      Endif
    Case Else
      If $bDebug Then Main.WriteDebugLogChars(" X10Security ?", True)
  End Select

  If $bDebug Then
    iHsAddr = CreateHsAddr()
    If Protocol = MODEB32 Then
      Main.WriteDebugLogChars(" addr:" & Hex(RecBuf[0], 2), True)
      Main.WriteDebugLogChars(" ID:" & Right("    " & CStr(iHsAddr), 5), True)
    Else
      Main.WriteDebugLogChars(" addr:" & Hex(RecBuf[0], 2), True)
      Main.WriteDebugLogChars(Hex(RecBuf[1], 2), True)
      Main.WriteDebugLogChars(Hex(RecBuf[4], 2), True)
      Main.WriteDebugLogChars(" " & Hex(RecBuf[4], 2), True)
      Main.WriteDebugLogChars(" ID:" & Right("    " & CStr(iHsAddr), 5), True)
    Endif
  Endif

  If Not sValue2 And sValue <> "Panic" Then sValue2 = "Secure"

  iDeviceId = Devices.Find(Instance, sType & sAddr, InterfaceId, sType)
  If iDeviceId Then
    Devices.ValueUpdate(iDeviceId, 1, sValue)
    Devices.ValueUpdate(iDeviceId, 2, sValue2)
    If bLowBatt Then
      Devices.Battery(iDeviceId, ("Low"))
    Else
      Devices.Battery(iDeviceId, ("OK"))
    Endif
  Endif

End

Private Sub ProcessDigimax()

  Dim iDeviceId, iParity, iAddr As Integer = RecBuf[1] * 256 + RecBuf[0]
  Dim sStatus As String
  Dim bParityError As Boolean

  If $bDebug Then
    Main.WriteDebugLogChars(" DIGIMAX[" & iAddr & "]", True)
    Main.WriteDebugLogChars(" Digimax  addr:" & Hex(RecBuf[0], 2), True)
    Main.WriteDebugLogChars(Hex(RecBuf[1], 2) & " ID:" & Str(iAddr), True)
  Endif

  If (RecBuf[4] And &H40) = 0 Then
    Select Case (RecBuf[2] And &H30)
      Case &H0
        sStatus = "No set temp"
      Case &H10
        sStatus = "Heating"
      Case &H20
        sStatus = "No heating"
      Case &H30
        sStatus = "Initializing"
    End Select
    If $bDebug Then Main.WriteDebugLogChars(" " & sStatus, True)
  Else
    Select Case (RecBuf[2] And &H30)
      Case &H0
        sStatus = "No set temp"
      Case &H10
        sStatus = "No cooling"
      Case &H20
        sStatus = "Cooling"
      Case &H30
        sStatus = "Initializing"
    End Select
    If $bDebug Then Main.WriteDebugLogChars(" " & sStatus, True)
  Endif
  If $bDebug Then Main.WriteDebugLogChars(" temp:" & RecBuf[3] & "°C | " & (RecBuf[3] * 1.8 + 32) & "°F", True)
  If Protocol = MODEB32 Or RecBits = 24 Then
    iParity = Not (Lsr((RecBuf[0] And &HF0), 4) + (RecBuf[0] And &HF) + Lsr((RecBuf[1] And &HF0), 4) + (RecBuf[1] And &HF) + Lsr((RecBuf[2] And &HF0), 4)) And &HF
    If iParity <> (RecBuf[2] And &HF) Then
      If $bDebug Then Main.WriteDebugLogChars(" Parity error on address/status SB: " & Hex(iParity), True)
      bParityError = True
    Endif
  Else
    If $bDebug Then Main.WriteDebugLogChars(" set:" & (RecBuf[4] And &H3F) & "°C | " & (RecBuf[4] * 1.8 + 32) & "°F", True)

    iParity = Not (Lsr((RecBuf[0] And &HF0), 4) + (RecBuf[0] And &HF) + Lsr((RecBuf[1] And &HF0), 4) + (RecBuf[1] And &HF) + Lsr((RecBuf[2] And &HF0), 4)) And &HF
    If iParity <> (RecBuf[2] And &HF) Then
      If $bDebug Then Main.WriteDebugLogChars(" Parity error on address/status SB:" & Hex(iParity), True)
      bParityError = True
    Endif
    iParity = Not (Lsr((RecBuf[3] And &HF0), 4) + (RecBuf[3] And &HF) + Lsr((RecBuf[4] And &HF0), 4) + (RecBuf[4] And &HF)) And &HF
    If iParity <> Lsr((RecBuf[5] And &HF0), 4) Then
      If $bDebug Then Main.WriteDebugLogChars(" Parity error on temp/set SB:" & Hex(iParity), False)
      bParityError = True
    Endif
  Endif

  If Not bParityError Then
    iDeviceId = Devices.Find(Instance, "DIGIMAX[" & iAddr & "]", InterfaceId, "DIGIMAX")
    If iDeviceId Then
      If Main.sTemperature = "°C" Then
        ' temp °C, set temp °C, status
        Devices.ValueUpdate(iDeviceId, 1, RecBuf[3], Devices.ValueType_Temperature)
        Devices.ValueUpdate(iDeviceId, 2, (RecBuf[4] And &H3F))
        Devices.ValueUpdate(iDeviceId, 3, sStatus)
      Else
        ' temp °F, set temp °F, status
        Devices.ValueUpdate(iDeviceId, 1, (RecBuf[3] * 1.8 + 32), Devices.ValueType_Temperature)
        Devices.ValueUpdate(iDeviceId, 2, (RecBuf[4] * 1.8 + 32))
        Devices.ValueUpdate(iDeviceId, 3, sStatus)
      Endif
    Endif
  Endif

End

Private Function CreateHsAddr() As Integer

  Dim iHsAddr As Integer = 0

  iHsAddr = 0
  If (RecBuf[0] And &H1) <> 0 Then
    iHsAddr = iHsAddr Or &H80
  Endif
  If (RecBuf[0] And &H2) <> 0 Then
    iHsAddr = iHsAddr Or &H40
  Endif
  If (RecBuf[0] And &H4) <> 0 Then
    iHsAddr = iHsAddr Or &H20
  Endif
  If (RecBuf[0] And &H8) <> 0 Then
    iHsAddr = iHsAddr Or &H10
  Endif
  If (RecBuf[0] And &H10) <> 0 Then
    iHsAddr = iHsAddr Or &H8
  Endif
  If (RecBuf[0] And &H20) <> 0 Then
    iHsAddr = iHsAddr Or &H4
  Endif
  If (RecBuf[0] And &H40) <> 0 Then
    iHsAddr = iHsAddr Or &H2
  Endif
  If (RecBuf[0] And &H80) <> 0 Then
    iHsAddr = iHsAddr Or &H1
  Endif
  If (RecBuf[1] And &H1) <> 0 Then
    iHsAddr = iHsAddr Or &H8000&
  Endif
  If (RecBuf[1] And &H2) <> 0 Then
    iHsAddr = iHsAddr Or &H4000&
  Endif
  If (RecBuf[1] And &H4) <> 0 Then
    iHsAddr = iHsAddr Or &H2000&
  Endif
  If (RecBuf[1] And &H8) <> 0 Then
    iHsAddr = iHsAddr Or &H1000&
  Endif
  If (RecBuf[1] And &H10) <> 0 Then
    iHsAddr = iHsAddr Or &H800&
  Endif
  If (RecBuf[1] And &H20) <> 0 Then
    iHsAddr = iHsAddr Or &H400&
  Endif
  If (RecBuf[1] And &H40) <> 0 Then
    iHsAddr = iHsAddr Or &H200&
  Endif
  If (RecBuf[1] And &H80) <> 0 Then
    iHsAddr = iHsAddr Or &H100&
  Endif
  Return iHsAddr

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' Retrieves the RFXComRX instance information for JSON-RPC and RFXCom Commander
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub JsonRpc_Tools_RFXCom_Get(cData As JSONCollection) As JSONCollection

  Dim cResult As New JSONCollection

  If cData = Null Then Return Null

  Select cData["command"]

    ' Get controller information
    Case "controller"
      cResult.Add(Instance, "instance_id")
      cResult.Add(IsRunning, "running")
      If Not IsRunning Then
        cResult.Add(ErrorText, "errortext")
      Endif

      cResult.Add("rfxcomrx", "rfxcom")

    Default
      Return Null

  End Select

  Return cResult

End

