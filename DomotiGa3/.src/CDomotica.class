' Gambas class file

' Description:
' CDomotica.class
' Support for Heino Peter's Domotica modules.

' Development Status:
' Just started.

' Links:
' http://www.elektor.nl/products/books/home/domotica.12267.lynkx
' http://www.domoticaforum.eu/forum.asp?FORUM_ID=30

' DomotiGa - an open source home automation program.
' Copyright (C) Ron Klinkien, The Netherlands.

' Read file called COPYING for license details.

Property Port As String
Property DomoticaDebug As Boolean

Private sPort As String
Private bDomoticaDebug As Boolean

Public hDomotica As New SerialPort

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' open serial port
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Function Connect() As Boolean

  ' try to close the port
  Try hDomotica.Close

  ' get a new one
  hDomotica = New Serialport As "Domotica"

  With hDomotica
    .PortName = sPort
    .Speed = 9600
    .Parity = 0
    .DataBits = 8
    .StopBits = 1
    .Open()
  End With

  ' all ok
  Return True

Catch ' some errors
  Main.WriteLog(("Domotica Error: ") & ERROR.Text)
  Return False

End

Public Sub Domotica_Read()

  Dim sData As Byte

  sData = Read #hDomotica As Byte

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' close port
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Function Disconnect() As Boolean

  ' try to close the connection
  Try hDomotica.Close
  Main.WriteLog(("Domotica serial port close."))

  ' all ok
  Return True

Catch ' some errors
  Main.WriteLog(("Domotica Error: ") & ERROR.Text)
  Return False

End

' implement properties
Function Port_Read() As String

  Return sPort

End

Sub Port_Write(Value As String)

  sPort = Value

End

Private Function DomoticaDebug_Read() As Boolean

  Return bDomoticaDebug

End

Private Sub DomoticaDebug_Write(Value As Boolean)

  bDomoticaDebug = Value

End

