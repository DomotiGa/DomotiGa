' Gambas class file

' Description:
' CWeeder.class
' Support for Weeder I/O Modules.

' Development Status:
' Started to implement WT-SSR (Solid State Relay Module) to control my Home Ventilation System.

' Links:
' http://www.weedertech.com

' DomotiGa - an open source home automation program.
' Copyright (C) Ron Klinkien, The Netherlands.

' Read file called COPYING for license details.

' Notes:
' You can stack Weeder modules on the same serial port.

Property Port As String
Property WeederDebug As Boolean
Private sPort As String
Private bWeederDebug As Boolean

Public hWeeder As New SerialPort

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' open serial port
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Function Connect() As Boolean

  ' try to close the port
  Try hWeeder.Close

  ' get a new one
  hWeeder = New Serialport As "Weeder"
  With hWeeder
    .PortName = sPort
    .Speed = 9600
    .Parity = 0
    .DataBits = 8
    .StopBits = 1
    .FlowControl = 0
    .Open()
  End With

  ' all ok
  Return True

Catch ' some errors
  Main.WriteLog(("Weeder Error: ") & ERROR.Text)
  Return False

End

Public Function ControlITHO(sAddress As String, sSpeed As String)

  Dim sCmd As String

  Select Case sSpeed
    Case "1"
      sPort = "A"
    Case "2"
      sPort = "B"
    Case "3"
      sPort = "C"
    Case "T"
      sPort = "D"
  End Select

  sCmd = sAddress & "C" & sPort & "1000" ' close relay sPort for 1 second
  Send(sCmd)

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' close port
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Function Disconnect() As Boolean

  ' try to close the connection
  Try hWeeder.Close
  Main.WriteLog(("Weeder serial port close."))

  ' all ok
  Return True

Catch ' some errors
  Main.WriteLog(("Weeder Error: ") & ERROR.Text)
  Return False

End

Public Sub Send(sCommand As String)

  If hWeeder.Status <> Net.Active Then Return

  If Main.bWeederDebug Then Main.WriteDebugLog(("[Weeder] Write: ") & sCommand)
  Print #hWeeder, sCommand & "\r"
  WeederRead()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' got data input
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub WeederRead()

  Dim iTries As Integer = 10
  Dim sData, sTemp As String

  While (iTries > 0)
    ' wait a bit and read response.
    Sleep 0.01
    ' see if we got some data.
    Try sTemp = Read #hweeder, Lof(hWeeder)
    sData &= sTemp
    Dec iTries
  Wend
  sData = Replace(sData, Chr(10), "")

  If Main.bWeederDebug Then
    If InStr(sData, "?")
      Main.WriteDebugLog(("[Weeder] Syntax error -> ") & sData)
    Else
      Main.WriteDebugLog(("[Weeder] Read: ") & sData)
    End If
  End If

End

' implement the properties
Private Function Port_Read() As String

  Return sPort

End

Private Sub Port_Write(sValue As String)

  sPort = sValue

End

Private Function WeederDebug_Read() As Boolean

  Return bWeederDebug

End

Private Sub WeederDebug_Write(sValue As Boolean)

  bWeederDebug = sValue

End
