' Gambas class file

' Description:
' FSettingsTemperaturNu.class
' Settings form for TemperaturNu temperature upload.

' Development Status:
' Development just started.

' Links:
' http://www.temperatur.nu

' DomotiGa - an open source home automation program.
' Copyright (C) Ron Klinkien, The Netherlands.

' This module was written by Daniel Lindmark in 2010.

' Read file called COPYING for license details.

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' initialize buttons and fill in current values
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Form_Open()

  Me.Move(FMain.X + 50, FMain.Y + 70)

  chkEnabled.Value = Main.bTemperaturNuEnabled
  txtCity.Text = Main.sTemperaturNuCity
  txtId.Text = Main.sTemperaturNuId
  chkDebug.Value = Main.bTemperaturNuDebug
  txtPushTime.Text = Main.iTemperaturNuPushTime

  If Main.bTemperaturNuEnabled = False Then
    txtCity.Enabled = False
    txtId.Enabled = False
    chkDebug.Enabled = False
    btnUpload.Enabled = False
    txtPushTime.Enabled = False
    cmbSensor.Enabled = False
    cmbValue.Enabled = False
    txtValue.Enabled = False
  End If

  FillTemperatureDevices()
  FillValue()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' fill combobox with available devices
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub FillTemperatureDevices()

  Dim rResult, rDevice As Result
  Dim iCount As Integer

  rResult = Main.hDB.Exec("SELECT * FROM devices WHERE enabled is true AND groups LIKE '%Temperature%'")

  If Not rResult Then
    Message.Info(("Error: table 'devices' not found!"))
    Return
  End If

  cmbValue.Add("", 0)
  cmbValue.Add("Value", 1)
  cmbValue.Add("Value2", 2)
  cmbValue.Add("Value3", 3)
  cmbValue.Add("Value4", 4)

  For iCount = 0 To rResult.Max
    cmbSensor.Add(rResult!name)
    rResult.MoveNext
  Next

  Try rDevice = Main.hDB.Exec("SELECT name FROM devices WHERE id = &1", Main.iTemperaturNuDeviceId)
  cmbSensor.Add("", 0)
  If rDevice.Count Then
    cmbSensor.Text = Devices.FindNameForDevice(Main.iTemperaturNuDeviceId)
    cmbValue.Index = Main.sTemperaturNuDeviceValue
  Endif

End

Public Sub FillValue()

  txtValue.Text = Devices.GetCurrentValueForDevice(Devices.FindIdForDevice(cmbSensor.Text), cmbValue.Index)

End

Public Sub btnCancel_Click()

  Me.Close

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' load defaults from database
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub btnDefaults_Click()

  Dim rResult As Result

  rResult = Main.GetSettingTable("temperaturnu", True) ' get defaults
  If rResult.Count Then
    chkEnabled.Value = rResult!enabled
    txtCity.Text = rResult!city
    txtId.Text = rResult!apikey
    chkDebug.Value = rResult!debug
    txtPushTime.Text = rResult!pushtime
  End If
  btnSave.Enabled = True

End

Public Sub chkEnabled_Click()

  txtCity.Enabled = chkEnabled.Value
  txtId.Enabled = chkEnabled.Value
  chkDebug.Enabled = chkEnabled.Value
  btnUpload.Enabled = chkEnabled.Value
  txtPushTime.Enabled = chkEnabled.Value
  cmbSensor.Enabled = chkEnabled.Value
  cmbValue.Enabled = chkEnabled.Value
  txtValue.Enabled = chkEnabled.Value
  btnSave.Enabled = True

End

Public Sub txtCity_KeyPress()

  btnSave.Enabled = True

End

Public Sub txtId_KeyPress()

  btnSave.Enabled = True

End

Public Sub txtPushTime_KeyPress()

  btnSave.Enabled = True

End

Public Sub cmbSensor_Click()

  btnSave.Enabled = True
  FillValue()

End

Public Sub cmbValue_Click()

  btnSave.Enabled = True
  FillValue()

End

Public Sub chkDebug_Click()

  btnSave.Enabled = True

End

Private Sub ValidInput() As Boolean

  If Not txtCity.Text Then
    Balloon(("Please enter a city name!"), txtCity)
    Return False
  End If
  If Not txtId.Text Then
    Balloon(("Please enter an id!"), txtId)
    Return False
  End If
  If Not cmbSensor.Text Then
    Balloon(("Please select a device!"), cmbSensor)
    Return False
  End If
  If Not cmbValue.Text Then
    Balloon(("Please select a value field!"), cmbValue)
    Return False
  End If
  Return True

End

Public Sub btnSave_Click()

  Dim rResult As Result

  If Not ValidInput() Then Return

  ' save new Temperatur.nu settings
  rResult = Main.hDB.Exec("UPDATE settings_temperaturnu SET debug = &1, city = &2, pushtime = &3, enabled = &4, apikey = &5, deviceid = &6, devicevalue = &7 WHERE id = 1", chkDebug.Value, txtCity.Text, txtPushTime.Text, chkEnabled.Value, txtId.Text, Devices.FindIdForDevice(cmbSensor.Text), cmbValue.Index)
  rResult = Main.GetSettingTable("temperaturnu") ' reload settings
  If rResult.Count Then
    Main.bTemperaturNuEnabled = rResult!enabled
    Main.sTemperaturNuCity = rResult!city
    Main.sTemperaturNuId = rResult!apikey
    Main.bTemperaturNuDebug = rResult!debug
    Main.iTemperaturNuPushTime = rResult!pushtime
    Main.iTemperaturNuDeviceId = rResult!deviceid
    Main.sTemperaturNuDeviceValue = rResult!devicevalue
  End If
  If Main.bServer Then
    Main.Restart_TemperaturNu()
  Else
    XMLClient.ModuleRestart("TemperaturNu")
  End If
  Me.Close

End

Public Sub btnUpload_Click()

  TemperaturNu.UploadTemperaturNuData()

End

Public Sub btnWeb_Click()

  Desktop.Open("http://www.temperatur.nu/")

End
