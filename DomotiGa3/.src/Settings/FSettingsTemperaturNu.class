' Gambas class file

' Description:
' FSettingsTemperaturNu.class
' Settings form for TemperaturNu temperature upload.

' Development Status:
' Development just started.

' Links:
' http://www.temperatur.nu

' DomotiGa - an open source home automation program.
' Copyright (C) Ron Klinkien, The Netherlands.

' This module was written by Daniel Lindmark in 2010.

' Read file called COPYING for license details.

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' Variables
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private $iDeviceId As Integer
Private $sDeviceValue As String

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' initialize buttons and fill in current values
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Form_Open()

  Me.Move(FMain.X + 50, FMain.Y + 70)

  ' TODO: add more instances
  If LoadSettings(1) = False Then
    ' TODO: Handle problems
    Try Me.Close
    Return
  Endif

  EnableDisableSettings()
  btnSave.Enabled = False

  FillTemperatureDevices()
  FillValue()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' fill combobox with available devices
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub FillTemperatureDevices()

  Dim rResult, rDevice As Result
  Dim iCount As Integer

  rResult = Devices.GetDevicesAndValues(["enabled": True, "groups": ["%Temperature%"], "inc_device_values": False])

  If Not rResult Then
    Message.Info(("Error: table 'devices' not found!"))
    Return
  Endif

  cmbValue.Add("", 0)
  cmbValue.Add("Value1", 1)
  cmbValue.Add("Value2", 2)
  cmbValue.Add("Value3", 3)
  cmbValue.Add("Value4", 4)

  For Each rResult
    cmbSensor.Add(rResult!device_name)
  Next

  Try rDevice = Devices.GetDevicesAndValues(["device_id": $iDeviceId, "inc_device_values": False])
  cmbSensor.Add("", 0)
  If rDevice.Count Then
    cmbSensor.Text = rDevice!device_name
    cmbValue.Index = $sDeviceValue
  Endif

End

Public Sub FillValue()

  txtValue.Text = Devices.GetCurrentValueForDevice(Devices.FindIdForDevice(cmbSensor.Text), cmbValue.Index)

End

Public Sub btnCancel_Click()

  Me.Close

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' load defaults from database
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub btnDefaults_Click()

  LoadSettings(0)
  btnSave.Enabled = True

End

Public Sub chkEnabled_Click()

  EnableDisableSettings()
  btnSave.Enabled = True

End

Public Sub txtCity_KeyPress()

  btnSave.Enabled = True

End

Public Sub txtId_KeyPress()

  btnSave.Enabled = True

End

Public Sub txtPushTime_KeyPress()

  btnSave.Enabled = True

End

Public Sub cmbSensor_Click()

  btnSave.Enabled = True
  FillValue()

End

Public Sub cmbValue_Click()

  btnSave.Enabled = True
  FillValue()

End

Public Sub chkDebug_Click()

  btnSave.Enabled = True

End

Private Sub ValidInput() As Boolean

  If Not txtCity.Text Then
    Balloon(("Please enter a city name!"), txtCity)
    Return False
  Endif
  If Not txtId.Text Then
    Balloon(("Please enter an id!"), txtId)
    Return False
  Endif
  If Not cmbSensor.Text Then
    Balloon(("Please select a device!"), cmbSensor)
    Return False
  Endif
  If Not cmbValue.Text Then
    Balloon(("Please select a value field!"), cmbValue)
    Return False
  Endif
  Return True

End

Public Sub btnSave_Click()

  Dim rResult As Result

  If Not ValidInput() Then Return

  ' save new Temperatur.nu settings
  Main.hDB.Exec("UPDATE settings_temperaturnu SET debug = &1, city = &2, pushtime = &3, enabled = &4, apikey = &5, deviceid = &6, devicevalue = &7 WHERE id = 1", chkDebug.Value, txtCity.Text, txtPushTime.Text, chkEnabled.Value, txtId.Text, Devices.FindIdForDevice(cmbSensor.Text), cmbValue.Index)

  If Main.bServer Then
    Plugin.Restart("TemperaturNu")
  Else
    Client.ModuleRestart("TemperaturNu")
  Endif

  Me.Close

End

Public Sub btnUpload_Click()

  Try Plugin.GetPluginObject("TemperaturNu", 1).Interface.UploadTemperaturNuData()

End

Public Sub btnWeb_Click()

  Desktop.Open("http://www.temperatur.nu/")

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' Load table row
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub LoadSettings(iRow As Integer) As Boolean

  Dim rResult As Result

  rResult = Plugin.GetSettingsTable("settings_temperaturnu", iRow)

  If rResult.Count Then
    chkEnabled.Value = rResult!enabled
    txtCity.Text = rResult!city
    txtId.Text = rResult!apikey
    chkDebug.Value = rResult!debug
    txtPushTime.Text = rResult!pushtime
    $iDeviceId = rResult!deviceid
    $sDeviceValue = rResult!devicevalue
    Return True
  Else
    Return False
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' Enable/Disable all input fields depending on enable value
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub EnableDisableSettings()

  txtCity.Enabled = chkEnabled.Value
  txtId.Enabled = chkEnabled.Value
  chkDebug.Enabled = chkEnabled.Value
  btnUpload.Enabled = chkEnabled.Value
  txtPushTime.Enabled = chkEnabled.Value
  cmbSensor.Enabled = chkEnabled.Value
  cmbValue.Enabled = chkEnabled.Value
  txtValue.Enabled = chkEnabled.Value

End

