' Gambas class file

' Description:
' COneWire.class
' Support for Midon's TEMP08 1-wire interface.

' Development Status:
' Working, but only temp sensors implemented tested yet.

' DomotiGa - an open source home automation program.
' Copyright(C) 2008-2010 Ron Klinkien

' Read file called COPYING for license details.

Property Port As String
Property Baud As String
Property OneWireDebug As Boolean

Private sPort As String
Private sBaud As String
Private bOneWireDebug As Boolean

Public hOneWire As New SerialPort
Public tOneWire As New Timer

Public sBuffer As String

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' open serial port
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Function Connect() As Boolean

  ' try to close the port
  Try hOneWire.Close

  ' get a new one
  hOneWire = New Serialport As "OneWire"

  With hOneWire
    .PortName = sPort
    .Speed = sBaud
    .Parity = 0
    .DataBits = 8
    .StopBits = 1
    .Open()
  End With

  ' start poll timer for OneWire status LED
  tOneWire = New Timer As "tOneWireLED"
  tOneWire.Delay = 250
  tOneWire.Stop

  ' all ok
  Return True

Catch ' some errors
  Main.WriteLog(("OneWire Error: ") & ERROR.Text)
  Return False

End

Public Sub OneWire_Read()

  Dim sData As String

  Try Read #hOneWire, sData, 1
  If Error Then Main.WriteDebugLog(("[1-Wire] Error reading data from serial port! -> ") & Error.Text)
  If sData = Chr(10) Then ' buffer until newline then parse
    If Len(sBuffer) > 1 Then ParseLine(sBuffer)
    sBuffer = Null
  Else
    sBuffer &= sData
  End If

End

Public Sub ParseLine(sStr As String)

  Dim iDeviceId As Integer
  Dim aScan As String[]

  Main.ControlLed("OneWire", "On")
  If Main.bServer Then tOneWire.Start

  ' example output
  ' SUN 00:36:20
  ' Reading Sensors...
  ' Voltage #01[4 D0000004FC78A26] = 00.32 V 04.98 V
  ' Temp #01[4D0000004FC78A26]=23.75C
  ' Temp #02[150008013A024910]=22.43C
  ' Temp #03[7A0008014A6BC310]=22.68C

  If bOneWireDebug Then Main.WriteDebugLog("[1-Wire] " & sStr)

  ' 1-wire temp sensor support
  If Mid$(sStr, 1, 4) = "Temp" Then
    If bOneWireDebug Then Main.WriteDebugLog(("[1-Wire] We got DS1820 temperature data."))
    aScan = Scan(sStr, "*[[]*]=*")
    If aScan.Count = 3 Then
      iDeviceId = Devices.Find(aScan[1], Devices.FindInterface("Midon TEMP08"), "Dallas DS1820")
      If iDeviceId Then Devices.ValueUpdate(iDeviceId, LTrim(Left(aScan[2], -2)), "", "", "")
    End If
  End If
  ' put support for other sensortypes here

End

Public Sub tOneWireLED_Timer()

  Main.ControlLed("OneWire", "Off")
  tOneWire.Stop

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' close port
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Function Disconnect() As Boolean

  ' try to close the connection
  Try hOneWire.Close
  Main.WriteLog(("OneWire serial port close."))

  ' all ok
  Return True

Catch ' some errors
  Main.WriteLog(("1-Wire Error: ") & ERROR.Text)
  Return False

End

' implement properties
Function Port_Read() As String

  Return sPort

End

Sub Port_Write(Value As String)

  sPort = Value

End

Private Function Baud_Read() As String

  Return sBaud

End

Private Sub Baud_Write(Value As String)

  sBaud = Value

End

Private Function OneWireDebug_Read() As Boolean

  Return bOneWireDebug

End

Private Sub OneWireDebug_Write(Value As Boolean)

  bOneWireDebug = Value

End
