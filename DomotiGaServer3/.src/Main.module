' Gambas module file

' Description:
' Main.module

' DomotiGa Server - the server part of DomotiGa an open source home automation program
' Copyright (C) Ron Klinkien, The Netherlands.

' This program is free software: you can redistribute it and/or modify
' it under the terms of the GNU General Public License as published by
' the Free Software Foundation, either version 3 of the License, or
' (at your option) any later version.

' This program is distributed in the hope that it will be useful,
' but WITHOUT ANY WARRANTY; without even the implied warranty of
' MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. See the
' GNU General PUBLIC License for more details.

' You should have received a copy of the GNU General PUBLIC License
' along with this program. If not, see <http://www.gnu.org/licenses/>.

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' this is the place where all global variables are defined
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' Main
Public sProgramVersion As String = "1.0.010"
Public sBaseDir As String
Public sSettings As String = "server-domotiga.conf"
Public bMainDebug As Boolean
Public bExitProgram As Boolean ' exit program flag
Public sLanguage As String
Public bAllowAutoUpgrade As Boolean
Public bAutoDeviceCreate As Boolean

' Client/Server
Public bServer As Boolean = True
Public hBroadcastEvent As UdpSocket
Public aBroadcastAddrs As New String[]
Public sOurIPAddress As String

' Debug
Public bEventsDebug As Boolean
Public bDevicesDebug As Boolean
Public bEnergyDebug As Boolean

' Message counters
Public iNewMails As Integer
Public iNewCalls As Integer
Public iNewVoicemails As Integer

' Logfiles
Public iLogBuffer As Integer = 10000 ' default size of buffer after logwindows gets flushed
Public sMainLogFile As String
Public sSpeakLogFile As String
Public sDebugLogFile As String
Public sDomoZWaveFile As String
Public hMainLogFile As File  ' main log file
Public hSpeakLogFile As File ' speak log file
Public hDebugLogFile As File ' debug log file
Public sLogPrefix As String

' Collection with Global Variables (these survive a program restart)
Public GlobalVar As New Collection

' Time and Date related
Public bNew_Minute As Boolean
Public bNew_Month As Boolean
Public dTime As Date
Public dPrev_Time As Date

' Timers
Public tMainFlush As Timer
Public iMainFlushTime As Integer = 3000
Public tMainSleep As Timer

' MySQL
Public sSQLHost As String
Public sSQLUser As String
Public sSQLPass As String
Public sSQLDatabase As String
Public bSQLDebug As Boolean
Public hDB As New Connection

' Sound
Public bSoundEnabled As Boolean ' enable sound support
Public bSoundDebug As Boolean ' debug sound
Public iSoundVolume As Integer ' default volume level

' VoiceText
Public bVoiceTextEnabled As Boolean ' enable TTS support
Public sVoiceTextEngine As String ' currently only 'cepstral' and 'espeak' are supported
Public sVoiceTextVoicesMale As String ' list of voices, first is default
Public sVoiceTextVoicesFemale As String ' list of voices, first is default
Public sVoiceTextPrefixCmd As String ' prefix command like 'padsp'
Public bVoiceTextDebug As Boolean ' debug TTS

' Astro
Public iAstroLatitude As Float
Public iAstroLongitude As Float
Public iAstroTimezone As Float
Public bAstroDST As Boolean
Public fAstroAutoTimezone As Float
Public sAstroAutoTimezoneName As String
Public sAstroSeasons As String
Public sAstroSeasonStarts As String
Public sAstroTwilight As String
Public bAstroDebug As Boolean
Public sTemperature As String
Public sCurrency As String

' Astro MoonPhase
Public MoonPhase As String
Public MoonZodiac As String
Public MoonAge As Integer
Public MoonDistance As Float
Public MoonLatitude As Float
Public MoonLongitude As Float
Public MoonIsLeapYear As Boolean

' Thermostat
Public bThermostatEnabled As Boolean
Public bThermostatDebug As Boolean
Public iThermostatPollTime As Integer

' X10Cmd
Public bX10CmdEnabled As Boolean
Public sX10CmdCommand As String
Public bX10CmdMonitor As Boolean
Public bX10CmdGlobalX10 As Boolean
Public iX10CmdType As Integer
Public bX10CmdDebug As Boolean

' CTX35
Public bCTX35Enabled As Boolean
Public sCTX35SerialPort As String
Public sCTX35Baudrate As String
Public iCTX35PollTime As Integer
Public bCTX35Debug As Boolean
Public bCTX35GlobalX10 As Boolean
Public hCTX35 As CCTX35

' SMS Modem
Public bSMSEnabled As Boolean
Public sSMSSerialPort As String
Public sSMSBaudrate As String
Public sSMSPIN As String
Public sSMSServiceCentre As String
Public sSMSContact As String
Public iSMSPollTime As Integer
Public bSMSDebug As Boolean
Public hSMS As CSMS

' UPS
Public bUPSEnabled As Boolean
Public sUPSTCPHost As String
Public iUPSTCPPort As Integer
Public iUPSPollTime As Integer
Public bUPSDebug As Boolean
Public hUPS As CUPS

' E-mail
Public bEmailEnabled As Boolean
Public sEmailSMTPServer As String
Public iEmailSMTPPort As Integer
Public sEmailFromAddress As String
Public sEmailToAddress As String
Public sEmailSubject As String
Public bEmailDebug As Boolean
Public sEmailUserName As String
Public sEmailPassword As String
Public bEmailSSL As Boolean

' GMail RSS
Public bGmailEnabled As Boolean
Public sGmailUser As String
Public sGmailPassword As String
Public iGmailPollTime As Integer
Public bGmailDebug As Boolean

' Google Translate
Public bGTranslateEnabled As Boolean = False ' use Google Translate
Public sGTranslateAPIKey As String ' Google Translate (paid) API key

' GPS
Public bGPSEnabled As Boolean
Public sGPSSerialPort As String
Public sGPSBaudrate As String
Public iGPSPollTime As Integer
Public bGPSDebug As Boolean
Public hGPS As CGPS

' Temp08
Public bTemp08Enabled As Boolean
Public sTemp08SerialPort As String
Public sTemp08Baudrate As String
Public bTemp08Debug As Boolean
Public hTemp08 As CTemp08

' VISCA
Public bVISCAEnabled As Boolean
Public sVISCASerialPort As String
Public sVISCABaudrate As String
Public iVISCACameraAddress As Integer
Public bVISCADebug As Boolean
Public sVISCAVideoDevice As String
Public hVISCA As CVISCA

' VideoServer
Public bVideoServerEnabled As Boolean
Public sVideoServerAddress As String
Public iVideoServerPort As Integer
Public sVideoServerUser As String
Public sVideoServerPassword As String
Public bVideoServerDebug As Boolean
Public sVideoServerChannel1 As String
Public sVideoServerChannel2 As String
Public sVideoServerChannel3 As String
Public sVideoServerChannel4 As String

' HDDTemp
Public bHDDTempEnabled As Boolean
Public sHDDTempTCPHost As String
Public iHDDTempTCPPort As Integer
Public iHDDTempPollTime As Integer
Public iHDDTempThreshold As Integer
Public bHDDTempDebug As Boolean

' RRDTool
Public bRRDToolEnabled As Boolean
Public iRRDToolPollTime As Integer
Public sRRDToolRRA As String
Public bRRDToolDebug As Boolean

' Asterisk *
Public bAsteriskEnabled As Boolean
Public sAsteriskTCPHost As String
Public iAsteriskTCPPort As Integer
Public iAsteriskPollTime As Integer
Public sAsteriskUser As String
Public sAsteriskPassword As String
Public bAsteriskDebug As Boolean
Public hAsterisk As CAsterisk

' Bluetooth
Public bBluetoothEnabled As Boolean
Public sBluetoothDevice As String
Public iBluetoothThreshold As Integer
Public iBluetoothPollTime As Integer
Public bBluetoothDebug As Boolean

' Weeder I/O
Public bWeederEnabled As Boolean
Public sWeederSerialPort As String
Public bWeederDebug As Boolean
Public hWeeder As CWeeder

' TV Guide
Public bTVGuideEnabled As Boolean
Public sTVGuideXMLGrabCommand As String
Public sTVGuideXMLFile As String
Public bTVGuideDebug As Boolean

' Server Stats
Public bServerStatsEnabled As Boolean
Public sServerStatsName As String
Public bServerStatsDebug As Boolean

' IRMan Infrared
Public bIRManEnabled As Boolean
Public sIRManSerialPort As String
Public bIRManDebug As Boolean
Public hIRMan As CIRMan

' WakeOnLan
Public hBroadcast As UdpSocket

' Plugwise
Public bPlugwiseEnabled As Boolean
Public sPlugwiseSerialPort As String
Public iPlugwisePollTime As Integer
Public bPlugwiseDebug As Boolean
Public hPlugwise As CPlugwise

' Fritz!Box
Public bFritzBoxEnabled As Boolean
Public sFritzBoxTCPHost As String
Public bFritzBoxDebug As Boolean
Public hFritzBox As CFritzBox

' XMLRPC
Public bXMLRPCEnabled As Boolean
Public iXMLRPCMaxConn As Integer
Public iXMLRPCHTTPPort As Integer
Public bXMLRPCDebug As Boolean
Public hXMLRPC As CXMLRPC

' Broadcast UDP
Public bBroadcastUDPEnabled As Boolean

' Bwired Domotica World
Public bBwiredMapEnabled As Boolean
Public sBwiredMapTitle As String
Public sBwiredMapWebsite As String
Public sBwiredMapWebsitePicUrl As String
Public sBwiredMapUser As String
Public sBwiredMapPassword As String
Public sBwiredMapScreenName As String
Public sBwiredMapGpsLat As String
Public sBwiredMapGpsLong As String
Public sBwiredMapCity As String
Public iBwiredMapPushTime As Integer
Public bBwiredMapDebug As Boolean

' Twitter
Public bTwitterEnabled As Boolean
Public sTwitterUser As String
Public sTwitterPassword As String
Public bTwitterTimeStamp As Boolean
Public bTwitterDebug As Boolean

' DSC Security
Public bDSCEnabled As Boolean
Public sDSCSerialPort As String
Public sDSCBaudrate As String
Public iDSCType As Integer
Public sDSCMasterCode As String
Public bDSCDebug As Boolean
Public hDSC As CDSC

' Visonic Security
Public bVisonicEnabled As Boolean
Public sVisonicSerialPort As String
Public iVisonicType As Integer
Public sVisonicMasterCode As String
Public bVisonicDebug As Boolean
Public hVisonic As CVisonic

' KNX/EIB
Public bEIBEnabled As Boolean
Public sEIBTCPHost As String
Public iEIBTCPPort As Integer
Public bEIBDebug As Boolean
Public hEIB As CEIB

' Domotica
Public bDomoticaEnabled As Boolean
Public sDomoticaSerialPort As String
Public bDomoticaDebug As Boolean
Public hDomotica As CDomotica

' Digitemp
Public bDigitempEnabled As Boolean
Public sDigitempCommand As String
Public sDigitempConfig As String
Public iDigitempReadTime As Integer
Public iDigitempPollTime As Integer
Public bDigitempDebug As Boolean

' Z-Wave
Public bZWaveEnabled As Boolean
Public sZWaveSerialPort As String
Public bZWaveDebug As Boolean
Public iZWavePollTime As Integer
Public sZWavePollTimeListening As String
Public bZWaveEnablePollListening As Boolean
Public sZWavePollTimeSleeping As String
Public bZWaveEnablePollSleeping As Boolean
Public sZWaveUpdateNeighbor As String
Public bZWaveEnableUpdateNeighbor As Boolean
Public hZWave As CZWave

' One-Wire Weather
Public bOWWEnabled As Boolean
Public sOWWTCPHost As String
Public iOWWTCPPort As Integer
Public sOWWServerType As String
Public bOWWDebug As Boolean
Public hOWWTCP As COWW
Public hOWWUDP As COWW

' LIRC
Public bLIRCEnabled As Boolean
Public sLIRCTCPHost As String
Public iLIRCTCPPort As Integer
Public bLIRCDebug As Boolean
Public hLIRC As CLIRC

' Pachube
Public bPachubeEnabled As Boolean
Public iPachubeFeed As Integer
Public iPachubePushTime As Integer
Public sPachubeAPIKey As String
Public bPachubeDebug As Boolean

' JeeLabs JeeLink
Public bJeeLabsEnabled As Boolean
Public sJeeLabsSerialPort As String
Public sJeeLabsBaudrate As String
Public bJeeLabsDebug As Boolean
Public hJeeLabs As CJeeLabs

' Ping
Public bPingEnabled As Boolean
Public iPingPollTime As Integer
Public bPingDebug As Boolean

' PLCBUS
Public bPLCBUSEnabled As Boolean
Public sPLCBUSSerialPort As String
Public sPLCBUSUserCode As String
Public sPLCBUSBaudrate As String
Public iPLCBUSPollTime As Integer
Public bPLCBUSDebug As Boolean
Public bPLCBUSThreePhase As Boolean
Public sPLCBUSHouseCodes As String
Public bPLCBUSAck As Boolean
Public hPLCBUS As CPLCBUS

' CallerID
Public bCallerIDEnabled As Boolean
Public sCallerIDCountryCode As String
Public sCallerIDAreaCode As String
Public sCallerIDNationalPrefix As String
Public sCallerIDInternationalPrefix As String
Public bCallerIDAutoCreateContacts As Boolean
Public bCallerIDDebug As Boolean

' TemperatureNu
Public bTemperaturNuEnabled As Boolean
Public sTemperaturNuCity As String
Public sTemperaturNuId As Integer
Public iTemperaturNuPushTime As Integer
Public bTemperaturNuDebug As Boolean
Public iTemperaturNuDeviceId As Integer
Public sTemperaturNuDeviceValue As String

' PVoutput
Public bPVoutputEnabled As Boolean
Public sPVoutputApi As String
Public sPVoutputId As String
Public iPVoutputPushTime As Integer
Public bPVoutputDebug As Boolean
Public iPVoutputDeviceId As Integer
Public sPVoutputDeviceValue As String
Public iPVoutputTempDeviceId As Integer
Public sPVoutputTempDeviceValue As String
Public iPVoutputUsageDeviceId As Integer
Public sPVoutputUsageDeviceValue As String

' SqueezeServer
Public bSqueezeServerEnabled As Boolean
Public sSqueezeServerTCPHost As String
Public iSqueezeServerTCPPort As Integer
Public bSqueezeServerDebug As Boolean
Public hSqueezeServer As CSqueezeServer

' LEDMatrix
Public bLEDMatrixEnabled As Boolean
Public sLEDMatrixSerialPort As String
Public sLEDMatrixID As String
Public iLEDMatrixColor As Integer
Public iLEDMatrixSpeed As Integer
Public bLEDMatrixDebug As Boolean
Public hLEDMatrix As CLEDMatrix

' WeatherBug
Public bWeatherBugEnabled As Boolean
Public sWeatherBugID As String
Public sWeatherBugCity As String
Public sWeatherBugCityCode As String
Public sWeatherBugCountryName As String
Public bWeatherBugDebug As Boolean

' EZcontrol
Public bEZcontrolEnabled As Boolean
Public sEZcontrolUDPHost As String
Public iEZcontrolUDPPort As Integer = 7042
Public bEZcontrolDebug As Boolean
Public hEZcontrol As CEZcontrol

' Current Cost
Public bCurrentCostEnabled As Boolean
Public sCurrentCostSerialPort As String
Public sCurrentCostBaudrate As String
Public bCurrentCostDebug As Boolean
Public hCurrentCost As CCurrentCost

' Denon
Public bDenonEnabled As Boolean
Public sDenonTCPHost As String
Public iDenonTCPPort As Integer
Public sDenonSerialPort As String
Public sDenonBaudrate As String
Public sDenonType As String
Public bDenonDebug As Boolean
Public hDenon As CDenon

' Pioneer
Public bPioneerEnabled As Boolean
Public sPioneerTCPHost As String
Public iPioneerTCPPort As Integer
Public sPioneerSerialPort As String
Public sPioneerBaudrate As String
Public sPioneerType As String
Public bPioneerDebug As Boolean
Public hPioneer As CPioneer

' IRTrans
Public bIRTransEnabled As Boolean
Public sIRTransTCPHost As String
Public iIRTransTCPPort As Integer
Public bIRTransDebug As Boolean
Public hIRTrans As CIRTrans

' Mochad
Public bMochadEnabled As Boolean
Public sMochadTCPHost As String
Public iMochadTCPPort As Integer
Public bMochadDebug As Boolean
Public bMochadGlobalX10 As Boolean
Public hMochad As CMochad

' Onkyo/Intergra
Public bOnkyoEnabled As Boolean
Public sOnkyoTCPHost As String
Public iOnkyoTCPPort As Integer
Public sOnkyoSerialPort As String
Public sOnkyoBaudrate As String
Public sOnkyoType As String
Public bOnkyoDebug As Boolean
Public hOnkyo As COnkyo

' Anel PwrCtrl
Public bPwrCtrlEnabled As Boolean
Public iPwrCtrlUDPRead As Integer
Public iPwrCtrlUDPSend As Integer
Public bPwrCtrlDebug As Boolean
Public sPwrCtrlUserPw As String
Public hPwrCtrl As CPwrCtrl

' SharpTV
Public bSharpTVEnabled As Boolean
Public sSharpTVTCPHost As String
Public iSharpTVTCPPort As Integer
Public sSharpTVSerialPort As String
Public sSharpTVBaudrate As String
Public sSharpTVType As String
Public bSharpTVDebug As Boolean
Public hSharpTV As CSharpTV

' iViewer
Public bIViewerEnabled As Boolean
Public iIViewerTCPPort As Integer
Public bIViewerDebug As Boolean
Public sIViewerPassword As String
Public hIViewer As CIViewer

' LGTV
Public bLGTVEnabled As Boolean
Public sLGTVTCPHost As String
Public iLGTVTCPPort As Integer
Public sLGTVSerialPort As String
Public sLGTVBaudrate As String
Public sLGTVType As String
Public bLGTVDebug As Boolean
Public hLGTV As CLGTV

' iPort
Public bIPortEnabled As Boolean
Public sIPortTCPHost As String
Public iIPortTCPPort As Integer
Public sIPortSerialPort As String
Public sIPortBaudrate As String
Public sIPortType As String
Public bIPortDebug As Boolean
Public hIPort As CIPort

' Velleman K8055
Public bK8055Enabled As Boolean
Public sK8055SerialPort As String
Public iK8055BoardAddress As Integer
Public iK8055PollTime As Integer
Public iK8055DebounceTime1 As Integer
Public iK8055DebounceTime2 As Integer
Public bK8055Debug As Boolean
Public hK8055 As CK8055

' OWFS
Public bOWFSEnabled As Boolean
Public iOWFSPollTime As Integer
Public sOWFSBaseDir As String
Public bOWFSCached As Boolean
Public bOWFSDebug As Boolean
Public hOWFS As COWFS

' CUL
Public bCULEnabled As Boolean
Public sCULTCPHost As String
Public iCULTCPPort As Integer
Public sCULSerialPort As String
Public sCULBaudrate As String
Public sCULType As String
Public sCULFHTid As String
Public hCUL As CCUL
Public iCULModel As Integer
Public bCULDebug As Boolean

' xPL
Public bxPLEnabled As Boolean
Public ixPLHeartBeatTime As Integer
Public bxPLDebug As Boolean
Public hxPL As CxPL

' RFXCom xPL
Public bRFXComxPLEnabled As Boolean
Public sRFXComxPLRXAddress As String
Public sRFXComxPLTXAddress As String
Public bRFXComxPLOldAddrFmt As Boolean
Public bRFXComxPLGlobalX10 As Boolean
Public bRFXComxPLDebug As Boolean
Public hRFXComxPL As CRFXComxPL

' Shell
Public bShellEnabled As Boolean
Public iShellPollTime As Integer
Public bShellDebug As Boolean

' TelnetServer
Public bTelnetServerEnabled As Boolean
Public iTelnetServerPort As Integer
Public bTelnetServerDebug As Boolean
Public hTelnetServer As CTelnetServer

' HomeMatic (Conrad, ELV)
Public bHMEnabled As Boolean
Public sHMTCPHost As String
Public iHMTCPPort As Integer
Public hHM As CHomeMatic
Public bHMDebug As Boolean
Public sHMhmid As String
Public iHM_Pairing As Boolean
Public iHM_PairSer As Boolean
Public iHMPairSec As Integer

' Ncid
Public bNcidEnabled As Boolean
Public sNcidTCPHost As String
Public iNcidTCPPort As Integer
Public bNcidDebug As Boolean
Public hNcid As CNcid

' OpenTherm gateway
Public bOpenThermEnabled As Boolean
Public sOpenThermSerialPort As String
Public iOpenThermPollTime As Integer
Public sOpenThermThermostat As String
Public sOpenThermTemperatureOverride As String
Public bOpenThermSyncClock As Boolean
Public bOpenThermDebug As Boolean
Public sOpenThermTCPhost As String
Public sOpenThermTCPport As String
Public sOpenThermType As String
Public bOpenThermRelayEnabled As Boolean
Public iOpenThermRelayPort As Integer
Public hOpenTherm As COpenTherm

' SmartMeter
Public bSmartMeterEnabled As Boolean
Public sSmartMeterTCPHost As String
Public iSmartMeterTCPPort As Integer
Public sSmartMeterSerialPort As String
Public sSmartMeterBaudrate As String
Public iSmartMeterParity As Integer
Public iSmartMeterDatabits As Integer
Public iSmartMeterStopbits As Integer
Public sSmartMeterType As String
Public bSmartMeterDebug As Boolean
Public hSmartMeter As CSmartMeter

' XBMC xPL
Public bXBMCxPLEnabled As Boolean
Public sXBMCxPLRXAddress As String
Public sXBMCxPLTXAddress As String
Public bXBMCxPLDebug As Boolean
Public hXBMCxPL As CXBMCxPL

' MQTT
Public bMQTTEnabled As Boolean
Public sMQTTTCPHost As String
Public iMQTTTCPPort As Integer
Public sMQTTUsername As String
Public sMQTTPassword As String
Public sMQTTPubTopic As String
Public sMQTTSubTopic As String
Public iMQTTHeartbeat As Integer
Public bMQTTRetain As Boolean
Public iMQTTQoS As Integer
Public bMQTTDebug As Boolean
Public hMQTT As CMQTT

' Meteohub
Public bMeteohubEnabled As Boolean
Public sMeteohubFetchURL As String
Public iMeteohubPollTime As Integer
Public bMeteohubDebug As Boolean
Public hMeteohub As CMeteohub

' ELV MAX!
Public bELVMAXEnabled As Boolean
Public sELVMAXTCPHost As String
Public iELVMAXTCPPort As Integer
Public bELVMAXDebug As Boolean
Public hELVMAX As CELVMAX

' YouLess
Public bYouLessEnabled As Boolean
Public iYouLessPollTime As Integer
Public bYouLessDebug As Boolean
Public hYouLess As CYouLess

' KMTronicUDP
Public bKMTronicUDPEnabled As Boolean
Public iKMTronicUDPPollTime As Integer
Public iKMTronicUDPPort As Integer
Public bKMTronicUDPDebug As Boolean
Public hKMTronicUDP As CKMTronicUDP

' SmartVISUServer
Public bSmartVisuServerEnabled As Boolean
Public iSmartVisuServerPort As Integer
Public bSmartVisuServerDebug As Boolean
Public hSmartVisuServer As CSmartVisuServer

' Prowl
Public bProwlEnabled As Boolean
Public bProwlDebug As Boolean
Public sProwlApiKey As String
Public sProwlApplication As String
Public sProwlEvent As String

' NMA - Notify My Android
Public bNMAEnabled As Boolean
Public bNMADebug As Boolean
Public sNMAApiKey As String
Public sNMAApplication As String
Public sNMAEvent As String

' Pushover
Public bPushoverEnabled As Boolean
Public bPushoverDebug As Boolean
Public sPushoverToken As String
Public sPushoverUser As String
Public sPushoverDevice As String

' WeatherUnderground
Public bWeatherUGEnabled As Boolean
Public sWeatherUGApiKey As String
Public sWeatherUGCity As String
Public iWeatherUGRefresh As Integer
Public bWeatherUGDebug As Boolean

' P2000
Public bP2000Enabled As Boolean
Public sP2000Regios As String
Public iP2000Messages As Integer
Public sP2000Disciplines As String
Public sP2000Filter As String
Public iP2000GeoRange As Integer
Public bP2000FetchImage As Boolean
Public bP2000CreateMapLink As Boolean
Public iP2000PollTime As Integer
Public bP2000Debug As Boolean

' DMXPlayer
Public bDMXPlayerEnabled As Boolean
Public sDMXPlayerSerialport As String
Public sDMXPlayerBaudrate As String
Public bDMXPlayerDebug As Boolean
Public hDMXPlayer As CDMXPlayer

' GenericIO - Serial and TCP/IP interface for use with devices such as arduino
Public sGenericIOType As String
Public bGenericIOEnabled As Boolean
Public sGenericIOTCPHost As String
Public iGenericIOTCPPort As Integer
Public sGenericIOSerialPort As String
Public sGenericIOBaudrate As String
Public bGenericIODebug As Boolean
Public sGenericIORegex As String
Public sGenericIODelimiter As String
Public hGenericIO As CGenericIO


'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' this is where domotiga starts
' determine basedir, set language and run application
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Function Main() As Boolean

  Dim sBackTrace, sTrace As String

  ' determine basedir
  If Exist(Application.Path &/ "logs") Then
    sBaseDir = Application.Path
  Else If Exist(Mid$(Application.Path &/ "logs", 1, RInStr(Application.Path, "/")))
    sBaseDir = Mid$(Application.Path, 1, RInStr(Application.Path, "/"))
  Else
    Main.WriteLog("ERROR: Couldn't determine DomotiGaServer's base directory.")
    Quit
  Endif

  ' parse cmd line arguments
  ParseArgs()

  ' load program settings
  Main.GetConfig()
  ' set language
  System.Language = sLanguage
  ' start different sections
  Main.Setup_BroadcastAddrs()
  Main.Setup_Logfiles()
  Main.DisplayProgramInfo()
  Main.WriteLog("[Main] Checking directory structure ...")
  Main.CreateDirectoryTree()

  ' connect to the mysql database
  WriteLog("[Main] Connecting to database ...")
  If Not Main.ConnectDatabase() Then
    Main.WriteLog("[Main] ERROR: Couldn't open the database (called '" & Main.sSQLDatabase & "') Check '" & Main.sSettings & "' or create & load a database.")
    Quit
  Endif

  ' check versions
  CheckDatabaseVersion()

  ' start all setups for modules
  Main.WriteLog("[Main] Loading modules ...")
  Main.Setup()

  ' update house status
  Main.WriteLog("[Main] Starting main program ...")
  If Not GetGlobalVar("House_Mode") Then SetGlobalVar("House_Mode", "normal")
  If ((GetGlobalVar("Mute") = "0") Or (GetGlobalVar("Mute") = "False")) Then SetGlobalVar("Mute", False) Else SetGlobalVar("Mute", True)
  Main.ChangeHouseMode(GetGlobalVar("House_Mode"))
  Main.ChangeMuteMode(GetGlobalVar("Mute"))

  Main.WriteLog("[Main] Entering main program loop ...")

  UpdateGlobalVars()
  Check_for_Action()
  SetupTimers() ' start timers

  If Main.bMainDebug Then Main.WriteLog("[Main] Main Debug enabled.")
  SetGlobalVar("Tagline", Main.Random_Text("remarks_tags"))
  Main.WriteLog("[Main] The current tagline is '" & GetGlobalVar("Tagline") & "'")
  If bSoundEnabled Then Sounds.PlaySnd("click.wav")

  If GetGlobalVar("EmailCount") Then Main.iNewMails = GetGlobalVar("EmailCount")
  If GetGlobalVar("CallCount") Then Main.iNewCalls = GetGlobalVar("CallCount")
  If GetGlobalVar("VoiceMailCount") Then Main.iNewVoicemails = GetGlobalVar("VoiceMailCount")

  ' Catch CTRL-Z signal
  'Signal[Signal.SIGINT].Catch
  ' Catch kill -TERM signal
  'Signal[Signal.SIGTERM].Catch

  ' exit program

Catch ' error trap
  For Each sBackTrace In Error.Backtrace
    sTrace &= sBackTrace & "\n"
  Next
  Main.WriteLog("ERROR: " & Error.Text & " " & Error.Code & " at\n" & sTrace)
  Main.WriteLog("Program abort.")
  Quit

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' Catch Linux signals
' http://en.wikipedia.org/wiki/Signal_(computing)
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
'Public Sub Application_Signal(iSignal As Integer)

  ' Reset signal handler
  'Signal[iSignal].Reset

  ' We want to exit the program
  'bExitProgram = True

'End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' parse command line arguments
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Function ParseArgs()

  Dim sArg As String
  Dim iCnt As Integer

  For iCnt = 1 To Application.Args.Count - 1
    sArg = Application.Args[iCnt]
    If Left(sArg) = "-" Then
      If sArg = "-d" Then
        ' start as a daemon in the background
        Application.Daemon = True
      Else If sArg = "-h" Then
        ' display help info
        Print Application.Name & " version " & sProgramVersion
        Print "Copyright(C) 2008-" & Year(Now) & " Ron Klinkien"
        Print
        Print "This program is free software; you can redistribute it and/or"
        Print "modify it under the terms of the GNU General Public License as"
        Print "published by the Free Software Foundation; either version 2, or"
        Print "(at your option) any later version."
        Print
        Print "Usage: " & Application.Args[0] & " [options]"
        Print
        Print "Options:"
        Print " -h              display this help"
        Print " -a              allow automatic upgrade"
        Print " -c <configfile> specify config file"
        Print
        Quit
      Else If sArg = "-a" Then
        ' allow automatic database upgrade
        bAllowAutoUpgrade = True
      Else If Left(sArg, 2) = "-c" Then
        ' run with specified config file
        If Len(sArg) > 2 Then
          sSettings = Trim(Right(sArg, Len(sArg) - 2))
        Else
          If iCnt < (Application.Args.Count - 1) Then
            sSettings = Trim(Application.Args[iCnt + 1])
          Else
            Main.WriteLog("[Main] ERROR: No config filename specified, using default ...")
          Endif
        Endif
      Endif
    Endif
  Next

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' connect to the mysql database
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Function ConnectDatabase() As Boolean

  ' try to close the connection first
  Try hDB.Close

  ' get a new one
  With hDB
    .Type = "mysql"
    .Host = sSQLHost
    .Login = sSQLUser
    .Password = sSQLPass
    .Name = sSQLDatabase
    .Open
  End With

  ' all ok
  Return True

Catch ' some errors
   Main.WriteLog("[Main] MySQL ERROR: " & ERROR.Text)
   Return False

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' check if we are connected to the mysql database
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Function ConnectedDatabase() As Boolean

  ' Only return True if the connection is open
  If hDB Not Null Then
    If hDB.Opened Then Return True
  Endif
  Return False

End

'-------------------------------------------------------
' update the mysql database
'-------------------------------------------------------
Public Function UpdateDatabase() As Boolean

  Dim rResult As Result
  Dim sSalt, sMD5 As String

  rResult = Main.hDB.Exec("SELECT username, password FROM users WHERE NOT ISNULL(password) AND (length(password) != 33 OR (length(password) = 33 AND substring(password,1,3) != 'MD5'))")
  ' update the 'users' table in database: set all passwords to an md5 hash
  For Each rResult
    sMD5 = Crypt.MD5(rResult!password)
    sSalt = Right$(Left$(sMD5, 11), 8)
    sMD5 = Right$(sMD5, 22)
    Main.hDB.Exec("UPDATE users SET password = &1 WHERE username = &2", "MD5" & sSalt & sMD5, rResult!username)
    Main.WriteLog("[Main] MySQL users table password changed to MD5 hash for user '" & rResult!username & "'")
  Next
  Return True

Catch ' some errors in update db
  Main.WriteLog("[Main] MySQL Update ERROR: " & ERROR.Text)
  Return False

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' display startup information
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub DisplayProgramInfo()

  Dim sUptime, sModified As String

  With Stat(Application.Path)
    sModified = Format$(.LastModified, "yyyy-mm-dd hh:nn:ss")
  End With

  Exec ["uptime"] To sUptime
  WriteLog("[Main]  ---- Program Restart ----")
  WriteLog("[Main] Starting " & Application.Name & " V" & Main.sProgramVersion & " last updated on " & sModified)
  WriteLog("[Main] Running on host '" & System.Host & "' (pid " & Application.Id & ") as user '" & System.User.Name & "' (id " & System.User.Id & ")" & " with language " & System.Language)
  WriteLog("[Main] Program base directory is '" & sBaseDir & "'.")
  WriteLog("[Main] Database settings are loaded from '" & sSettings & "'.")
  WriteLog("[Main] Active logfiles are '" & sMainLogFile & "', '" & sSpeakLogFile & "' and '" & sDebugLogFile & "'.")
  WriteLog("[Main] Running on Gambas version " & GetGambasVersion())
  WriteLog("[Main] Server uptime is " & Left$(Replace$(sUptime, "  ", " "), -1))

  ' check if started as superuser
  If System.User.Id = 0 Then
    WriteLog("[Main] ******* You have started DomotiGaServer as superuser/root!\nDoing this imposes a huge security risk!\nSo you have been warned! *******")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' create main directory structure if incomplete
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub CreateDirectoryTree()

  If Not Exist(sBaseDir) Then
    WriteLog("[Main] Creating default directory structure.")
    Try Mkdir (sBaseDir)
    Try Mkdir (sBaseDir &/ "logs")
    Try Mkdir (sBaseDir &/ "www")
    Try Mkdir (sBaseDir &/ "icons")
    Try Mkdir (sBaseDir &/ "images")
    Try Mkdir (sBaseDir &/ "sounds")
    Try Mkdir (sBaseDir &/ "rrd")
    Try Mkdir (sBaseDir &/ "rrd/graphs")
    Try Mkdir (sBaseDir &/ "tvguide")
    Try Mkdir (sBaseDir &/ "tvguide/imdb")
    Try Mkdir (sBaseDir &/ "tvguide/cache")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' save settings to file
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub SetConfig()

  SetConfigValue("MySQL/Host", sSQLHost)
  SetConfigValue("MySQL/User", sSQLUser)
  SetConfigValue("MySQL/Password", sSQLPass)
  SetConfigValue("MySQL/Database", sSQLDatabase)
  SetConfigValue("Program/Language", sLanguage)

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' load config, create default config file if not found
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub GetConfig()

  Dim hSettings As Settings

  ' load basic settings from file, if the settings file is not
  ' found then create one with default settings
  If Not Exist(sBaseDir &/ sSettings) Then
    hSettings = New Settings(sBaseDir &/ sSettings)
    hSettings["MySQL/Host"] = "localhost"
    hSettings["MySQL/User"] = "domouser"
    hSettings["MySQL/Password"] = "kung-fu"
    hSettings["MySQL/Database"] = "domotiga"
    hSettings["Program/Language"] = "en_US.UTF-8"
    hSettings.Save
    ' re-load
    GetConfig()
    Main.WriteLog("[Main] Couldn't open config file called '" & Main.sSettings & "'. Created one with default settings!")
  Else
    sSQLHost = GetConfigValue("MySQL/Host", "localhost")
    sSQLUser = GetConfigValue("MySQL/User", "domouser")
    sSQLPass = GetConfigValue("MySQL/Password", "kung-fu")
    sSQLDatabase = GetConfigValue("MySQL/Database", "domotiga")
    sLanguage = GetConfigValue("Program/Language", "en_US.UTF-8")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' get all settings from settings_ database tables
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub GetSettings()

  Dim rResult As Result

  ' Main
  rResult = GetSettingTable("main")
  bMainDebug = rResult!debug
  bDevicesDebug = rResult!debugdevices
  bEventsDebug = rResult!debugevents
  bEnergyDebug = rResult!debugenergy
  iMainFlushTime = rResult!flushtime
  iLogBuffer = rResult!logbuffer
  bAutoDeviceCreate = rResult!autodevicecreate
  sLogPrefix = rResult!logprefix

  ' Sound
  rResult = GetSettingTable("sound")
  bSoundEnabled = rResult!enabled
  bSoundDebug = rResult!debug
  iSoundVolume = rResult!volume

  ' Voice Text
  rResult = GetSettingTable("voicetext")
  bVoiceTextEnabled = rResult!enabled
  sVoiceTextEngine = rResult!engine
  sVoiceTextPrefixCmd = rResult!prefixcmd
  sVoiceTextVoicesMale = rResult!voicesmale
  sVoiceTextVoicesFemale = rResult!voicesfemale
  bVoiceTextDebug = rResult!debug

  ' Astro and Location
  rResult = GetSettingTable("astro")
  iAstroLatitude = rResult!latitude
  iAstroLongitude = rResult!longitude
  iAstroTimezone = rResult!timezone
  sAstroTwilight = rResult!twilight
  sAstroSeasons = rResult!seasons
  sAstroSeasonStarts = rResult!seasonstarts
  bAstroDebug = rResult!debug
  sTemperature = rResult!temperature
  sCurrency = rResult!currency
  bAstroDST = rResult!dst

  ' X10Cmd
  rResult = GetSettingTable("x10cmd")
  bX10CmdEnabled = rResult!enabled
  sX10CmdCommand = rResult!command
  bX10CmdMonitor = rResult!monitor
  bX10CmdGlobalX10 = rResult!globalx10
  bX10CmdDebug = rResult!debug
  iX10CmdType = rResult!type

  ' Thermostat
  rResult = GetSettingTable("thermostat")
  bThermostatEnabled = rResult!enabled
  bThermostatDebug = rResult!debug
  iThermostatPollTime = rResult!polltime

  ' CTX35
  rResult = GetSettingTable("ctx35")
  bCTX35Enabled = rResult!enabled
  sCTX35SerialPort = rResult!serialport
  sCTX35Baudrate = rResult!baudrate
  iCTX35PollTime = rResult!polltime
  bCTX35GlobalX10 = rResult!globalx10
  bCTX35Debug = rResult!debug

  ' SMS
  rResult = GetSettingTable("sms")
  bSMSEnabled = rResult!enabled
  sSMSSerialPort = rResult!serialport
  sSMSBaudrate = rResult!baudrate
  iSMSPollTime = rResult!polltime
  sSMSPIN = rResult!pin
  sSMSServiceCentre = rResult!servicecentre
  sSMSContact = rResult!contact
  bSMSDebug = rResult!debug

  ' E-Mail
  rResult = GetSettingTable("email")
  bEmailEnabled = rResult!enabled
  sEmailSMTPServer = rResult!smtpserver
  iEmailSMTPPort = rResult!smtpport
  sEmailFromAddress = rResult!fromaddress
  sEmailToAddress = rResult!toaddress
  bEmailDebug = rResult!debug
  sEmailUserName = rResult!username
  sEmailPassword = rResult!password
  bEmailSSL = rResult!sslenabled

  ' GMail RSS
  rResult = GetSettingTable("gmail")
  bGmailEnabled = rResult!enabled
  sGmailUser = rResult!user
  sGmailPassword = rResult!password
  iGmailPollTime = rResult!polltime
  bGmailDebug = rResult!debug

  ' UPS
  rResult = GetSettingTable("ups")
  bUPSEnabled = rResult!enabled
  sUPSTCPHost = rResult!tcphost
  iUPSTCPPort = rResult!tcpport
  iUPSPollTime = rResult!polltime
  bUPSDebug = rResult!debug

  ' GPS
  rResult = GetSettingTable("gps")
  bGPSEnabled = rResult!enabled
  sGPSSerialPort = rResult!serialport
  sGPSBaudrate = rResult!baudrate
  iGPSPollTime = rResult!polltime
  bGPSDebug = rResult!debug

  ' Temp08
  rResult = GetSettingTable("temp08")
  bTemp08Enabled = rResult!enabled
  sTemp08SerialPort = rResult!serialport
  sTemp08Baudrate = rResult!baudrate
  bTemp08Debug = rResult!debug

  ' VISCA
  rResult = GetSettingTable("visca")
  bVISCAEnabled = rResult!enabled
  sVISCASerialPort = rResult!serialport
  sVISCABaudrate = rResult!baudrate
  iVISCACameraAddress = rResult!cameraaddress
  sVISCAVideoDevice = rResult!device
  bVISCADebug = rResult!debug

  ' HDDTemp
  rResult = GetSettingTable("hddtemp")
  bHDDTempEnabled = rResult!enabled
  sHDDTempTCPHost = rResult!tcphost
  iHDDTempTCPPort = rResult!tcpport
  iHDDTempPollTime = rResult!polltime
  iHDDTempThreshold = rResult!threshold
  bHDDTempDebug = rResult!debug

  ' VideoServer
  rResult = GetSettingTable("videoserver")
  bVideoServerEnabled = rResult!enabled
  sVideoServerAddress = rResult!tcphost
  iVideoServerPort = rResult!tcpport
  sVideoServerUser = rResult!user
  sVideoServerPassword = rResult!password
  bVideoServerDebug = rResult!debug
  sVideoServerChannel1 = rResult!channel1
  sVideoServerChannel2 = rResult!channel2
  sVideoServerChannel3 = rResult!channel3
  sVideoServerChannel4 = rResult!channel4

  ' RRDTool
  rResult = GetSettingTable("rrdtool")
  bRRDToolEnabled = rResult!enabled
  iRRDToolPollTime = rResult!polltime
  sRRDToolRRA = rResult!rra
  bRRDToolDebug = rResult!debug

  ' Asterisk *
  rResult = GetSettingTable("asterisk")
  bAsteriskEnabled = rResult!enabled
  sAsteriskTCPHost = rResult!tcphost
  iAsteriskTCPPort = rResult!tcpport
  iAsteriskPollTime = rResult!polltime
  sAsteriskUser = rResult!user
  sAsteriskPassword = rResult!password
  bAsteriskDebug = rResult!debug

  ' Bluetooth
  rResult = GetSettingTable("bluetooth")
  bBluetoothEnabled = rResult!enabled
  sBluetoothDevice = rResult!device
  iBluetoothThreshold = rResult!threshold
  iBluetoothPollTime = rResult!polltime
  bBluetoothDebug = rResult!debug

  ' Weeder I/O
  rResult = GetSettingTable("weeder")
  bWeederEnabled = rResult!enabled
  sWeederSerialPort = rResult!serialport
  bWeederDebug = rResult!debug

  ' XML TVGuide
  rResult = GetSettingTable("tvguide")
  bTVGuideEnabled = rResult!enabled
  sTVGuideXMLGrabCommand = rResult!xmlgrabcmd
  sTVGuideXMLFile = rResult!xmlfile
  bTVGuideDebug = rResult!debug

  ' Server Stats
  rResult = GetSettingTable("serverstats")
  bServerStatsEnabled = rResult!enabled
  sServerStatsName = rResult!servername
  bServerStatsDebug = rResult!debug

  ' IRMan Infrared
  rResult = GetSettingTable("irman")
  bIRManEnabled = rResult!enabled
  sIRManSerialPort = rResult!serialport
  bIRManDebug = rResult!debug

  ' Plugwise
  rResult = GetSettingTable("plugwise")
  bPlugwiseEnabled = rResult!enabled
  iPlugwisePollTime = rResult!polltime
  sPlugwiseSerialPort = rResult!serialport
  bPlugwiseDebug = rResult!debug

  ' Fritz!Box
  rResult = GetSettingTable("fritzbox")
  bFritzBoxEnabled = rResult!enabled
  sFritzBoxTCPHost = rResult!tcphost
  bFritzBoxDebug = rResult!debug

  ' XMLRPC
  rResult = GetSettingTable("xmlrpc")
  bXMLRPCEnabled = rResult!enabled
  iXMLRPCMaxConn = rResult!maxconn
  iXMLRPCHTTPPort = rResult!httpport
  bXMLRPCDebug = rResult!debug
  bBroadcastUDPEnabled = rResult!broadcastudp

  ' Bwired GoogleMap
  rResult = GetSettingTable("bwiredmap")
  bBwiredMapEnabled = rResult!enabled
  sBwiredMapTitle = rResult!title
  sBwiredMapWebsite = rResult!website
  sBwiredMapWebsitePicUrl = rResult!websitepicurl
  sBwiredMapUser = rResult!user
  sBwiredMapPassword = rResult!password
  sBwiredMapScreenName = rResult!screenname
  sBwiredMapGpsLat = rResult!gpslat
  sBwiredMapGpsLong = rResult!gpslong
  sBwiredMapCity = rResult!city
  iBwiredMapPushTime = rResult!pushtime
  bBwiredMapDebug = rResult!debug

  ' Twitter
  rResult = GetSettingTable("twitter")
  bTwitterEnabled = rResult!enabled
  sTwitterUser = rResult!username
  sTwitterPassword = rResult!password
  bTwitterTimeStamp = rResult!sendtimestamp
  bTwitterDebug = rResult!debug

  ' DSC Security
  rResult = GetSettingTable("dsc")
  bDSCEnabled = rResult!enabled
  sDSCSerialPort = rResult!serialport
  sDSCBaudrate = rResult!baudrate
  iDSCType = rResult!type
  sDSCMasterCode = rResult!mastercode
  bDSCDebug = rResult!debug

  ' Visonic Security
  rResult = GetSettingTable("visonic")
  bVisonicEnabled = rResult!enabled
  sVisonicSerialPort = rResult!serialport
  iVisonicType = rResult!type
  sVisonicMasterCode = rResult!mastercode
  bVisonicDebug = rResult!debug

  ' KNX/EIB
  rResult = GetSettingTable("eib")
  bEIBEnabled = rResult!enabled
  sEIBTCPHost = rResult!tcphost
  iEIBTCPPort = rResult!tcpport
  bEIBDebug = rResult!debug

  ' Domotica
  rResult = GetSettingTable("domotica")
  bDomoticaEnabled = rResult!enabled
  sDomoticaSerialPort = rResult!serialport
  bDomoticaDebug = rResult!debug

  ' Digitemp
  rResult = GetSettingTable("digitemp")
  bDigitempEnabled = rResult!enabled
  sDigitempCommand = rResult!command
  sDigitempConfig = rResult!config
  iDigitempReadTime = rResult!readtime
  iDigitempPollTime = rResult!polltime
  bDigitempDebug = rResult!debug

  ' Z-Wave
  rResult = GetSettingTable("zwave")
  bZWaveEnabled = rResult!enabled
  sZWaveSerialPort = rResult!serialport
  bZWaveDebug = rResult!debug
  iZWavePollTime = rResult!polltime
  sZWavePollTimeListening = rResult!polltimelistening
  bZWaveEnablePollListening = rResult!enablepolllistening
  sZWavePollTimeSleeping = rResult!polltimesleeping
  bZWaveEnablePollSleeping = rResult!enablepollsleeping
  sZWaveUpdateNeighbor = rResult!updateneighbor
  bZWaveEnableUpdateNeighbor = rResult!enableupdateneighbor

  ' One-Wire Weather
  rResult = GetSettingTable("oww")
  bOWWEnabled = rResult!enabled
  sOWWTCPHost = rResult!tcphost
  iOWWTCPPort = rResult!tcpport
  sOWWServerType = rResult!servertype
  bOWWDebug = rResult!debug

  ' LIRC
  rResult = GetSettingTable("lirc")
  bLIRCEnabled = rResult!enabled
  sLIRCTCPHost = rResult!tcphost
  iLIRCTCPPort = rResult!tcpport
  bLIRCDebug = rResult!debug

  ' Pachube
  rResult = GetSettingTable("pachube")
  bPachubeEnabled = rResult!enabled
  iPachubeFeed = rResult!feed
  sPachubeAPIKey = rResult!apikey
  iPachubePushTime = rResult!pushtime
  bPachubeDebug = rResult!debug

  ' JeeLabs JeeLink
  rResult = GetSettingTable("jeelabs")
  bJeeLabsEnabled = rResult!enabled
  sJeeLabsSerialPort = rResult!serialport
  sJeeLabsBaudrate = rResult!baudrate
  bJeeLabsDebug = rResult!debug

  ' Ping
  rResult = GetSettingTable("ping")
  bPingEnabled = rResult!enabled
  iPingPollTime = rResult!polltime
  bPingDebug = rResult!debug

  ' PLCBUS
  rResult = GetSettingTable("plcbus")
  bPLCBUSEnabled = rResult!enabled
  sPLCBUSSerialPort = rResult!serialport
  sPLCBUSBaudrate = rResult!baudrate
  sPLCBUSUserCode = rResult!usercode
  iPLCBUSPollTime = rResult!polltime
  bPLCBUSThreePhase = rResult!threephase
  sPLCBUSHouseCodes = rResult!housecodes
  bPLCBUSAck = rResult!ack
  bPLCBUSDebug = rResult!debug

  ' CallerID
  rResult = GetSettingTable("callerid")
  bCallerIDEnabled = rResult!enabled
  sCallerIDCountryCode = rResult!countrycode
  sCallerIDAreaCode = rResult!areacode
  sCallerIDNationalPrefix = rResult!prefixnational
  sCallerIDInternationalPrefix = rResult!prefixinternational
  bCallerIDAutoCreateContacts = rResult!autocreatecontacts
  bCallerIDDebug = rResult!debug

  ' TemperaturNu
  rResult = GetSettingTable("temperaturnu")
  bTemperaturNuEnabled = rResult!enabled
  sTemperaturNuCity = rResult!city
  sTemperaturNuId = rResult!apikey
  iTemperaturNuPushTime = rResult!pushtime
  iTemperaturNuDeviceId = rResult!deviceid
  sTemperaturNuDeviceValue = rResult!devicevalue
  bTemperaturNuDebug = rResult!debug

  ' PVoutput
  rResult = GetSettingTable("pvoutput")
  bPVoutputEnabled = rResult!enabled
  sPVoutputApi = rResult!api
  sPVoutputId = rResult!pvoutputid
  iPVoutputPushTime = rResult!pushtime
  iPVoutputDeviceId = rResult!deviceid
  sPVoutputDeviceValue = rResult!devicevalue
  iPVoutputTempDeviceId = rResult!tempdeviceid
  sPVoutputTempDeviceValue = rResult!tempdevicevalue
  iPVoutputUsageDeviceId = rResult!usagedeviceid
  sPVoutputUsageDeviceValue = rResult!usagedevicevalue
  bPVoutputDebug = rResult!debug

  ' Squeeze Server
  rResult = GetSettingTable("squeezeserver")
  bSqueezeServerEnabled = rResult!enabled
  sSqueezeServerTCPHost = rResult!tcphost
  iSqueezeServerTCPPort = rResult!tcpport
  bSqueezeServerDebug = rResult!debug

  ' LED Matrix
  rResult = GetSettingTable("ledmatrix")
  bLEDMatrixEnabled = rResult!enabled
  sLEDMatrixSerialPort = rResult!serialport
  sLEDMatrixID = rResult!displayid
  iLEDMatrixColor = rResult!color
  iLEDMatrixSpeed = rResult!speed
  bLEDMatrixDebug = rResult!debug

  ' WeatherBug
  rResult = GetSettingTable("weatherbug")
  bWeatherBugEnabled = rResult!enabled
  sWeatherBugID = rResult!weatherbugid
  sWeatherBugCity = rResult!city
  sWeatherBugCityCode = rResult!citycode
  sWeatherBugCountryName = rResult!countryname
  bWeatherBugDebug = rResult!debug

  ' EZcontrol
  rResult = GetSettingTable("ezcontrol")
  bEZcontrolEnabled = rResult!enabled
  sEZcontrolUDPHost = rResult!udphost
  bEZcontrolDebug = rResult!debug

  ' Current Cost
  rResult = GetSettingTable("currentcost")
  bCurrentCostEnabled = rResult!enabled
  sCurrentCostSerialPort = rResult!serialport
  sCurrentCostBaudrate = rResult!baudrate
  bCurrentCostDebug = rResult!debug

  ' Denon
  rResult = GetSettingTable("denon")
  bDenonEnabled = rResult!enabled
  sDenonTCPHost = rResult!tcphost
  iDenonTCPPort = rResult!tcpport
  sDenonType = rResult!type
  sDenonSerialPort = rResult!serialport
  sDenonBaudrate = rResult!baudrate
  bDenonDebug = rResult!debug

  ' Pioneer
  rResult = GetSettingTable("pioneer")
  bPioneerEnabled = rResult!enabled
  sPioneerTCPHost = rResult!tcphost
  iPioneerTCPPort = rResult!tcpport
  sPioneerType = rResult!type
  sPioneerSerialPort = rResult!serialport
  sPioneerBaudrate = rResult!baudrate
  bPioneerDebug = rResult!debug

  ' IRTrans
  rResult = GetSettingTable("irtrans")
  bIRTransEnabled = rResult!enabled
  sIRTransTCPHost = rResult!tcphost
  iIRTransTCPPort = rResult!tcpport
  bIRTransDebug = rResult!debug

  ' Mochad
  rResult = GetSettingTable("mochad")
  bMochadEnabled = rResult!enabled
  sMochadTCPHost = rResult!tcphost
  iMochadTCPPort = rResult!tcpport
  bMochadGlobalX10 = rResult!globalX10
  bMochadDebug = rResult!debug

  ' Onkyo/Integra
  rResult = GetSettingTable("onkyo")
  bOnkyoEnabled = rResult!enabled
  sOnkyoTCPHost = rResult!tcphost
  iOnkyoTCPPort = rResult!tcpport
  sOnkyoType = rResult!type
  sOnkyoSerialPort = rResult!serialport
  sOnkyoBaudrate = rResult!baudrate
  bOnkyoDebug = rResult!debug

  ' Anel PWrCtrl
  rResult = GetSettingTable("pwrctrl")
  bPwrCtrlEnabled = rResult!enabled
  iPwrCtrlUDPRead = rResult!udpread
  iPwrCtrlUDPSend = rResult!udpsend
  sPwrCtrlUserPw = rResult!userpw
  bPwrCtrlDebug = rResult!debug

  ' SharpTV
  rResult = GetSettingTable("sharptv")
  bSharpTVEnabled = rResult!enabled
  sSharpTVTCPHost = rResult!tcphost
  iSharpTVTCPPort = rResult!tcpport
  sSharpTVType = rResult!type
  sSharpTVSerialPort = rResult!serialport
  sSharpTVBaudrate = rResult!baudrate
  bSharpTVDebug = rResult!debug

  ' iViewer
  rResult = GetSettingTable("iviewer")
  bIViewerEnabled = rResult!enabled
  iIViewerTCPPort = rResult!tcpport
  sIViewerPassword = rResult!password
  bIViewerDebug = rResult!debug

  ' iPort
  rResult = GetSettingTable("iport")
  bIPortEnabled = rResult!enabled
  sIPortTCPHost = rResult!tcphost
  iIPortTCPPort = rResult!tcpport
  sIPortType = rResult!type
  sIPortSerialPort = rResult!serialport
  sIPortBaudrate = rResult!baudrate
  bIPortDebug = rResult!debug

  ' LGTV
  rResult = GetSettingTable("lgtv")
  bLGTVEnabled = rResult!enabled
  sLGTVTCPHost = rResult!tcphost
  iLGTVTCPPort = rResult!tcpport
  sLGTVType = rResult!type
  sLGTVSerialPort = rResult!serialport
  sLGTVBaudrate = rResult!baudrate
  bLGTVDebug = rResult!debug

  ' Velleman K8055
  rResult = GetSettingTable("k8055")
  bK8055Enabled = rResult!enabled
  iK8055BoardAddress = rResult!boardaddress
  iK8055PollTime = rResult!polltime
  iK8055DebounceTime1 = rResult!debouncetime1
  iK8055DebounceTime2 = rResult!debouncetime2
  bK8055Debug = rResult!debug

  ' OWFS
  rResult = GetSettingTable("owfs")
  bOWFSEnabled = rResult!enabled
  sOWFSBaseDir = rResult!basedir
  bOWFSCached = rResult!cached
  iOWFSPollTime = rResult!polltime
  bOWFSDebug = rResult!debug

  ' CUL
  rResult = GetSettingTable("cul")
  bCULEnabled = rResult!enabled
  sCULTCPHost = rResult!tcphost
  iCULTCPPort = rResult!tcpport
  sCULType = rResult!type
  sCULSerialPort = rResult!serialport
  sCULBaudrate = rResult!baudrate
  sCULFHTid = rResult!fhtid
  iCULModel = rResult!model
  bCULDebug = rResult!debug

  ' xPL
  rResult = GetSettingTable("xpl")
  bxPLEnabled = rResult!enabled
  ixPLHeartBeatTime = rResult!heartbeat
  bxPLDebug = rResult!debug

  ' RFXCom xPL
  rResult = GetSettingTable("rfxcomxpl")
  bRFXComxPLEnabled = rResult!enabled
  sRFXComxPLRXAddress = rResult!rxaddress
  sRFXComxPLTXAddress = rResult!txaddress
  bRFXComxPLOldAddrFmt = rResult!oldaddrfmt
  bRFXComxPLGlobalX10 = rResult!globalx10
  bRFXComxPLDebug = rResult!debug

  ' Shell
  rResult = GetSettingTable("shell")
  bShellEnabled = rResult!enabled
  iShellPollTime = rResult!polltime
  bShellDebug = rResult!debug

  ' TelnetServer
  rResult = GetSettingTable("telnetserver")
  bTelnetServerEnabled = rResult!enabled
  iTelnetServerPort = rResult!telnetport
  bTelnetServerDebug = rResult!debug

  ' Ncid
  rResult = GetSettingTable("ncid")
  bNcidEnabled = rResult!enabled
  sNcidTCPHost = rResult!tcphost
  iNcidTCPPort = rResult!tcpport
  bNcidDebug = rResult!debug

  ' HomeMatic
  rResult = GetSettingTable("homematic")
  bHMEnabled = rResult!enabled
  sHMTCPHost = rResult!tcphost
  iHMTCPPort = rResult!tcpport
  sHMhmid = rResult!hmid
  bHMDebug = rResult!debug

  ' OpenTherm gateway
  rResult = GetSettingTable("opentherm")
  bOpenThermEnabled = rResult!enabled
  sOpenThermSerialPort = rResult!serialport
  sOpenThermTCPhost = rResult!tcphost
  sOpenThermTCPport = rResult!tcpport
  sOpenThermType = rResult!type
  sOpenThermThermostat = rResult!thermostat
  iOpenThermPollTime = rResult!polltime
  bOpenThermDebug = rResult!debug
  sOpenThermTemperatureOverride = rResult!temperatureoverride
  bOpenThermRelayEnabled = rResult!relayenabled
  iOpenThermRelayPort = rResult!relayport
  bOpenThermSyncClock = rResult!syncclock

  ' SmartMeter
  rResult = GetSettingTable("nta8130")
  bSmartMeterEnabled = rResult!enabled
  sSmartMeterTCPHost = rResult!tcphost
  iSmartMeterTCPPort = rResult!tcpport
  sSmartMeterType = rResult!type
  sSmartMeterSerialPort = rResult!serialport
  sSmartMeterBaudrate = rResult!baudrate
  iSmartMeterDatabits = rResult!databits
  iSmartMeterStopbits = rResult!stopbits
  iSmartMeterParity = rResult!parity
  bSmartMeterDebug = rResult!debug

  ' XBMC xPL
  rResult = GetSettingTable("xbmcxpl")
  bXBMCxPLEnabled = rResult!enabled
  sXBMCxPLRXAddress = rResult!rxaddress
  sXBMCxPLTXAddress = rResult!txaddress
  bXBMCxPLDebug = rResult!debug

  ' MQTT
  rResult = GetSettingTable("mqtt")
  bMQTTEnabled = rResult!enabled
  sMQTTTCPHost = rResult!tcphost
  iMQTTTCPPort = rResult!tcpport
  sMQTTUsername = rResult!username
  sMQTTPassword = rResult!password
  sMQTTPubTopic = rResult!pubtopic
  sMQTTSubTopic = rResult!subtopic
  iMQTTHeartbeat = rResult!heartbeat
  bMQTTRetain = rResult!retain
  iMQTTQoS = rResult!qos
  bMQTTDebug = rResult!debug

  ' Meteohub
  rResult = GetSettingTable("meteohub")
  bMeteohubEnabled = rResult!enabled
  sMeteohubFetchURL = rResult!fetchurl
  iMeteohubPollTime = rResult!polltime
  bMeteohubDebug = rResult!debug

  ' ELV MAX!
  rResult = GetSettingTable("elvmax")
  bELVMAXEnabled = rResult!enabled
  sELVMAXTCPHost = rResult!tcphost
  iELVMAXTCPPort = rResult!tcpport
  bELVMAXDebug = rResult!debug

  ' YouLess
  rResult = GetSettingTable("youless")
  bYouLessEnabled = rResult!enabled
  iYouLessPollTime = rResult!polltime
  bYouLessDebug = rResult!debug

  ' KMTronicUDP
  rResult = GetSettingTable("kmtronicudp")
  bKMTronicUDPEnabled = rResult!enabled
  iKMTronicUDPPort = rResult!udpport
  iKMTronicUDPPollTime = rResult!polltime
  bKMTronicUDPDebug = rResult!debug

  ' SmartVISUServer
  rResult = GetSettingTable("smartvisu")
  bSmartVisuServerEnabled = rResult!enabled
  iSmartVisuServerPort = rResult!tcpport
  bSmartVisuServerDebug = rResult!debug

  ' Prowl
  rResult = GetSettingTable("prowl")
  bProwlEnabled = rResult!enabled
  bProwlDebug = rResult!debug
  sProwlApiKey = rResult!apikey
  sProwlApplication = rResult!application
  sProwlEvent = rResult!event

  ' NMA = Notify My Android
  rResult = GetSettingTable("nma")
  bNMAEnabled = rResult!enabled
  bNMADebug = rResult!debug
  sNMAApiKey = rResult!apikey
  sNMAApplication = rResult!application
  sNMAEvent = rResult!event

  ' Pushover
  rResult = GetSettingTable("pushover")
  bPushoverEnabled = rResult!enabled
  bPushoverdebug = rResult!debug
  sPushoverToken = rResult!token
  sPushoverUser = rResult!user
  sPushoverDevice = rResult!device

  ' Weather Underground
  rResult = GetSettingTable("weatherug")
  bWeatherUGEnabled = rResult!enabled
  sWeatherUGApiKey = rResult!apikey
  sWeatherUGCity = rResult!city
  iWeatherUGRefresh = rResult!polltime
  bWeatherUGDebug = rResult!debug

  ' P2000
  rResult = GetSettingTable("p2000")
  bP2000Enabled = rResult!enabled
  sP2000Regios = rResult!regios
  iP2000Messages = rResult!messages
  sP2000Disciplines = rResult!discipline
  sP2000Filter = rResult!filter
  iP2000GeoRange = rResult!georange
  bP2000FetchImage = rResult!fetchimage
  bP2000CreateMapLink = rResult!maplink
  iP2000PollTime = rResult!polltime
  bP2000Debug = rResult!debug

  ' DMXPlayer
  rResult = GetSettingTable("dmxplayer")
  bDMXPlayerEnabled = rResult!enabled
  sDMXPlayerSerialport = rResult!serialport
  sDMXPlayerBaudrate = rResult!baudrate
  bDMXPlayerDebug = rResult!debug

  ' GenericIO
  rResult = GetSettingTable("genericio")
  bGenericIOEnabled = rResult!enabled
  sGenericIOTCPHost = rResult!tcphost
  iGenericIOTCPPort = rResult!tcpport
  sGenericIOType = rResult!type
  sGenericIOSerialPort = rResult!serialport
  sGenericIOBaudrate = rResult!baudrate
  bGenericIODebug = rResult!debug
  sGenericIORegex = rResult!regex
  sGenericIODelimiter = rResult!delimiter



Catch
  WriteLog("[Main] ERROR: " & Error.Text & " " & Error.Code & " while loading settings at " & Error.Where & "!\nIs your database version correct?")

  CloseAll()
  Quit

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' set a value in the config file
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub SetConfigValue(sKey As String, vValue As Variant)

   Dim hSettings As Settings

   hSettings = New Settings(sBaseDir &/ sSettings)
   hSettings[sKey] = vValue
   hSettings.Save

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' get a value from the config file
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Function GetConfigValue(sKey As String, Optional vValue As Variant) As Variant

  Dim hSettings As Settings

  hSettings = New Settings(sBaseDir &/ sSettings)

  If Not IsNull(vValue) Then
    Return hSettings[sKey, vValue]
  Else
    Return hSettings[sKey]
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' display text on console and save to log
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub WriteLog(sText As String, Optional bStrip As Boolean)

  If Not bStrip Then sText &= "\n"
  sText = Format$(Now, "yyyy/mm/dd hh:nn:ss") & " " & sText
  Print sText;
  If hMainLogFile Then
    Print #hMainLogFile, sText;
    Flush #hMainLogFile
  Endif
  Main.BroadcastEvent("[MainLog]" & sLogPrefix & sText)

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' display text on console and save to log
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub WriteSpeakLog(sText As String, Optional bStrip As Boolean)

  If Not bStrip Then sText &= "\n"

  sText = Format$(Now, "yyyy/mm/dd hh:nn:ss") & " " & sText
  Print sText;
  If hSpeakLogFile Then
    Print #hSpeakLogFile, sText;
    Flush #hSpeakLogFile
  Endif
  Main.BroadcastEvent("[SpeakLog]" & sLogPrefix & sText)

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' display text on console and save to log
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub WriteDebugLog(sText As String, Optional bStrip As Boolean)

  If Not bStrip Then sText &= "\n"
  sText = Format$(Now, "yyyy/mm/dd hh:nn:ss") & " " & sText
  Print sText;
  If hDebugLogFile Then
    Print #hDebugLogFile, sText;
    Flush #hDebugLogFile
  Endif
  Main.BroadcastEvent("[DebugLog]" & sLogPrefix & sText)

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' display text on console and save to log without date/time (for RFXCom)
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub WriteRFXDebugLog(sText As String, Optional bStrip As Boolean)

  If Not bStrip Then sText = Format$(Now, "yyyy/mm/dd hh:nn:ss") & " " & sText
  Print sText;
  If hDebugLogFile Then
    Print #hDebugLogFile, sText;
    Flush #hDebugLogFile
  Endif
  Main.BroadcastEvent("[DebugLog]" & sText)

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' return version of gambas we are running with
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Function GetGambasVersion() As String

  Dim sVer As String

  Shell "gbx" & System.Version & " -V " To sVer
  Return Trim(Mid$(sVer, InStr(sVer, "-") + 1))

Catch
  Return "?"

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' get settings table from db, return defaults if not found
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Function GetSettingTable(sGroup As String, Optional bDefault As Boolean) As Result

  Dim rResult As Result

  If bDefault Then
    rResult = hDB.Exec("SELECT * FROM " & hDB.Quote("settings_" & sGroup) & " WHERE id = 0") ' load default settings
  Else
    rResult = hDB.Exec("SELECT * FROM " & hDB.Quote("settings_" & sGroup) & " WHERE id = 1") ' try to load active settings
    If (rResult.Count < 1) Then
      hDB.Exec("SELECT * FROM " & hDB.Quote("settings_" & sGroup) & " WHERE id = 0") ' fall back to defaults
    Endif
  Endif

  Return rResult

Catch
  WriteLog("[Main] GetSettings ERROR: " & Error.Text & " for " & sGroup)

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' close all what's open
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub CloseAll()

  ' stop all running timers
  StopTimers()

  ' save all globalvars in db
  If bServer Then SaveGlobalVars()
  ' dmxplayer close
  Try hDMXPlayer.Disconnect
  ' smartvisu close
  Try hSmartVisuServer.Disconnect
  ' kmtronicudp close
  Try hKMTronicUDP.Disconnect
  ' YouLess close
  Try hYouLess.Disconnect
  ' ELV MAX! close
  Try hELVMAX.Disconnect
  ' Meteohub close
  Try hMeteohub.Disconnect
  ' MQTT close
  Try hMQTT.Disconnect
  ' XBMCxPl close
  Try hXBMCxPL = Null
  ' SmartMeter
  Try hSmartMeter.Disconnect
  ' OpenTherm gateway close
  Try hOpenTherm.Disconnect
  ' telnetserver close
  Try hTelnetServer.Disconnect
  ' HomeMatic close
  Try hHM.Disconnect
  ' ping
  Try Ping.tPing.Stop
  ' shell
  Try Shell.tShell.Stop
  ' xpl close
  Try hxPL.Disconnect
  ' cul close
  Try hCUL.Disconnect
  ' k8055 close
  Try hK8055.Disconnect
  ' stop X10Cmd Heyu monitor
  Try X10Cmd.Monitor_Stop
  ' iviewer close
  Try hIViewer.Disconnect
  ' squeezeserver close
  Try hSqueezeServer.Disconnect
  ' UDP broadcast server close
  Try hBroadcastEvent.Close
  ' pachube
  Try Pachube.hPost.Close
  ' hddtemp
  Try HDDTemp.hHDDTemp.Close
  ' plcbus close
  Try hPLCBUS.Disconnect
  ' ctx35 close
  Try hCTX35.Disconnect
  ' ledmatrix close
  Try hLEDMatrix.Disconnect
  ' rfxcom close
  Try hRFXComxPL = Null
  ' ups close
  Try hUPS.Disconnect
  ' sms close
  Try hSMS.Disconnect
  ' gps close
  Try hGPS.Disconnect
  ' temp08 close
  Try hTemp08.Disconnect
  ' visca close
  Try hVISCA.Disconnect
  ' asterisk TCP socket close
  Try hAsterisk.Disconnect
  ' weeder close
  Try hWeeder.Disconnect
  ' irman close
  Try hIRMan.Disconnect
  ' plugwise close
  Try hPlugwise.Disconnect
  ' fritzbox close
  Try hFritzBox.Disconnect
  ' xmlrpc close
  Try hXMLRPC.Disconnect
  ' dsc close
  Try hDSC.Disconnect
  ' Visonic close
  Try hVisonic.Disconnect
  ' denon close
  Try hDenon.Disconnect
  ' Pioneer close
  Try hPioneer.Disconnect
  ' onkyo close
  Try hOnkyo.Disconnect
  ' mochad close
  Try hMochad.Disconnect
  ' irtrans close
  Try hIRTrans.Disconnect
  ' ncid close
  Try hNcid.Disconnect
  ' eib close
  Try hEIB.Disconnect
  ' domotica close
  Try hDomotica.Disconnect
  ' z-wave close
  Try hZWave.Disconnect
  ' one-wire weather close
  Try hOWWTCP.Disconnect
  Try hOWWUDP.Disconnect
  ' lirc close
  Try hLIRC.Disconnect
  ' jeelabs close
  Try hJeeLabs.Disconnect
  ' ezcontrol close
  Try hEZcontrol.Disconnect()
  ' current cost close
  Try hCurrentCost.Disconnect()
  ' pwrctrl cloese
  Try hPwrCtrl.Disconnect()
  ' sharptv close
  Try hSharpTV.Disconnect
  ' lgtv close
  Try hLGTV.Disconnect
  ' GenericIO close
  Try hGenericIO.Close
  ' iport close
  Try hIPort.Disconnect

  ' Stop all plugins
  Plugin.StopAll()

  ' db close
  Try hDB.Close

  WriteLog("[Main]   ---- Program End ----")

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' start various stuff
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Setup()

  WriteLog("[Main] Starting setup ...")

  ' setup modules
  GetSettings() ' read all settings from database
  RestoreGlobalVars() ' restore globalvars from database
  If Not bMainDebug Then WriteLog("[Main] NOTE: All disabled module log entries are muted, enable main debug if you want to see them!")
  Setup_IPAddr() ' get our ip address
  Setup_Email() ' e-mail SMTP client
  Setup_Sound() ' built in sound player
  Setup_VoiceText() ' text2speech support
  Setup_Thermostat() ' Thermostat function
  Setup_RRDTool() ' RRDTool graphing framework
  Setup_XMLRPC() ' XML-RPC server
  Setup_X10Cmd() ' X10 command interface
  Setup_CTX35() ' Xanura CTX35 X10 interface
  Setup_UPS() ' Nut SmartUPS monitoring client
  Setup_SMS() ' SMS modem support
  Setup_GPS() ' uBlox GPS receiver
  Setup_Temp08() ' Midon TEMP08 1-wire interface
  Setup_VISCA() ' Sony VISCA PTZ interface
  Setup_HDDTemp() ' read disk temperatures
  Setup_VideoServer() ' IP9100 videoserver
  Setup_Asterisk() ' Asterisk PABX support
  Setup_Bluetooth() ' Bluetooth Proximity support
  Setup_Weeder() ' Weeder I/O modules support
  Setup_Gmail() ' fetch Gmail RSS feed
  Setup_TVGuide() ' XMLTV guide
  Setup_ServerStats() ' Server Statistics
  Setup_IRMan() ' IRMan Infrared
  Setup_Plugwise() ' Plugwise support
  Setup_FritzBox() ' FritzBox support
  Setup_BwiredMap() ' Bwired support
  Setup_Twitter() ' Twitter support
  Setup_DSC() ' DSC security interface support
  Setup_Visonic() ' Visonic PowerMax/PowerMaster security interface support
  Setup_EIB() ' KNX/EIB support
  Setup_Domotica() ' Domotica modules support
  Setup_Digitemp() ' Digitemp support
  Setup_ZWave() ' Z-Wave support
  Setup_OWW() ' One-Wire Weather support
  Setup_LIRC() ' LIRC support
  Setup_Pachube() ' Pachube support
  Setup_JeeLabs() ' JeeLabs support
  Setup_Ping() ' Ping support
  Setup_PLCBUS() ' PLCBUS support
  Setup_TemperaturNu() ' TemperaturNu support
  Setup_PVoutput() ' PVoutput support
  Setup_SqueezeServer() ' SqueezeServer support
  Setup_LEDMatrix() ' LED Matrix message support
  Setup_WeatherBug() ' WeatherBug support
  Setup_EZcontrol() ' EZcontrol support
  Setup_CurrentCost() ' Current Cost support
  Setup_Denon() ' Denon support
  Setup_Pioneer() ' Pioneer support
  Setup_IRTrans() ' IRTrans support
  Setup_Mochad() ' Mochad support
  Setup_Onkyo() ' Onkyo/Integra support
  Setup_PwrCtrl() ' Anel PwrCtrl support
  Setup_SharpTV() ' Sharp TV support
  Setup_iViewer() ' iViewer support
  Setup_iPort() ' iPort dock support
  Setup_LGTV() ' LG TV support
  Setup_K8055() ' Velleman K8055 support
  Setup_OWFS() ' OWFS support
  Setup_CUL() ' CULFW support
  Setup_xPL() ' xPL support
  Setup_RFXComxPL() ' RFXCom xPL support
  Setup_Shell() ' Shell support
  Setup_TelnetServer() ' TelnetServer support
  Setup_Calendar() 'Calendar planning support
  Setup_Ncid() 'Ncid Support
  Setup_HomeMatic() ' HMLAN support
  Setup_OpenTherm() ' OpenTherm support
  Setup_SmartMeter() ' NTA8130 smart meter support
  Setup_XBMCxPL() ' XBMC control via xPL
  Setup_MQTT() ' MQTT client support
  Setup_Meteohub() ' Meteohub support
  Setup_ELVMAX() ' ELV MAX! support
  Setup_YouLess() ' YouLess support
  Setup_KMTronicUDP() ' KMTronicUDP support
  Setup_SmartVisuServer() ' SmartVISU support
  Setup_WeatherUG() ' Weather Underground support
  Setup_P2000() ' P2000 monitor support
  Setup_NMA() ' Notify My Android support
  Setup_Prowl() ' Prowl notification support
  Setup_Pushover() ' Pushover notification support
  Setup_DMXPlayer() ' DMXPlayer support
  Setup_GenericIO() ' Generic Serial and TCPIP I/O support

  ' Register all plugins
  Plugin.Init()
  ' Start all enabled plugins
  Plugin.StartAll()

  WriteLog("[Main] Done with setup ...")

  ' experimental
  ' LoadPlugins()

End

' Public Sub LoadPlugins()
' 
'   Dim sPlugin As String
'   Dim cClass As Class
'   Dim oPlugin As Object
'   Dim oInterface As CPlugin
'   WriteLog("Looking for plugins...")
' 
'   ' find plugins
'   For Each sPlugin In RDir(sBaseDir &/ "plugins", "*.gambas", gb.File)
'     WriteLog("Loading plugin '" & sPlugin & "'")
'     Component.Load(sBaseDir &/ "plugins" &/ sPlugin)
'   Next
' 
'   ' initiate found plugins
'   For Each cClass In Classes
'     If Not IsNull(cClass.Component) Then
'       If cClass.Component.Name Like "*.gambas" Then
'         oPlugin = Object.New(cClass.Name)   ' create instance
'         oPlugin.Run(Object.New(oInterface)) ' start plugin
'         ' Object.Call(oPlugin, "Run")
'         ' Object.New(cClass.Name).pluginMain(frm, frm.Button1.X, frm.Button1.Y + frm.Button1.H, frm.Button1.W, frm.Button1.H)
'       Endif
'     Endif
'   Next
' 
' Catch
'   Debug Error.Text & " at " & Error.Where
' 
' End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' open logfiles
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Setup_Logfiles()

  ' close open files first (in case of new month)
  Try Close #hMainLogFile
  Try Close #hSpeakLogFile
  Try Close #hDebugLogFile

  sMainLogFile As String = "server-main-" & Format(Now, "yyyy-mm") & ".log"
  sSpeakLogFile As String = "server-speak-" & Format(Now, "yyyy-mm") & ".log"
  sDebugLogFile As String = "server-debug-" & Format(Now, "yyyy-mm") & ".log"
  sDomoZWaveFile As String = "server-domozwave-"

  ' If "logs" doesn't exist, try to create it first
  If Exist(sBaseDir &/ "logs") = False Then
    Try Mkdir (sBaseDir &/ "logs")
  Endif

  ' open the file in append mode and write to it
  hMainLogFile = Open sBaseDir &/ "logs" &/ sMainLogFile For Append
  hSpeakLogFile = Open sBaseDir &/ "logs" &/ sSpeakLogFile For Append
  hDebugLogFile = Open sBaseDir &/ "logs" &/ sDebugLogFile For Append

Catch
  WriteLog("[Main] ERROR: While opening logfiles: " & Error.Text & " at " & Error.Where)

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' reload main settings
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_Main()

  ' not much todo now
  GetSettings()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' location info, and calc. sunset/sunrise and moonphase
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_Astro()

  Dim bSunRise As Boolean = True
  Dim bSunSet As Boolean = False
  Dim iTwilight As Integer
  Dim rResult As Result
  Dim aSplitTime As String[]
  Dim sSeasons, sSeason_Starts As String[]
  Dim sDateTime As String
  Dim sDateName As String

  ' Check if automatic timezone+daylight savings is enabled (Normally 255)
  If iAstroTimezone < -12 Or iAstroTimezone > 13 Then
    Exec ["date", "+%:z"] To sDateTime
    Exec ["date", "+%Z"] To sDateName
    sDateTime = Replace$(sDateTime, "\n", "")
    sDateTime = Replace$(sDateTime, ":", ".")
    sDateName = Replace$(sDateName, "\n", "")

    ' Convert :30 & :45 timezones too - Only works in automatic mode
    Try sDateTime = Fix(CFloat(sDateTime)) + ((Frac(CFloat(sDateTime)) / 60) * 100)
    Try fAstroAutoTimezone = CFloat(sDateTime)

    ' If we detect an error, set Name to "unknown"
    If Error Then
      sDateName = "UNKNOWN"
    Endif

    sAstroAutoTimezoneName = sDateName

    WriteLog("[Astro] Latitude: " & iAstroLatitude & ", Longitude: " & iAstroLongitude & ", Timezone: " & sDateName)
  Else
    ' It isn't automatic, manually configured
    fAstroAutoTimezone = iAstroTimezone
    If bAstroDST Then
      fAstroAutoTimezone = fAstroAutoTimezone + 1
    Endif

    WriteLog("[Astro] Latitude: " & iAstroLatitude & " Longitude: " & iAstroLongitude & " Timezone: " & iAstroTimezone & IIf(bAstroDST, " (DST)", ""))
  Endif

  ' calculate sun set/rise
  SetGlobalVar("Sunrise", Astro.CalcSunTimes(iAstroLongitude, iAstroLatitude, fAstroAutoTimezone, bSunRise, 0))
  SetGlobalVar("Sunset", Astro.CalcSunTimes(iAstroLongitude, iAstroLatitude, fAstroAutoTimezone, bSunSet, 0))

  ' update Sunset/Sunrise triggers in database
  aSplitTime = Split(GetGlobalVar("Sunset"), ":")
  rResult = hDB.Exec("UPDATE triggers t SET t.param1 = &1 WHERE t.name = 'Time is Sunset' ", Format(aSplitTime[1], "#") & " " & Format(aSplitTime[0], "#") & " * * *")
  aSplitTime = Split(GetGlobalVar("Sunrise"), ":")
  rResult = hDB.Exec("UPDATE triggers t SET t.param1 = &1 WHERE t.name = 'Time is Sunrise' ", Format(aSplitTime[1], "#") & " " & Format(aSplitTime[0], "#") & " * * *")

  If (sAstroTwilight = "civil") Then iTwilight = 1
  If (sAstroTwilight = "nautical") Then iTwilight = 2
  If (sAstroTwilight = "astronomical") Then iTwilight = 3
  SetGlobalVar("Sunrise_Twilight", Astro.CalcSunTimes(iAstroLongitude, iAstroLatitude, fAstroAutoTimezone, bSunRise, iTwilight))
  SetGlobalVar("Sunset_Twilight", Astro.CalcSunTimes(iAstroLongitude, iAstroLatitude, fAstroAutoTimezone, bSunSet, iTwilight))

  If bServer Then
    WriteLog("[Astro] Sunrise at " & GetGlobalVar("Sunrise") & ", Sunset at " & GetGlobalVar("Sunset"))
    WriteLog("[Astro] Twilight Sunrise at " & GetGlobalVar("Sunrise_Twilight") & ", Twilight Sunset at " & GetGlobalVar("Sunset_Twilight") & " " & sAstroTwilight)

    ' calculate moon data
    Astro.CalcMoonPhase()
    WriteLog("[Astro] Moon phase is " & MoonPhase & ".")
    WriteLog("[Astro] Moon is in " & MoonZodiac & ".")
    WriteLog("[Astro] Age from new " & MoonAge & " days.")
    WriteLog("[Astro] Distance " & MoonDistance & " Earth radii.")
    WriteLog("[Astro] Ecliptic latitude: " & MoonLatitude & " degrees.")
    WriteLog("[Astro] Ecliptic longitude: " & MoonLongitude & " degrees.")
    If MoonIsLeapYear Then WriteLog("[Astro] This is a leap year.")
  Endif

  ' calculate season
  sSeasons = Split(sAstroSeasons, ",")
  sSeason_Starts = Split(sAstroSeasonStarts, ",")
  If (CInt(GetGlobalVar("Month")) < 3) Then
    SetGlobalVar("Season", sSeasons[0])
  Else If (CInt(GetGlobalVar("Month")) = 3) And If (CInt(GetGlobalVar("Day")) < CInt(sSeason_Starts[0])) Then
    SetGlobalVar("Season", sSeasons[0])
  Else If (CInt(GetGlobalVar("Month")) = 12) And If (CInt(GetGlobalVar("Day")) > CInt(sSeason_Starts[3])) Then
    SetGlobalVar("Season", sSeasons[0])
  Else If (CInt(GetGlobalVar("Month")) < 6) Then
    SetGlobalVar("Season", sSeasons[1])
  Else If (CInt(GetGlobalVar("Month")) = 6) And If (CInt(GetGlobalVar("Day")) < CInt(sSeason_Starts[1])) Then
    SetGlobalVar("Season", sSeasons[1])
  Else If (CInt(GetGlobalVar("Month")) < 9) Then
    SetGlobalVar("Season", sSeasons[2])
  Else If (CInt(GetGlobalVar("Month")) = 9) And If (CInt(GetGlobalVar("Day")) < CInt(sSeason_Starts[2])) Then
    SetGlobalVar("Season", sSeasons[2])
  Else
    SetGlobalVar("Season", sSeasons[3])
  Endif
  If bServer Then WriteLog("[Astro] Season is " & GetGlobalVar("Season") & ".")

Catch
  WriteLog("[Astro] ERROR: " & Error.Text & " at " & Error.Where & ".")

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' reload astro settings
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_Astro()

  GetSettings()
  Setup_Astro()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' start kmtronicudp
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_KMTronicUDP()

  If bKMTronicUDPEnabled Then
    WriteLog("[Plugin] KMTronicUDP support enabled.")
    If bServer Then
      ' create a new KMTronicUDP class instance
      hKMTronicUDP = New CKMTronicUDP
      ' set the properties
      With hKMTronicUDP
        .PollTime = iKMTronicUDPPollTime
        .UDPPort = iKMTronicUDPPort
        .KMTronicUDPDebug = bKMTronicUDPDebug
      End With
      ' start
      hKMTronicUDP.Run()
    Endif
  Else
    If bMainDebug Then WriteLog("[Plugin] KMTronicUDP support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart kmtronicudp after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_KMTronicUDP()

  If hKMTronicUDP Then
    hKMTronicUDP.Disconnect
    hKMTronicUDP = Null
  Endif
  Setup_KMTronicUDP()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' start smartvisu server
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_SmartVisuServer()

  If bSmartVisuServerEnabled Then
    If bSmartVisuServerDebug Then WriteLog("[Plugin] SmartVISU Server enabled.")
    If bServer Then
      ' create a new smartvisu server class instance
      hSmartVisuServer = New CSmartVisuServer

      ' set the properties
      hSmartVisuServer.Port = iSmartVisuServerPort
      hSmartVisuServer.SmartVisuServerDebug = bSmartVisuServerDebug

      ' start smartvisu server
      If hSmartVisuServer.Connect() Then
      Else
      Endif
    Endif
  Else
    If bMainDebug Then WriteLog("[Plugin] SmartVISU Server disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart smartvisu server after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_SmartVisuServer()

  If hSmartVisuServer Then
    hSmartVisuServer.Disconnect
    hSmartVisuServer = Null
  Endif
  Setup_SmartVisuServer()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' start xmlrpc
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_XMLRPC()

  If bXMLRPCEnabled Then
    If bXMLRPCDebug Then WriteLog("[Plugin] XML-RPC server enabled.")
    If bServer Then
      ' create a new xmlrpc class instance
      hXMLRPC = New CXMLRPC

      ' set the properties
      hXMLRPC.MaxConn = iXMLRPCMaxconn
      hXMLRPC.HTTPPort = iXMLRPCHTTPPort
      hXMLRPC.XMLRPCDebug = bXMLRPCDebug

      ' start xmlrpc server
      If hXMLRPC.Connect() Then
      Else
      Endif

      If bBroadcastUDPEnabled Then
        WriteLog("[XMLRPC] UDP Broadcasts are enabled on Port " & Str(iXMLRPCHTTPPort + 10000))
      Else
        WriteLog("[XMLRPC] UDP Broadcasts are disabled.")
      Endif

      ' Setup Broadcast UDP socket
      hBroadcastEvent = New UdpSocket As "BroadcastUDP"
      hBroadcastEvent.Broadcast = True
      hBroadcastEvent.Port = 0
      hBroadcastEvent.Bind()
      Try hBroadcastEvent.TargetPort = iXMLRPCHTTPPort + 10000
      If Error Then
        hBroadcastEvent = Null
        WriteLog("[XMLRPC] ERROR: UDP Broadcast server FAILED to start on Port " & Str(iXMLRPCHTTPPort + 10000))
      Endif

    Endif
  Else
    If bMainDebug Then WriteLog("[Plugin] XML-RPC server disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart xmlrpc server after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_XMLRPC()

  If hXMLRPC Then
    hXMLRPC.Disconnect
    hXMLRPC = Null
  Endif

  ' Also re-init the BroadcastUDP
  If hBroadcastEvent Then
    hBroadcastEvent = Null
  Endif

  Setup_XMLRPC()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' check if e-mail client is enabled
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_Email()

  If bEmailEnabled Then
    WriteLog("[Plugin] e-mail client enabled.", bMainDebug)
  Else
    If bMainDebug Then WriteLog("[Plugin] e-mail client disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart e-mail after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_Email()

  ' not much todo now
  Setup_Email()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' check if Gmail Rss client is enabled
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_Gmail()

  If bGmailEnabled Then
    WriteLog("[Plugin] Gmail RSS feed support enabled.", bMainDebug)
    If bServer Then Mail.GmailRun()
  Else
    If bMainDebug Then WriteLog("[Plugin] Gmail RSS feed support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart Gmail after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_Gmail()

  ' not much todo now
  Setup_Gmail()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' setup sound related stuff
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_Sound()

  If bSoundEnabled Then
    WriteLog("[Plugin] Sound support enabled.")
    Sounds.LoadSounds()
  Else
    If bMainDebug Then WriteLog("[Plugin] Sound support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart sound after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_Sound()

  ' not much todo now
  Setup_Sound()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' setup bwired related stuff
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_BwiredMap()

  If bBwiredMapEnabled Then
    WriteLog("[Plugin] Bwired XML upload support enabled.")
    If bServer Then Bwired.Run()
  Else
    Try Bwired.tBwired.Stop
    If bMainDebug Then WriteLog("[Plugin] Bwired XML upload support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart bwired after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_BwiredMap()

  Try Bwired.tBwired.Stop
  ' not much todo now
  Setup_BwiredMap()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' setup voicetext related stuff
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_VoiceText()

  If bVoiceTextEnabled Then
    WriteLog("[Plugin] VoiceText support enabled.")
  Else
    If bMainDebug Then WriteLog("[Plugin] VoiceText support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart voicetext after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_VoiceText()

  ' not much todo now
  Setup_VoiceText()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' initialize x10cmd if needed
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_X10Cmd()

  Dim sTemp As String

  If bX10CmdEnabled Then
    WriteLog("[Plugin] X10Cmd support enabled.")
    If bServer Then
      If ProgramExist(sX10CmdCommand) Then
        If iX10CmdType = 0 Then
          Exec [sX10CmdCommand, "version"] To sTemp
          WriteLog("[X10Cmd] Found Heyu executable " & sTemp)
          If bX10CmdMonitor Then
            WriteLog("[X10Cmd] Heyu monitor enabled.")
            X10Cmd.Monitor
          Else
            WriteLog("[X10Cmd] Heyu monitor disabled.")
          Endif
        Else If iX10CmdType = 1 Then
          If bX10CmdMonitor Then
            WriteLog("[X10Cmd] monitor enabled.")
            X10Cmd.Monitor
          Else
            WriteLog("[X10Cmd] monitor disabled.")
           Endif
        Endif
      Else
        WriteLog("[X10Cmd] ERROR: command '" & sX10CmdCommand & "' not found, did you install it?")
        bX10CmdEnabled = False
        WriteLog("[Plugin] X10Cmd interface disabled.")
      Endif
    Endif
  Else
    Try X10Cmd.Monitor_Stop
    If bMainDebug Then WriteLog("[Plugin] X10Cmd support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart x10cmd after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_X10Cmd()

  ' not much todo now
  Try X10Cmd.Monitor_Stop
  Setup_X10Cmd()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' open ctx35 serial port and initialize
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_CTX35()

  If bCTX35Enabled Then
    WriteLog("[Plugin] Xanura CTX35 X10 support enabled.")
    If bServer Then
      ' create a new CTX35 class instance
      hCTX35 = New CCTX35
      ' set the properties
      With hCTX35
        .Port = sCTX35SerialPort
        .Baud = sCTX35Baudrate
        .PollTime = iCTX35PollTime
        .GlobalX10 = bCTX35GlobalX10
        .CTX35Debug = bCTX35Debug
      End With
      ' connect to the serial port
      If hCTX35.Connect() Then
        hCTX35.Run()
      Else
        hCTX35 = Null
      Endif
    Endif
  Else
    If bMainDebug Then WriteLog("[Plugin] Xanura CTX35 X10 support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart ctx35 after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_CTX35()

  If hCTX35 Then
    Try hCTX35.tCTX35.Stop
    hCTX35.Disconnect
    hCTX35 = Null
  Endif
  Setup_CTX35()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' open plcbus serial port and initialize
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_PLCBUS()

  If bPLCBUSEnabled Then
    WriteLog("[Plugin] PLCBUS support enabled.")
    If bServer Then
      ' create a new PLCBUS class instance
      hPLCBUS = New CPLCBUS
      ' set the properties
      With hPLCBUS
        .Port = sPLCBUSSerialPort
        .Baud = sPLCBUSBaudrate
        .PollTime = iPLCBUSPollTime
        .UserCode = sPLCBUSUserCode
        .ThreePhase = bPLCBUSThreePhase
        .HouseCodes = sPLCBUSHouseCodes
        .PLCBUSDebug = bPLCBUSDebug
        .Ack = bPLCBUSAck
      End With
      ' connect to the serial port
      If hPLCBUS.Connect() Then
        hPLCBUS.Run()
      Else
        hPLCBUS = Null
      Endif
    Endif
  Else
    If bMainDebug Then WriteLog("[Plugin] PLCBUS support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart plcbus after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_PLCBUS()

  If hPLCBUS Then
    Try hPLCBUS.tPLCBUS.Stop
    Try hPLCBUS.tPLCBUSLed.Stop
    hPLCBUS.Disconnect
    hPLCBUS = Null
  Endif
  Setup_PLCBUS()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' connect with ups tcp host and port
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_UPS()

  If bUPSEnabled Then
    WriteLog("[Plugin] UPS TCP support enabled.")
    If bServer Then
      ' create a new UPS class instance
      hUPS = New CUPS
      ' set the properties
      With hUPS
        .Host = sUPSTCPHost
        .Port = iUPSTCPPort
        .PollTime = iUPSPollTime
        .UPSDebug = bUPSDebug
      End With
      ' connect to the ups host:port
      If hUPS.Connect() Then
      Else
      Endif
    Endif
  Else
    Try hUPS.tUPS.Stop
    If bMainDebug Then WriteLog("[Plugin] UPS TCP support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart ups after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_UPS()

  If hUPS Then
    Try hUPS.tUPS.Stop
    hUPS.Disconnect
    hUPS = Null
  Endif
  Setup_UPS()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' initialize sms modem
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_SMS()

  If bSMSEnabled Then
    WriteLog("[Plugin] SMS modem support enabled.")
    If bServer Then
      ' create a new SMS class instance
      hSMS = New CSMS
      ' set the properties
      With hSMS
        .Port = sSMSSerialPort
        .Baud = sSMSBaudrate
        .PIN = sSMSPIN
        .ServiceCentre = sSMSServiceCentre
        .Contact = sSMSContact
        .SMSDebug = bSMSDebug
      End With
      ' connect to the serial port
      If hSMS.Connect() Then
        If Not hSMS.InitModem() Then
          WriteLog("[SMS] ERROR: SMS modem interface FAILED to initialize.")
        Endif
      Else
      Endif
    Endif
  Else
    If bMainDebug Then WriteLog("[Plugin] SMS modem support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart sms after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_SMS()

  If hSMS Then
    hSMS.Disconnect
    hSMS = Null
  Endif
  Setup_SMS()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' check if network device is reachable
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_Ping()

  If bPingEnabled Then
    WriteLog("[Plugin] Network Ping support enabled.")
    ' start timer
    If bServer Then Ping.Run()
  Else
    Try Ping.tPing.Stop
    If bMainDebug Then WriteLog("[Plugin] Network Ping support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart ping after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_Ping()

  Try Ping.tPing.Stop
  ' not much todo now
  Setup_Ping()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' check if bluetooth devices are around
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_Bluetooth()

  If bBluetoothEnabled Then
    If ProgramExist("hcitool") Then
      WriteLog("[Plugin] Bluetooth Proximity support enabled.")
      ' start timer
      If bServer Then Bluetooth.Run()
    Else
      If bServer Then
        WriteLog("[Bluetooth] ERROR: Bluetooth command 'hcitool' not found, did you install it?")
        bBluetoothEnabled = False
        WriteLog("[Plugin] Bluetooth Proximity support disabled.")
      Endif
    Endif
  Else
    Try Bluetooth.tBluetooth.Stop
    If bMainDebug Then WriteLog("[Plugin] Bluetooth Proximity support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart bluetooth after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_Bluetooth()

  ' not much todo now
   Setup_Bluetooth()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' initialize gps receiver
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_GPS()

  If bGPSEnabled Then
    WriteLog("[Plugin] GPS receiver support enabled.")
    If bServer Then
      ' create a new GPS class instance
      hGPS = New CGPS
      ' set the properties
      With hGPS
        .Port = sGPSSerialPort
        .Baud = sGPSBaudrate
        .GPSDebug = bGPSDebug
      End With
      ' connect to the serial port
      If hGPS.Connect() Then
      Else
      Endif
    Endif
  Else
    If bMainDebug Then WriteLog("[Plugin] GPS receiver support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart gps after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_GPS()

  If hGPS Then
    hGPS.Disconnect
    hGPS = Null
  Endif
  Setup_GPS()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' initialize weeder i/o
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_Weeder()

  If bWeederEnabled Then
    WriteLog("[Plugin] Weeder Module support enabled.")
    If bServer Then
      ' create a new Weeder class instance
      hWeeder = New CWeeder
      ' set the properties
      With hWeeder
        .Port = sWeederSerialPort
        .WeederDebug = bWeederDebug
      End With

      ' connect to the serial port
      If hWeeder.Connect() Then
      Else
        hWeeder = Null
      Endif
    Endif
  Else
    If bMainDebug Then WriteLog("[Plugin] Weeder Module support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart weeder after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_Weeder()

  If hWeeder Then
    hWeeder.Disconnect
    hWeeder = Null
  Endif
  Setup_Weeder()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' open 1-wire serial port and initialize
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_Temp08()

  If bTemp08Enabled Then
    WriteLog("[Plugin] Midon Temp08 support enabled.")
    If bServer Then
      ' create a newTemp08 class instance
      hTemp08 = New CTemp08
      ' set the properties
      With hTemp08
        .Port = sTemp08SerialPort
        .Baud = sTemp08Baudrate
        .Temp08Debug = bTemp08Debug
      End With
      ' connect to the serial port
      If hTemp08.Connect() Then
      Else
      Endif
    Endif
  Else
    If bMainDebug Then WriteLog("[Plugin] Midon Temp08 support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart temp08 after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_Temp08()

  If hTemp08 Then
    hTemp08.Disconnect
    hTemp08 = Null
  Endif
  Setup_Temp08()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' open visca ptz control serial port and initialize
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_VISCA()

  If bVISCAEnabled Then
    WriteLog("[Plugin] Sony VISCA support enabled.")
    If bServer Then
      ' create a new VISCA class instance
      hVISCA = New CVISCA
      ' set the properties
      hVISCA.Port = sVISCASerialPort
      hVISCA.VISCADebug = bVISCADebug
      ' connect to the serial port
      If hVISCA.Connect() Then
      Else
      Endif
    Endif
  Else
    If bMainDebug Then WriteLog("[Plugin] Sony VISCA support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart visca after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_VISCA()

  If hVISCA Then
    hVISCA.Disconnect
    hVISCA = Null
  Endif
  Setup_VISCA()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' check if HDD temps are below threshold
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_HDDTemp()

  If bHDDTempEnabled Then
    WriteLog("[Plugin] HDDTemp support enabled.")
    ' start timer
    If bServer Then HDDTemp.Run()
  Else
    Try HDDTemp.tHDDTemp.Stop
    Try HDDTemp.hHDDTemp.Close
    If bMainDebug Then WriteLog("[Plugin] HDDTemp support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart hddtemp after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_HDDTemp()

  Setup_HDDTemp()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' capture video images from videoserver
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_VideoServer()

  If bVideoServerEnabled Then
    WriteLog("[Plugin] IP9100 VideoServer support enabled.")
  Else
    If bMainDebug Then WriteLog("[Plugin] IP9100 VideoServer support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart videoserver after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_VideoServer()

  ' not much todo now
   Setup_VideoServer()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' check if rrdtool support is enabled
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_RRDTool()

    If bRRDToolEnabled Then
      If bServer Then
        If ProgramExist("rrdtool") Then
          RRDTool.Run()
          WriteLog("[Plugin] RRDTool support enabled.")
        Else
          WriteLog("[RRDTool] ERROR: RRDTool command 'rrdtool' not found, did you install it?")
          bRRDToolEnabled = False
          WriteLog("[Plugin] RRDTool support disabled.")
        Endif
      Else
        WriteLog("[Plugin] RRDTool support enabled.")
      Endif
    Else
      Try RRDTool.tRRDTool.Stop
      If bMainDebug Then WriteLog("[Plugin] RRDTool support disabled.")
    Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart rrdtool after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_RRDTool()

  ' not much todo now
  Setup_RRDTool()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' check if asterisk support is enabled
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_Asterisk()

  If bAsteriskEnabled Then
    WriteLog("[Plugin] Asterisk API support enabled.")
    If bServer Then
      ' create a new Asterisk class instance
      hAsterisk = New CAsterisk
      ' set the properties
      With hAsterisk
        .TCPHost = sAsteriskTCPHost
        .TCPPort = iAsteriskTCPPort
        .User = sAsteriskUser
        .Password = sAsteriskPassword
        .PollTime = iAsteriskPollTime
        .AsteriskDebug = bAsteriskDebug
      End With
      ' connect to the asterisk host:port
      If hAsterisk.Connect() Then
      Else
      Endif
    Endif
  Else
    If bMainDebug Then WriteLog("[Plugin] Asterisk API support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart asterisk support after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_Asterisk()

  If hAsterisk Then
    hAsterisk.Disconnect
    hAsterisk = Null
  Endif
  Setup_Asterisk()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' check if tvguide support is enabled
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_TVGuide()

  If bTVGuideEnabled Then
    WriteLog("[Plugin] TV Guide support enabled.")
  Else
    If bMainDebug Then WriteLog("[Plugin] TV Guide support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart tvguide after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_TVGuide()

  Setup_TVGuide()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' check if server statistics is enabled
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_ServerStats()

  If bServerStatsEnabled Then
    If bServer Then ServerStats.Run()
    WriteLog("[Plugin] Server Statistics enabled.")
  Else
    Try ServerStats.tServerStats.Stop
    If bMainDebug Then WriteLog("[Plugin] Server Statistics disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart server statistics after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_ServerStats()

  Setup_ServerStats()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' open IRMan serial port and initialize
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_IRMan()

  If bIRManEnabled Then
    WriteLog("[Plugin] IRMan IR support enabled.")
    If bServer Then
      ' create a new IRMan class instance
      hIRMan = New CIRMan
      ' set the properties
      With hIRMan
        .Port = sIRManSerialPort
        .IRManDebug = bIRManDebug
      End With
      ' connect to the serial port
      If hIRMan.Connect() Then
        ' wakeup device
        hIRMan.Run()
      Else
      Endif
    Endif
  Else
    If bMainDebug Then WriteLog("[Plugin] IRMan IR support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart irman after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_IRMan()

  If hIRMan Then
    hIRMan.Disconnect
    hIRMan = Null
  Endif
  Setup_IRMan()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' open plugwise serial port and initialize
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_Plugwise()

  If bPlugwiseEnabled Then
    WriteLog("[Plugin] Plugwise support enabled.")
    If bServer Then
      ' create a new Plugwise class instance
      hPlugwise = New CPlugwise
      ' set the properties
      With hPlugwise
        .Port = sPlugwiseSerialPort
        .PollTime = iPlugwisePollTime
        .PlugwiseDebug = bPlugwiseDebug
      End With
      ' connect to the serial port
      If hPlugwise.Connect() Then
        hPlugwise.Run()
      Else
        hPlugwise = Null
      Endif
    Endif
  Else
    If bMainDebug Then WriteLog("[Plugin] Plugwise support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart plugwise after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_Plugwise()

  If hPlugwise Then
    Try hPlugwise.tPlugwise.Stop
    hPlugwise.Disconnect
    hPlugwise = Null
  Endif
  Setup_Plugwise()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' check if fritzbox support is enabled
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_FritzBox()

  If bFritzBoxEnabled Then
    WriteLog("[Plugin] Fritz!Box API support enabled.")
    If bServer Then
      ' create a new FritzBox class instance
      hFritzBox = New CFritzBox
      ' set the properties
      With hFritzBox
        .TCPHost = sFritzBoxTCPHost
        .FritzBoxDebug = bFritzBoxDebug
      End With
      ' connect to the fritzbox host:port
      If hFritzBox.Connect() Then
      Endif
    Endif
  Else
    If bMainDebug Then WriteLog("[Plugin] Fritz!Box API support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart fritzbox support after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_FritzBox()

  If hFritzBox Then
    hFritzBox.Disconnect
    hFritzBox = Null
  Endif
  Setup_FritzBox()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' check if Twitter support is enabled
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_Twitter()

  If bTwitterEnabled Then
    WriteLog("[Plugin] Twitter support enabled.")
  Else
    If bMainDebug Then WriteLog("[Plugin] Twitter support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart Twitter settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_Twitter()

  ' not much todo now
  Setup_Twitter()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' open DSC serial port and initialize
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_DSC()

  If bDSCEnabled Then
    WriteLog("[Plugin] DSC Security support enabled.")
    If bServer Then
      ' create a new DSC class instance
      hDSC = New CDSC
      ' set the properties
      With hDSC
        .Port = sDSCSerialPort
        .Baud = sDSCBaudrate
        .Type = iDSCType
        .MasterCode = sDSCMasterCode
        .DSCDebug = bDSCDebug
      End With
      ' connect to the serial port
      If hDSC.Connect() Then
      Endif
    Endif
  Else
    If bMainDebug Then WriteLog("[Plugin] DSC Security support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart DSC after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_DSC()

  If hDSC Then
    hDSC.Disconnect
    hDSC = Null
  Endif
  Setup_DSC()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' open Visonic serial port and initialize
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_Visonic()

  If bVisonicEnabled Then
    WriteLog("[Plugin] Visonic PowerMax/PowerMaster Security support enabled.")
    If bServer Then
      ' create a new Visonic class instance
      hVisonic = New CVisonic
      ' set the properties
      With hVisonic
        .Port = sVisonicSerialPort
        .MasterCode = sVisonicMasterCode
        .VisonicDebug = bVisonicDebug
      End With
      ' connect to the serial port
      If hVisonic.Connect() Then
        If bServer Then hVisonic.Run()
      Else
      Endif
    Endif
  Else
    If bMainDebug Then WriteLog("[Plugin] Visonic PowerMax/PowerMaster Security support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart Visonic after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_Visonic()

  If hVisonic Then
    hVisonic.Disconnect
    hVisonic = Null
  Endif
  Setup_Visonic()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' connect with eibd via tcp
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_EIB()

  If bEIBEnabled Then
    WriteLog("[Plugin] KNX/EIB TCP support enabled.")
    If bServer Then
      ' create a new EIB class instance
      hEIB = New CEIB
      ' set the properties
      With hEIB
        .TCPHost = sEIBTCPHost
        .TCPPort = iEIBTCPPort
        .EIBDebug = bEIBDebug
      End With
      ' connect to eibd host:port
      If hEIB.Connect() Then
      Endif
    Endif
  Else
    If bMainDebug Then WriteLog("[Plugin] KNX/EIB TCP support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart eib after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_EIB()

  If hEIB Then
    hEIB.Disconnect
    hEIB = Null
  Endif
  Setup_EIB()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' open Domotica serial port and initialize
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_Domotica()

  If bDomoticaEnabled Then
    WriteLog("[Plugin] Domotica support enabled.")
    If bServer Then
      ' create a new Domotica class instance
      hDomotica = New CDomotica
      ' set the properties
      With hDomotica
        .Port = sDomoticaSerialPort
        .DomoticaDebug = bDomoticaDebug
      End With
      ' connect to the serial port
      If hDomotica.Connect() Then
      Endif
    Endif
  Else
    If bMainDebug Then WriteLog("[Plugin] Domotica support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart Domotica after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_Domotica()

  If hDomotica Then
    hDomotica.Disconnect
    hDomotica = Null
  Endif
  Setup_Domotica()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' read sensors via digitemp
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_Digitemp()

  Dim bNotOk As Boolean

  If bDigitempEnabled Then
    If bServer Then
      If Not ProgramExist(sDigitempCommand) Then
        bNotOk = True
        WriteLog("[Digitemp] ERROR: Digitemp command " & sDigitempCommand & " not found, did you install it?")
      Endif
      If Not Exist(sDigitempConfig) Then
        bNotOk = True
        WriteLog("[Digitemp] ERROR: Digitemp config file " & sDigitempConfig & " not found, did you initialize it?")
      Endif
    Endif
    If bNotOk And If bServer Then
      bDigitempEnabled = False
      WriteLog("[Plugin] Digitemp support disabled.")
    Else
      WriteLog("[Plugin] Digitemp support enabled.")
      ' start timer
      If bServer Then Digitemp.Run()
    Endif
  Else
    Try Digitemp.tDigitemp.Stop
    If bMainDebug Then WriteLog("[Plugin] Digitemp support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart digitemp after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_Digitemp()

  ' not much todo now
   Setup_Digitemp()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' open Z-Wave serial port and initialize
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_ZWave()

  If bZWaveEnabled Then
    WriteLog("[Plugin] OpenZWave Z-Wave support enabled.")
    If bServer Then
      ' create a new Z-Wave class instance
      hZWave = New CZWave
      ' set the properties
      With hZWave
        .Port = sZWaveSerialPort
        .ZWaveDebug = bZWaveDebug
        .PollTime = iZWavePollTime
        .PollTimeListening = sZWavePollTimeListening
        .PollTimeSleeping = sZWavePollTimeSleeping
        .UpdateNeighbor = sZWaveUpdateNeighbor
        .EnablePollListening = bZWaveEnablePollListening
        .EnablePollSleeping = bZWaveEnablePollSleeping
        .EnableUpdateNeighbor = bZWaveEnableUpdateNeighbor
        .tOZWKeepAlive.Delay = iZWavePollTime
      End With

      ' First check if we can load the library
      If hZWave.Version() = "" Then
        WriteLog("[OpenZWave] ERROR: interface is disabled, because the open-zwave library cannot be loaded or is an invalid format")
        hZWave = Null
        Return
      Endif

      ' Check if the library matches the required version
      If hZWave.sLibDomoZwave <> hZWave.Version() Then
        WriteLog("[OpenZWave] ERROR: ***************************************************************************************************")
        WriteLog("[OpenZWave] ERROR: *** OpenZWave Z-Wave interface is disabled, because of a version mismatch ***")
        WriteLog("[OpenZWave] ERROR: *** The OpenZWave wrapper version doesn't match the required version ***")
        WriteLog("[OpenZWave] ERROR: *** Required by DomotiGa: " & hZWave.sLibDomoZwave & " ***")
        WriteLog("[OpenZWave] ERROR: *** OpenZWave wrapper: " & hZWave.Version() & " ***")
        WriteLog("[OpenZWave] ERROR: *** Please recompile as described on page: http://www.domotiga.nl/projects/domotiga/wiki/Z-Wave ***")
        WriteLog("[OpenZWave] ERROR: ***************************************************************************************************")
        hZWave = Null
        Return
      Endif

      If Exist(Main.sBaseDir &/ "wrappers/domozwave/open-zwave/config/") = False Then
        WriteLog("[OpenZWave] ERROR: interface is disabled, the open-zwave configuration directory is missing (" & Main.sBaseDir &/ "wrappers/domozwave/open-zwave/config/" & ")")
        hZWave = Null
        Return
      Endif

      ' connect to the serial port
      hZWave.Connect()

    Endif
  Else
    If bMainDebug Then WriteLog("[Plugin] OpenZWave Z-Wave support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart Z-Wave after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_ZWave()

  If hZWave Then
    Try hZWave.tZWave.Stop
    Try hZWave.tZWaveOZWKeepAlive.Stop
    hZWave.Disconnect
    hZWave = Null
  Endif
  Setup_ZWave()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' check if One-Wire Weather support is enabled
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_OWW()

  If bOWWEnabled Then
    WriteLog("[Plugin] One-Wire Weather support enabled.")
    If bServer Then
      ' create a new One-Wire Weather class instance
      If sOWWServerType = "Henriksen WServer UDP" Then
        hOWWUDP = New COWW
        ' set the properties
        With hOWWUDP
          .TCPHost = sOWWTCPHost
          .TCPPort = iOWWTCPPort
          .ServerType = sOWWServerType
          .OWWDebug = bOWWDebug
        End With
        ' connect to the One-Wire Weather host:port
        If hOWWUDP.Connect() Then
        Endif
      Else
        hOWWTCP = New COWW
        ' set the properties
        With hOWWTCP
          .TCPHost = sOWWTCPHost
          .TCPPort = iOWWTCPPort
          .ServerType = sOWWServerType
          .OWWDebug = bOWWDebug
        End With
        ' connect to the One-Wire Weather host:port
        If hOWWTCP.Connect() Then
        Endif
      Endif
    Endif
  Else
    If bMainDebug Then WriteLog("[Plugin] One-Wire Weather support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart One-Wire Weather support after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_OWW()

  If hOWWUDP Then
    hOWWUDP.Disconnect
    hOWWUDP = Null
  Endif
  If hOWWTCP Then
    hOWWTCP.Disconnect
    hOWWTCP = Null
  Endif
  Setup_OWW()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' check if LIRC support is enabled
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_LIRC()

  If bLIRCEnabled Then
    WriteLog("[Plugin] LIRC support enabled.")
    If bServer Then
      ' create a new LIRC class instance
      hLIRC = New CLIRC
      ' set the properties
      With hLIRC
        .TCPHost = sLIRCTCPHost
        .TCPPort = iLIRCTCPPort
        .LIRCDebug = bLIRCDebug
      End With
      ' connect to the LIRC host:port
      If hLIRC.Connect() Then
      Endif
    Endif
  Else
    If bMainDebug Then WriteLog("[Plugin] LIRC support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart LIRC support after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_LIRC()

  If hLIRC Then
    hLIRC.Disconnect
    hLIRC = Null
  Endif
  Setup_LIRC()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' check if Pachube support is enabled
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_Pachube()

  If bPachubeEnabled Then
    WriteLog("[Plugin] Pachube support with " & IIf(Main.iPachubePushTime, "Manual", "Automatic") & " feeds enabled.")
    ' start timer
    If bServer Then
      If Main.iPachubePushTime Then
        Pachube.Run()
      Endif
    Endif
  Else
    Try Pachube.tPachube.Stop
    If bMainDebug Then WriteLog("[Plugin] Pachube support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart pachube after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_Pachube()

  Setup_Pachube()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' open jeelink serial port and initialize
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_JeeLabs()

  If bJeeLabsEnabled Then
    WriteLog("[Plugin] JeeLabs JeeLink support enabled.")
    If bServer Then
      ' create a new JeeLabs class instance
      hJeeLabs = New CJeeLabs
      ' set the properties
      With hJeeLabs
        .Port = sJeeLabsSerialPort
        .Baud = sJeeLabsBaudrate
        .JeeLabsDebug = bJeeLabsDebug
      End With
      ' connect to the serial port
      If hJeeLabs.Connect() Then
      Else
        hJeeLabs = Null
      Endif
    Endif
  Else
    If bMainDebug Then WriteLog("[Plugin] JeeLabs JeeLink support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart jeelabs after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_JeeLabs()

  If hJeeLabs Then
    hJeeLabs.Disconnect
    hJeeLabs = Null
  Endif
  Setup_JeeLabs()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' check if TemperaturNu support is enabled
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_TemperaturNu()

  If bTemperaturNuEnabled Then
    WriteLog("[Plugin] TemperaturNu support enabled.")
    ' start timer
    If bServer Then
      If Main.iTemperaturNuPushTime Then
        TemperaturNu.Run()
      Endif
    Endif
  Else
    Try TemperaturNu.tTemperaturNu.Stop
    If bMainDebug Then WriteLog("[Plugin] TemperaturNu support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart TemperaturNu after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_TemperaturNu()

  Setup_TemperaturNu()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' connect with squeezeserver via socket
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_SqueezeServer()

  If bSqueezeServerEnabled Then
    WriteLog("[Plugin] Squeeze Server support enabled.")
    If bServer Then
      ' create a new SqueezeServer class instance
      hSqueezeServer = New CSqueezeServer
      ' set the properties
      With hSqueezeServer
        .TCPHost = sSqueezeServerTCPHost
        .TCPPort = iSqueezeServerTCPPort
        .SqueezeServerDebug = bSqueezeServerDebug
      End With
      ' connect to squeezeserver host:port
      If hSqueezeServer.Connect() Then
      Endif
    Endif
  Else
    If bMainDebug Then WriteLog("[Plugin] Squeeze Server support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart squeezeserver after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_SqueezeServer()

  If hSqueezeServer Then
    hSqueezeServer.Disconnect
    hSqueezeServer = Null
  Endif
  Setup_SqueezeServer()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' open led matrix serial port and initialize
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_LEDMatrix()

  If bLEDMatrixEnabled Then
    WriteLog("[Plugin] LED Matrix support enabled.")
    If bServer Then
      ' create a new LEDMatrix class instance
      hLEDMatrix = New CLEDMatrix
      ' set the properties
      With hLEDMatrix
        .Port = sLEDMatrixSerialPort
        .LEDMatrixDebug = bLEDMatrixDebug
        .DisplayID = sLEDMatrixID
        .DisplayColor = iLEDMatrixColor
        .DisplaySpeed = iLEDMatrixSpeed
      End With
      ' connect to the serial port
      If hLEDMatrix.Connect() Then
        ' show startup message
        hLEDMatrix.Run()
      Endif
    Endif
  Else
    If bMainDebug Then WriteLog("[Plugin] LED Matrix support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart led matrix after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_LEDMatrix()

  If hLEDMatrix Then
    hLEDMatrix.Disconnect
    hLEDMatrix = Null
  Endif
  Setup_LEDMatrix()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' check if weatherbug support is enabled
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_WeatherBug()

  If bWeatherBugEnabled Then
    WriteLog("[Plugin] WeatherBug support enabled.")
  Else
    If bMainDebug Then WriteLog("[Plugin] WeatherBug support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart weatherbug after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_WeatherBug()

  ' not much todo now
  Setup_WeatherBug()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' check if weatherug support is enabled
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_WeatherUG()

  If bWeatherUGEnabled Then
    WriteLog("[Plugin] Weather Underground support enabled.")
    WeatherUG.Run()
  Else
    If bMainDebug Then WriteLog("[Plugin] Weather Undergound support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart weatherug after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_WeatherUG()

  ' not much todo now
  Setup_WeatherUG()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' check if p2000 support is enabled
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_P2000()

  If bP2000Enabled Then
    WriteLog("[Plugin] P2000 monitor support enabled.")
    P2000.Run()
  Else
    If bMainDebug Then WriteLog("[Plugin] P2000 monitor support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart p2000 after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_P2000()

  ' not much todo now
  Setup_P2000()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' connect with ezcontrol interface via udpsocket
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_EZcontrol()

  If bEZcontrolEnabled Then
    WriteLog("[Plugin] EZcontrol support enabled.")
    If bServer Then
      ' create a new EZcontrol class instance
      hEZcontrol = New CEZcontrol
      ' set the properties
      With hEZcontrol
        .UDPHost = sEZcontrolUDPHost
        .UDPPort = iEZcontrolUDPPort
        .EZcontrolDebug = bEZcontrolDebug
      End With
      ' connect to interface host:port
      If hEZcontrol.Connect() Then
      Endif
    Endif
  Else
    If bMainDebug Then WriteLog("[Plugin] EZcontrol support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart ezcontrol after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_EZcontrol()

  If hEZcontrol Then
    hEZcontrol.Disconnect
    hEZcontrol = Null
  Endif
  Setup_EZcontrol()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' connect with Current Cost
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_CurrentCost()

  If bCurrentCostEnabled Then
    WriteLog("[Plugin] CurrentCost receiver support enabled.")
    If bServer Then
      ' create a new CurrentCost class instance
      hCurrentCost = New CCurrentCost
      ' set the properties
      With hCurrentCost
        .Baud = sCurrentCostBaudrate
        .Port = sCurrentCostSerialPort
        .CurrentCostDebug = bCurrentCostDebug
      End With
      ' connect to the currentcost serial interface
      If hCurrentCost.Connect() Then
      Else
        hCurrentCost = Null
      Endif
    Endif
  Else
    If bMainDebug Then WriteLog("[Plugin] CurrentCost receiver support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart Current Cost after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_CurrentCost()

  If hCurrentCost Then
    hCurrentCost.Disconnect
    hCurrentCost = Null
  Endif
  Setup_CurrentCost()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' connect with denon receiver tcp host:port or serial port
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_Denon()

  If bDenonEnabled Then
    WriteLog("[Plugin] Denon receiver support enabled.")
    If bServer Then
      ' create a new Denon class instance
      hDenon = New CDenon
      ' set the properties
      With hDenon
        .TCPHost = sDenonTCPHost
        .TCPPort = iDenonTCPPort
        .Interface = sDenonType
        .Baud = sDenonBaudrate
        .SerPort = sDenonSerialPort
        .DenonDebug = bDenonDebug
      End With
      If InStr(sDenonType, "tcp") Then
        ' connect to the denon host:port
        If hDenon.ConnectTCP() Then
        Else
          hDenon = Null
        Endif
      Else
        ' connect to the denon serial interface
        If hDenon.ConnectSerial() Then
        Else
          hDenon = Null
        Endif
      Endif
    Endif
  Else
    If bMainDebug Then WriteLog("[Plugin] Denon receiver support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart denon after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_Denon()

  If hDenon Then
    hDenon.Disconnect
    hDenon = Null
  Endif
  Setup_Denon()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' connect with pioneer receiver tcp host:port or serial port
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_Pioneer()

  If bPioneerEnabled Then
    WriteLog("[Plugin] Pioneer receiver support enabled.")
    If bServer Then
      ' create a new Pioneer class instance
      hPioneer = New CPioneer
      ' set the properties
      With hPioneer
        .TCPHost = sPioneerTCPHost
        .TCPPort = iPioneerTCPPort
        .Interface = sPioneerType
        .Baud = sPioneerBaudrate
        .SerPort = sPioneerSerialPort
        .PioneerDebug = bPioneerDebug
      End With
      If InStr(sPioneerType, "tcp") Then
        ' connect to the pioneer host:port
        If hPioneer.ConnectTCP() Then
        Else
          hPioneer = Null
        Endif
      Else
        ' connect to the Pioneer serial interface
        If hPioneer.ConnectSerial() Then
        Else
          hPioneer = Null
        Endif
      Endif
    Endif
  Else
    If bMainDebug Then WriteLog("[Plugin] Pioneer receiver support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart pioneer after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_Pioneer()

  If hPioneer Then
    hPioneer.Disconnect
    hPioneer = Null
  Endif
  Setup_Pioneer()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' connect with irtrans receiver tcp host:port
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_IRTrans()

  If bIRTransEnabled Then
    WriteLog("[Plugin] IRTrans support enabled.")
    If bServer Then
      ' create a new IRTrans class instance
      hIRTrans = New CIRTrans
      ' set the properties
      With hIRTrans
        .TCPHost = sIRTransTCPHost
        .TCPPort = iIRTransTCPPort
        .IRTransDebug = bIRTransDebug
      End With
      ' connect to the irtrans host:port
      If hIRTrans.Connect() Then
      Else
        hIRTrans = Null
      Endif
    Endif
  Else
    If bMainDebug Then WriteLog("[Plugin] IRTrans support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart irtrans after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_IRTrans()

  If hIRTrans Then
    hIRTrans.Disconnect
    hIRTrans = Null
  Endif
  Setup_IRTrans()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' connect with Mochad receiver tcp host:port
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_Mochad()

  If bMochadEnabled Then
    WriteLog("[Plugin] Mochad X10 support enabled.")
    If bServer Then
      ' create a new Mochad class instance
      hMochad = New CMochad
      ' set the properties
      With hMochad
        .TCPHost = sMochadTCPHost
        .TCPPort = iMochadTCPPort
        .MochadDebug = bMochadDebug
      End With
      ' connect to the Mochad host:port
      If hMochad.Connect() Then
      Else
        hMochad = Null
      Endif
    Endif
  Else
    If bMainDebug Then WriteLog("[Plugin] Mochad X10 support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart Mochad after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_Mochad()

  If hMochad Then
    hMochad.Disconnect
    hMochad = Null
  Endif
  Setup_Mochad()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' connect with onkyo receiver tcp host:port or serial port
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_Onkyo()

  If bOnkyoEnabled Then
    WriteLog("[Plugin] Onkyo/Integra receiver support enabled.")
    If bServer Then
      ' create a new Onkyo class instance
      hOnkyo = New COnkyo
      ' set the properties
      With hOnkyo
        .TCPHost = sOnkyoTCPHost
        .TCPPort = iOnkyoTCPPort
        .Interface = sOnkyoType
        .Baud = sOnkyoBaudrate
        .SerPort = sOnkyoSerialPort
        .OnkyoDebug = bOnkyoDebug
      End With
      If InStr(sOnkyoType, "tcp") Then
        ' connect to the onkyo host:port
        If hOnkyo.ConnectTCP() Then
        Else
          hOnkyo = Null
        Endif
      Else
        ' connect to the onkyo serial interface
        If hOnkyo.ConnectSerial() Then
        Else
          hOnkyo = Null
        Endif
      Endif
    Endif
  Else
    If bMainDebug Then WriteLog("[Plugin] Onkyo/Integra receiver support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart onkyo after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_Onkyo()

  If hOnkyo Then
    hOnkyo.Disconnect
    hOnkyo = Null
  Endif
  Setup_Onkyo()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' connect with pwrctrl interface via udpsocket
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_PwrCtrl()

  If bPwrCtrlEnabled Then
    WriteLog("[Plugin] PwrCtrl support enabled.")
    If bServer Then
      ' create a new PwrCtrl class instance
      hPwrCtrl = New CPwrCtrl
      ' set the properties
      With hPwrCtrl
        .UDPPortRead = iPwrCtrlUDPRead
        .UDPPortSend = iPwrCtrlUDPSend
        .PwrCtrlDebug = bPwrCtrlDebug
        .PwrCtrlUserPw = sPwrCtrlUserPw
      End With
      ' connect to interface host:port
      If hPwrCtrl.Connect() Then
        ' get state for all devices
        hPwrCtrl.GetAllState()
      Endif
    Endif
  Else
    If bMainDebug Then WriteLog("[Plugin] PwrCtrl support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart PwrCtrl after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_PwrCtrl()

  If hPwrCtrl Then
    hPwrCtrl.Disconnect
    hPwrCtrl = Null
  Endif
  Setup_PwrCtrl()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' Setup PVoutput
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_PVoutput()

  If bPVoutputEnabled Then
    WriteLog("[Plugin] PVoutput support enabled.")
    ' start timer
    If bServer Then
      If Main.iPVoutputPushTime Then
        PVoutput.Run()
      Endif
    Endif
  Else
    Try PVoutput.tPVoutput.Stop
    If bMainDebug Then WriteLog("[Plugin] PVoutput support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart PVoutput settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_PVoutput()

  Setup_PVoutput()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' connect with sharptv
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_SharpTV()

  If bSharpTVEnabled Then
    WriteLog("[Plugin] Sharp TV receiver support enabled.")
    If bServer Then
      ' create a new SharpTV class instance
      hSharpTV = New CSharpTV
      ' set the properties
      With hSharpTV
        .TCPHost = sSharpTVTCPHost
        .TCPPort = iSharpTVTCPPort
        .Interface = sSharpTVType
        .Baud = sSharpTVBaudrate
        .SerPort = sSharpTVSerialPort
        .SharpTVDebug = bSharpTVDebug
      End With
      If InStr(sSharpTVType, "tcp") Then
        ' connect to the sharptv host:port
        If hSharpTV.ConnectTCP() Then
        Else
          hSharpTV = Null
        Endif
      Else
        ' connect to the sharptv serial interface
        If hSharpTV.ConnectSerial() Then
        Else
          hSharpTV = Null
        Endif
      Endif
    Endif
  Else
    If bMainDebug Then WriteLog("[Plugin] Sharp TV receiver support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart sharptv after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_SharpTV()

  If hSharpTV Then
    hSharpTV.Disconnect
    hSharpTV = Null
  Endif
  Setup_SharpTV()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' connect with lgtv
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_LGTV()

  If bLGTVEnabled Then
    WriteLog("[Plugin] LG TV receiver support enabled.")
    If bServer Then
      ' create a new LGTV class instance
      hLGTV = New CLGTV
      ' set the properties
      With hLGTV
        .TCPHost = sLGTVTCPHost
        .TCPPort = iLGTVTCPPort
        .Interface = sLGTVType
        .Baud = sLGTVBaudrate
        .SerPort = sLGTVSerialPort
        .LGTVDebug = bLGTVDebug
      End With
      If InStr(sLGTVType, "tcp") Then
        ' connect to the lgtv host:port
        If hLGTV.ConnectTCP() Then
        Else
          hLGTV = Null
        Endif
      Else
        ' connect to the lgtv serial interface
        If hLGTV.ConnectSerial() Then
        Else
          hLGTV = Null
        Endif
      Endif
    Endif
  Else
    If bMainDebug Then WriteLog("[Plugin] LG TV receiver support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart lgtv after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_LGTV()

  If hLGTV Then
    hLGTV.Disconnect
    hLGTV = Null
  Endif
  Setup_LGTV()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' connect with iport
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_iPort()

  If bIPortEnabled Then
    WriteLog("[Plugin] iPort dock support enabled.")
    If bServer Then
      ' create a new IPort class instance
      hIPort = New CIPort
      ' set the properties
      With hIPort
        .TCPHost = sIPortTCPHost
        .TCPPort = iIPortTCPPort
        .Interface = sIPortType
        .Baud = sIPortBaudrate
        .SerPort = sIPortSerialPort
        .IPortDebug = bIPortDebug
      End With
      If InStr(sIPortType, "tcp") Then
        ' connect to the iport host:port
        If hIPort.ConnectTCP() Then
        Else
          hIPort = Null
        Endif
      Else
        ' connect to the iport serial interface
        If hIPort.ConnectSerial() Then
        Else
          hIPort = Null
        Endif
      Endif
    Endif
  Else
    If bMainDebug Then WriteLog("[Plugin] iPort dock support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart iport after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_iPort()

  If hIPort Then
    hIPort.Disconnect
    hIPort = Null
  Endif
  Setup_iPort()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' start listening for cf iviewer remotes
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_iViewer()

  If bIViewerEnabled Then
    Main.WriteLog("[Plugin] CF iViewer support enabled.")
    If bServer Then
      ' create a new iViewer class instance
      hIViewer = New CIViewer

      ' set the properties
      hIViewer.IViewerPassword = sIViewerPassword
      hIViewer.IViewerPort = iIViewerTCPPort
      hIViewer.IViewerDebug = bIViewerDebug

      ' start iviewer
      If hIViewer.Connect() Then
      Endif
    Endif
  Else
    If bMainDebug Then Main.WriteLog("[Plugin] CF iViewer support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart cf iviewer after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_iViewer()

  If hIViewer Then
    hIViewer.Disconnect
    hIViewer = Null
  Endif
  Setup_IViewer()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' thermostat
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_Thermostat()

  If bThermostatEnabled Then
    WriteLog("[Plugin] Thermostat support enabled.")
    ' start timer
    If bServer Then Thermostat.Run()
  Else
    Try Thermostat.tThermostat.Stop
    If bMainDebug Then WriteLog("[Plugin] Thermostat support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart Thermostat after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_Thermostat()

  Setup_Thermostat()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' open Velleman K8055 board and initialize
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_K8055()

  If bK8055Enabled Then
    WriteLog("[Plugin] Velleman K8055 support enabled.")
    If bServer Then
      If ProgramExist("k8055") Then
        ' create a new K8055 class instance
        hK8055 = New CK8055
        ' set the properties
        With hK8055
          .PollTime = iK8055PollTime
          .K8055Debug = bK8055Debug
          .AddressBoard = iK8055BoardAddress
          .DebounceTime1 = iK8055DebounceTime1
          .DebounceTime2 = iK8055DebounceTime2
        End With
        ' connect to the serial port
        If hK8055.Connect() Then
          hK8055.Run()
        Else
          hK8055 = Null
        Endif
      Else
        WriteLog("[K8055] ERROR: Velleman command 'k8055' not found, did you install it?")
        bK8055Enabled = False
        WriteLog("[Plugin] Velleman K8055 support disabled.")
      Endif
    Endif
  Else
    If bMainDebug Then WriteLog("[Plugin] Velleman K8055 support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart K8055 after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_K8055()

  If hK8055 Then
    Try hK8055.tK8055.Stop
    hK8055.Disconnect
    hK8055 = Null
  Endif
  Setup_K8055()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' OWFS support
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_OWFS()

  If bOWFSEnabled Then
    WriteLog("[Plugin] OWFS support enabled.")
    ' create a new OWFS class instance
    hOWFS = New COWFS
    ' set the properties
    With hOWFS
        .PollTime = iOWFSPollTime
        .BaseDir = sOWFSBaseDir
        .Cached = bOWFSCached
        .OWFSDebug = bOWFSDebug
    End With
    ' start timer
    If bServer Then hOWFS.Run()
  Else
    Try hOWFS.tOWFS.Stop
    If bMainDebug Then WriteLog("[Plugin] OWFS support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart OWFS after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_OWFS()

  Try hOWFS.tOWFS.Stop
  If hOWFS Then
    hOWFS = Null
  Endif
  ' not much todo now
  Setup_OWFS()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' connect with CUL interface tcp host:port or serial port
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_CUL()

  Dim sModel As String[] = ["", "CUL", "CUN", "CUNO", "CUR"]

  If bCULEnabled Then
    WriteLog("[Plugin] CUL support enabled.")
    If bServer Then
      ' create a new CUL class instance
      hCUL = New CCUL
      ' set the properties
      With hCUL
        .TCPHost = sCULTCPHost
        .TCPPort = iCULTCPPort
        .Interface = sCULType
        .Baud = sCULBaudrate
        .SerPort = sCULSerialPort
        .Model = iCULModel
        .CULDebug = bCULDebug
        .FHTid = sCULFHTid
      End With
      If InStr(sCULType, "tcp") Then
        ' connect to the CUL host:port
        If hCUL.ConnectTCP() Then
        Else
          hCUL = Null
        Endif
      Else
        ' connect to the CUL serial interface
        If hCUL.ConnectSerial() Then
        Else
          hCUL = Null
        Endif
      Endif
    Endif
  Else
    If bMainDebug Then WriteLog("[Plugin] CUL support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart CUL after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_CUL()

  If hCUL Then
    hCUL.Disconnect
    hCUL = Null
  Endif
  Setup_CUL()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' connect with xPL
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_xPL()

  If bxPLEnabled Then
    WriteLog("[Plugin] xPL support enabled.")
    If bServer Then
      ' create a new xPL class instance
      hxPL = New CxPL
      ' set the properties
      With hxPL
        .TargetHost = aBroadcastAddrs[0]
        .OurIPAddress = sOurIPAddress
        .HeartBeatTime = ixPLHeartBeatTime
        .xPLDebug = bxPLDebug
      End With
      ' start listening
      If hxPL.StartListener() Then
      Else
        hxPL = Null
      Endif
    Endif
  Else
    If bMainDebug Then WriteLog("[Plugin] xPL support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart xPL after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_xPL()

  If hxPL Then
    hxPL.Disconnect
    hxPL = Null
  Endif
  Setup_xPL()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' connect with rfxcom xpl
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_RFXComxPL()

  If bRFXComxPLEnabled Then
    WriteLog("[Plugin] RFXCom xPL support enabled.")
    If Not bxPLEnabled Then WriteLog("Warning: xPL support is disabled!")
    If bServer Then
      ' create a new RFXCom class instance
      hRFXComxPL = New CRFXComxPL
      ' set the properties
      With hRFXComxPL
        .RXAddress = sRFXComxPLRXAddress
        .TXAddress = sRFXComxPLTXAddress
        .RFXComDebug = bRFXComxPLDebug
        .GlobalX10 = bRFXComxPLGlobalX10
        .OldAddrFmt = bRFXComxPLOldAddrFmt
      End With

      ' No connect?

    Endif
  Else
    hRFXComxPL = Null
    If bMainDebug Then WriteLog("[Plugin] RFXCom xPL support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart rfxcom xpl after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_RFXComxPL()

  If hRFXComxPL Then
    hRFXComxPL.Disconnect
    hRFXComxPL = Null
  Endif
  Setup_RFXComxPL()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' get device values from shell command/script
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_Shell()

  If bShellEnabled Then
    WriteLog("[Plugin] Shell support enabled.")
    ' start timer
    If bServer Then Shell.Run()
  Else
    Try Shell.tShell.Stop
    If bMainDebug Then WriteLog("[Plugin] Shell support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart shell after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_Shell()

  Try Shell.tShell.Stop
  ' not much todo now
  Setup_Shell()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' start telnetserver
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_TelnetServer()

  If bTelnetServerEnabled Then
    WriteLog("[Plugin] Telnet Server enabled.")
    If bServer Then
      ' create a new TelnetServer class instance
      hTelnetServer = New CTelnetServer

      ' set the properties
      hTelnetServer.TelnetPort = iTelnetServerPort
      hTelnetServer.TelnetServerDebug = bTelnetServerDebug

      ' start telnetserver
      If hTelnetServer.Connect() Then
      Endif
    Endif
  Else
    If bMainDebug Then WriteLog("[Plugin] Telnet Server disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart telnetserver after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_TelnetServer()

  If hTelnetServer Then
    hTelnetServer.Disconnect
    hTelnetServer = Null
  Endif
  Setup_TelnetServer()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' check if Ncid support is enabled
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_Ncid()

  If bNcidEnabled Then
    WriteLog("[Plugin] Ncid API support enabled.")
    If bServer Then
      ' create a new Ncid class instance
      hNcid = New CNcid
      ' set the properties
      With hNcid
        .TCPHost = sNcidTCPHost
        .TCPPort = iNcidTCPPort
        .NcidDebug = bNcidDebug
      End With
      ' connect to the Ncid host:port
      If hNcid.Connect() Then
      Endif
    Endif
  Else
    If bMainDebug Then WriteLog("[Plugin] Ncid API support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart Ncid support after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_Ncid()

  If hNcid Then
    hNcid.Disconnect
    hNcid = Null
  Endif
  Setup_Ncid()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' connect with HomeMatic interface tcp host:port
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_HomeMatic()

  If bHMEnabled Then
    WriteLog("[Plugin] HomeMatic support enabled.")
    If bServer Then
      ' create a new HomeMatic class instance
      hHM = New CHomeMatic
      ' set the properties
      With hHM
        .TCPHost = sHMTCPHost
        .TCPPort = iHMTCPPort
        .HMDebug = bHMDebug
        .HMLANid = sHMhmid
        .Pairing = False
      End With
      ' connect to the HMLAN host:port
      If hHM.ConnectTCP() Then
      Else
        hHM = Null
      Endif
    Endif
  Else
    If bMainDebug Then WriteLog("[Plugin] HomeMatic support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart HM after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_HomeMatic()

  If hHM Then
    hHM.Disconnect
    hHM = Null
  Endif
  Setup_HomeMatic()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' connect with NTA8130 smart meter tcp host:port or serial port
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_SmartMeter()

  If bSmartMeterEnabled Then
    WriteLog("[Plugin] SmartMeter support enabled.")
    If bServer Then
      ' create a new SmartMeter class instance
      hSmartMeter = New CSmartMeter
      ' set the properties
      With hSmartMeter
        .TCPHost = sSmartMeterTCPHost
        .TCPPort = iSmartMeterTCPPort
        .Interface = sSmartMeterType
        .Baud = sSmartMeterBaudrate
        .SerPort = sSmartMeterSerialPort
        .Databits = iSmartMeterDatabits
        .Stopbits = iSmartMeterStopbits
        .Parity = iSmartMeterParity
        .SmartMeterDebug = bSmartMeterDebug
      End With
      If InStr(sSmartMeterType, "tcp") Then
        ' connect to the SmartMeter host:port
        If hSmartMeter.ConnectTCP() Then
        Else
          hSmartMeter = Null
        Endif
      Else
        ' connect to the SmartMeter serial interface
        If hSmartMeter.ConnectSerial() Then
        Else
          hSmartMeter = Null
        Endif
      Endif
    Endif
  Else
    hSmartMeter = Null
    If bMainDebug Then WriteLog("[Plugin] SmartMeter support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart SmartMeter after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_SmartMeter()

  If hSmartMeter Then
    hSmartMeter.Disconnect
    hSmartMeter = Null
  Endif
  Setup_SmartMeter()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' open OpenTherm gateway serial port and initialize
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_OpenTherm()

  If bOpenThermEnabled Then
    WriteLog("[Plugin] OpenTherm gateway support enabled.")
    If bServer Then
      ' create a new OpenTherm gateway class instance
      hOpenTherm = New COpenTherm
      ' set the properties
      With hOpenTherm
        .SerPort = sOpenThermSerialPort
        .PollTime = iOpenThermPollTime
        .Thermostat = sOpenThermThermostat
        .OpenThermDebug = bOpenThermDebug
        .TemperatureOverride = sOpenThermTemperatureOverride
        .SyncClock = bOpenThermSyncClock
        .Type = sOpenThermType
        .TCPHost = sOpenThermTCPHost
        .TCPPort = sOpenThermTCPPort
      End With
      If InStr(sOpenThermType, "tcp") Then
        ' connect to the OpenTherm host:port
        If hOpenTherm.ConnectTCP() Then
        Else
          hOpenTherm = Null
        Endif
      Else
        ' connect to the OpenTherm serial interface
        If hOpenTherm.ConnectSerial() Then
        Else
          hOpenTherm = Null
        Endif
      Endif
    Endif
  Else
    If bMainDebug Then WriteLog("[Plugin] OpenTherm gateway support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart OpenTherm gateway after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_OpenTherm()

  If hOpenTherm Then
    hOpenTherm.Disconnect
    hOpenTherm = Null
  Endif
  Setup_OpenTherm()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' connect with XBMC xpl
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_XBMCxPL()

  If bXBMCxPLEnabled Then
    WriteLog("[Plugin] XBMC xPL support enabled.")
    If Not bxPLEnabled Then WriteLog("Warning: xPL support is disabled!")
    If bServer Then
      ' create a new XBMC class instance
      hXBMCxPL = New CXBMCxPL
      ' set the properties
      With hXBMCxPL
        .RXAddress = sXBMCxPLRXAddress
        .TXAddress = sXBMCxPLTXAddress
        .XBMCDebug = bXBMCxPLDebug
      End With
    Endif
  Else
    hXBMCxPL = Null
    If bMainDebug Then WriteLog("[Plugin] XBMC xPL support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart XBMC xpl after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_XBMCxPL()

  If hXBMCxPL Then
    hXBMCxPL.Disconnect
    hXBMCxPL = Null
  Endif
  Setup_XBMCxPL()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' connect with MQTT tcp host and port
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_MQTT()

  If bMQTTEnabled Then
    WriteLog("[Plugin] MQTT client support enabled.")
    If bServer Then
      ' create a new MQTT class instance
      hMQTT = New CMQTT
      ' set the properties
      With hMQTT
        .Host = sMQTTTCPHost
        .Port = iMQTTTCPPort
        .Username = sMQTTUsername
        .Password = sMQTTPassword
        .PubTopic = sMQTTPubTopic
        .SubTopic = sMQTTSubTopic
        .HeartBeat = iMQTTHeartbeat
        .Retain = bMQTTRetain
        .QoS = iMQTTQoS
        .MQTTDebug = bMQTTDebug
      End With
      ' connect to the MQTT host:port
      If hMQTT.Connect() Then
      Endif
    Endif
  Else
    If bMainDebug Then WriteLog("[Plugin] MQTT client support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart MQTT after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_MQTT()

  If hMQTT Then
    hMQTT.Disconnect
    hMQTT = Null
  Endif
  Setup_MQTT()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' initialize meteohub
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_Meteohub()

  If bMeteohubEnabled Then
    WriteLog("[Plugin] Meteohub support enabled.")
    If bServer Then
      ' create a new Meteohub class instance
      hMeteohub = New CMeteohub
      ' set the properties
      With hMeteohub
        .FetchURL = sMeteohubFetchURL
        .PollTime = iMeteohubPollTime
        .MeteohubDebug = bMeteohubDebug
      End With
      ' start fetch timer
      hMeteohub.Connect()
    Endif
  Else
    If bMainDebug Then WriteLog("[Plugin] Meteohub support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart Meteohub after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_Meteohub()

  If hMeteohub Then
    Try hMeteohub.tMeteohub.Stop
    hMeteohub.Disconnect
    hMeteohub = Null
  Endif
  Setup_Meteohub()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' connect with ELV MAX! tcp host:port or serial port
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_ELVMAX()

  If bELVMAXEnabled Then
    WriteLog("[Plugin] ELV MAX! support enabled.")
    If bServer Then
      ' create a new ELV MAX! class instance
      hELVMAX = New CELVMAX
      ' set the properties
      With hELVMAX
        .TCPHost = sELVMAXTCPHost
        .TCPPort = iELVMAXTCPPort
        .ELVMaxDebug = bELVMAXDebug
      End With
      ' connect to the ELV MAX! host:port
      If hELVMAX.ConnectTCP() Then
      Else
        hELVMAX = Null
      Endif
    Endif
  Else
    If bMainDebug Then WriteLog("[Plugin] ELV MAX! support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart ELV MAX! after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_ELVMAX()

  If hELVMAX Then
    hELVMAX.Disconnect
    hELVMAX = Null
  Endif
  Setup_ELVMAX()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' initialize YouLess
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_YouLess()

  If bYouLessEnabled Then
    WriteLog("[Plugin] YouLess support enabled.")
    If bServer Then
      ' create a new YouLess class instance
      hYouLess = New CYouLess
      ' set the properties
      With hYouLess
        .PollTime = iYouLessPollTime
        .YouLessDebug = bYouLessDebug
      End With
      ' start fetch timer
      hYouLess.Connect()
    Endif
  Else
    If bMainDebug Then WriteLog("[Plugin] YouLess support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart YouLess after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_YouLess()

  If hYouLess Then
    Try hYouLess.tYouLess.Stop
    hYouLess.Disconnect
    hYouLess = Null
  Endif
  Setup_YouLess()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' check if NMA client is enabled
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_NMA()

  If bNMAEnabled Then
    WriteLog("[Plugin] Notify My Android enabled.", bMainDebug)
  Else
    If bMainDebug Then WriteLog("[Plugin] Notify My Android disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart NMA after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_NMA()

  ' not much todo now
  Setup_NMA()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' check if Prowl client is enabled
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_Prowl()

  If bProwlEnabled Then
    WriteLog("[Plugin] Prowl notification enabled.", bMainDebug)
  Else
    If bMainDebug Then WriteLog("[Plugin] Prowl notification disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart Prowl after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_Prowl()

  ' not much todo now
  Setup_Prowl()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' check if Pushover client is enabled
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_Pushover()

  If bPushoverEnabled Then
    WriteLog("[Plugin] Pushover notification enabled.", bMainDebug)
  Else
    If bMainDebug Then WriteLog("[Plugin] Pushover notification disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart Pushover after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_Pushover()

  ' not much todo now
  Setup_Pushover()

End

Private Sub Setup_DMXPlayer()

  If bDMXPlayerEnabled Then
    WriteLog("[Plugin] DMXPlayer interface enabled.")
    ' create a new DMXPlayer class instance
    hDMXPlayer = New CDMXPlayer
    ' set the properties
    With hDMXPlayer
      .Port = sDMXPlayerSerialport
      .Baud = sDMXPlayerBaudrate
      .Debug = bDMXPlayerDebug
    End With
    ' connect to the serial port
    If hDMXPlayer.Connect() Then
    Endif
  Else
    If bMainDebug Then WriteLog("[Plugin] DMXPlayer interface disabled.")
  Endif

End

Public Sub Restart_DMXPlayer()

  Setup_DMXPlayer()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' open GenericIO serial or TCP port and initialize
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub Setup_GenericIO()

  If bGenericIOEnabled Then
    WriteLog("[Plugin] GenericIO IO board support enabled.")
    If bServer Then
      ' create a new GenericIO class instance
      hGenericIO = New CGenericIO
      ' set the properties
      With hGenericIO
        .TCPHost = sGenericIOTCPHost
        .TCPPort = iGenericIOTCPPort
        .Interface = sGenericIOType
        .SerPort = sGenericIOSerialPort
        .Baud = sGenericIOBaudrate
        .GenericIODebug = bGenericIODebug
        .GenericIORegex = sGenericIORegex
        .GenericIODelimiter = sGenericIODelimiter
      End With
      If InStr(sGenericIOType, "tcp") Then
        ' connect to the GenericIO host:port
        If hGenericIO.ConnectTCP() Then
        Else
          hGenericIO = Null
        Endif
      Else
        ' connect to the GenericIO serial interface
        If hGenericIO.Connect() Then
        Else
          hGenericIO = Null
        Endif
      Endif
    Endif
  Else
    If bMainDebug Then WriteLog("[Plugin] GenericIO IO board support disabled.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restart GenericIO after settings change
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Restart_GenericIO()

  If hGenericIO Then
    hGenericIO.Disconnect
    hGenericIO = Null
  Endif
  Setup_GenericIO()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' main loop checking for action and acted upon
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Check_for_Action()

  If bExitProgram Then
    CloseAll()
    Quit
  Endif

  SetGlobalVars()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' change house mode
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub ChangeHouseMode(sMode As String)

  SetGlobalVar("House_Mode", sMode)
  WriteLog("[Main] House mode is set to '" & Caps(sMode) & "'.")

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' change mute mode
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub ChangeMuteMode(bMode As Boolean)

  SetGlobalVar("Mute", bMode)
  If bMode Then
    WriteLog("[Main] Mute mode is set to 'Audio Disabled'.")
  Else
    WriteLog("[Main] Mute mode is set to 'Audio Enabled'.")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' update counters
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub UpdateCounters()

  ' IF iNewMails OR IF iNewCalls OR IF iNewVoicemails THEN Main.WriteLog("Inbox counters are: " & iNewMails & If(iNewMails <> 1, (" e-mails, "), (" e-mail, ")) & iNewCalls & If(iNewCalls <> 1, (" calls "), " call ") & "and " & iNewVoicemails & If(iNewVoicemails <> 1, (" voicemsgs"), (" voicemsg")) & ".")

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' return with capital first letter
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Caps(sString As String) As String

  Return UCase(Mid(sString, 1, 1)) & Mid(sString, 2)

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' Encode String as Html, normally to be used with XML-RPC
' We support XML 1.0 Fith Edition and XML 1.1
' http://en.wikipedia.org/wiki/XML#Characters_and_escaping
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub HtmlEncode(sStr As String, Optional sOnlyFirstLine As Boolean = False) As String

  ' In certain scenarios we only want the first line in the Html string and remove the rest
  If sOnlyFirstLine Then
    ' Remove &H0A - line feed
    If String.InStr(sStr, Chr(10)) > 0 Then
      sStr = String.Left(sStr, String.InStr(sStr, Chr(10)) - 1)
    Endif

    ' Remove &H0D - carriage return
    If String.InStr(sStr, Chr(13)) > 0 Then
      sStr = String.Left(sStr, String.InStr(sStr, Chr(13)) - 1)
    Endif
  Endif

  sStr = Replace(sStr, "&", "&amp;")
  sStr = Replace(sStr, "<", "&lt;")
  sStr = Replace(sStr, ">", "&gt;")
  sStr = Replace(sStr, "'", "&apos;")
  sStr = Replace(sStr, "\"", "&quot;")

  Return sStr

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' Decode String as Html, normally to be used with XML-RPC
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub HtmlDecode(sStr As String) As String

  sStr = Replace(sStr, "&amp;", "&")
  sStr = Replace(sStr, "&lt;", "<")
  sStr = Replace(sStr, "&gt;", ">")
  sStr = Replace(sStr, "&apos;", "'")
  sStr = Replace(sStr, "&quot;", "\"")

  Return sStr

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' start basic timers
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub SetupTimers()

  ' main loop sleep timer
  tMainSleep = New Timer As "tSleep"

  If bServer Then
    tMainSleep.Delay = 250
  Else
    ' only refresh ones per second to keep clock uptodate
    tMainSleep.Delay = 1000
  Endif
  tMainSleep.Enabled = True

  ' flush logfile buffers to disk
  tMainFlush = New Timer As "tFlush"
  tMainFlush.Delay = iMainFlushTime
  tMainFlush.Enabled = True

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' stop all timers
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub StopTimers()

  WriteLog("Stopping running timers.")
  ' p2000
  Try P2000.tP2000.Stop
  ' weatherug
  Try WeatherUG.tWeatherUG.Stop
  ' PVoutput close
  Try PVoutput.tPVoutput.Stop
  ' OpenTherm timer
  Try hOpenTherm.tOpenTherm.Stop
  ' k8055 timer
  Try hK8055.tK8055.Stop
  ' owfs timer
  Try hOWFS.tOWFS.Stop
  ' temperaturnu timer
  Try TemperaturNu.tTemperaturNu.Stop
  ' plugwise timer
  Try hPlugwise.tPlugwise.Stop
  ' pachube timer
  Try Pachube.tPachube.Stop
  ' bwired timer
  Try Bwired.tBwired.Stop
  ' ping timer
  Try Ping.tPing.Stop
  ' digitemp timer
  Try Digitemp.tDigitemp.Stop
  ' thermostat timer
  Try Thermostat.tThermostat.Stop
  ' serverstats timer
  Try ServerStats.tServerStats.Stop
  ' bluetooth timer
  Try Bluetooth.tBluetooth.Stop
  ' dsc timer
  Try hDSC.tDSC.Stop
  ' HDDTemp timer
  Try HDDTemp.tHDDTemp.Stop
  ' z-wave timer
  Try hZWave.tZWave.Stop
  ' ups timer
  Try hUPS.tUPS.Stop
  ' rrdtool timer
  Try RRDTool.tRRDTool.Stop
  ' gmail timer
  Try Mail.tGmail.Stop
  ' flush output streams
  Try tMainFlush.Stop
  ' main loop sleep timer
  Try tMainSleep.Stop

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' gets triggered by flush timer, flushes buffered data to disk
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub tFlush_Timer()

  Flush

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' gets triggered by sleep timer, triggers main loop
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub tSleep_Timer()

  Check_for_Action()

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' time related functions
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Function Time_Less_Than(sTime As String) As Boolean

  If (DateDiff(stime, GetGlobalVar("Hour") & ":" & GetGlobalVar("Minute"), gb.Minute) < 0) Then
    Return True
  Else
    Return False
  Endif

End

Private Function Time_Greater_Than(sTime As String) As Boolean

  If (DateDiff(stime, GetGlobalVar("Hour") & ":" & GetGlobalVar("Minute"), gb.Minute) > 0) Then
    Return True
  Else
    Return False
  Endif

End

Public Function Time_Now(sTime As String) As Boolean

  If (DateDiff(stime, GetGlobalVar("Hour") & ":" & GetGlobalVar("Minute"), gb.Second) = 0) Then
    Return True
  Else
    Return False
  Endif

End

Public Sub UpdateGlobalVars()

  ' only run at startup
  dTime = Now()
  SetGlobalVar("Second", Second(dTime))
  SetGlobalVar("Minute", Minute(dTime))
  SetGlobalVar("Hour", Hour(dTime))
  SetGlobalVar("Day", Day(dTime))
  SetGlobalVar("Month", Month(dTime))
  SetGlobalVar("Year", Year(dTime))
  SetGlobalVar("Weekday", WeekDay(dTime))
  SetGlobalVar("Program_Start", Now())
  SetGlobalVar("Program_Uptime", UptimeString(DateDiff(GetGlobalVar("Program_Start"), Now(), gb.Second)))

  If (Time_Less_Than("5:00")) Then
    SetGlobalVar("Time_Of_Day", "night")
  Else If (Time_Less_Than("11:59")) Then
    SetGlobalVar("Time_Of_Day", "morning")
  Else If (Time_Less_Than("17:00")) Then
    SetGlobalVar("Time_Of_Day", "afternoon")
  Else If (Time_Less_Than("23:59")) Then
    SetGlobalVar("Time_Of_Day", "evening")
  Else
    SetGlobalVar("Time_Of_Day", "night")
  Endif

  If (GetGlobalVar("Weekday") = 0 Or GetGlobalVar("Weekday") = 6) Then
    SetGlobalVar("Weekend", True)
  Else
    SetGlobalVar("Weekend", False)
  Endif

  ' calc sunset / rise
  Setup_Astro()

  ' check if it's dark or light
  If (Time_Less_Than(GetGlobalVar("Sunrise")) Or Time_Greater_Than(GetGlobalVar("Sunset"))) Then
    SetGlobalVar("Dark", True)
  Else
    SetGlobalVar("Dark", False)
  Endif

  WriteLog("[Main] The Time of Day is " & GetGlobalVar("Time_Of_Day") & ".")
  WriteLog("[Main] It's " & IIf(GetGlobalVar("Dark"), ("dark"), ("light")) & " outside.")
  WriteLog("[Main] DomotiGa is running for " & GetGlobalVar("Program_Uptime"))

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' loop with time related code
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub SetGlobalVars()

  Dim bTrigger As Boolean = False
  Dim sDateName As String

  bNew_Minute = 0
  bNew_Month = 0
  dTime = Now()

  ' prevent repeating time based events
  If (dPrev_Time > dTime) Then dTime = dPrev_Time

  If (dPrev_Time <> dTime) Then

    dPrev_Time = dTime

    ' new second
    If (GetGlobalVar("Second") <> Second(dTime)) Then
      SetGlobalVar("Second", Second(dTime))
      SetGlobalVar("Program_Uptime", UptimeString(DateDiff(GetGlobalVar("Program_Start"), Now(), gb.Second)))
    Endif

    ' new minute
    If (GetGlobalVar("Minute") <> Minute(dTime)) Then
      SetGlobalVar("Minute", Minute(dTime))
      bNew_Minute = 1

      btrigger = True

      ' check if it's dark or light
      If (Time_Less_Than(GetGlobalVar("Sunrise")) Or Time_Greater_Than(GetGlobalVar("Sunset"))) Then
        SetGlobalVar("Dark", True)
      Else
        SetGlobalVar("Dark", False)
      Endif

      ' new hour
      If (GetGlobalVar("Hour") <> Hour(dTime)) Then
        SetGlobalVar("Hour", Hour(dTime))

        ' sanity save global variables to database
        'SaveGlobalVars()

        If (Time_Less_Than("5:00")) Then
          SetGlobalVar("Time_Of_Day", "night")
        Else If (Time_Less_Than("11:59")) Then
          SetGlobalVar("Time_Of_Day", "morning")
        Else If (Time_Less_Than("17:00")) Then
          SetGlobalVar("Time_Of_Day", "afternoon")
        Else If (Time_Less_Than("23:59")) Then
          SetGlobalVar("Time_Of_Day", "evening")
        Else
          SetGlobalVar("Time_Of_Day", "night")
        Endif

        WriteLog("[Main] The Time of Day is " & GetGlobalVar("Time_Of_Day") & ".")
        WriteLog("[Main] It's " & IIf(GetGlobalVar("Dark"), ("dark"), ("light")) & " outside.")
        WriteLog("[Main] DomotiGa is running for " & GetGlobalVar("Program_Uptime"))

        If iAstroTimezone < -12 Or iAstroTimezone > 13 Then
         ' We have a new hour, we need to check if the daylight savings changed
          Exec ["date", "+%Z"] To sDateName
          sDateName = Replace$(sDateName, "\n", "")

          If sDateName <> sAstroAutoTimezoneName Then
            Setup_Astro()
          Endif
        Endif

        ' new day
        If (GetGlobalVar("Day") <> Day(dTime)) Then
          SetGlobalVar("Day", Day(dTime))
          If bServer Then Calendar.Run()

          SetGlobalVar("Weekday", WeekDay(dTime))

          If (GetGlobalVar("Weekday") = 0 Or GetGlobalVar("Weekday") = 6) Then
            SetGlobalVar("Weekend", True)
          Else
            SetGlobalVar("Weekend", False)
          Endif

          Setup_Astro()

          ' new month
          If (GetGlobalVar("Month") <> Month(dTime)) Then
            SetGlobalVar("Month", Month(dTime))
            bNew_Month = 1

            ' new year
            If (GetGlobalVar("Year") <> Year(dTime)) Then
              SetGlobalVar("Year", Year(dTime))
            Endif ' new year
          Endif ' new month
        Endif ' new day loop
      Endif ' new hour loop
    Endif ' new minute loop
  Endif ' time changed loop

  If bTrigger Then EventLoop.Run()

Catch
  WriteLog("ERROR: " & Error.Text & " at " & Error.Where & ".")

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' return random string from table
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Function Random_Text(sTable As String) As String

  Dim rResult As Result

  Try rResult = Main.hDB.Exec("SELECT text FROM " & hDB.Quote(sTable) & " ORDER BY rand() LIMIT 1")
  If rResult.Count Then
    Return rResult!text
  Else
    Return ("Error fetching random text!")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' get globalvar
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub GetGlobalVar(sVar As String) As Variant

  ' The GlobalVar is a Collection, which doesn't support empty strings.
  ' For this we internally store it as a "<EMPTY>", but return a "".
  ' If the sVar doesn't exist, we return NULL.

  If GlobalVar.Exist(sVar) Then
    If GlobalVar[sVar] = "<EMPTY>" Then
      Return ""
    Else
      Return GlobalVar[sVar]
    Endif
  Else
    Return Null
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' set globalvar to value
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub SetGlobalVar(sVar As String, vValue As Variant, Optional bBroadcast As Boolean = False) As Boolean

  Dim vTemp As Variant
  Dim rResult As Result
  Dim bGlobalVarExist As Boolean

  ' Don't call GetGlobalVar, we don't want a loop
  If GlobalVar.Exist(sVar) Then
    If GlobalVar[sVar] = "<EMPTY>" Then
      vTemp = ""
    Else
      vTemp = GlobalVar[sVar]
    Endif
  Else
    vTemp = Chr(0) & "NEVEREXISTS" & Chr(0)
  Endif

  If Events.CheckCondition(vTemp, "<>", vValue, True) Then

    ' First check if the GlobalVar exist
    ' If vValue is blank, it is removed from the collection
    bGlobalVarExist = GlobalVar.Exist(sVar)
    GlobalVar[sVar] = vValue

    ' Never look for trigger for the uptime or tagline
    If (sVar <> "Program_Uptime" And sVar <> "Tagline") Then
      Events.CheckGlobalVarEvents(sVar, vValue)
      If bBroadcast Then BroadcastEvent("[GlobalVar]" & sVar & "|" & vValue)
    Endif

    ' Write it to the globalvars table, but ignore second and program uptime. We don't want to write too much
    If (sVar <> "Second" And sVar <> "Program_Uptime") Then
      If GlobalVar.Exist(sVar) Then
        rResult = Main.hDB.Exec("UPDATE globalvars SET value = &1 WHERE var = &2", vValue, sVar)
      Else
        ' Before we do an insert, first check if it already exist - as safeguard
        rResult = Main.hDB.Exec("SELECT * FROM globalvars where var = &1", sVar)

        ' Only do an insert if the count=0, else do an update
        If rResult.Count = 0 Then
          Try rResult = Main.hDB.Exec("INSERT INTO globalvars SET var = &1, value = &2", sVar, vValue)
        Else
          rResult = Main.hDB.Exec("UPDATE globalvars SET value = &1 WHERE var = &2", vValue, sVar)
        Endif
      Endif
    Endif

    ' Convert an empty string to "<EMPTY>" - else the Collection will remove the sVar key
    If TypeOf(vValue) = gb.String Then
      If vValue = "" Then
        vValue = "<EMPTY>"
        GlobalVar[sVar] = vValue
      Endif
    Endif

  Endif

  Return True

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' del globalvar
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub DelGlobalVar(sVar As String)

  If Main.GlobalVar.Exist(sVar) Then Main.GlobalVar.Remove(sVar)
  Main.hDB.Exec("DELETE FROM globalvars WHERE var = &1", sVar)

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' save globalvars to database
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub SaveGlobalVars()

  ' DIM tableGlobalVars AS Table
  Dim vValue As Variant
  Dim rResult As Result

  ' erase table contents only
  Try Main.hDB.Exec("TRUNCATE TABLE globalvars")

  ' write vars to db table
  For Each vValue In Main.GlobalVar
    Main.hDB.Begin()
    rResult = Main.hDB.Create("globalvars")
    rResult!var = Main.GlobalVar.Key
    If vValue = "<EMPTY>" Then
      rResult!value = ""
    Else
      rResult!value = vValue
    Endif
    rResult.Update()
    Main.hDB.Commit()
  Next
  If Main.bMainDebug Then Main.WriteDebugLog("[Main] Globalvars Saved.")

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' restore all globalvars from database
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub RestoreGlobalVars()

  Dim rResult As Result

  Try rResult = Main.hDB.Exec("SELECT * FROM globalvars")
  If rResult Then
    If rResult.Count Then
      For Each rResult
        If rResult!value = "" Then
          Main.GlobalVar[rResult!var] = "<EMPTY>"
        Else
          Main.GlobalVar[rResult!var] = rResult!value
        Endif
      Next
      If Main.bMainDebug Then Main.WriteDebugLog("[Main] Globalvars Restored.")
    Endif
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' check if command can be found on system
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Function ProgramExist(sProg As String) As Boolean

  Dim sTemp As String
  Dim iPos As Integer

  iPos = String.InStr(sProg, " ")
  If iPos Then sProg = String.Left(sProg, iPos - 1)

  Shell "which " & sProg To sTemp

  If Not sTemp Then Return False
  Return Not (Trim$(sTemp) Like "which: *")

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' insert spaces at end of string until length reached
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Function SpaceAlignLeft(sString As String, iLength As Integer) As String

  While Len(sString) < iLength
    sString = sString & " "
  Wend
  Return sString

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' insert spaces at start of string until length reached
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Function SpaceAlign(sString As String, iLength As Integer) As String

  While Len(sString) < iLength
    sString = " " & sString
  Wend
  Return sString

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' wake up a computer by sending a WOL magic packet
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub WakeOnLan(sMAC As String)

  Dim aMAC, aIPs, athisIP As String[]
  Dim sHWAddress, sMsg, sHost, sIP As String
  Dim iCount As Integer

  aMAC = Split(sMAC, ":")

  For iCount = 0 To 5
    sHWAddress &= aMAC[icount]
  Next
  sMsg = Chr(255) & Chr(255) & Chr(255) & Chr(255) & Chr(255) & Chr(255)
  For iCount = 1 To 16
    sMsg &= sHWAddress
  Next

  ' sent it to all computers on this network
  hBroadcast = New UdpSocket As "Broadcast"
  hBroadcast.Broadcast = True
  hBroadcast.Port = 0
  hBroadcast.Bind()
  hBroadcast.TargetPort = 9

  Exec ["hostname", "-i"] To sHost
  aIPs = Split(Trim$(sHost), " ")
  For Each sIP In aIPs
    athisIP = Split(sIP, ".")
    If CInt(athisIP[0]) = 127 Then Continue
    hBroadcast.TargetHost = athisIP[0] & "." & athisIP[1] & "." & athisIP[2] & "." & "255"
    Write #hBroadcast, sMsg, Len(sMsg)
  Next
  Close hBroadcast

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' catch errors
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Broadcast_Error()

  Select Case hBroadcast.Status
    Case Net.CannotBindSocket
      Main.WriteDebugLog("[WOL] Unable to bind to that port.")
    Case Net.CannotCreateSocket
      Main.WriteDebugLog("[WOL] The system does not allow to create a socket.")
    Case Net.CannotRead
      Main.WriteDebugLog("[WOL] Error receiving data.")
    Case Net.CannotWrite
      Main.WriteDebugLog("[WOL] Error sending data.")
  End Select

End

Public Sub DisplayBool(bSwitch As Boolean) As String

  Select bSwitch
    Case True
        Return ("True")
    Case Else
        Return ("False")
  End Select

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' simple check for time string
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Function IsTime(sString As String) As Boolean

  If Len(sString) > 3 And InStr(sString, ":") Then
    Return True
  Else
    Return False
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' simple check for boolean string
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Function IsBool(sStr As String) As Boolean

  If sStr == "True" Then Return True
  If sStr == "False" Then Return True
  Return False

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' calculate program uptime string
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Function UptimeString(lSeconds As Long) As String

  Dim lDays, lHrs, lMins, lSecs As Long

  lSecs = lSeconds Mod 60
  lMins = (lSeconds Mod 3600) \ 60
  lHrs = (lSeconds Mod (3600 * 24)) \ 3600
  lDays = lSeconds \ (3600 * 24)
  Return lDays & IIf(lDays = 1, (" day, "), (" days, ")) & lHrs & IIf(lHrs = 1, (" hr, "), (" hrs, ")) & lMins & IIf(lMins = 1, (" min,"), (" mins,")) & (" and ") & lSecs & IIf(lSecs = 1, (" sec."), (" secs."))

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' return name of caller if known
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Function ReturnCallerID(sPhoneNo As String) As String

  Dim rResult As Result
  Dim sName As String = ("Unknown")

  If Len(sPhoneNo) Then
    rResult = Main.hDB.Exec("SELECT name, cidphone FROM contacts WHERE phoneno = &1", sPhoneNo)
    If rResult.Count Then
      If rResult!cidphone Then
        sName = rResult!cidphone
      Else
        sName = rResult!name
      Endif
    Endif
    rResult = Main.hDB.Exec("SELECT name, cidmobile FROM contacts WHERE mobileno = &1", sPhoneNo)
    If rResult.Count Then
      If rResult!cidmobile Then
        sName = rResult!cidmobile
      Else
        sName = rResult!name
      Endif
    Endif
    Return sName
  Else
    Return ("Hidden")
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' check if system has minimal gambas version required
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Function CheckReq(iMinimalVersion As Integer) As Boolean

  Dim iVer As Integer
  Dim sVer As String

  If InStr(GetGambasVersion(), " ") = 0 Then
    sVer = GetGambasVersion()
  Else
    sVer = Left$(GetGambasVersion(), InStr(GetGambasVersion(), " ") - 1)
  Endif

  iVer = Val(Replace(sVer, ".", ""))
  If iVer >= iMinimalVersion Then
    Return False
  Else
    Return True
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' get ip address of this machine
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Setup_IPAddr()

  Dim sHost As String

  ' inet 192.168.178.24/24 brd 192.168.178.255 scope global eth0
  Shell "ip addr | grep brd | grep inet | awk -F ' ' '{print $2}' | awk -F '/' '{print $1}'" To sHost
  sOurIPAddress = Trim(sHost)

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' determine broadcast address(es) of this machine
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Setup_BroadcastAddrs()

  Dim aIPs, athisIP As String[]
  Dim sHost, sIP As String

  Shell "ip addr | grep brd | grep inet | awk -F ' ' '{print $4}'" To sHost
  aIPs = Split(Trim$(sHost), " ")
  For Each sIP In aIPs
    athisIP = Split(sIP, ".")
    If CInt(athisIP[0]) = 127 Then Continue
    aBroadcastAddrs.Add(athisIP[0] & "." & athisIP[1] & "." & athisIP[2] & "." & athisIP[3])
    Main.WriteLog("[Main] Found broadcast address '" & Trim(sHost) & "'")
  Next

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' broadcast events via UDP
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub BroadcastEvent(sMessage As String)

  Dim sIP As String

  ' not ready yet
  If hBroadcastEvent = Null Then Return
  ' broadcast msg on network(s)
  For Each sIp In aBroadcastAddrs
    hBroadcastEvent.TargetHost = sIp
    Try Write #hBroadcastEvent, sMessage, Len(sMessage)
  Next

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' catch errors
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub BroadcastUDP_Error()

  Select Case hBroadcastEvent.Status
    Case Net.CannotBindSocket
      Main.WriteDebugLog("[BroadcastUDP] Unable to bind to that port.")
    Case Net.CannotCreateSocket
      Main.WriteDebugLog("[BroadcastUDP] The system does not allow to create a socket.")
    Case Net.CannotRead
      Main.WriteDebugLog("[BroadcastUDP] Error receiving data.")
    Case Net.CannotWrite
      Main.WriteDebugLog("[BroadcastUDP] Error sending data.")
  End Select

Catch

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' check if program and database versions match and try to update
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Private Sub CheckDatabaseVersion()

  Dim rResult As Result
  Dim sDBVersion, sPrgVersion, sDumpFile, sToVersion As String
  Dim iDBVersion, iPrgVersion As Integer
  Dim hMysql As Process

  sPrgVersion = sProgramVersion
  iPrgVersion = Val(Replace(sPrgVersion, ".", ""))

  ' fetch database version from database
  rResult = Main.hDB.Exec("SELECT * FROM version ORDER BY db DESC LIMIT 1 ")
  If rResult.Count = 1 Then
    sDBVersion = Str(rResult!db)
    ' convert 0.1.180 to 01180
    iDBVersion = Val(Replace(sDBVersion, ".", ""))
    If iDBVersion < iPrgVersion Then
      WriteLog("The version of your database is " & sDBVersion & " but the version of the program is " & sPrgVersion & ("!"))
      Repeat
        If bAllowAutoUpgrade Then
          If Main.ProgramExist("mysql") Then
            sToVersion = Format(Str(iDBVersion + 1), "00000")
            ' make the jump to version 1.0.000
            If sToVersion = "01210" Then sToVersion = "10000"
            sDumpFile = "upgrade/" & Replace(sDBVersion, ".", "") & "to" & sToVersion & ".sql"
            If Exist(sBaseDir &/ sDumpFile) Then
              hMysql = Shell "mysql --host=" & sSQLHost & " --user=" & sSQLUser & " --password=" & sSQLPass & " --database=" & sSQLDatabase & " --execute='SOURCE " & sBaseDir &/ sDumpFile & "'" Wait
              If hMysql.Value Then ' mysql returned an error
                WriteLog("MySQL command returned an error! The database is now at version " & sDBVersion)
                Quit
              Else
                ' check if we are there yet
                rResult = Main.hDB.Exec("SELECT * FROM version ORDER BY db DESC LIMIT 1")
                If rResult.Count = 1 Then
                  sDBVersion = Str(rResult!db)
                  ' convert 0.1.180 to 01180
                  iDBVersion = Val(Replace(sDBVersion, ".", ""))
                Endif
              Endif
            Else
              WriteLog("Couldn't find upgrade file " & sDumpFile & "! The Database is now at version " & sDBVersion)
              Quit
            Endif
            WriteLog("Database has been upgraded to version " & sDBVersion)
            If iPrgVersion = iDBVersion Then Return
          Else
            WriteLog("Couldn't find MySQL program!")
            Quit
          Endif
        Else
          WriteLog("You can run " & Application.Name & " with the -a parameter to allow automatic upgrade!")
          Quit
        Endif
      Until iPrgVersion = iDBVersion
    Endif
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' some GUI related routines are placed here, so max number of
' modules for client and server can share code.
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' run notify-send to display notification
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub NotifySend(sTitle As String, sText As String)

  If Main.bServer Then
    If Main.bBroadcastUDPEnabled Then Main.BroadcastEvent("[NotifySend]" & sTitle & "|" & sText & "|" & sBaseDir &/ "icons" &/ "logo.png")
  Endif

End

Public Sub ControlLed(sLed As String, sStatus As String)

  ' do nothing

End

Public Sub PLCBUSStatus(sStatus As String)

  Main.BroadcastEvent("[PLCBUSStatus]" & sStatus)

End

Public Sub RefreshDeviceList()

  Main.BroadcastEvent("[DeviceUpdate]")

End

Public Sub RefreshControlPage()

  Main.BroadcastEvent("[ControlUpdate]")

End

Public Sub RefreshPhoneCallList()

  Main.BroadcastEvent("[PhoneCallUpdate]")

End

Public Sub SendSMS(sText As String, sTo As String)

  If Main.hSMS Then Main.hSMS.SendSMS(sText, sTo)

End

Private Sub Setup_Calendar()
  
  Calendar.Init()
  
End
