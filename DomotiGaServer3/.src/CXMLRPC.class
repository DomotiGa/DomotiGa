' Gambas class file

' Description:
' CXMLRPC.class
' Built-in XML-RPC server.

' Development Status:
' Just started.

' DomotiGa - an open source home automation program.
' Copyright (C) Ron Klinkien, The Netherlands.

' Read file called COPYING for license details.

PROPERTY HTTPPort AS Integer
PROPERTY MaxConn AS Integer
PROPERTY XMLRPCDebug AS Boolean

PRIVATE iHTTPPort AS Integer
PRIVATE iMaxConn AS Integer
PRIVATE bXMLRPCDebug AS Boolean

PUBLIC hXMLRPC AS RpcServer
PRIVATE APIVersion AS String = "0.16"

PUBLIC FUNCTION Connect() AS Boolean

  DIM hRpcFunc AS RpcFunction

  hXMLRPC = NEW RpcServer AS "hXMLRPC"

  ' start method definitions
  hRpcFunc = NEW RpcFunction("system.program_uptime", NULL, XmlRpc.xString)
  hRpcFunc.Help = ("returns the program uptime.")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("system.program_version", NULL, XmlRpc.xString)
  hRpcFunc.Help = ("returns the program version.")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("api.version", NULL, XmlRpc.xString)
  hRpcFunc.Help = ("returns the api version.")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("system.pid", NULL, XmlRpc.xString)
  hRpcFunc.Help = ("returns the process id.")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("system.hostname", NULL, XmlRpc.xString)
  hRpcFunc.Help = ("returns the hostname.")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("data.newmessages", NULL, XmlRpc.xArray)
  hRpcFunc.Help = ("returns new mails, calls and voicemails.")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("data.sunmoon", NULL, XmlRpc.xArray)
  hRpcFunc.Help = ("returns sun and moon data.")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("mode.get_housemode", NULL, XmlRpc.xString)
  hRpcFunc.Help = ("returns the house mode.")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("mode.get_mutemode", NULL, XmlRpc.xBoolean)
  hRpcFunc.Help = ("returns the mute mode.")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("globalvar.list", NULL, XmlRpc.xArray)
  hRpcFunc.Help = ("returns a list of global variables.")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("device.list", NULL, XmlRpc.xStruct)
  hRpcFunc.Help = ("returns a list of devices.")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("device.listswitch", NULL, XmlRpc.xStruct)
  hRpcFunc.Help = ("returns a list of devices which can be switched.")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("device.listdim", NULL, XmlRpc.xStruct)
  hRpcFunc.Help = ("returns a list of devices which can be dimmed.")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("module.restart", [XmlRpc.xString], XmlRpc.xBoolean)
  hRpcFunc.Help = ("reload config and restart module param1.")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("send.email", [XmlRpc.xString, XmlRpc.xString, XmlRpc.xString], XmlRpc.xBoolean)
  hRpcFunc.Help = ("send email to param1, with subject param2 and body param3.")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("send.tweet", [XmlRpc.xString], XmlRpc.xBoolean)
  hRpcFunc.Help = ("send tweet with param1 as contents.")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("send.sms", [XmlRpc.xString, XmlRpc.xString], XmlRpc.xBoolean)
  hRpcFunc.Help = ("send sms to param1, with param2 as contents.")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("set.housemode", [XmlRpc.xString], XmlRpc.xBoolean)
  hRpcFunc.Help = ("set house mode to param1.")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("set.mutemode", [XmlRpc.xBoolean], XmlRpc.xBoolean)
  hRpcFunc.Help = ("set mute mode to param1.")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("device.setdevice", [XmlRpc.xString, XmlRpc.xString], XmlRpc.xBoolean)
  hRpcFunc.Help = ("set device param1 with value param2.")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("device.getstate", [XmlRpc.xString], XmlRpc.xString)
  hRpcFunc.Help = ("get device state from device with name param1.")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("set.alarmpin", [XmlRpc.xString], XmlRpc.xBoolean)
  hRpcFunc.Help = ("set alarm pin to param1.")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("set.alarmmode", [XmlRpc.xString], XmlRpc.xBoolean)
  hRpcFunc.Help = ("set alarm mode to param1.")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("play.sound", [XmlRpc.xString, XmlRpc.xInteger], XmlRpc.xBoolean)
  hRpcFunc.Help = ("play sound param1 with volume param2.")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("voicetext.speak", [XmlRpc.xString, XmlRpc.xString], XmlRpc.xBoolean)
  hRpcFunc.Help = ("speak text param1 with voice param2.")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("pachube.list", NULL, XmlRpc.xString)
  hRpcFunc.Help = ("get pachube device list in eeml.")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("serverstats.updategraphs", [XmlRpc.xString], XmlRpc.xBoolean)
  hRpcFunc.Help = ("update serverstats graph images for range param1.")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("rrdtool.listgraphs", NULL, XmlRpc.xString)
  hRpcFunc.Help = ("get list of rrdtool graph images in group param1.")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("rrdtool.updategraphs", [XmlRpc.xString, XmlRpc.xString], XmlRpc.xBoolean)
  hRpcFunc.Help = ("update rrdtool graph images in group param1 for range param2.")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("rrdtool.createrrds", [XmlRpc.xString], XmlRpc.xBoolean)
  hRpcFunc.Help = ("create rrdtool database for device id param1.")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("display.ledmessage", [XmlRpc.xString, XmlRpc.xString], XmlRpc.xBoolean)
  hRpcFunc.Help = ("display message param2 on display with id param1.")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("av.setcontrol", [XmlRpc.xString, XmlRpc.xString, XmlRpc.xString, XmlRpc.xString], XmlRpc.xBoolean)
  hRpcFunc.Help = ("set audio/video param1 with command param2, value param3, address param4.")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("av.getcontrol", [XmlRpc.xString, XmlRpc.xString, XmlRpc.xString], XmlRpc.xBoolean)
  hRpcFunc.Help = ("get audio/video param1 setting param2, address param3.")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("globalvar.save", NULL, XmlRpc.xBoolean)
  hRpcFunc.Help = ("saves global variables to database.")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("globalvar.get", NULL, XmlRpc.xArray)
  hRpcFunc.Help = ("returns a list of global variables with values.")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("globalvar.set", [XmlRpc.xString, XmlRpc.xString], XmlRpc.xBoolean)
  hRpcFunc.Help = ("set global variable param1 to param2.")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("globalvar.del", [XmlRpc.xString], XmlRpc.xBoolean)
  hRpcFunc.Help = ("delete global variable param1")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("zwave.removenodes", NULL, XmlRpc.xBoolean)
  hRpcFunc.Help = ("zwave remove all nodes.")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("zwave.createnode", [XmlRpc.xInteger, XmlRpc.xInteger, XmlRpc.xInteger, XmlRpc.xInteger, XmlRpc.xInteger, XmlRpc.xInteger, XmlRpc.xBoolean], XmlRpc.xBoolean)
  hRpcFunc.Help = ("zwave create node.")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("zwave.setids", [XmlRpc.xInteger, XmlRpc.xInteger], XmlRpc.xBoolean)
  hRpcFunc.Help = ("zwave set ids.")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("zwave.setvalue", [XmlRpc.xInteger, XmlRpc.xInteger, XmlRpc.xInteger, XmlRpc.xInteger, XmlRpc.xString], XmlRpc.xBoolean)
  hRpcFunc.Help = ("zwave set device value.")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("zwave.allqueried", NULL, XmlRpc.xBoolean)
  hRpcFunc.Help = ("zwave all queried.")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("cmdr.culsimulate", [XmlRpc.xString], XmlRpc.xBoolean)
  hRpcFunc.Help = ("cmdr inject cul packet in simulator.")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("cmdr.culqueuecommand", [XmlRpc.xString], XmlRpc.xBoolean)
  hRpcFunc.Help = ("cmdr cul queue command.")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("cmdr.plcbustxcommand", [XmlRpc.xString, XmlRpc.xString, XmlRpc.xBoolean, XmlRpc.xInteger], XmlRpc.xBoolean)
  hRpcFunc.Help = ("cmdr plcbus queue command.")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("thermostat.listscenario", NULL, XmlRpc.xStruct)
  hRpcFunc.Help = ("thermostat list all scenarii.")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("thermostat.getscenario", NULL, XmlRpc.xStruct)
  hRpcFunc.Help = ("thermostat get active scenario.")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("thermostat.setscenario", [XmlRpc.xString], XmlRpc.xBoolean)
  hRpcFunc.Help = ("thermostat set scenario.")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("thermostat.derogateheating", [XmlRpc.xString, XmlRpc.xString, XmlRpc.xString], XmlRpc.xBoolean)
  hRpcFunc.Help = ("thermostat change requested temperature for a heating.")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("events.runactions", [XmlRpc.xInteger], XmlRpc.xBoolean)
  hRpcFunc.Help = ("run all actions from event with id param1")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("events.runaction", [XmlRpc.xInteger], XmlRpc.xBoolean)
  hRpcFunc.Help = ("run action with id param1")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("calendar.setplanning", [XmlRpc.xArray], XmlRpc.xBoolean)
  hRpcFunc.Help = ("set occupancy planning")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("calendar.getplanning", NULL, XmlRpc.xArray)
  hRpcFunc.Help = ("get occupancy planning")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("squeezebox.setvolumeplayer", [XmlRpc.xString, XmlRpc.xString], XmlRpc.xBoolean)
  hRpcFunc.Help = ("set volume with player")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("squeezebox.getvolumeplayer", [XmlRpc.xString], XmlRpc.xString)
  hRpcFunc.Help = ("get volume with player")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("squeezebox.stopplayer", [XmlRpc.xString], XmlRpc.xBoolean)
  hRpcFunc.Help = ("stop player")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("squeezebox.playplayer", [XmlRpc.xString], XmlRpc.xBoolean)
  hRpcFunc.Help = ("start player")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("squeezebox.nextnumberplayer", [XmlRpc.xString], XmlRpc.xBoolean)
  hRpcFunc.Help = ("next number")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("squeezebox.prevnumberplayer", [XmlRpc.xString], XmlRpc.xBoolean)
  hRpcFunc.Help = ("prev number")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("squeezebox.getcurrentnumberplayer", [XmlRpc.xString], XmlRpc.xString)
  hRpcFunc.Help = ("get current number")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("squeezebox.getalbums", NULL, XmlRpc.xArray)
  hRpcFunc.Help = ("get albums")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("squeezebox.getmodeplayer", [XmlRpc.xString], XmlRpc.xString)
  hRpcFunc.Help = ("get mode player")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("squeezebox.getplayerid", [XmlRpc.xString], XmlRpc.xString)
  hRpcFunc.Help = ("get player id")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("squeezebox.getplayername", [XmlRpc.xString], XmlRpc.xString)
  hRpcFunc.Help = ("get player name")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("squeezebox.getisplayer", [XmlRpc.xString], XmlRpc.xString)
  hRpcFunc.Help = ("get is player")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("squeezebox.clearplaylistplayer", [XmlRpc.xString], XmlRpc.xBoolean)
  hRpcFunc.Help = ("clear playlist player")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("squeezebox.addalbumtoplaylistplayer", [XmlRpc.xString, XmlRpc.xString], XmlRpc.xBoolean)
  hRpcFunc.Help = ("add album to playlist for player")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("squeezebox.getcurrentartistplayer", [XmlRpc.xString], XmlRpc.xString)
  hRpcFunc.Help = ("get current artist for player")
  hXMLRPC.Register(hRpcFunc)
  hRpcFunc = NEW RpcFunction("squeezebox.getplayerisconnectedtoserver", [XmlRpc.xString], XmlRpc.xBoolean)
  hRpcFunc.Help = ("is player connected to server")
  hXMLRPC.Register(hRpcFunc)

  TRY hXMLRPC.Listen(iHTTPPort, iMaxConn)
  IF NOT hXMLRPC.Listening THEN
    RETURN FALSE
  ENDIF
  RETURN TRUE

END

' shutdown our xmlrpc server
PUBLIC SUB Disconnect()

  hXMLRPC.Stop()

END

PRIVATE SUB ReturnDeviceListDimSwitch(sType AS String)

  DIM rResult AS Result
  DIM sString AS NEW Collection
  DIM sList AS NEW RpcStruct
  DIM sStatusIcon AS String
  DIM iCnt AS Integer

  rResult = Main.hDB.Exec("SELECT * FROM devices WHERE enabled is TRUE")

  IF NOT rResult.Available THEN
    Main.WriteLog(("Error: table 'devices' not found!"))
    RETURN
  ENDIF

  FOR iCnt = 0 TO rResult.Max
    IF NOT rResult!hide THEN
      IF (sType = "switchable" AND rResult!switchable) OR (sType = "dimable" AND rResult!dimable) THEN
        ' status icon
        IF rResult!onicon OR rResult!officon THEN
          IF UCase$(rResult!value) = "ON" OR UCase$(rResult!value) = "OPEN" OR UCase$(rResult!value) = "MOTION" THEN
            sStatusIcon = rResult!onicon
          ELSE
            sStatusIcon = rResult!officon
          ENDIF
        ENDIF
        sString[iCnt] = rResult!id & ";;" & sStatusIcon & ";;" & rResult!name & ";;" & rResult!value
        sList.Add(rResult!name, sString[iCnt], XmlRpc.xString)
      ENDIF
    ENDIF
    rResult.MoveNext
  NEXT
  hXMLRPC.SetReply(sList)

END

PRIVATE SUB ModuleRestart(sParams AS Variant[])

  IF sParams.Count = 1 THEN
    Main.GetSettings()
    TRY Object.Call(Main, "Restart_" & sParams[0])
    IF ERROR THEN
      Main.WriteDebugLog(("XMLRPC Error: '" & Error.Text & "' at '" & Error.Where & "' when restarting module!"))
      hXMLRPC.SetReply(FALSE)
    ELSE
      hXMLRPC.SetReply(TRUE)
    ENDIF
  ELSE
    hXMLRPC.SetReply(FALSE)
  ENDIF

END

PRIVATE SUB SendEmail(sParams AS Variant[])

  IF sParams.Count = 3 THEN
    TRY Mail.SendMail(sParams[1], sParams[2], sParams[0])
    IF ERROR THEN
      Main.WriteDebugLog(("XMLRPC Error: '" & Error.Text & "' at '" & Error.Where & "' when sending an e-mail!"))
      hXMLRPC.SetReply(FALSE)
    ELSE
      hXMLRPC.SetReply(TRUE)
    ENDIF
  ELSE
    hXMLRPC.SetReply(FALSE)
  ENDIF

END

PRIVATE SUB SendTweet(sParams AS Variant[])

  IF sParams.Count = 1 THEN
    TRY Twitter.PostTweet(sParams[0])
    IF ERROR THEN
      Main.WriteDebugLog(("XMLRPC Error: '" & Error.Text & "' at '" & Error.Where & "' when sending an Tweet!"))
      hXMLRPC.SetReply(FALSE)
    ELSE
      hXMLRPC.SetReply(TRUE)
    ENDIF
  ELSE
    hXMLRPC.SetReply(FALSE)
  ENDIF

END

PRIVATE SUB SendSMS(sParams AS Variant[])

  IF sParams.Count = 2 THEN
    TRY Main.hSMS.SendSMS(sParams[1], sParams[0])
    IF ERROR THEN
      Main.WriteDebugLog(("XMLRPC Error: '" & Error.Text & "' at '" & Error.Where & "' when sending an SMS!"))
      hXMLRPC.SetReply(FALSE)
    ELSE
      hXMLRPC.SetReply(TRUE)
    ENDIF
  ELSE
    hXMLRPC.SetReply(FALSE)
  ENDIF

END

PRIVATE SUB SetHouseMode(sParams AS Variant[])

  IF sParams.Count = 1 THEN
    IF InStr("normal away vacation work", sParams[0]) THEN
      TRY Main.ChangeHouseMode(sParams[0])
      IF ERROR THEN
        Main.WriteDebugLog(("XMLRPC Error: '" & Error.Text & "' at '" & Error.Where & "' when setting House mode!"))
        hXMLRPC.SetReply(FALSE)
      ELSE
        hXMLRPC.SetReply(TRUE)
      ENDIF
    ENDIF
  ELSE
    hXMLRPC.SetReply(FALSE)
  ENDIF

END

PRIVATE SUB SetAlarmMode(sParams AS Variant[])

  IF sParams.Count = 1 THEN
    IF InStr("0311 0301", sParams[0]) THEN
      IF Main.hDSC THEN TRY Main.hDSC.TX(sParams[0])
      IF ERROR THEN
        Main.WriteDebugLog(("XMLRPC Error: '" & Error.Text & "' at '" & Error.Where & "' when setting Alarm mode!"))
        hXMLRPC.SetReply(FALSE)
      ELSE
        hXMLRPC.SetReply(TRUE)
      ENDIF
    ENDIF
  ELSE
    hXMLRPC.SetReply(FALSE)
  ENDIF

END

PRIVATE SUB SetAlarmPin(sParams AS Variant[])

  IF sParams.Count = 1 THEN
    IF Main.hDSC THEN TRY Main.hDSC.TX("0401" & sParams[0])
    IF ERROR THEN
      Main.WriteDebugLog(("XMLRPC Error: '" & Error.Text & "' at '" & Error.Where & "' when setting Alarm pin!"))
      hXMLRPC.SetReply(FALSE)
    ELSE
      hXMLRPC.SetReply(TRUE)
    ENDIF
  ELSE
    hXMLRPC.SetReply(FALSE)
  ENDIF

END

PRIVATE SUB SetMuteMode(sParams AS Variant[])

  IF sParams.Count = 1 THEN
    TRY Main.ChangeMuteMode(sParams[0])
    IF ERROR THEN
      Main.WriteDebugLog(("XMLRPC Error: '" & Error.Text & "' at '" & Error.Where & "' when setting Mute mode!"))
      hXMLRPC.SetReply(FALSE)
    ELSE
      hXMLRPC.SetReply(TRUE)
    ENDIF
  ELSE
    hXMLRPC.SetReply(FALSE)
  ENDIF

END

PRIVATE SUB DeviceSetDevice(sParams AS Variant[])

  IF sParams.Count = 2 THEN
    TRY Devices.SetDevice(sParams[0], sParams[1])
    IF ERROR THEN
      Main.WriteDebugLog(("XMLRPC Error: '" & Error.Text & "' at '" & Error.Where & "' when setting device value!"))
      hXMLRPC.SetReply(FALSE)
    ELSE
      hXMLRPC.SetReply(TRUE)
    ENDIF
  ELSE
    hXMLRPC.SetReply(FALSE)
  ENDIF

END

PRIVATE SUB DeviceGetState(sParams AS Variant[])

  DIM sValue AS String

  IF sParams.Count = 1 THEN
    TRY sValue = Devices.GetValueForDevice(sParams[0])
    IF ERROR THEN
      Main.WriteDebugLog(("XMLRPC Error: '" & Error.Text & "' at '" & Error.Where & "' when getting device state!"))
      hXMLRPC.SetReply(FALSE)
    ELSE
      hXMLRPC.SetReply(sValue)
    ENDIF
  ELSE
    hXMLRPC.SetReply(FALSE)
  ENDIF

END

PRIVATE SUB ReturnDeviceList()

  DIM rResult, rResult3 AS Result
  DIM sString AS NEW Collection
  DIM sList AS NEW RpcStruct
  DIM iCnt AS Integer
  DIM sStatusIcon, sLastseen, sValue, sValue2, sValue3, sValue4, sLocation AS String

  rResult = Main.hDB.Exec("SELECT * FROM devices WHERE enabled is TRUE")

  IF NOT rResult.Available THEN
    Main.WriteLog(("Error: table 'devices' not found!"))
    RETURN
  ENDIF

  FOR iCnt = 0 TO rResult.Max
    IF NOT rResult!hide THEN
      ' status icon
      IF rResult!onicon OR rResult!officon THEN
        IF UCase$(rResult!value) = "ON" OR UCase$(rResult!value) = "OPEN" OR UCase$(rResult!value) = "MOTION" THEN
          sStatusIcon = rResult!onicon
        ELSE
          sStatusIcon = rResult!officon
        ENDIF
      ELSE
        sStatusIcon = ""
      ENDIF
      ' location
      TRY rResult3 = Main.hDB.Exec("SELECT * FROM locations WHERE id = &1", rResult!location)
      IF ERROR THEN
        sLocation = ""
      ELSE IF rResult3.Available THEN
        sLocation = rResult3!name
      ENDIF
      ' last seen
      TRY sLastseen = Replace$(Str$(Format(rResult!lastseen, "yyyy-mm-dd hh:nn:ss")), Format(Date(), "yyyy-mm-dd") & " ", "")
      IF ERROR THEN
        sLastSeen = "Never"
      ENDIF

      TRY sValue = Devices.CorrectValue(rResult!value, rResult!correction, rResult)
      TRY sValue2 = Devices.CorrectValue(rResult!value2, rResult!correction2, rResult)
      TRY sValue3 = Devices.CorrectValue(rResult!value3, rResult!correction3, rResult)
      TRY sValue4 = Devices.CorrectValue(rResult!value4, rResult!correction4, rResult)

      sString[iCnt] = rResult!id & ";;" & sStatusIcon & ";;" & rResult!name & ";;" & sLocation & ";;" & sValue & ";;" & rResult!label & ";;" & sValue2 & ";;" & rResult!label2 & ";;" & sValue3 & ";;" & rResult!label3 & ";;" & sValue4 & ";;" & rResult!label4 & ";;" & sLastSeen & ";;" & rResult!dimable & ";;" & rResult!switchable & ";;" & rResult!battery
      sList.Add(rResult!name, sString[iCnt], XmlRpc.xString)
    ENDIF
    rResult.MoveNext
  NEXT
  hXMLRPC.SetReply(sList)

END

PRIVATE SUB PlaySound(sParams AS Variant[])

  IF sParams.Count > 1 AND IF sParams.Count < 3 THEN
    TRY Sounds.PlaySnd(sParams[0], sParams[1])
    IF ERROR THEN
      Main.WriteDebugLog(("XMLRPC Error: '" & Error.Text & "' at '" & Error.Where & "' when playing sound!"))
      hXMLRPC.SetReply(FALSE)
    ELSE
      hXMLRPC.SetReply(TRUE)
    ENDIF
  ELSE
    hXMLRPC.SetReply(FALSE)
  ENDIF

END

PRIVATE SUB VoiceTextSpeak(sParams AS Variant[])

  IF sParams.Count > 1 AND IF sParams.Count < 3 THEN
    TRY VoiceText.Speak(sParams[0], sParams[1])
    IF ERROR THEN
      Main.WriteDebugLog(("XMLRPC Error: '" & Error.Text & "' at '" & Error.Where & "' when speaking voicetext!"))
      hXMLRPC.SetReply(FALSE)
    ELSE
      hXMLRPC.SetReply(TRUE)
    ENDIF
  ELSE
    hXMLRPC.SetReply(FALSE)
  ENDIF

END

PRIVATE SUB ServerStatsUpdateGraphs(sParams AS Variant[])

  IF sParams.Count = 1 THEN
    TRY ServerStats.CreateGraphs(sParams[0])
    IF ERROR THEN
      Main.WriteDebugLog(("XMLRPC Error: '" & Error.Text & "' at '" & Error.Where & "' when updating serverstats graphs!"))
      hXMLRPC.SetReply(FALSE)
    ELSE
      hXMLRPC.SetReply(TRUE)
    ENDIF
  ELSE
    hXMLRPC.SetReply(FALSE)
  ENDIF

END

PRIVATE SUB RRDToolListGraphs(sParams AS Variant[])

  IF sParams.Count = 1 THEN
    TRY RRDTool.Graphs(sParams[0])
    IF ERROR THEN
      Main.WriteDebugLog(("XMLRPC Error: '" & Error.Text & "' at '" & Error.Where & "' when listing rrdtool graphs!"))
      hXMLRPC.SetReply(FALSE)
    ELSE
      hXMLRPC.SetReply(TRUE)
    ENDIF
  ELSE
    hXMLRPC.SetReply(FALSE)
  ENDIF

END

PRIVATE SUB RRDToolUpdateGraphs(sParams AS Variant[])

  IF sParams.Count = 2 THEN
    TRY RRDTool.CreateGraphs(sParams[0], sParams[1])
    TRY RRDTool.CreateExtGraphs(sParams[0], sParams[1])
    IF ERROR THEN
      Main.WriteDebugLog(("XMLRPC Error: '" & Error.Text & "' at '" & Error.Where & "' when updating rrdtool graphs!"))
      hXMLRPC.SetReply(FALSE)
    ELSE
      hXMLRPC.SetReply(TRUE)
    ENDIF
  ELSE
    hXMLRPC.SetReply(FALSE)
  ENDIF

END

PRIVATE SUB RRDToolCreateRRDs(sParams AS Variant[])

  IF sParams.Count = 1 THEN
    TRY RRDTool.CreateRRDs(sParams[0])
    IF ERROR THEN
      Main.WriteDebugLog(("XMLRPC Error: '" & Error.Text & "' at '" & Error.Where & "' when creating rrdtool database!"))
      hXMLRPC.SetReply(FALSE)
    ELSE
      hXMLRPC.SetReply(TRUE)
    ENDIF
  ELSE
    hXMLRPC.SetReply(FALSE)
  ENDIF

END

PRIVATE SUB DisplayLEDMessage(sParams AS Variant[])

  IF sParams.Count = 2 THEN
    TRY Main.hLEDMatrix.DisplayMessage(sParams[0], sParams[1])
    IF ERROR THEN
      Main.WriteDebugLog(("XMLRPC Error: '" & ERROR.Text & "' at '" & Error.Where & "' when displaying a message!"))
      hXMLRPC.SetReply(FALSE)
    ELSE
      hXMLRPC.SetReply(TRUE)
    ENDIF
  ELSE
    hXMLRPC.SetReply(FALSE)
  ENDIF

END

PRIVATE SUB SetAVControl(sParams AS Variant[])

  IF sParams.Count = 4 THEN
    TRY AVControl.Set(sParams[0], sParams[1], sParams[2], sParams[3])
    IF ERROR THEN
      Main.WriteDebugLog(("XMLRPC Error: '" & Error.Text & "' at '" & Error.Where & "' when setting audio/video control!"))
      hXMLRPC.SetReply(FALSE)
    ELSE
      hXMLRPC.SetReply(TRUE)
    ENDIF
  ELSE
    hXMLRPC.SetReply(FALSE)
  ENDIF

END

PRIVATE SUB GetAVControl(sParams AS Variant[])

  IF sParams.Count = 2 THEN
    TRY AVControl.Get(sParams[0], sParams[1], sParams[2])
    IF ERROR THEN
      Main.WriteDebugLog(("XMLRPC Error: '" & Error.Text & "' at '" & Error.Where & "' when getting audio/video control!"))
      hXMLRPC.SetReply(FALSE)
    ELSE
      hXMLRPC.SetReply(TRUE)
    ENDIF
  ELSE
    hXMLRPC.SetReply(FALSE)
  ENDIF

END

PRIVATE SUB GetGlobalVars()

  DIM vValue AS Variant
  DIM aArray AS NEW RpcArray

  FOR EACH vValue IN Main.GlobalVar
    aArray.Add(Main.GlobalVar.Key, XmlRpc.xString)
    aArray.Add(vValue, XmlRpc.xString)
  NEXT
  hXMLRPC.SetReply(aArray)

END

PRIVATE SUB SetGlobalVar(sParams AS Variant[])

  IF sParams.Count = 2 THEN
    TRY Main.SetGlobalVar(sParams[0], PrepareValue(sParams[1]), FALSE)
    IF ERROR THEN
      Main.WriteDebugLog(("XMLRPC Error: '" & Error.Text & "' when setting globalvar!"))
      hXMLRPC.SetReply(FALSE)
    ELSE
      hXMLRPC.SetReply(TRUE)
    ENDIF
  ELSE
    hXMLRPC.SetReply(FALSE)
  ENDIF

END

PRIVATE SUB SaveGlobalVars()

  TRY Main.SaveGlobalVars()
  IF ERROR THEN
    Main.WriteDebugLog(("XMLRPC Error: '" & Error.Text & "' when saving globalvars!"))
    hXMLRPC.SetReply(FALSE)
  ELSE
    hXMLRPC.SetReply(TRUE)
  ENDIF

END

PRIVATE SUB EventsRunActions(sParams AS Variant[])

  IF sParams.Count = 1 THEN
    TRY Events.RunActions(sParams[0])
    IF ERROR THEN
      Main.WriteDebugLog(("XMLRPC Error: '" & Error.Text & "' at '" & Error.Where & "' when running event actions!"))
      hXMLRPC.SetReply(FALSE)
    ELSE
      hXMLRPC.SetReply(TRUE)
    ENDIF
  ELSE
    hXMLRPC.SetReply(FALSE)
  ENDIF

END

PRIVATE SUB EventsRunAction(sParams AS Variant[])

  IF sParams.Count = 1 THEN
    TRY Events.RunAction(sParams[0], 0, 0)
    IF ERROR THEN
      Main.WriteDebugLog(("XMLRPC Error: '" & Error.Text & "' at '" & Error.Where & "' when running action!"))
      hXMLRPC.SetReply(FALSE)
    ELSE
      hXMLRPC.SetReply(TRUE)
    ENDIF
  ELSE
    hXMLRPC.SetReply(FALSE)
  ENDIF

END

PRIVATE SUB ZWaveRemoveNodes(sParams AS Variant[])

  TRY Main.hZWave.RemoveNodes()
  IF ERROR THEN
    Main.WriteDebugLog(("XMLRPC Error: '" & Error.Text & "' at '" & Error.Where & "' when removing zwave nodes"))
    hXMLRPC.SetReply(FALSE)
  ELSE
    hXMLRPC.SetReply(TRUE)
  ENDIF

END

PRIVATE SUB ZWaveCreateNode(sParams AS Variant[])

  IF sParams.Count = 7 THEN
    TRY Main.hZWave.CreateNode(sParams[0], sParams[1], sParams[2], sParams[3], sParams[4], sParams[5], sParams[6])
    IF ERROR THEN
      Main.WriteDebugLog(("XMLRPC Error: '" & Error.Text & "' at '" & Error.Where & "' when creating a zwave node!"))
      hXMLRPC.SetReply(FALSE)
    ELSE
      hXMLRPC.SetReply(TRUE)
    ENDIF
  ELSE
    hXMLRPC.SetReply(FALSE)
  ENDIF

END

PRIVATE SUB ZWaveSetIds(sParams AS Variant[])

  IF sParams.Count = 2 THEN
    TRY Main.hZWave.OZW_SetIds(sParams[0], sParams[1])
    IF ERROR THEN
      Main.WriteDebugLog(("XMLRPC Error: '" & Error.Text & "' at '" & Error.Where & "' when setting zwave ids!"))
      hXMLRPC.SetReply(FALSE)
    ELSE
      hXMLRPC.SetReply(TRUE)
    ENDIF
  ELSE
    hXMLRPC.SetReply(FALSE)
  ENDIF

END

PRIVATE SUB ZWaveSetValue(sParams AS Variant[])

  IF sParams.Count = 5 THEN
    TRY Main.hZWave.OZW_SetValue(sParams[0], sParams[1], sParams[2], sParams[3], sParams[4])
    IF ERROR THEN
      Main.WriteDebugLog(("XMLRPC Error: '" & Error.Text & "' at '" & Error.Where & "' when handling zwave set value!"))
      hXMLRPC.SetReply(FALSE)
    ELSE
      hXMLRPC.SetReply(TRUE)
    ENDIF
  ELSE
    hXMLRPC.SetReply(FALSE)
  ENDIF

END

PRIVATE SUB CULSimulate(sParams AS Variant[])

  IF sParams.Count = 1 THEN
    IF Main.hCUL THEN TRY Main.hCUL.Simulate(sParams[0])
    IF ERROR THEN
      Main.WriteDebugLog(("XMLRPC Error: '" & Error.Text & "' at '" & Error.Where & "' when injecting CUL packet!"))
      hXMLRPC.SetReply(FALSE)
    ELSE
      hXMLRPC.SetReply(TRUE)
    ENDIF
  ELSE
    hXMLRPC.SetReply(FALSE)
  ENDIF

END

PRIVATE SUB CULqueuecommand(sParams AS Variant[])

  IF sParams.Count = 1 THEN
    IF Main.hCUL THEN TRY Main.hCUL.QueueCommand(sParams[0])
    IF ERROR THEN
      Main.WriteDebugLog(("XMLRPC Error: '" & Error.Text & "' at '" & Error.Where & "' when queueing CUL command!"))
      hXMLRPC.SetReply(FALSE)
    ELSE
      hXMLRPC.SetReply(TRUE)
    ENDIF
  ELSE
    hXMLRPC.SetReply(FALSE)
  ENDIF

END

PRIVATE SUB PLCBUSTXcommand(sParams AS Variant[])

  IF sParams.Count = 4 THEN
    IF Main.hPLCBUS THEN TRY Main.hPLCBUS.PLCBUSTXCommand(sParams[0], sParams[1], sParams[2], sParams[3])
    IF ERROR THEN
      Main.WriteDebugLog(("XMLRPC Error: '" & Error.Text & "' at '" & Error.Where & "' when queueing PLCBUS command!"))
      hXMLRPC.SetReply(FALSE)
    ELSE
      hXMLRPC.SetReply(TRUE)
    ENDIF
  ELSE
    hXMLRPC.SetReply(FALSE)
  ENDIF

END

PRIVATE SUB ThermostatListScenarii(sParams AS Variant[])

  DIM rResultScenarii AS Result
  DIM sString AS NEW Collection
  DIM sList AS NEW RpcStruct
  DIM iCnt AS Integer

  TRY rResultScenarii = Main.hDB.Exec("SELECT * FROM thermostat_scenarii")
  IF rResultScenarii THEN
    FOR EACH rResultScenarii
    iCnt = iCnt + 1
      sString[iCnt] = rResultScenarii!id & ";;" & rResultScenarii!name & ";;" & rResultScenarii!description
      sList.Add(rResultScenarii!name, sString[iCnt], XmlRpc.xString)
    NEXT
    hXMLRPC.SetReply(sList)
  ENDIF

END

PRIVATE SUB ThermostatGetScenario(sParams AS Variant[])

  DIM rResultScenarii, rResultHeatings AS Result
  DIM sString AS NEW Collection
  DIM sList AS NEW RpcStruct
  DIM iCnt AS Integer
  DIM sCurrTemp, sReqTemp AS String
  DIM fTemp AS Float

  TRY rResultScenarii = Main.hDB.Exec("SELECT * FROM thermostat_scenarii where name=&1", Main.GlobalVar["Thermostat_Mode"])
  IF rResultScenarii.Count > 0 THEN
    iCnt = 1
    sString[iCnt] = rResultScenarii!id & ";;" & rResultScenarii!name & ";;" & rResultScenarii!description
    sList.Add(rResultScenarii!name, sString[iCnt], XmlRpc.xString)

    rResultHeatings = Main.hDB.Exec("SELECT * FROM thermostat_schedule, thermostat_heating where heating=id and scenario=&1 ORDER BY name", rResultScenarii!id)
    FOR EACH rResultHeatings
      INC iCnt
      sCurrTemp = Devices.GetCurrentValueForDevice(rResultHeatings!sensor, 1)
      fTemp = Thermostat.GetDerogateHeating(rResultHeatings!id)
      IF fTemp = Thermostat.NO_TEMP THEN fTemp = Thermostat.GetRequestedTempForHeating(rResultHeatings!scenario, rResultHeatings!id)
      sReqTemp = fTemp
      sString[iCnt] = rResultHeatings!id & ";;" & rResultHeatings!name & ";;" & sCurrTemp & ";;" & sReqTemp
      sList.Add(rResultHeatings!name, sString[iCnt], XmlRpc.xString)
    NEXT
  ENDIF
  hXMLRPC.SetReply(sList)

END

PRIVATE SUB ThermostatSetScenario(sParams AS Variant[])

  ' param0 must be the scenario name
  IF sParams.Count = 1 THEN
    TRY Main.SetGlobalVar("Thermostat_Mode", sParams[0])
    Thermostat.DeleteAllDerogateHeating()
    hXMLRPC.SetReply(TRUE)
  ELSE
    hXMLRPC.SetReply(FALSE)
  ENDIF

END

' param 0 : scenario id
' param 1 : heating id
' param 2 : '+' or '-'
PRIVATE SUB ThermostatDerogateHeating(sParams AS Variant[])

  DIM fNewVal, fVal, fDerVal AS Float
  DIM scenarioId, heatingId AS Integer

  IF sParams.Count = 3 THEN
    scenarioId = CInt(sParams[0])
    heatingId = CInt(sParams[1])
    fVal = Thermostat.GetRequestedTempForHeating(scenarioId, heatingId)
    fDerVal = Thermostat.GetDerogateHeating(heatingId)
    IF fDerVal <> Thermostat.NO_TEMP THEN
      fval = fderval
    ENDIF
    IF sParams[2] = "+" THEN
      IF fDerVal = Thermostat.NO_TEMP THEN
        fNewVal = Thermostat.GetNextRequestedTempForHeating(scenarioId, heatingId)
        IF fNewVal <> Thermostat.NO_TEMP THEN
          IF fNewVal < fval THEN
            fNewVal = fval + 0.5
          ENDIF
        ELSE
          fNewVal = fval + 0.5
        ENDIF
      ELSE
        fNewVal = fval + 0.5
      ENDIF
    ELSE
      IF fDerVal = Thermostat.NO_TEMP THEN
        fNewVal = Thermostat.GetNextRequestedTempForHeating(scenarioId, heatingId)
        IF fNewVal <> Thermostat.NO_TEMP THEN
          IF fNewVal > fval THEN
            fNewVal = fval - 0.5
          ENDIF
        ELSE
          fNewVal = fval - 0.5
        ENDIF
      ELSE
        fNewVal = fval - 0.5
      ENDIF
    ENDIF
    Thermostat.SetDerogateHeating(scenarioId, heatingId, fNewVal)
    hXMLRPC.SetReply(TRUE)
  ELSE
    hXMLRPC.SetReply(FALSE)
  ENDIF

END

PRIVATE SUB SqueezeboxSetVolumePlayer(sParams AS Variant[])

  IF sParams.Count = 2 THEN
    IF Val(sParams[1]) >= 0 OR IF Val(sParams[1]) <= 100 THEN
      TRY Main.hSqueezeServer.SetVolumePlayer(sParams[0], sParams[1])
      IF ERROR THEN
        Main.WriteDebugLog(("XMLRPC Error: '" & Error.Text & "' at '" & Error.Where & "' when changing volume"))
        hXMLRPC.SetReply(FALSE)
      ELSE
        hXMLRPC.SetReply(TRUE)
      ENDIF
    ELSE
      hXMLRPC.SetReply(FALSE)
    ENDIF
  ELSE
    hXMLRPC.SetReply(FALSE)
  ENDIF

END

PRIVATE SUB SqueezeboxGetVolumePlayer(sParams AS Variant[])

  DIM sVolume AS String = "0"
  IF sParams.Count = 1 THEN
    TRY sVolume = Main.hSqueezeServer.GetVolumePlayer(sParams[0])
    IF ERROR THEN
      Main.WriteDebugLog(("XMLRPC Error: '" & Error.Text & "' at '" & Error.Where & "' when prev number player"))
      hXMLRPC.SetReply(sVolume)
    ELSE
      hXMLRPC.SetReply(sVolume)
    ENDIF
  ELSE
    hXMLRPC.SetReply(sVolume)
  ENDIF

END

PRIVATE SUB SqueezeboxStopPlayer(sParams AS Variant[])

  IF sParams.Count = 1 THEN
    TRY Main.hSqueezeServer.StopPlayer(sParams[0])
    IF ERROR THEN
      Main.WriteDebugLog(("XMLRPC Error: '" & Error.Text & "' at '" & Error.Where & "' when running stop player"))
      hXMLRPC.SetReply(FALSE)
    ELSE
      hXMLRPC.SetReply(TRUE)
    ENDIF
  ELSE
    hXMLRPC.SetReply(FALSE)
  ENDIF

END

PRIVATE SUB SqueezeboxPlayPlayer(sParams AS Variant[])

  IF sParams.Count = 1 THEN
    TRY Main.hSqueezeServer.PlayPlayer(sParams[0])
    IF ERROR THEN
      Main.WriteDebugLog(("XMLRPC Error: '" & Error.Text & "' at '" & Error.Where & "' when running play player"))
      hXMLRPC.SetReply(FALSE)
    ELSE
      hXMLRPC.SetReply(TRUE)
    ENDIF
  ELSE
    hXMLRPC.SetReply(FALSE)
  ENDIF

END

PRIVATE SUB SqueezeboxNextNumberPlayer(sParams AS Variant[])

  IF sParams.Count = 1 THEN
    TRY Main.hSqueezeServer.NextNumberPlayer(sParams[0])
    IF ERROR THEN
      Main.WriteDebugLog(("XMLRPC Error: '" & Error.Text & "' at '" & Error.Where & "' when running next number player"))
      hXMLRPC.SetReply(FALSE)
    ELSE
      hXMLRPC.SetReply(TRUE)
    ENDIF
  ELSE
    hXMLRPC.SetReply(FALSE)
  ENDIF

END

PRIVATE SUB SqueezeboxPrevNumberPlayer(sParams AS Variant[])

  IF sParams.Count = 1 THEN
    TRY Main.hSqueezeServer.PrevNumberPlayer(sParams[0])
    IF ERROR THEN
      Main.WriteDebugLog(("XMLRPC Error: '" & Error.Text & "' at '" & Error.Where & "' when running prev number player"))
      hXMLRPC.SetReply(FALSE)
    ELSE
      hXMLRPC.SetReply(TRUE)
    ENDIF
  ELSE
    hXMLRPC.SetReply(FALSE)
  ENDIF

END

PRIVATE SUB SqueezeboxCurrentTitlePlayer(sParams AS Variant[])

  DIM sCurrentTitle AS String = "No title"
  IF sParams.Count = 1 THEN
    TRY sCurrentTitle = Main.hSqueezeServer.GetCurrentTitle(sParams[0])
    IF ERROR THEN
      Main.WriteDebugLog(("XMLRPC Error: '" & Error.Text & "' at '" & Error.Where & "' when running current title player"))
      hXMLRPC.SetReply(sCurrentTitle)
    ELSE
      hXMLRPC.SetReply(sCurrentTitle)
    ENDIF
  ELSE
    hXMLRPC.SetReply(sCurrentTitle)
  ENDIF

END

PRIVATE SUB SqueezeboxModePlayer(sParams AS Variant[])

  DIM sStatus AS String = "Unknown status"
  IF sParams.Count = 1 THEN
    TRY sStatus = Main.hSqueezeServer.GetModePlayer(sParams[0])
    IF ERROR THEN
      Main.WriteDebugLog(("XMLRPC Error: '" & Error.Text & "' at '" & Error.Where & "' when running mode player"))
      hXMLRPC.SetReply(sStatus)
    ELSE
      hXMLRPC.SetReply(sStatus)
    ENDIF
  ELSE
    hXMLRPC.SetReply(sStatus)
  ENDIF

END

PRIVATE SUB SqueezeboxPlayerId(sParams AS Variant[])

  DIM sId AS String = "Unknown id"
  IF sParams.Count = 1 THEN
    TRY sId = Main.hSqueezeServer.GetPlayerId(sParams[0])
    IF ERROR THEN
      Main.WriteDebugLog(("XMLRPC Error: '" & Error.Text & "' at '" & Error.Where & "' when running get player id"))
      hXMLRPC.SetReply(sId)
    ELSE
      hXMLRPC.SetReply(sId)
    ENDIF
  ELSE
    hXMLRPC.SetReply(sId)
  ENDIF

END

PRIVATE SUB SqueezeboxPlayerName(sParams AS Variant[])

  DIM sName AS String = "Unknown name"
  IF sParams.Count = 1 THEN
    TRY sName = Main.hSqueezeServer.GetPlayerName(sParams[0])
    IF ERROR THEN
      Main.WriteDebugLog(("XMLRPC Error: '" & Error.Text & "' at '" & Error.Where & "' when running get player name"))
      hXMLRPC.SetReply(sName)
    ELSE
      hXMLRPC.SetReply(sName)
    ENDIF
  ELSE
    hXMLRPC.SetReply(sName)
  ENDIF

END

PRIVATE SUB SqueezeboxIsPlayer(sParams AS Variant[])

  DIM sStatus AS String = "Unknown status"
  IF sParams.Count = 1 THEN
    TRY sStatus = Main.hSqueezeServer.GetIsPlayer(sParams[0])
    IF ERROR THEN
      Main.WriteDebugLog(("XMLRPC Error: '" & Error.Text & "' at '" & Error.Where & "' when running is player command"))
      hXMLRPC.SetReply(sStatus)
    ELSE
      hXMLRPC.SetReply(sStatus)
    ENDIF
  ELSE
    hXMLRPC.SetReply(sStatus)
  ENDIF

END

PUBLIC SUB SqueezeboxGetAlbums()

  DIM aAlbums AS NEW RpcArray
  DIM asAlbums AS NEW String[]
  DIM s AS String
  TRY asAlbums = Main.hSqueezeServer.GetAlbums()
  IF ERROR THEN
    Main.WriteDebugLog(("XMLRPC Error: '" & Error.Text & "' at '" & Error.Where & "' when running get albums command"))
    'hXMLRPC.SetReply(aAlbums)
  ELSE
    FOR EACH s IN asAlbums
      aAlbums.Add(s, XmlRpc.xString)
    NEXT
    hXMLRPC.SetReply(aAlbums)
  ENDIF

END

PUBLIC SUB SqueezeboxClearPlaylistPlayer(sParams AS Variant[])

  IF sParams.Count = 1 THEN
    TRY Main.hSqueezeServer.ClearPlaylistPlayer(sParams[0])
    IF ERROR THEN
      Main.WriteDebugLog(("XMLRPC Error: '" & Error.Text & "' at '" & Error.Where & "' when running clear playlist player"))
      hXMLRPC.SetReply(FALSE)
    ELSE
      hXMLRPC.SetReply(TRUE)
    ENDIF
  ELSE
    hXMLRPC.SetReply(FALSE)
  ENDIF

END

PUBLIC SUB SqueezeboxAddAlbumToPlaylistPlayer(sParams AS Variant[])

  IF sParams.Count = 2 THEN
    TRY Main.hSqueezeServer.AddAlbumToPlaylistPlayer(sParams[0], sParams[1])
    IF ERROR THEN
      Main.WriteDebugLog(("XMLRPC Error: '" & Error.Text & "' at '" & Error.Where & "' when running add album to playlist player"))
      hXMLRPC.SetReply(FALSE)
    ELSE
      hXMLRPC.SetReply(TRUE)
    ENDIF
  ELSE
    hXMLRPC.SetReply(FALSE)
  ENDIF

END

PRIVATE SUB SqueezeboxGetCurrentArtistPlayer(sParams AS Variant[])

  DIM sName AS String = "Unknown artist"

  IF sParams.Count = 1 THEN
    TRY sName = Main.hSqueezeServer.GetCurrentArtist(sParams[0])
    IF ERROR THEN
      Main.WriteDebugLog(("XMLRPC Error: '" & Error.Text & "' at '" & Error.Where & "' when running get player name"))
      hXMLRPC.SetReply(sName)
    ELSE
      hXMLRPC.SetReply(sName)
    ENDIF
  ELSE
    hXMLRPC.SetReply(sName)
  ENDIF

END

PRIVATE SUB SqueezeboxGetIsPlayerConnectedToServer(sParams AS Variant[])

  DIM bConnected AS Boolean

  IF sParams.Count = 1 THEN
    TRY bConnected = Main.hSqueezeServer.PlayerConnectedToServer(sParams[0])
    IF ERROR THEN
      Main.WriteDebugLog(("XMLRPC Error: '" & Error.Text & "' at '" & Error.Where & "' when running get player name"))
      hXMLRPC.SetReply(bConnected)
    ELSE
      hXMLRPC.SetReply(bConnected)
    ENDIF
  ELSE
    hXMLRPC.SetReply(bConnected)
  ENDIF

END

PUBLIC SUB hXMLRPC_RemoteCall(sName AS String, sData AS Variant[])

  DIM vValue AS Variant
  DIM aArray AS NEW RpcArray
  DIM sParam AS String
  DIM iParam AS Integer

  IF bXMLRPCDebug THEN
    Main.WriteDebugLog(("[XMLRPC] Got a RemoteCall for method '" & sName & "'"))
    FOR EACH sParam IN sData
      Main.WriteDebugLog(("[XMLRPC] Param[" & iParam & "] = '" & sParam & "'"))
      INC iParam
    NEXT
  ENDIF

  SELECT CASE sName
    CASE "system.program_uptime"
      hXMLRPC.SetReply(Main.GlobalVar["Program_Uptime"])
    CASE "system.program_version"
      hXMLRPC.SetReply(Main.sProgramVersion)
    CASE "system.pid"
      hXMLRPC.SetReply(Application.Id)
    CASE "system.hostname"
      hXMLRPC.SetReply(System.Host)
    CASE "api.version"
      hXMLRPC.SetReply(APIVersion)
    CASE "mode.get_housemode"
      hXMLRPC.SetReply(Main.GlobalVar["House_Mode"])
    CASE "mode.get_mutemode"
      hXMLRPC.SetReply(Main.GlobalVar["Mute"])
    CASE "globalvar.list"
      FOR EACH vValue IN Main.GlobalVar
        aArray.Add(Main.GlobalVar.Key, XmlRpc.xString)
      NEXT
      hXMLRPC.SetReply(aArray)
    CASE "globalvar.get"
      GetGlobalVars()
    CASE "globalvar.set"
      SetGlobalVar(sData)
    CASE "globalvar.save"
      SaveGlobalVars()
    CASE "globalvar.del"
      DelGlobalVar(sData)
    CASE "data.sunmoon"
      aArray.Add(Main.GlobalVar["Sunrise"], XmlRpc.xString)
      aArray.Add(Main.GlobalVar["Sunset"], XmlRpc.xString)
      hXMLRPC.SetReply(aArray)
    CASE "data.newmessages"
      aArray.Add(Main.iNewMails, XmlRpc.xString)
      aArray.Add(Main.iNewCalls, XmlRpc.xString)
      aArray.Add(Main.iNewVoicemails, XmlRpc.xString)
      hXMLRPC.SetReply(aArray)
    CASE "device.list"
      ReturnDeviceList()
    CASE "device.listswitch"
      ReturnDeviceListDimSwitch("switchable")
    CASE "device.listdim"
      ReturnDeviceListDimSwitch("dimable")
    CASE "module.restart"
      ModuleRestart(sData)
    CASE "send.email"
      SendEmail(sData)
    CASE "send.tweet"
      SendTweet(sData)
    CASE "send.sms"
      SendSMS(sData)
    CASE "set.housemode"
      SetHouseMode(sData)
    CASE "set.mutemode"
      SetMuteMode(sData)
    CASE "set.alarmpin"
      SetAlarmPin(sData)
    CASE "set.alarmmode"
      SetAlarmMode(sData)
    CASE "device.setdevice"
      DeviceSetDevice(sData)
    CASE "device.getstate"
      DeviceGetState(sData)
    CASE "play.sound"
      PlaySound(sData)
    CASE "voicetext.speak"
      VoiceTextSpeak(sData)
    CASE "pachube.list"
      hXMLRPC.SetReply(Pachube.CreatePachubeData())
    CASE "serverstats.updategraphs"
      ServerStatsUpdateGraphs(sData)
    CASE "rrdtool.listgraphs"
      RRDToolListGraphs(sData)
    CASE "rrdtool.updategraphs"
      RRDToolUpdateGraphs(sData)
    CASE "rrdtool.createrrds"
      RRDToolCreateRRDs(sData)
    CASE "display.ledmessage"
      DisplayLEDMessage(sData)
    CASE "av.setcontrol"
      SetAVControl(sData)
    CASE "av.getcontrol"
      GetAVControl(sData)
    CASE "zwave.removenodes"
      ZWaveRemoveNodes(sData)
    CASE "zwave.createnode"
      ZWaveCreateNode(sData)
    CASE "zwave.setids"
      ZWaveSetIds(sData)
    CASE "zwave.setvalue"
      ZWaveSetValue(sData)
    CASE "zwave.allqueried"
      Main.hZWave.OZW_AllQueried()
      hXMLRPC.SetReply(TRUE)
    CASE "cmdr.culsimulate"
      CULSimulate(sData)
    CASE "cmdr.culqueuecommand"
      CULqueuecommand(sData)
    CASE "cmdr.plcbustxcommand"
      PLCBUSTXcommand(sData)
    CASE "thermostat.listscenario"
      ThermostatListScenarii(sData)
    CASE "thermostat.getscenario"
      ThermostatGetScenario(sData)
    CASE "thermostat.setscenario"
      ThermostatSetScenario(sData)
    CASE "thermostat.derogateheating"
      ThermostatDerogateHeating(sData)
    CASE "events.runactions"
      EventsRunActions(sData)
    CASE "events.runaction"
      EventsRunAction(sData)
    CASE "calendar.setplanning"
      Calendar.SetPlanning(sData)
    CASE "calendar.getplanning"
      Calendar.GetPlanning()
    CASE "squeezebox.setvolumeplayer"
      SqueezeboxSetVolumePlayer(sData)
    CASE "squeezebox.getvolumeplayer"
      SqueezeboxGetVolumePlayer(sData)
    CASE "squeezebox.stopplayer"
      SqueezeboxStopPlayer(sData)
    CASE "squeezebox.playplayer"
      SqueezeboxPlayPlayer(sData)
    CASE "squeezebox.nextnumberplayer"
      SqueezeboxNextNumberPlayer(sData)
    CASE "squeezebox.prevnumberplayer"
      SqueezeboxPrevNumberPlayer(sData)
    CASE "squeezebox.getcurrentnumberplayer"
      SqueezeboxCurrentTitlePlayer(sData)
    CASE "squeezebox.getmodeplayer"
      SqueezeboxModePlayer(sData)
    CASE "squeezebox.getplayerid"
      SqueezeboxPlayerId(sData)
    CASE "squeezebox.getplayername"
      SqueezeboxPlayerName(sData)
    CASE "squeezebox.getisplayer"
      SqueezeboxIsPlayer(sData)
    CASE "squeezebox.getalbums"
      SqueezeboxGetAlbums()
    CASE "squeezebox.clearplaylistplayer"
      SqueezeboxClearPlaylistPlayer(sData)
    CASE "squeezebox.addalbumtoplaylistplayer"
      SqueezeboxAddAlbumToPlaylistPlayer(sData)
    CASE "squeezebox.getcurrentartistplayer"
      SqueezeboxGetCurrentArtistPlayer(sData)
    CASE "squeezebox.getplayerisconnectedtoserver"
      SqueezeboxGetIsPlayerConnectedToServer(sData)
    DEFAULT
      RETURN
  END SELECT

END

PRIVATE FUNCTION HTTPPort_Read() AS Integer

  RETURN iHTTPPort

END

PRIVATE SUB HTTPPort_Write(Value AS Integer)

  iHTTPPort = Value

END

PRIVATE FUNCTION MaxConn_Read() AS Integer

  RETURN iMaxConn

END

PRIVATE SUB MaxConn_Write(Value AS Integer)

  iMaxConn = Value

END

PRIVATE FUNCTION XMLRPCDebug_Read() AS Boolean

  RETURN bXMLRPCDebug

END

PRIVATE SUB XMLRPCDebug_Write(Value AS Boolean)

  bXMLRPCDebug = Value

END

PRIVATE SUB DelGlobalVar(sParams AS Variant[])

  IF sParams.Count = 1 THEN
      TRY Main.DelGlobalVar(sParams[0])
      IF ERROR THEN
        Main.WriteDebugLog(("XMLRPC Error: '" & Error.Text & "' when deleting globalvar!"))
        hXMLRPC.SetReply(FALSE)
      ELSE
        hXMLRPC.SetReply(TRUE)
      ENDIF
  ELSE
    hXMLRPC.SetReply(FALSE)
  ENDIF

END

PRIVATE SUB PrepareValue(sText AS String) AS Variant

  IF sText == "true" THEN
    RETURN TRUE
  ELSE IF sText == "false" THEN
    RETURN FALSE
  ELSE
    RETURN sText
  ENDIF

END
