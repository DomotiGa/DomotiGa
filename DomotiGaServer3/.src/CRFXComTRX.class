' Gambas class file

' Description:
' CRFXComTrx.class
' Connect to RFXCom TRX transceiver interface via tcp socket or serial port.

' Development Status:
' Used RFXCom's RFXmngr_vb project as example.

' Credits:
' Thanks to Bert Weijenberg/RFXCom for letting me test new hardware products.

' DomotiGa - an open source home automation program.
' Copyright(C) 2008-2012 Ron Klinkien

' Read file called COPYING for license details.

Property TCPHost As String
Property TCPPort As Integer
Property Interface As String
Property SerPort As String
Property Baud As String
Property RFXComDebug As Boolean
Property RelayPort As Integer
Property GlobalX10 As Boolean
Property OldAddrFmt As Boolean

Private sTCPHost As String
Private iTCPPort As Integer
Private sInterface As String
Private sSerPort As String
Private sBaud As String
Private bRFXComTRXDebug As Boolean
Private iRelayPort As Integer
Private bGlobalX10 As Boolean
Private bOldAddrFmt As Boolean

Public hRFXComTRX As New Socket
Public hRFXComTRXSer As New SerialPort
Public hRFXComTRXRelay As New ServerSocket
Public hRelayTRXClient As Object[]
Public hRelayTRXSocket As New Socket
Public tRFXComTRXConnect As Timer
Public tRFXComTRXReset As Timer
Private bResetActive As Boolean = True
Private iConnectRetry As Integer = 0 ' retries
Private iConnectDelay As Integer = 60000 ' 1 minute
' [GB2:ARRD] PRIVATE RecBuf AS Byte[30]
Private RecBuf As New Byte[30]
Private RecBytes As Byte
Public bSimulate As Boolean
Private iSeq As Integer

' interface control
Const pTypeInterfaceControl As Byte = &H0
Const sTypeInterfaceCommand As Byte = &H0

Const pTypeInterfaceMessage As Byte = &H1
Const sTypeInterfaceResponse As Byte = &H0

' interface commands
Const cmdRESET As Byte = &H0 ' reset the receiver/transceiver
Const cmdSTATUS As Byte = &H2 ' return firmware versions and configuration of the interface
Const cmdSETMODE As Byte = &H3 ' set the configuration of the interface
Const cmdENABLEALL As Byte = &H4 ' enable all receiving modes of the receiver/transceiver
Const cmdUNDECODED As Byte = &H5 ' display undecoded messages
Const cmdSAVE As Byte = &H6 ' save receiving modes of the receiver/transceiver in non-volatile memory
Const cmdDISX10 As Byte = &H10 ' disable receiving of X10
Const cmdDISARC As Byte = &H11 ' disable receiving of ARC
Const cmdDISAC As Byte = &H12 ' disable receiving of AC
Const cmdDISHEU As Byte = &H13 ' disable receiving of HomeEasy EU
Const cmdDISKOP As Byte = &H14 ' disable receiving of Ikea-Koppla
Const cmdDISOREGON As Byte = &H15 ' disable receiving of Oregon Scientific
Const cmdDISATI As Byte = &H16 ' disable receiving of ATI Remote Wonder
Const cmdDISVISONIC As Byte = &H17 ' disable receiving of Visonic
Const cmdDISMERTIK As Byte = &H18 ' disable receiving of Mertik
Const cmdDISAD As Byte = &H19 ' disable receiving of AD
Const cmdDISHID As Byte = &H1A ' disable receiving of Hideki
Const cmdDISLCROS As Byte = &H1B ' disable receiving of La Crosse
Const cmdDISFS20 As Byte = &H1C ' disable receiving of FS20
Const cmdDISNOVAT As Byte = &H1D ' disable receiving of Novatys

Const cmd310 As Byte = &H50 ' select 310MHz in the 310/315 transceiver
Const cmd315 As Byte = &H51 ' select 315MHz in the 310/315 transceiver
Const cmd830 As Byte = &H57 ' select 868.30MHz ASK in the 868 transceiver
Const cmd830F As Byte = &H58 ' select 868.30MHz FSK in the 868 transceiver
Const cmd835 As Byte = &H59 ' select 868.35MHz ASK in the 868 transceiver
Const cmd835F As Byte = &H5A ' select 868.35MHz FSK in the 868 transceiver
Const cmd895 As Byte = &H5B ' select 868.95MHz in the 868 transceiver

Const pTypeRecXmitMessage As Byte = &H2
Const sTypeReceiverLockError As Byte = &H0
Const sTypeTransmitterResponse As Byte = &H1

' receiver
Const pTypeResponse As Byte = &H1
Const recType310 As Byte = &H50
Const recType315 As Byte = &H51
Const recType43392 As Byte = &H53
Const recType86800 As Byte = &H55
Const recType86800FSK As Byte = &H56
Const recType86830 As Byte = &H57
Const recType86830FSK As Byte = &H58
Const recType86835 As Byte = &H59
Const recType86835FSK As Byte = &H5A
Const recType86895 As Byte = &H5B

' undecoded
Const pTypeUndecoded As Byte = &H3
Const sTypeUac As Byte = &H0
Const sTypeUarc As Byte = &H1
Const sTypeUati As Byte = &H2
Const sTypeUhideki As Byte = &H3
Const sTypeUlacrosse As Byte = &H4
Const sTypeUlwrf As Byte = &H5
Const sTypeUmertik As Byte = &H6
Const sTypeUoregon1 As Byte = &H7
Const sTypeUoregon2 As Byte = &H8
Const sTypeUoregon3 As Byte = &H9
Const sTypeUproguard As Byte = &HA
Const sTypeUvisonic As Byte = &HB
Const sTypeUnec As Byte = &HC
Const sTypeUfs20 As Byte = &HD

' lighting
Const pTypeLighting1 As Byte = &H10
Const sTypeX10 As Byte = &H0
Const sTypeARC As Byte = &H1
Const sTypeAB400D As Byte = &H2
Const sTypeWaveman As Byte = &H3
Const sTypeEMW200 As Byte = &H4
Const sTypeIMPULS As Byte = &H5

Const pTypeLighting2 As Byte = &H11
Const sTypeAC As Byte = &H0
Const sTypeHEU As Byte = &H1
Const sTypeANSLUT As Byte = &H2

Const pTypeLighting3 As Byte = &H12
Const sTypeKoppla As Byte = &H0

Const pTypeLighting4 As Byte = &H13
Const sTypePT2262 As Byte = &H0

Const pTypeLighting5 As Byte = &H14
Const sTypeLightwaveRF As Byte = &H0

' curtain
Const pTypeCurtain As Byte = &H18
Const sTypeHarrison As Byte = &H0

' security
Const pTypeSecurity1 As Byte = &H20
Const sTypeSecX10 As Byte = &H0
Const sTypeSecX10M As Byte = &H1
Const sTypeSecX10R As Byte = &H2
Const sTypeKD101 As Byte = &H3
Const sTypePowercodeSensor As Byte = &H4
Const sTypePowercodeMotion As Byte = &H5
Const sTypeCodesecure As Byte = &H6
Const sTypePowercodeAux As Byte = &H7

' status security
Const sStatusNormal As Byte = &H0
Const sStatusNormalDelayed As Byte = &H1
Const sStatusAlarm As Byte = &H2
Const sStatusAlarmDelayed As Byte = &H3
Const sStatusMotion As Byte = &H4
Const sStatusNoMotion As Byte = &H5
Const sStatusPanic As Byte = &H6
Const sStatusPanicOff As Byte = &H7
Const sStatusTamper As Byte = &H8
Const sStatusArmAway As Byte = &H9
Const sStatusArmAwayDelayed As Byte = &HA
Const sStatusArmHome As Byte = &HB
Const sStatusArmHomeDelayed As Byte = &HC
Const sStatusDisarm As Byte = &HD
Const sStatusLightOff As Byte = &H10
Const sStatusLightOn As Byte = &H11
Const sStatusLight2Off As Byte = &H12
Const sStatusLight2On As Byte = &H13
Const sStatusDark As Byte = &H14
Const sStatusLight As Byte = &H15
Const sStatusBatLow As Byte = &H16
Const sStatusPairKD101 As Byte = &H17

' camera1
Const pTypeCamera1 As Byte = &H28
Const sTypeNinja As Byte = &H0

' remotes
Const pTypeRemote As Byte = &H30
Const sTypeATI As Byte = &H0
Const sTypeATI2 As Byte = &H1
Const sTypeMedion As Byte = &H2
Const sTypePCremote As Byte = &H3

' thermostat1
Const pTypeThermostat1 As Byte = &H40
Const sTypeDigimax As Byte = &H0    ' Digimax with long packet
Const sTypeDigimax1 As Byte = &H1   ' Digimax with short packet (no set point)

' thermostat2
Const pTypeThermostat2 As Byte = &H41
Const sTypeHE105 As Byte = &H0  ' HE105
Const sTypeRTS10 As Byte = &H1  ' RTS10

' thermostat3
Const pTypeThermostat3 As Byte = &H42
Const sTypeMertikG6RH4T1 As Byte = &H0  ' Mertik G6R-H4T1
Const sTypeMertikG6RH4TB As Byte = &H1  ' Mertik G6R-H4TB

' temperature
Const pTypeTEMP As Byte = &H50
Const sTypeTEMP1 As Byte = &H1  ' THR128/138, THC138
Const sTypeTEMP2 As Byte = &H2  ' THC238/268,THN132,THWR288,THRN122,THN122,AW129/131
Const sTypeTEMP3 As Byte = &H3  ' THWR800
Const sTypeTEMP4 As Byte = &H4  ' RTHN318
Const sTypeTEMP5 As Byte = &H5  ' LaCrosse TX3

' humidity
Const pTypeHUM As Byte = &H51   ' not used
Const sTypeHUM1 As Byte = &H1   ' LaCrosse TX3

' temperature+humidity
Const pTypeTEMP_HUM As Byte = &H52
Const sTypeTH1 As Byte = &H1    ' THGN122/123,/THGN132,THGR122/228/238/268
Const sTypeTH2 As Byte = &H2    ' THGR810
Const sTypeTH3 As Byte = &H3    ' RTGR328
Const sTypeTH4 As Byte = &H4    ' THGR328
Const sTypeTH5 As Byte = &H5    ' WTGR800
Const sTypeTH6 As Byte = &H6    ' THGR918,THGRN228,THGN500
Const sTypeTH7 As Byte = &H7    ' TFA TS34C
Const sTypeTH8 As Byte = &H8    ' WT440H/450H

' barometric
Const pTypeBARO As Byte = &H53  ' not used

' temperature+humidity+baro
Const pTypeTEMP_HUM_BARO As Byte = &H54
Const sTypeTHB1 As Byte = &H1   ' BTHR918
Const sTypeTHB2 As Byte = &H2   ' BTHR918N,BTHR968

' rain
Const pTypeRAIN As Byte = &H55
Const sTypeRAIN1 As Byte = &H1  ' RGR126/682/918
Const sTypeRAIN2 As Byte = &H2  ' PCR800
Const sTypeRAIN3 As Byte = &H3  ' TFA

' wind
Const pTypeWIND As Byte = &H56
Const sTypeWIND1 As Byte = &H1  ' WTGR800
Const sTypeWIND2 As Byte = &H2  ' WGR800
Const sTypeWIND3 As Byte = &H3  ' STR918,WGR918
Const sTypeWIND4 As Byte = &H4  ' TFA

' uv
Const pTypeUV As Byte = &H57
Const sTypeUV1 As Byte = &H1    ' UVN128,UV138
Const sTypeUV2 As Byte = &H2    ' UVN800
Const sTypeUV3 As Byte = &H3    ' TFA

' date & time
Const pTypeDT As Byte = &H58
Const sTypeDT1 As Byte = &H1    ' RTGR328N

' current
Const pTypeCURRENT As Byte = &H59
Const sTypeELEC1 As Byte = &H1  ' CM113,Electrisave

' energy
Const pTypeENERGY As Byte = &H5A
Const sTypeELEC2 As Byte = &H1  ' CM119/160

' gas
Const pTypeGAS As Byte = &H5B   ' not used

' water
Const pTypeWATER As Byte = &H5C ' not used

' weight scales
Const pTypeWEIGHT As Byte = &H5D
Const sTypeWEIGHT1 As Byte = &H1   ' BWR102
Const sTypeWEIGHT2 As Byte = &H2   ' GR101

' rfxsensor
Const pTypeRFXSensor As Byte = &H70
Const sTypeRFXSensorTemp As Byte = &H0
Const sTypeRFXSensorAD As Byte = &H1
Const sTypeRFXSensorVolt As Byte = &H2
Const sTypeRFXSensorMessage As Byte = &H3

' rfxmeter
Const pTypeRFXMeter As Byte = &H71
Const sTypeRFXMeterCount As Byte = &H0
Const sTypeRFXMeterInterval As Byte = &H1
Const sTypeRFXMeterCalib As Byte = &H2
Const sTypeRFXMeterAddr As Byte = &H3
Const sTypeRFXMeterCounterReset As Byte = &H4
Const sTypeRFXMeterCounterSet As Byte = &HB
Const sTypeRFXMeterSetInterval As Byte = &HC
Const sTypeRFXMeterSetCalib As Byte = &HD
Const sTypeRFXMeterSetAddr As Byte = &HE
Const sTypeRFXMeterIdent As Byte = &HF

Public Sub RFXComTRX_Ready()

  Main.WriteLog(("RFXCom transceiver TCP socket connected."))
  ResetInterface()

  ' define timer for RFXComTRX reconnect
  tRFXComTRXConnect = New Timer As "tRFXComTRXConnect"
  tRFXComTRXConnect.Delay = iConnectRetry
  tRFXComTRXConnect.Stop

  ' define timer for RFXComTRX reset
  tRFXComTRXReset = New Timer As "tRFXComTRXReset"
  tRFXComTRXReset.Delay = 1000
  tRFXComTRXReset.Stop

End

' just here for development/debuggingi
Public Sub ParseDump(sFile As String)

  Dim hFile As File
  Dim sLine As String

  Try hFile = Open sFile For Input
  If Error Then Return

  While Not Eof(hFile)
    Line Input #hFile, sLine
    If Len(sLine) > 5 Then Simulate(sLine)
  Wend

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' reconnect routine
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub tRFXComTRXConnect_Timer()

  If Not ConnectTCP() Then
    Inc iConnectRetry
    iConnectDelay *= iConnectRetry
    tRFXComTRXConnect.Delay = iConnectDelay
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' reset routine
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub tRFXComTRXReset_Timer()

  tRFXComTRXReset.Stop
  ProtocolSetup("STATUS")

  ParseDump("/home/ron/RFXtrxLog.txt")

End

Public Function StartRelay() As Boolean

  hRFXComTRXRelay = New ServerSocket As "RFXComTRXRelay"
  hRFXComTRXRelay.Type = Net.Internet
  hRFXComTRXRelay.Port = iRelayPort
  ' we start listening for max 1 connection
  hRFXComTRXRelay.Listen(1)

  If hRFXComTRXRelay.Status = Net.Active Then
    hRelayTRXClient = New Object[]
    ' all ok
    Return True
  Else
    Return False
  Endif

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' connect to the host:port
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Function ConnectTCP() As Boolean

  ' try to close the connection
  Try hRFXComTRX.Close

  ' get a new one
  hRFXComTRX = New Socket As "RFXComTRX"
  hRFXComTRX.Connect(sTCPHost, iTCPPort)

  ' all ok
  Return True

Catch ' some errors
  Main.WriteLog(("RFXCom transceiver Error: ") & ERROR.Text & " at " & ERROR.Where)
  Return False

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' connect to the serial port
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Function ConnectSerial() As Boolean

  ' try to close the connection
  Try hRFXComTRXSer.Close

  ' get a new one
  hRFXComTRXSer = New Serialport As "RFXComTRXSer"
  With hRFXComTRXSer
    .PortName = sSerPort
    .Speed = sBaud
    .Parity = 0
    .DataBits = 8
    .StopBits = 1
    .FlowControl = 0
    .Open()
  End With

  ' define timer for RFXComTRX reset
  tRFXComTRXReset = New Timer As "tRFXComTRXReset"
  tRFXComTRXReset.Delay = 1000
  tRFXComTRXReset.Stop

  ' all ok
  Return True

Catch ' some errors
  Main.WriteLog(("RFXCom transceiver Error: ") & ERROR.Text & " at " & ERROR.Where)
  Return False

End

Public Sub RFXComTRXRelay_Connection(sHost As String)

  hRelayTRXSocket = New Socket As "RelayTRXSocket"
  ' accept client
  If hRFXComTRXRelay.Status <= Net.Inactive Then Return
  If Main.bRFXComTRXDebug Then Main.WriteDebugLog(("[RFXComTRXRelay] Connection request from client ") & sHost)

  hRelayTRXSocket = hRFXComTRXRelay.Accept()
  hRelayTRXClient.Add(hRelayTRXSocket)
  If Main.bRFXComTRXDebug Then
    If hRelayTRXSocket.Status = Net.Connected Then Main.WriteLog(("RFXCom transceiver Relay client connection from ip address ") & hRelayTRXSocket.RemoteHost & " (" & DNS.ResolveHost(hRelayTRXSocket.RemoteHost) & (" ) accepted."))
  Endif

End

Public Sub Socket_Read()

  Dim sBuf As Byte

  If Last.Status <> Net.Connected Then Return
  Try Read #Last, sBuf, Lof(Last)

End

Public Sub RFXComTRXRelay_Error()

  ' handle error
  Select Case hRFXComTRXRelay.Status
    Case Net.CannotCreateSocket
      Main.WriteDebugLog(("[RFXComTRXRelay] The system does not allow to create a socket."))
    Case Net.CannotBindSocket
      Main.WriteDebugLog(("[RFXComTRXRelay] Cannot bind socket."))
    Case Net.CannotListen
      Main.WriteDebugLog(("[RFXComTRXRelay] Cannot listen on port."))
  End Select

End

Public Sub Socket_Closed()

  Main.WriteLog(("RFXCom transceiver Relay client connection closed."))
  hRelayTRXClient.Remove(hRelayTRXClient.Find(Last))

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' reset interface
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Function ResetInterface()

  ProtocolSetup("RESET")

End

Public Sub SendCommand(sAddress As String, sCmd As String)

  Dim iDeviceId As Integer
  Dim sType As String

  iDeviceId = Devices.Find(sAddress, Devices.FindInterface("RFXCom Tranceiver"))
  If iDeviceId Then
    sType = Devices.FindTypeForDevice(iDeviceId)
  Endif

  Select UCase(sType)
    Case "X10", "ARC", "AB400", "WAVEMAN", "EMW200", "IMPULS" ' Lightning1
      Lighting1(sType, sAddress, sCmd)
    Case "AC", "HEEU", "ANSLUT" ' Lightning2
      Lighting2(sType, sAddress, sCmd)
    Case "LIGHTWAVERF" ' Lightning5
      Lighting5(sType, sAddress, sCmd)
    Case "HARRISON" ' Curtain1
      Curtain(sType, sAddress, sCmd)
    Case Else
      Main.WriteDebugLog(("[RFXComTRX] " & sType & " protocol is not (yet) supported by RFXComTRX code!"))
      Return
  End Select

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' protocol commands
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Function ProtocolSetup(sType As String)

  ' [GB2:ARRD] DIM bCmd AS Byte[14]
  Dim bCmd As New Byte[14]
  Dim b As Byte
  Dim sText As String

  bCmd[0] = &HD
  bCmd[1] = pTypeInterfaceControl
  bCmd[2] = sTypeInterfaceCommand
  bCmd[3] = iSeq

  Select sType
    Case "RESET"
      bCmd[4] = cmdRESET
      sText = ("Reset receiver/transceiver")
    Case "UNDECODED"
      bCmd[4] = cmdUNDECODED
      sText = ("UnDecoded On")
    Case "STATUS"
      bCmd[4] = cmdSTATUS
      sText = ("Get status")
    Case "ALL"
      bCmd[4] = cmdENABLEALL
      sText = ("Enable ALL RF")
    Case "X10"
      bCmd[4] = cmdDISX10
      sText = ("Disable X10 RF")
    Case "ARC"
      bCmd[4] = cmdDISARC
      sText = ("Disable ARC RF")
    Case "AC"
      bCmd[4] = cmdDISAC
      sText = ("Disable AC RF")
    Case "OREGON"
      bCmd[4] = cmdDISOREGON
      sText = ("Disable Oregon Scientific RF")
    Case "KOPPLA"
      bCmd[4] = cmdDISKOP
      sText = ("Disable Ikea Koppla RF")
    Case "ATI"
      bCmd[4] = cmdDISATI
      sText = ("Disable ATI Remote RF")
    Case "VISONIC"
      bCmd[4] = cmdDISVISONIC
      sText = ("Disable Visonic RF")
    Case "AD"
      bCmd[4] = cmdDISAD
      sText = ("Disable AD")
    Case "HEEU"
      bCmd[4] = cmdDISHEU
      sText = ("Disable HomeEasy EU RF")
    Case "MERTIK"
      bCmd[4] = cmdDISMERTIK
      sText = ("Disable Mertik RF")
    Case "HIDEKI"
      bCmd[4] = cmdDISHID
      sText = ("Disable Hideki RF")
    Case "LACROSSE"
      bCmd[4] = cmdDISLCROS
      sText = ("Disable La Crosse RF")
    Case "FS20"
      bCmd[4] = cmdDISFS20
      sText = ("Disable FS20 RF")
    Case "NOVATYS"
      bCmd[4] = cmdDISNOVAT
      sText = ("Disable Novatys RF")
    Case "SAVE"
      bCmd[4] = cmdSAVE
      sText = ("Save")
    Case Else
      sText = ("Unknown cmd: " & sType)
  End Select

  WriteCommand(bCmd)

  If sType = "RESET" Then
    tRFXComTRXReset.Start
    If Main.bRFXComTRXDebug Then Main.WriteDebugLog(("[RFXComTRX] Resetting interface, 1Sec. timer started."))
  Endif
  If sType = "STATUS" Then bResetActive = False

  If Not bRFXComTRXDebug Then Return
  Main.WriteRFXDebugLog("[RFXComTRX] " & sText & ": ")
  For Each b In bCmd
    WriteMessage(Hex(b, 2) & " ", True)
  Next
  Main.WriteRFXDebugLog("\n", True)

End

' ENUM TRESPONSE AS Integer
'     packetlength = 0
'     packettype = 1
'     subtype = 2
'     seqnbr = 3
'     msg = 4
' END ENUM

Public Sub Decode_RecXmitMessage()

  Select Case RecBuf[2]
    Case sTypeReceiverLockError
      WriteMessage("Subtype           = Receiver lock error")
      WriteMessage("Sequence no.      = " & CStr(RecBuf[3]))
    Case sTypeTransmitterResponse
      WriteMessage("Subtype           = Transmitter Response")
      WriteMessage("Sequence nbr      = " & CStr(RecBuf[3]))
      Select Case RecBuf[4]
        Case &H0
          WriteMessage("Response          = ACK, data correct transmitted")
        Case &H1
          WriteMessage("Response          = ACK, but transmit started after 6 seconds delay anyway with RF receive data detected")
        Case &H2
          WriteMessage("Response          = NAK, transmitter did not lock on the requested transmit frequency")
        Case Else
          WriteMessage("ERROR: Unexpected message type=" & Hex(RecBuf[5]))
      End Select
    Case Else
      WriteMessage("ERROR: Unknown Sub type for Packet type=" & Hex(RecBuf[1]) & ": " & Hex(RecBuf[2]))
      Return
  End Select

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' send a command to the interface
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Function WriteCommand(bBuffer As Byte[])

  Dim iCnt As Integer
  Dim sMessage As String

  For iCnt = 0 To bBuffer[0]
    sMessage &= Hex(bBuffer[iCnt], 2)
  Next
  If Main.bRFXComTRXDebug Then Main.WriteDebugLog("[RFXComTRX] > " & sMessage)

  If sInterface = "tcp" Then
    ' send the message to the tcp stream
    Try bBuffer.Write(hRFXComTRX, 0, bBuffer.Length)
    If Error Then Main.WriteRFXDebugLog(("[RFXComTRX] Unable to write to TCP port! -> ") & Error.Text)
  Else
    ' send the message to the serial port
    Try bBuffer.Write(hRFXComTRXSer, 0, bBuffer.Length)
    If Error Then Main.WriteRFXDebugLog(("[RFXComTRX] Unable to write to serial port! -> ") & Error.Text)
  Endif
  Inc iSeq
  If iSeq = 256 Then iSeq = 1

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' disconnect from the host
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Function Disconnect() As Boolean

  ' try to close the connection
  Try hRFXComTRX.Close
  Try hRFXComTRXSer.Close
  Try hRFXComTRXRelay.Close
  Try tRFXComTRXConnect.Stop
  Try tRFXComTRXReset.Stop
  Try hRelayTRXClient.Remove

  Main.WriteLog(("RFXCom transceiver " & IIf(InStr(sInterface, "tcp"), "TCP socket", "serial port") & " close."))

  ' all ok
  Return True

Catch ' some errors
  Main.WriteLog(("RFXCom transceiver Error: ") & ERROR.Text & " at " & ERROR.Where)
  Return False

End

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' inject packet into parser.
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub Simulate(sPacket As String)

  Dim iCnt As Integer

  If bRFXComTRXDebug Then Main.WriteRFXDebugLog(("RFXCom transceiver Simulate String: ") & sPacket & "\n")

  For iCnt = 1 To Len(sPacket) Step 2
    ProcessReceivedChar(Val("&H" & Mid(sPacket, iCnt, 2)))
  Next
  bSimulate = False

End

Public Sub RFXComTRX_Closed()

  Main.WriteDebugLog(("[RFXComTRX] ERROR: TCP socket closed by peer."))
  If iConnectRetry < 6 Then
    Main.WriteDebugLog(("[RFXComTRX] Retry to connect" & IIf(iConnectRetry, " in " & (iConnectDelay / 60) & " minutes.", ".")))
    tRFXComTRXConnect.Start
  Endif

End

Public Sub RFXComTRX_Error()

  Dim sString As String = "RFXCom transceiver: "

  ' handle error
  Select Case hRFXComTRX.Status
    Case Net.CannotCreateSocket
      Main.WriteLog(sString & ("The system does not allow to create a socket."))
    Case Net.HostNotFound
      Main.WriteLog(sString & ("Host '") & sTCPHost & ("' not found."))
    Case Net.ConnectionRefused
      Main.WriteLog(sString & ("Unable to connect. Connection refused."))
    Case Net.CannotRead
      Main.WriteLog(sString & ("Error reading data."))
    Case Net.CannotWrite
      Main.WriteLog(sString & ("Error writing data."))
  End Select

End

Public Sub RFXComTRX_Read()

  Dim sData As Byte

  Try Read #hRFXComTRX, sData
  If Error Then Main.WriteDebugLog(("[RFXComTRX] Error reading data from the TCP port! -> ") & Error.Text)
  If bSimulate = False Then ProcessReceivedChar(sData)

End

Public Sub RFXComTRXSer_Read()

  Dim sData As Byte

  Try Read #hRFXComTRXSer, sData
  If Error Then Main.WriteDebugLog(("[RFXComTRX] Error reading data from the serial port! -> ") & Error.Text)
  If bSimulate = False Then ProcessReceivedChar(sData)

End

Private Sub ProcessReceivedChar(bTemp As Byte)

  ' ignore data until interface reset
  If bResetActive Then Return

  ' relay incoming data to relay port
  If Main.bRFXComTRXRelayEnabled Then Try Write #hRelayTRXSocket, bTemp

  Main.ControlLed("RFXCom", "On")
  If RecBytes = 0 Then ' 1st char of a packet received
    If bTemp <> 0 Then
      If bRFXComTRXDebug Then Main.WriteRFXDebugLog("[RFXComTRX] < ", 0)
    Else
      Return  ' ignore 1st char if 0
    Endif
  Endif

  Try RecBuf[RecBytes] = bTemp ' store received char
  If Error Then
    RecBytes = 0 ' temp hack (overflow)
    RecBuf = Null
    Return
  Endif
  Inc RecBytes  ' increment char counter

  If RecBytes > RecBuf[0] Then ' all bytes of the packet received?
    If bRFXComTRXDebug Then Main.WriteRFXDebugLog(Hex(bTemp, 2) & "\n", 1)
    Decode_Messages()  ' decode message
    RecBytes = 0  ' set to zero to receive next message
  Else
    If bRFXComTRXDebug Then Main.WriteRFXDebugLog(Hex(bTemp, 2), 1) ' write the output to the screen
  Endif

End

Private Sub Decode_Messages()

  Select Case RecBuf[1]
    Case pTypeInterfaceMessage
      WriteMessage("Packettype        = Interface Message")
      Decode_InterfaceMessage()

    Case pTypeRecXmitMessage
      WriteMessage("Packettype        = Receiver/Transmitter Message")
      Decode_RecXmitMessage()

    Case pTypeUndecoded
      WriteMessage("Packettype        = Undecoded RF Message")
      Decode_UnDecoded()

    Case pTypeLighting1
      WriteMessage("Packettype    = Lighting1")
      Decode_Lighting1()

    Case pTypeLighting2
      WriteMessage("Packettype    = Lighting2")
      Decode_Lighting2()

    Case pTypeLighting3
      WriteMessage("Packettype    = Lighting3")
      Decode_Lighting3()

    Case pTypeLighting4
      WriteMessage("Packettype    = Lighting4")
      Decode_Lighting4()

    Case pTypeLighting5
      WriteMessage("Packettype    = Lighting5")
      Decode_Lighting5()

    Case pTypeSecurity1
      WriteMessage("Packettype    = Security1")
      Decode_Security1()

    Case pTypeCamera1
      WriteMessage("Packettype    = Camera1")
      Decode_Camera1()

    Case pTypeRemote
      WriteMessage("Packettype    = Remote control & IR")
      Decode_Remote()

    Case pTypeThermostat1
      WriteMessage("Packettype    = Thermostat1")
      Decode_Thermostat1()

    Case pTypeThermostat2
      WriteMessage("Packettype    = Thermostat2")
      Decode_Thermostat2()

    Case pTypeThermostat3
      WriteMessage("Packettype    = Thermostat3")
      Decode_Thermostat3()

    Case pTypeTEMP
      WriteMessage("Packettype    = TEMP")
      Decode_Temp()

    Case pTypeHUM
      WriteMessage("Packettype    = HUM")
      Decode_Hum()

    Case pTypeTEMP_HUM
      WriteMessage("Packettype    = TEMP_HUM")
      Decode_TempHum()

    Case pTypeBARO
      WriteMessage("Packettype    = BARO")
      Decode_Baro()

    Case pTypeTEMP_HUM_BARO
      WriteMessage("Packettype    = TEMP_HUM_BARO")
      Decode_TempHumBaro()

    Case pTypeRAIN
      WriteMessage("Packettype    = RAIN")
      Decode_Rain()

    Case pTypeWIND
      WriteMessage("Packettype    = WIND")
      Decode_Wind()

    Case pTypeDT
      WriteMessage("Packettype    = DT")
      Decode_DateTime()

    Case pTypeUV
      WriteMessage("Packettype    = UV")
      Decode_Uv()

    Case pTypeCURRENT
      WriteMessage("Packettype    = CURRENT")
      Decode_Current()

    Case pTypeENERGY
      WriteMessage("Packettype    = ENERGY")
      Decode_Energy()

    Case pTypeGAS
      WriteMessage("Packettype    = GAS")
      Decode_Gas()

    Case pTypeWATER
      WriteMessage("Packettype    = WATER")
      Decode_Water()

    Case pTypeWEIGHT
      WriteMessage("Packettype    = WEIGHT")
      Decode_Weight()

    Case pTypeRFXSensor
      WriteMessage("Packettype    = RFXSensor")
      Decode_RFXSensor()

    Case pTypeRFXMeter
      WriteMessage("Packettype    = RFXMeter")
      Decode_RFXMeter()

    Case Else
      WriteMessage("ERROR: Unknown Packet type: " & Hex(RecBuf[1], 2))
      Return
  End Select

  Main.ControlLed("RFXCom", "Off")

End

Private Sub ConvertAddress(sAddr As String) As String

  Dim aAddress As String[] = Split(sAddr, " ")

  If bOldAddrFmt Then
    Return UCase(aAddress[0] & "[" & Replace(aAddress[1], "0x", "") & "]")
  Else
    Return LCase(aAddress[0] & " 0x" & Hex(aAddress[1]))
  Endif

Catch
  Return sAddr

End

' ENUM IRESPONSE AS Integer
'     packetlength = 0
'     packettype = 1
'     subtype = 2
'     seqnbr = 3
'     cmnd = 4
'     msg1 = 5
'     msg2 = 6
'     msg3 = 7
'     msg4 = 8
'     msg5 = 9
'     msg6 = 10
'     msg7 = 11
'     msg8 = 12
'     msg9 = 13
' END ENUM

Public Sub Decode_InterfaceMessage()

  Select Case RecBuf[2]
    Case sTypeInterfaceResponse
      WriteMessage("Subtype           = Interface Response")
      WriteMessage("Sequence no.      = " & CStr(RecBuf[3]))
      Select Case RecBuf[4]
        Case cmdSTATUS, cmdSETMODE, cmd310, cmd315, cmd830, cmd830F, cmd835, cmd835F, cmd895
          Select Case RecBuf[4]
            Case cmdSTATUS
              WriteMessage("Response on cmnd  = Get Status")
            Case cmdSETMODE
              WriteMessage("Response on cmnd  = Set Mode")
            Case cmd310
              WriteMessage("Response on cmnd  = Select 310MHz")
            Case cmd315
              WriteMessage("Response on cmnd  = Select 315MHz")
            Case cmd830
              WriteMessage("Response on cmnd  = Select 868.30MHz")
            Case cmd830F
              WriteMessage("Response on cmnd  = Select 868.30MHz FSK")
            Case cmd835
              WriteMessage("Response on cmnd  = Select 868.35MHz")
            Case cmd835F
             WriteMessage("Response on cmnd  = Select 868.35MHz FSK")
            Case cmd895
              WriteMessage("Response on cmnd  = Select 868.95MHz")
            Case Else
              WriteMessage("Error: unknown response")
          End Select
          Select Case RecBuf[5]
            Case recType310
              WriteMessage("Transceiver type  = 310MHz")
            Case recType315
              WriteMessage("Receiver type     = 315MHz")
            Case recType43392
              WriteMessage("Transceiver type  = 433.92MHz")
            Case recType86830
              WriteMessage("Receiver type     = 868.30MHz")
            Case recType86830FSK
              WriteMessage("Receiver type     = 868.30MHz FSK")
            Case recType86835
              WriteMessage("Receiver type     = 868.35MHz")
            Case recType86835FSK
              WriteMessage("Receiver type     = 868.35MHz FSK")
            Case recType86895
              WriteMessage("Receiver type     = 868.95MHz")
            Case Else
              WriteMessage("Receiver type     = Unknown")
          End Select
          WriteMessage("Firmware version  = " & RecBuf[6])
          If (RecBuf[7] And &H80) <> 0 Then
            WriteMessage("Undecoded         enabled")
          Else
            WriteMessage("Undecoded         disabled")
          Endif
          If (RecBuf[9] And &H1) <> 0 Then
            WriteMessage("X10               enabled")
          Else
            WriteMessage("X10               disabled")
          Endif
          If (RecBuf[9] And &H2) <> 0 Then
            WriteMessage("ARC               enabled")
          Else
            WriteMessage("ARC               disabled")
          Endif
          If (RecBuf[9] And &H4) <> 0 Then
            WriteMessage("AC                enabled")
          Else
            WriteMessage("AC                disabled")
          Endif
          If (RecBuf[9] And &H8) <> 0 Then
            WriteMessage("HomeEasy EU       enabled")
          Else
            WriteMessage("HomeEasy EU       disabled")
          Endif
          If (RecBuf[9] And &H10) <> 0 Then
            WriteMessage("Ikea Koppla       enabled")
          Else
            WriteMessage("Ikea Koppla       disabled")
          Endif
          If (RecBuf[9] And &H20) <> 0 Then
            WriteMessage("Oregon Scientific enabled")
          Else
            WriteMessage("Oregon Scientific disabled")
          Endif
          If (RecBuf[9] And &H40) <> 0 Then
            WriteMessage("ATI               enabled")
          Else
            WriteMessage("ATI               disabled")
          Endif
          If (RecBuf[9] And &H80) <> 0 Then
            WriteMessage("Visonic           enabled")
          Else
            WriteMessage("Visonic           disabled")
          Endif
          If (RecBuf[8] And &H1) <> 0 Then
            WriteMessage("Mertik            enabled")
          Else
            WriteMessage("Mertik            disabled")
          Endif
          If (RecBuf[8] And &H2) <> 0 Then
            WriteMessage("LightwaveRF       enabled")
          Else
            WriteMessage("LightwaveRF       disabled")
          Endif
          If (RecBuf[8] And &H4) <> 0 Then
            WriteMessage("Hideki            enabled")
          Else
            WriteMessage("Hideki            disabled")
          Endif
          If (RecBuf[8] And &H8) <> 0 Then
            WriteMessage("La Crosse         enabled")
          Else
            WriteMessage("La Crosse         disabled")
          Endif
          If (RecBuf[8] And &H10) <> 0 Then
            WriteMessage("FS20              enabled")
          Else
            WriteMessage("FS20              disabled")
          Endif
          If (RecBuf[8] And &H20) <> 0 Then
            WriteMessage("ProGuard          enabled")
          Else
            WriteMessage("ProGuard          disabled")
          Endif
          If (RecBuf[8] And &H40) <> 0 Then
            WriteMessage("Novatys           enabled")
          Else
            WriteMessage("Novatys           disabled")
          Endif
          If (RecBuf[8] And &H80) <> 0 Then
            WriteMessage("RFU protocol 7    enabled")
          Else
            WriteMessage("RFU protocol 7    disabled")
          Endif

        Case cmdUNDECODED
          WriteMessage("Response on cmnd  = UnDecoded On")
        Case cmdENABLEALL
          WriteMessage("Response on cmnd  = Enable All RF")
        Case cmdSAVE
          WriteMessage("Response on cmnd  = Save")
        Case cmdDISX10
          WriteMessage("Response on cmnd  = Disable X10 RF")
        Case cmdDISARC
          WriteMessage("Response on cmnd  = Disable ARC RF")
        Case cmdDISAC
          WriteMessage("Response on cmnd  = Disable AC RF")
        Case cmdDISHEU
          WriteMessage("Response on cmnd  = Disable HomeEasy EU RF")
        Case cmdDISKOP
          WriteMessage("Response on cmnd  = Disable Ikea Koppla RF")
        Case cmdDISOREGON
          WriteMessage("Response on cmnd  = Disable Oregon Scientific RF")
        Case cmdDISATI
          WriteMessage("Response on cmnd  = Disable ATI remote RF")
        Case cmdDISVISONIC
          WriteMessage("Response on cmnd  = Disable Visonic RF")
        Case cmdDISMERTIK
          WriteMessage("Response on cmnd  = Disable Mertik RF")
        Case cmdDISAD
          WriteMessage("Response on cmnd  = Disable AD RF")
        Case cmdDISHID
          WriteMessage("Response on cmnd  = Disable Hideki RF")
        Case cmdDISLCROS
          WriteMessage("Response on cmnd  = Disable La Crosse RF")
        Case cmdDISFS20
          WriteMessage("Response on cmnd  = Disable FS20 RF")
        Case cmdDISNOVAT
          WriteMessage("Response on cmnd  = Disable Novatys RF")
        Case Else
          WriteMessage("ERROR: Unexpected response for Packet type=" & Hex(RecBuf[1]) & ", Sub type=" & Hex(RecBuf[2]) & " msg=" & Hex(RecBuf[4]))
          Return
    End Select
  End Select

End

' ENUM ICMD AS Integer
'        packetlength = 0
'        packettype = 1
'        subtype = 2
'        seqnbr = 3
'        cmnd = 4
'        msg1 = 5
'        msg2 = 6
'        msg3 = 7
'        msg4 = 8
'        msg5 = 9
'        msg6 = 10
'        msg7 = 11
'        msg8 = 12
'        msg9 = 13
'        size = 13

' ENUM UNDECODED AS Integer
'     packetlength = 0
'     packettype = 1
'     subtype = 2
'     seqnbr = 3
'     msg1 = 4
'     ' msg2 to msg32 depending on RF packet length
'     size = 36 ' maximum size
'     pType = &H3
'     sTypeUac = &H0
'     sTypeUarc = &H1
'     sTypeUati = &H2
'     sTypeUhideki = &H3
'     sTypeUlacrosse = &H4
'     sTypeUlwrf = &H5
'     sTypeUmertik = &H6
'     sTypeUoregon1 = &H7
'     sTypeUoregon2 = &H8
'     sTypeUoregon3 = &H9
'     sTypeUproguard = &HA
'     sTypeUvisonic = &HB
'     sTypeUnec = &HC
'     sTypeUfs20 = &HD
' END ENUM

Public Sub Decode_UnDecoded()

  Dim iCnt As Integer

  WriteMessage("UnDecoded ", False)
  Select Case RecBuf[2]
    Case sTypeUac
      WriteMessage("AC:", False)
    Case sTypeUarc
      WriteMessage("ARC:", False)
    Case sTypeUati
      WriteMessage("ATI:", False)
    Case sTypeUhideki
      WriteMessage("HIDEKI:", False)
    Case sTypeUlacrosse
      WriteMessage("LACROSSE:", False)
    Case sTypeUlwrf
      WriteMessage("LWRF:", False)
    Case sTypeUmertik
      WriteMessage("MERTIK:", False)
    Case sTypeUoregon1
      WriteMessage("OREGON1:", False)
    Case sTypeUoregon2
      WriteMessage("OREGON2:", False)
    Case sTypeUoregon3
      WriteMessage("OREGON3:", False)
    Case sTypeUproguard
      WriteMessage("PROGUARD:", False)
    Case sTypeUvisonic
      WriteMessage("VISONIC:", False)
    Case sTypeUnec
      WriteMessage("NEC:", False)
    Case sTypeUfs20
      WriteMessage("FS20:", False)
    Case Else
      WriteMessage("ERROR: Unknown Sub type for Packet type=" & Hex(RecBuf[1]) & ": " & Hex(RecBuf[2]))
  End Select
  For iCnt = 0 To RecBuf[0] - RecBuf[4]
    WriteMessage(Hex(RecBuf[RecBuf[4] + iCnt]), False)
  Next
  WriteMessage(" ")

End

' ENUM LIGHTING1 AS Integer
'     packetlength = 0
'     packettype = 1
'     subtype = 2
'     seqnbr = 3
'     housecode = 4
'     unitcode = 5
'     cmnd = 6
'     filler = 7 'bits 3-0
'     rssi = 7   'bits 7-4
'     size = 7
' END ENUM

Public Sub Decode_Lighting1()

  Dim sAddress, sType, sCmd As String
  Dim iDeviceId As Integer

  Select Case RecBuf[2]
    Case sTypeX10
      sType = "X10"
      WriteMessage("Subtype       = X10")
      WriteMessage("Sequence no.  = " & CStr(RecBuf[3]))
      WriteMessage("Housecode     = " & Chr(RecBuf[4]))
      WriteMessage("Unitcode      = " & CStr(RecBuf[5]))
      sAddress = Chr(RecBuf[4]) & Format(CStr(RecBuf[5]), "00")
      Select Case RecBuf[6]
        Case &H0
          sCmd = "Off"
        Case &H1
          sCmd = "On"
        Case &H2
          sCmd = "Dim"
        Case &H3
          sCmd = "Bright"
        Case &H5
          sCmd = "All On"
        Case &H6
          sCmd = "All Off"
        Case Else
          WriteMessage("Command       = Unknown")
          Return
      End Select
      WriteMessage("Command       = " & sCmd)
    Case sTypeARC
      sType = "ARC"
      WriteMessage("Subtype       = ARC")
      WriteMessage("Sequence no.  = " & CStr(RecBuf[3]))
      WriteMessage("Housecode     = " & Chr(RecBuf[4]))
      WriteMessage("Unitcode      = " & CStr(RecBuf[5]))
      sAddress = Chr(RecBuf[4]) & Format(CStr(RecBuf[5]), "00")
      Select Case RecBuf[6]
        Case &H0
          sCmd = "Off"
        Case &H1
          sCmd = "On"
        Case &H5
          sCmd = "All On"
        Case &H6
          sCmd = "All Off"
        Case Else
          WriteMessage("Command       = Unknown")
          Return
      End Select
      WriteMessage("Command       = " & sCmd)
    Case sTypeAB400D
      sType = "AB400"
      WriteMessage("Subtype       = ELRO AB400")
      WriteMessage("Sequence no.  = " & CStr(RecBuf[3]))
      WriteMessage("Housecode     = " & Chr(RecBuf[4]))
      WriteMessage("Unitcode      = " & CStr(RecBuf[5]))
      sAddress = Chr(RecBuf[4]) & Format(CStr(RecBuf[5]), "00")
      Select Case RecBuf[6]
        Case &H0
          sCmd = "Off"
        Case &H1
          sCmd = "On"
        Case Else
          WriteMessage("Command       = Unknown")
          Return
      End Select
      WriteMessage("Command       = " & sCmd)
    Case Else
      WriteMessage("ERROR: Unknown Sub type for Packet type=" & Hex(RecBuf[1]) & ": " & Hex(RecBuf[2]))
      Return
  End Select
  WriteMessage("Signal level  = " & CStr(Lsr(RecBuf[7], 4)))
  iDeviceId = Devices.Find(sAddress, Devices.FindInterface("RFXCom Tranceiver"), UCase(sType))
  ' update value
  If iDeviceId Then Devices.ValueUpdate(iDeviceId, sCmd, "", "", "")

End

' ENUM LIGHTING2 AS Integer
'     packetlength = 0
'     packettype = 1
'     subtype = 2
'     seqnbr = 3
'     id1 = 4
'     id2 = 5
'     id3 = 6
'     id4 = 7
'     unitcode = 8
'     cmnd = 9
'     level = 10
'     filler = 11 'bits 3-0
'     rssi = 11   'bits 7-4
'     size = 11
' END ENUM

Public Sub Decode_Lighting2()

  Dim sAddress, sType, sCmd As String
  Dim iDeviceId As Integer

  Select Case RecBuf[2]
    Case sTypeAC, sTypeHEU, sTypeANSLUT
      Select Case RecBuf[2]
        Case sTypeAC
          sType = "AC"
          WriteMessage("Subtype       = AC")
        Case sTypeHEU
          sType = "HEEU"
          WriteMessage("Subtype       = HomeEasy EU")
        Case sTypeANSLUT
          sType = "Anslut"
          WriteMessage("Subtype       = ANSLUT")
      End Select
      WriteMessage("Sequence no.  = " & CStr(RecBuf[3]))
      sAddress = Hex(RecBuf[4]) & Hex(RecBuf[5], 2) & Hex(RecBuf[6, 2]) & Hex(RecBuf[7], 2) & " " & CStr(RecBuf[8])
      WriteMessage("ID            = " & sAddress)
      Select Case RecBuf[9]
        Case &H0
          sCmd = "Off"
        Case &H1
          sCmd = "On"
        Case &H2
          sCmd = "Dim " & CStr(RecBuf[10])
        Case &H3
          sCmd = "Group Off"
        Case &H4
          sCmd = "Group On"
        Case &H5
          sCmd = "Dim " & CStr(RecBuf[10])
          WriteMessage("Command       = Group " & sCmd)
        Case Else
          WriteMessage("Command       = Unknown")
          Return
      End Select
      WriteMessage("Command       = " & sCmd)
    Case Else
      WriteMessage("ERROR: Unknown Sub type for Packet type=" & Hex(RecBuf[1]) & ": " & Hex(RecBuf[2]))
      Return
  End Select
  WriteMessage("Signal level  = " & CStr(Lsr(RecBuf[11], 4)))
  iDeviceId = Devices.Find(sAddress, Devices.FindInterface("RFXCom Tranceiver"), UCase(sType))
  ' update value
  If iDeviceId Then Devices.ValueUpdate(iDeviceId, sCmd, "", "", "")

End

' ENUM LIGHTING3 AS Integer
'     packetlength = 0
'     packettype = 1
'     subtype = 2
'     seqnbr = 3
'     system = 4
'     channel = 5
'     cmnd = 6
'     level = 7
'     filler = 8  'bits 3-0
'     rssi = 8    'bits 7-4
'     size = 8
' END ENUM

Public Sub Decode_Lighting3()

  Dim sAddress, sType, sCmd As String
  Dim iDeviceId As Integer

  Select Case RecBuf[2]
    Case sTypeKoppla
      sType = "Koppla"
      WriteMessage("Subtype       = Ikea Koppla")
      WriteMessage("Sequence no.  = " & CStr(RecBuf[3]))
      Select Case RecBuf[6]
        Case &H0
          sCmd = "Off"
        Case &H1
          sCmd = "On"
        Case &H20
          sCmd = "Dim " & CStr(RecBuf[6])
        Case &H21
          sCmd = "Program"
        Case Else
          If RecBuf[6] >= &H10 And RecBuf[6] < &H18 Then
            sCmd = "Dim"
          Else If RecBuf[6] >= &H18 And RecBuf[6] < &H20 Then
            sCmd = "Bright"
          Else
            sCmd = "UNKNOWN"
          Endif
      End Select
      WriteMessage("Command       = " & sCmd)
    Case Else
      WriteMessage("ERROR: Unknown Sub type for Packet type=" & Hex(RecBuf[1]) & ": " & Hex(RecBuf[2]))
      Return
  End Select

  WriteMessage("Signal level  = " & CStr(Lsr(RecBuf[8], 4)))
  iDeviceId = Devices.Find(sAddress, Devices.FindInterface("RFXCom Tranceiver"), UCase(sType))
  ' update value
  If iDeviceId Then Devices.ValueUpdate(iDeviceId, sCmd, "", "", "")

End

' ENUM LIGHTING4 AS Integer
'     packetlength = 0
'     packettype = 1
'     subtype = 2
'     seqnbr = 3
'     cmd1 = 4
'     cmd2 = 5
'     cmd3 = 6
'     pulsehigh = 7
'     pulselow = 8
'     filler = 9
'     size = 9
' END ENUM

Public Sub Decode_Lighting4()

  WriteMessage("Not implemented")

End

' ENUM LIGHTING5 AS Integer
'     packetlength = 0
'     packettype = 1
'     subtype = 2
'     seqnbr = 3
'     id1 = 4
'     id2 = 5
'     id3 = 6
'     unitcode = 7
'     cmnd = 8
'     filler = 9 'bits 3-0
'     rssi = 9   'bits 7-4
'     size = 9
' END ENUM

Public Sub Decode_Lighting5()

  Dim sAddress, sType, sCmd As String
  Dim iDeviceId As Integer

  Select Case RecBuf[2]
    Case sTypeLightwaveRF
      sType = "LightwaveRF"
      WriteMessage("Subtype       = LightwaveRF")
      WriteMessage("Sequence no.  = " & CStr(RecBuf[3]))
      sAddress = Hex(RecBuf[4], 2) & Hex(RecBuf[5], 2) & Hex(RecBuf[6], 2) & " " & CStr(RecBuf[7])
      WriteMessage("ID            = " & sAddress)
      Select Case RecBuf[8]
        Case &H0
          sCmd = "Off"
        Case &H1
          sCmd = "On"
        Case &H2
          sCmd = "Group Off"
        Case &H3
          sCmd = "Group Mood 1"
        Case &H4
          sCmd = "Group Mood 2"
        Case &H5
          sCmd = "Group Mood 3"
        Case &H6
          sCmd = "Unlock"
        Case &H7
          sCmd = "Lock"
        Case &H8
          sCmd = "All Lock"
        Case Else
          WriteMessage("Command       = Unknown")
          Return
      End Select
      WriteMessage("Command       = " & sCmd)
    Case Else
      WriteMessage("ERROR: Unknown Sub type for Packet type=" & Hex(RecBuf[1]) & ": " & Hex(RecBuf[2]))
      Return
  End Select
  WriteMessage("Signal level  = " & CStr(Lsr(RecBuf[9], 4)))
  iDeviceId = Devices.Find(sAddress, Devices.FindInterface("RFXCom Tranceiver"), UCase(sType))
  ' update value
  If iDeviceId Then Devices.ValueUpdate(iDeviceId, sCmd, "", "", "")

End

' ENUM SECURITY1 AS Integer
'      packetlength = 0
'      packettype = 1
'      subtype = 2
'      seqnbr = 3
'      id1 = 4
'      id2 = 5
'      id3 = 6
'      status = 7
'      battery_level = 8  'bits 3-0
'      rssi = 8           'bits 7-4
'      filler = 8
'      size = 8
'  END ENUM

Public Sub Decode_Security1()

  Dim sAddress, sType, sCmd As String
  Dim sTamper As String = " "
  Dim sBatt As String = "OK"
  Dim iDeviceId As Integer

  Select Case RecBuf[2]
    Case sTypeSecX10
      sType = "X10Security"
      WriteMessage("Subtype       = X10 security")
    Case sTypeSecX10M
      sType = "X10Security"
      WriteMessage("Subtype       = X10 security motion")
    Case sTypeSecX10R
      sType = "X10Security"
      WriteMessage("Subtype       = X10 security remote")
    Case sTypeKD101
      WriteMessage("Subtype       = KD101 smoke detector")
    Case sTypePowercodeSensor
      sType = "VisonicSensor"
      WriteMessage("Subtype       = Visonic PowerCode sensor - primary contact")
    Case sTypePowercodeMotion
      sType = "VisonicMotion"
      WriteMessage("Subtype       = Visonic PowerCode motion")
    Case sTypeCodesecure
      sType = "VisonicCode"
      WriteMessage("Subtype       = Visonic CodeSecure")
    Case sTypePowercodeAux
      sType = "VisonicPwrCode"
      WriteMessage("Subtype       = Visonic PowerCode sensor - auxiliary contact")
    Case Else
      WriteMessage("ERROR: Unknown Sub type for Packet type=" & Hex(RecBuf[1]) & ": " & Hex(RecBuf[2]))
      Return
  End Select
  WriteMessage("Sequence no.  = " & CStr(RecBuf[3]))
  sAddress = ConvertAddress("x10sec " & Hex(RecBuf[4], 2) & Hex(RecBuf[5], 2) & Hex(RecBuf[6], 2))
  WriteMessage("ID1-3         = " & sAddress)

  Select Case RecBuf[7]
    Case sStatusNormal
      sCmd = "Normal"
    Case sStatusNormalDelayed
      sCmd = "Normal Delayed"
    Case sStatusAlarm
      sCmd = "Alarm"
    Case sStatusAlarmDelayed
      sCmd = "Alarm Delayed"
    Case sStatusMotion
      sCmd = "Motion"
    Case sStatusNoMotion
      sCmd = "No Motion"
    Case sStatusPanic
      sCmd = "Panic"
    Case sStatusPanicOff
      sCmd = "Panic End"
    Case sStatusTamper
      sTamper = "Tamper"
    Case sStatusArmAway
      sCmd = "Arm Away"
    Case sStatusArmAwayDelayed
      sCmd = "Arm Away Delayed"
    Case sStatusArmHome
      sCmd = "Arm Home"
    Case sStatusArmHomeDelayed
      sCmd = "Arm Home Delayed"
    Case sStatusDisarm
      sCmd = "Disarm"
    Case sStatusLightOff
      sCmd = "Light Off"
    Case sStatusLightOn
      sCmd = "Light On"
    Case sStatusLight2Off
      sCmd = "Light 2 Off"
    Case sStatusLight2On
      sCmd = "Light 2 On"
    Case sStatusDark
      sCmd = "Dark"
    Case sStatusLight
      sCmd = "Light"
    Case sStatusBatLow
      sCmd = "Battery low MS10 or XX18 sensor"
      sBatt = "Low"
    Case sStatusPairKD101
      sCmd = "Pair KD101"
  End Select
  WriteMessage("Status        = " & sCmd)
  If (RecBuf[8] And &HF) = 0 Then
    sBatt = "Low"
  Else
    sBatt = "OK"
  Endif
  WriteMessage("Battery level = " & sBatt)
  WriteMessage("Signal level  = " & CStr(Lsr(RecBuf[8], 4)))
  iDeviceId = Devices.Find(sAddress, Devices.FindInterface("RFXCom Tranceiver"), UCase(sType))
  ' update value & battery status
  If iDeviceId Then
    ' cmd
    Devices.ValueUpdate(iDeviceId, sCmd, sTamper, "", "")
    Devices.Battery(iDeviceId, sBatt)
  Endif

End

' ENUM CAMERA1 AS Integer
'     packetlength = 0
'     packettype = 1
'     subtype = 2
'     seqnbr = 3
'     housecode = 4
'     cmnd = 5
'     filler = 6 'bits 3-0
'     rssi = 6   'bits 7-4
'     size = 6
' END ENUM

Public Sub Decode_Camera1()

  Dim sAddress, sType, sCmd As String
  Dim iDeviceId As Integer

  ' TODO: address decode

  Select Case RecBuf[2]
    Case sTypeNinja
      sType = "ninja"
      WriteMessage("Subtype       = X10 Ninja/Robocam")
      WriteMessage("Sequence no.  = " & CStr(RecBuf[3]))
      sAddress = sType & " " & Chr(RecBuf[4])
      WriteMessage("Address       = " & sAddress)
      Select Case RecBuf[5]
        Case &H0
          sType = "Left"
        Case &H1
          sType = "Right"
        Case &H2
          sType = "Up"
        Case &H3
          sType = "Down"
        Case &H4
          sType = "Preset 1"
        Case &H5
          sType = "Preset 1 Program"
        Case &H6
          sType = "Preset 2"
        Case &H7
          sType = "Preset 2 Program"
        Case &H8
          sType = "Preset 3"
        Case &H9
          sType = "Preset 3 Program"
        Case &HA
          sType = "Preset 4"
        Case &HB
          sType = "Preset 4 Program"
        Case &HC
          sType = "Center"
        Case &HD
          sType = "Center Program"
        Case &HE
          sType = "Sweep"
        Case &HF
          sType = "Sweep Program"
        Case Else
          WriteMessage("Unknown")
          Return
      End Select
      WriteMessage("Command       = " & sCmd)
    Case Else
      WriteMessage("ERROR: Unknown Sub type for Packet type=" & Hex(RecBuf[1]) & ": " & Hex(RecBuf[2]))
      Return
  End Select
  WriteMessage("Signal level  = " & CStr(Lsr(RecBuf[6], 4)))
  iDeviceId = Devices.Find(sAddress, Devices.FindInterface("RFXCom Tranceiver"), UCase(sType))
  ' update value
  If iDeviceId Then Devices.ValueUpdate(iDeviceId, sCmd, "", "", "")

End

' ENUM REMOTE AS Integer
'      packetlength = 0
'      packettype = 1
'      subtype = 2
'      seqnbr = 3
'      id = 4
'      cmnd = 5
'      toggle = 6       'bit 0 
'      filler = 6       'bits 3-1 
'      rssi = 6         'bits 7-4 
'      size = 6
'  END ENUM

Public Sub Decode_Remote()

  Dim sAddress, sType, sCmd As String
  Dim iDeviceId As Integer

  Select Case RecBuf[2]
    Case sTypeATI
      sType = "ATI"
      WriteMessage("Subtype       = ATI Remote Wonder")
      WriteMessage("Sequence no.  = " & CStr(RecBuf[3]))
      sAddress = CStr(RecBuf[4])
      WriteMessage("ID            = " & sAddress)
      Select Case RecBuf[5]
        Case &H0
          sCmd = "A"
        Case &H1
          sCmd = "B"
        Case &H2
          sCmd = "Power"
        Case &H3
          sCmd = "TV"
        Case &H4
          sCmd = "DVD"
        Case &H5
          sCmd = "?"
        Case &H6
          sCmd = "Guide"
        Case &H7
          sCmd = "Drag"
        Case &H8
          sCmd = "VOL+"
        Case &H9
          sCmd = "VOL-"
        Case &HA
          sCmd = "MUTE"
        Case &HB
          sCmd = "CHAN+"
        Case &HC
          sCmd = "CHAN-"
        Case &HD
          sCmd = "1"
        Case &HE
          sCmd = "2"
        Case &HF
          sCmd = "3"
        Case &H10
          sCmd = "4"
        Case &H11
          sCmd = "5"
        Case &H12
          sCmd = "6"
        Case &H13
          sCmd = "7"
        Case &H14
          sCmd = "8"
        Case &H15
          sCmd = "9"
        Case &H16
          sCmd = "Txt"
        Case &H17
          sCmd = "0"
        Case &H18
          sCmd = "Snapshot ESC"
        Case &H19
          sCmd = "C"
        Case &H1A
          sCmd = "^"
        Case &H1B
          sCmd = "D"
        Case &H1C
          sCmd = "TV/RADIO"
        Case &H1D
          sCmd = "<"
        Case &H1E
          sCmd = "OK"
        Case &H1F
          sCmd = ">"
        Case &H20
          sCmd = "<-"
        Case &H21
          sCmd = "E"
        Case &H22
          sCmd = "v"
        Case &H23
          sCmd = "F"
        Case &H24
          sCmd = "Rewind"
        Case &H25
          sCmd = "Play"
        Case &H26
          sCmd = "Fast forward"
        Case &H27
          sCmd = "Record"
        Case &H28
          sCmd = "Stop"
        Case &H29
          sCmd = "Pause"
        Case &H2C
          sCmd = "TV"
        Case &H2D
          sCmd = "VCR"
        Case &H2E
          sCmd = "RADIO"
        Case &H2F
          sCmd = "TV preview"
        Case &H30
          sCmd = "Channel list"
        Case &H31
          sCmd = "Video desktop"
        Case &H32
          sCmd = "Red"
        Case &H33
          sCmd = "Green"
        Case &H34
          sCmd = "Yellow"
        Case &H35
          sCmd = "Blue"
        Case &H36
          sCmd = "Rename TAB"
        Case &H37
          sCmd = "Acquire image"
        Case &H38
          sCmd = "Edit image"
        Case &H39
          sCmd = "Full screen"
        Case &H3A
          sCmd = "DVD Audio"
        Case &H70
          sCmd = "Cursor-left"
        Case &H71
          sCmd = "Cursor-right"
        Case &H72
          sCmd = "Cursor-up"
        Case &H73
          sCmd = "Cursor-down"
        Case &H74
          sCmd = "Cursor-up-left"
        Case &H75
          sCmd = "Cursor-up-right"
        Case &H76
          sCmd = "Cursor-down-right"
        Case &H77
          sCmd = "Cursor-down-left"
        Case &H78
          sCmd = "V"
        Case &H79
          sCmd = "V-End"
        Case &H7C
          sCmd = "X"
        Case &H7D
          sCmd = "X-End"
        Case Else
          sCmd = "Unknown"
          Return
      End Select
      WriteMessage("Command       = " & SCmd)
    Case sTypeATI2
      sType = "ATI2"
      WriteMessage("Subtype       = ATI Remote Wonder II")
      WriteMessage("Sequence no.  = " & CStr(RecBuf[3]))
      sAddress = CStr(RecBuf[4])
      WriteMessage("ID            = " & sAddress)
      Select Case RecBuf[5]
        Case &H0
          sCmd = "A"
        Case &H1
          sCmd = "B"
        Case &H2
          sCmd = "Power"
        Case &H3
          sCmd = "TV"
        Case &H4
          sCmd = "DVD"
        Case &H5
          sCmd = "?"
        Case &H6
          sCmd = "Guide"
        Case &H7
          sCmd = "Drag"
        Case &H8
          sCmd = "VOL+"
        Case &H9
          sCmd = "VOL-"
        Case &HA
          sCmd = "MUTE"
        Case &HB
          sCmd = "CHAN+"
        Case &HC
          sCmd = "CHAN-"
        Case &HD
          sCmd = "1"
        Case &HE
          sCmd = "2"
        Case &HF
          sCmd = "3"
        Case &H10
          sCmd = "4"
        Case &H11
          sCmd = "5"
        Case &H12
          sCmd = "6"
        Case &H13
          sCmd = "7"
        Case &H14
          sCmd = "8"
        Case &H15
          sCmd = "9"
        Case &H16
          sCmd = "Txt"
        Case &H17
          sCmd = "0"
        Case &H18
          sCmd = "Open setup menu"
        Case &H19
          sCmd = "C"
        Case &H1A
          sCmd = "^"
        Case &H1B
          sCmd = "D"
        Case &H1C
          sCmd = "FM"
        Case &H1D
          sCmd = "<"
        Case &H1E
          sCmd = "OK"
        Case &H1F
          sCmd = ">"
        Case &H20
          sCmd = "Max/Restore window"
        Case &H21
          sCmd = "E"
        Case &H22
          sCmd = "V"
        Case &H23
          sCmd = "F"
        Case &H24
          sCmd = "Rewind"
        Case &H25
          sCmd = "Play"
        Case &H26
          sCmd = "Fast forward"
        Case &H27
          sCmd = "Record"
        Case &H28
          sCmd = "Stop"
        Case &H29
          sCmd = "Pause"
        Case &H2A
          sCmd = "TV2"
        Case &H2B
          sCmd = "Clock"
        Case &H2C
          sCmd = "I"
        Case &H2D
          sCmd = "ATI"
        Case &H2E
          sCmd = "RADIO"
        Case &H2F
          sCmd = "TV preview"
        Case &H30
          sCmd = "Channel list"
        Case &H31
          sCmd = "Video desktop"
        Case &H32
          sCmd = "Red"
        Case &H33
          sCmd = "Green"
        Case &H34
          sCmd = "Yellow"
        Case &H35
          sCmd = "lue"
        Case &H36
          sCmd = "Rename TAB"
        Case &H37
          sCmd = "Acquire image"
        Case &H38
          sCmd = "Edit image"
        Case &H39
          sCmd = "Full screen"
        Case &H3A
          sCmd = "DVD audio"
        Case &H70
          sCmd = "Cursor-left"
        Case &H71
          sCmd = "Cursor-right"
        Case &H72
          sCmd = "Cursor-up"
        Case &H73
          sCmd = "Cursor-down"
        Case &H74
          sCmd = "Cursor-up-left"
        Case &H75
          sCmd = "Cursor-up-right"
        Case &H76
          sCmd = "Cursor-down-right"
        Case &H77
          sCmd = "Cursor-down-left"
        Case &H78
          sCmd = "V"
        Case &H79
          sCmd = "V-End"
        Case &H7C
          sCmd = "X"
        Case &H7D
          sCmd = "X-End"
        Case Else
          WriteMessage("Command       = Unknown")
          Return
      End Select
      WriteMessage("Command       = " & sCmd)
      If (RecBuf[6] And &H1) = &H1 Then
        WriteMessage("  (Button press = odd)")
      Else
        WriteMessage("  (Button press = even)")
      Endif

    Case sTypeMedion
      sType = "MEDION"
      WriteMessage("Subtype       = Medion Remote")
      WriteMessage("Sequence no.  = " & CStr(RecBuf[3]))
      sAddress = CStr(RecBuf[4])
      WriteMessage("ID            = " & sAddress)
      Select Case RecBuf[5]
        Case &H0
          sCmd = "Mute"
        Case &H1
          sCmd = "B"
        Case &H2
          sCmd = "Power"
        Case &H3
          sCmd = "TV"
        Case &H4
          sCmd = "DVD"
        Case &H5
          sCmd = "Photo"
        Case &H6
          sCmd = "Music"
        Case &H7
          sCmd = "Drag"
        Case &H8
          sCmd = "VOL-"
        Case &H9
          sCmd = "VOL+"
        Case &HA
          sCmd = "MUTE"
        Case &HB
          sCmd = "CHAN+"
        Case &HC
          sCmd = "CHAN-"
        Case &HD
          sCmd = "1"
        Case &HE
          sCmd = "2"
        Case &HF
          sCmd = "3"
        Case &H10
          sCmd = "4"
        Case &H11
          sCmd = "5"
        Case &H12
          sCmd = "6"
        Case &H13
          sCmd = "7"
        Case &H14
          sCmd = "8"
        Case &H15
          sCmd = "9"
        Case &H16
          sCmd = "Txt"
        Case &H17
          sCmd = "0"
        Case &H18
          sCmd = "Snapshot ESC"
        Case &H19
          sCmd = "DVD MENU"
        Case &H1A
          sCmd = "^"
        Case &H1B
          sCmd = "Setup"
        Case &H1C
          sCmd = "TV/RADIO"
        Case &H1D
          sCmd = "<"
        Case &H1E
          sCmd = "OK"
        Case &H1F
          sCmd = ">"
        Case &H20
          sCmd = "<-"
        Case &H21
          sCmd = "E"
        Case &H22
          sCmd = "v"
        Case &H23
          sCmd = "F"
        Case &H24
          sCmd = "Rewind"
        Case &H25
          sCmd = "Play"
        Case &H26
          sCmd = "Fast forward"
        Case &H27
          sCmd = "Record"
        Case &H28
          sCmd = "Stop"
        Case &H29
          sCmd = "Pause"
        Case &H2C
          sCmd = "TV"
        Case &H2D
          sCmd = "VCR"
        Case &H2E
          sCmd = "RADIO"
        Case &H2F
          sCmd = "TV preview"
        Case &H30
          sCmd = "Channel list"
        Case &H31
          sCmd = "Video desktop"
        Case &H32
          sCmd = "Red"
        Case &H33
          sCmd = "Green"
        Case &H34
          sCmd = "Yellow"
        Case &H35
          sCmd = "Blue"
        Case &H36
          sCmd = "Rename TAB"
        Case &H37
          sCmd = "Acquire image"
        Case &H38
          sCmd = "Edit image"
        Case &H39
          sCmd = "Full screen"
        Case &H3A
          sCmd = "DVD audio"
        Case &H70
          sCmd = "Cursor-left"
        Case &H71
          sCmd = "Cursor-right"
        Case &H72
          sCmd = "Cursor-up"
        Case &H73
          sCmd = "Cursor-down"
        Case &H74
          sCmd = "Cursor-up-left"
        Case &H75
          sCmd = "Cursor-up-right"
        Case &H76
          sCmd = "Cursor-down-right"
        Case &H77
          sCmd = "Cursor-down-left"
        Case &H78
          sCmd = "V"
        Case &H79
          sCmd = "V-End"
        Case &H7C
          sCmd = "X"
        Case &H7D
          sCmd = "X-End"
        Case Else
          WriteMessage("Command       = Unknown")
          Return
      End Select
      WriteMessage("Command       = " & sCmd)
    Case sTypePCremote
      sType = "PCREMOTE"
      WriteMessage("Subtype       = PC Remote")
      WriteMessage("Sequence no.  = " & CStr(RecBuf[3]))
      sAddress = CStr(RecBuf[4])
      WriteMessage("ID            = " & sAddress)
      Select Case RecBuf[5]
        Case &H2
          sCmd = "0"
        Case &H82
          sCmd = "1"
        Case &HD1
          sCmd = "MP3"
        Case &H42
          sCmd = "2"
        Case &HD2
          sCmd = "DVD"
        Case &HC2
          sCmd = "3"
        Case &HD3
          sCmd = "CD"
        Case &H22
          sCmd = "4"
        Case &HD4
          sCmd = "PC"
        Case &HA2
          sCmd = "5"
        Case &HD5
          sCmd = "SHIFT-5"
        Case &H62
          sCmd = "6"
        Case &HE2
          sCmd = "7"
        Case &H12
          sCmd = "8"
        Case &H92
          sCmd = "9"
        Case &HC0
          sCmd = "CH-"
        Case &H40
          sCmd = "CH+"
        Case &HE0
          sCmd = "VOL-"
        Case &H60
          sCmd = "VOL+"
        Case &HA0
          sCmd = "MUTE"
        Case &H3A
          sCmd = "INFO"
        Case &H38
          sCmd = "REW"
        Case &HB8
          sCmd = "FF"
        Case &HB0
          sCmd = "PLAY"
        Case &H64
          sCmd = "PAUSE"
        Case &H63
          sCmd = "STOP"
        Case &HB6
          sCmd = "MENU"
        Case &HFF
          sCmd = "REC"
        Case &HC9
          sCmd = "EXIT"
        Case &HD8
          sCmd = "TEXT"
        Case &HD9
          sCmd = "SHIFT-TEXT"
        Case &HF2
          sCmd = "TELETEXT"
        Case &HD7
          sCmd = "SHIFT-TELETEXT"
        Case &HBA
          sCmd = "A+B"
        Case &H52
          sCmd = "ENT"
        Case &HD6
          sCmd = "SHIFT-ENT"
        Case &H70
          sCmd = "Cursor-left"
        Case &H71
          sCmd = "Cursor-right"
        Case &H72
          sCmd = "Cursor-up"
        Case &H73
          sCmd = "Cursor-down"
        Case &H74
          sCmd = "Cursor-up-left"
        Case &H75
          sCmd = "Cursor-up-right"
        Case &H76
          sCmd = "Cursor-down-right"
        Case &H77
          sCmd = "Cursor-down-left"
        Case &H78
          sCmd = "Left mouse"
        Case &H79
          sCmd = "Left mouse-End"
        Case &H7B
          sCmd = "Drag"
        Case &H7C
          sCmd = "Right mouse"
        Case &H7D
          sCmd = "Right mouse-End"
        Case Else
          WriteMessage("Command       = Unknown")
          Return
      End Select
      WriteMessage("Command       = " & sCmd)
    Case Else
      WriteMessage("ERROR: Unknown Sub type for Packet type=" & Hex(RecBuf[1], 2) & ":" & Hex(RecBuf[2], 2))
      Return
  End Select
  WriteMessage("Signal level  = " & CStr(Lsr(RecBuf[6], 4)))
  iDeviceId = Devices.Find("default", Devices.FindInterface("RFXCom Tranceiver"), UCase(sType))
  ' update value
  If iDeviceId Then Devices.ValueUpdate(iDeviceId, sCmd, "", "", "")

End

' ENUM THERMOSTAT1 AS Integer
'     packetlength = 0
'     packettype = 1
'     subtype = 2
'     seqnbr = 3
'     id1 = 4
'     id2 = 5
'     temperature = 6
'     set_point = 7
'     status = 8  'bits 1-0
'     filler = 8  'bits 6-2
'     mode = 8    'bit 7
'     battery_level = 9   'bits 3-0
'     rssi = 9            'bits 7-4
'     size = 9
' END ENUM

Public Sub Decode_Thermostat1()

  Dim sAddress, sType, sTemp, sSetTemp, sCmd, sStatus As String
  Dim iDeviceId As Integer

  Select Case RecBuf[2]
    Case sTypeDigimax
      sType = "Digimax"
      WriteMessage("Subtype       = Digimax")
    Case sTypeDigimax1
      sType = "Digimax"
      WriteMessage("Subtype       = Digimax with short format")
    Case Else
      WriteMessage("ERROR: Unknown Sub type for Packet type=" & Hex(RecBuf[1]) & ":" & Hex(RecBuf[2]))
      Return
  End Select
  WriteMessage("Sequence no.  = " & CStr(RecBuf[3]))
  sAddress = ConvertAddress(CStr(RecBuf[4] * 256 + RecBuf[5]))
  WriteMessage("ID            = " & sAddress)
  sTemp = CStr(RecBuf[6])
  WriteMessage("Temperature   = " & sTemp & " °C")
  If RecBuf[2] = sTypeDigimax Then
    sSetTemp = CStr(RecBuf[7])
    WriteMessage("Set           = " & sSetTemp & " °C")
    If (RecBuf[8] And &H80) = 0 Then
      sCmd = "Heating"
    Else
      sCmd = "Cooling"
    Endif
    WriteMessage("Mode          = " & sCmd)
    Select Case (RecBuf[8] And &H3)
      Case 0
        sStatus = "Not Available"
      Case 1
        sStatus = "Demand"
      Case 2
        sStatus = "No demand"
      Case 3
        sStatus = "Initializing"
    End Select
    WriteMessage("Status        = " & sStatus)
  Endif
  WriteMessage("Signal level  = " & CStr(Lsr(RecBuf[9], 4)))
  iDeviceId = Devices.Find(sAddress, Devices.FindInterface("RFXCom Tranceiver"), UCase(sType))
  ' update values
  If iDeviceId Then Devices.ValueUpdate(iDeviceId, sSetTemp, sTemp, sCmd, sStatus)

End

' ENUM THERMOSTAT2 AS Integer
'     packetlength = 0
'     packettype = 1
'     subtype = 2
'     seqnbr = 3
'     unitcode = 4
'     cmnd = 5
'     filler = 6  'bits 3-0
'     rssi = 6    'bits 7-4
'     size = 6
' END ENUM

Public Sub Decode_Thermostat2()

  WriteMessage("Not implemented")

End

' ENUM THERMOSTAT3 AS Integer
'     packetlength = 0
'     packettype = 1
'     subtype = 2
'     seqnbr = 3
'     unitcode1 = 4
'     unitcode2 = 5
'     unitcode3 = 6
'     cmnd = 7
'     filler = 9   'bits 3-0
'     rssi = 9     'bits 7-4
'     size = 9
' END ENUM

Public Sub Decode_Thermostat3()

  Dim sAddress, sType, sCmd As String
  Dim iDeviceId As Integer

  Select Case RecBuf[2]
    Case sTypeMertikG6RH4T1
      sType = "MERTIKG6R-H4T1"
      WriteMessage("Subtype       = Mertik G6R-H4T1")
    Case sTypeMertikG6RH4TB
      sType = "MERTIKG6R-H4TB"
      WriteMessage("Subtype       = Mertik G6R-H4TB")
    Case Else
      WriteMessage("ERROR: Unknown Sub type for Packet type=" & Hex(RecBuf[1]) & ":" & Hex(RecBuf[2]))
      Return
  End Select
  WriteMessage("Sequence nbr  = " & CStr(RecBuf[3]))
  sAddress = ConvertAddress(Hex(RecBuf[4], 2) & Hex(RecBuf[5], 2) & Hex(RecBuf[6], 2))
  WriteMessage("ID            = " & sAddress)
  Select Case RecBuf[7]
    Case 0
      sCmd = "Off"
    Case 1
      sCmd = "On"
    Case 2
      sCmd = "Up"
    Case 3
      sCmd = "Down"
    Case 4
      If RecBuf[2] = sTypeMertikG6RH4T1 Then
        sCmd = "Run Up"
      Else
        sCmd = "2nd Off"
      Endif
    Case 5
      If RecBuf[2] = sTypeMertikG6RH4T1 Then
        sCmd = "Run Down"
      Else
        sCmd = "2nd On"
      Endif
    Case 6
      If RecBuf[2] = sTypeMertikG6RH4T1 Then
        sCmd = "Stop"
      Else
        WriteMessage("Command       = Unknown")
        Return
      Endif
    Case Else
      WriteMessage("Command       = Unknown")
      Return
  End Select
  WriteMessage("Command       = " & sCmd)
  WriteMessage("Signal level  = " & CStr(Lsr(RecBuf[9], 4)))
  iDeviceId = Devices.Find(sAddress, Devices.FindInterface("RFXCom Tranceiver"), UCase(sType))
  ' update value
  If iDeviceId Then Devices.ValueUpdate(iDeviceId, sCmd, "", "", "")

End

' ENUM RAIN AS Integer
'     packetlength = 0
'     packettype = 1
'     subtype = 2
'     seqnbr = 3
'     id1 = 4
'     id2 = 5
'     rainrateh = 6
'     rainratel = 7
'     raintotal1 = 8
'     raintotal2 = 9
'     raintotal3 = 10
'     battery_level = 11  'bits 3-0
'     rssi = 11           'bits 7-4
'     size = 11
' END ENUM

Private Sub Decode_Rain()

  Dim sAddress, sType, sTemp, sRainRate, sRainTotal, sBatt As String
  Dim iDeviceId As Integer

  Select Case RecBuf[2]
    Case sTypeRAIN1
      sType = "rain1"
      WriteMessage("Subtype       = RAIN1 - RGR126/682/918")
    Case sTypeRAIN2
      sType = "rain2"
      WriteMessage("Subtype       = RAIN2 - PCR800")
    Case sTypeRAIN3
      sType = "rain3"
      WriteMessage("Subtype       = RAIN3 - TFA")
    Case Else
      WriteMessage("ERROR: Unknown Sub type for Packet type=" & Hex(RecBuf[1]) & ":" & Hex(RecBuf[2]))
      Return
  End Select
  WriteMessage("Sequence no.  = " & CStr(RecBuf[3]))
  sAddress = ConvertAddress(sType & " " & (RecBuf[4] * 256 + RecBuf[5]))
  WriteMessage("ID            = " & sAddress)
  If RecBuf[2] = sTypeRAIN1 Then
    sRainRate = CStr((RecBuf[6] * 256) + RecBuf[7])
    WriteMessage("Rain rate     = " & sRainRate & " mm/h")
  Else
    sRainRate = CStr(((RecBuf[6] * 256) + RecBuf[7]) / 100)
    WriteMessage("Rain rate     = " & sRainRate & " mm/h")
  Endif
    sRainTotal = CStr((RecBuf[8] * 65535) + RecBuf[9] * 256 + RecBuf[10])
  WriteMessage("Total rain    = " & sRainTotal & " mm")
  WriteMessage("Signal level  = " & Lsr(RecBuf[11], 4))
  If (Recbuf[11] And &HF) = 0 Then
    sBatt = "Low"
  Else
    sBatt = "OK"
  Endif
  WriteMessage("Battery       = " & sBatt)
  iDeviceId = Devices.Find(sAddress, Devices.FindInterface("RFXCom Tranceiver"), UCase(sType))
  ' update values & battery status
  If iDeviceId Then
    ' rain rate mm/hr, total rain mm
    Devices.ValueUpdate(iDeviceId, Format(CStr(sRainRate), "#0.00"), Format(CStr(sRainTotal), "#0.00"), "", "")
    Devices.Battery(iDeviceId, sBatt)
  Endif

End

' ENUM Temp AS Integer
'     packetlength = 0
'     packettype = 1
'     subtype = 2
'     seqnbr = 3
'     id1 = 4
'     id2 = 5
'     temperatureh = 6    'bits 6-0
'     tempsign = 6        'bit 7
'     temperaturel = 7
'     battery_level = 8   'bits 3-0
'     rssi = 8            'bits 7-4
'     size = 8
' END ENUM

Public Sub Decode_Temp()

  Dim sAddress, sType, sTemp, sBatt As String
  Dim iDeviceId As Integer

  Select Case RecBuf[2]
    Case sTypeTEMP1
      sType = "temp1"
      WriteMessage("Subtype       = TEMP1 - THR128/138, THC138")
    Case sTypeTEMP2
      sType = "temp2"
      WriteMessage("Subtype       = TEMP2 - THC238/268,THN132,THWR288,THRN122,THN122,AW129/131")
    Case sTypeTEMP3
      sType = "temp3"
      WriteMessage("Subtype       = TEMP3 - THWR800")
    Case sTypeTEMP4
      sType = "temp4"
      WriteMessage("Subtype       = TEMP4 - RTHN318")
    Case sTypeTEMP5
      sType = "temp5"
      WriteMessage("Subtype       = TEMP5 - LaCrosse TX3, TX4, TX17")
    Case Else
      WriteMessage("ERROR: Unknown Sub type for Packet type=" & Hex(RecBuf[1]) & ":" & Hex(RecBuf[2]))
      Return
  End Select
  sAddress = ConvertAddress(sType & " " & (RecBuf[4] * 256 + RecBuf[5]))
  WriteMessage("Sequence no.  = " & CStr(RecBuf[3]))
  WriteMessage("ID            = " & sAddress)
  If (RecBuf[6] And &H80) = 0 Then
    sTemp = CStr((RecBuf[6] * 256 + RecBuf[7]) / 10)
  Else
    sTemp = "-" & CStr(((RecBuf[6] And &H7F) * 256 + RecBuf[7]) / 10)
  Endif
  WriteMessage("Temperature   = " & sTemp & " °C")
  WriteMessage("Signal level  = " & CStr(Lsr(RecBuf[8], 4)))
  If (RecBuf[8] And &HF) = 0 Then
    sBatt = "Low"
  Else
    sBatt = "OK"
  Endif
  WriteMessage("Battery       = OK")
  iDeviceId = Devices.Find(sAddress, Devices.FindInterface("RFXCom Tranceiver"), UCase(sType))
  ' update value & battery status
  If iDeviceId Then
    If Main.sTemperature = "°C" Then
      ' temp °C
      Devices.ValueUpdate(iDeviceId, Format(CStr(sTemp), "#0.#"), "", "", "")
    Else
      ' temp °F
      Devices.ValueUpdate(iDeviceId, Format(CStr(sTemp * 1.8 + 32), "##.##"), "", "", "")
    Endif
    Devices.Battery(iDeviceId, sBatt)
  Endif

End

' ENUM TEMP_HUM AS Integer
'      packetlength = 0
'      packettype = 1
'      subtype = 2
'      seqnbr = 3
'      id1 = 4
'      id2 = 5
'      humidity = 6
'      humidity_status = 7
'      battery_level = 8  'bits 3-0
'      rssi = 8           'bits 7-4
'      size = 8
'  END ENUM

Public Sub Decode_Hum()

  Dim sAddress, sType, sBatt, sHumid, sComfort As String
  Dim iDeviceId As Integer

  Select Case RecBuf[2]
    Case sTypeHUM1
      sType = "hum1"
      WriteMessage("Subtype       = HUM1 - LaCrosse TX3")
    Case Else
      WriteMessage("ERROR: Unknown Sub type for Packet type=" & Hex(RecBuf[1]) & ":" & Hex(RecBuf[2]))
      Return
  End Select
  WriteMessage("Sequence no.  = " & CStr(RecBuf[3]))
  sAddress = ConvertAddress(sType & " " & (RecBuf[4] * 256 + RecBuf[5]))
  WriteMessage("ID            = " & sAddress)
  sHumid = RecBuf[6]
  WriteMessage("Humidity      = " & sHumid & " %")
  Select Case RecBuf[7]
    Case &H0
      sComfort = "Dry"
    Case &H1
      sComfort = "Comfort"
    Case &H2
      sComfort = "Normal"
    Case &H3
      sComfort = "Wet"
  End Select
  WriteMessage("Status        = " & sComfort)
  WriteMessage("Signal level  = " & CStr(Lsr(RecBuf[8], 4)))
  If (RecBuf[8] And &HF) = 0 Then
    sBatt = "Low"
  Else
    sBatt = "OK"
  Endif
  WriteMessage("Battery       = " & sBatt)
  iDeviceId = Devices.Find(sAddress, Devices.FindInterface("RFXCom Tranceiver"), UCase(sType))
  ' update value & battery status
  If iDeviceId Then
    ' humid %
    Devices.ValueUpdate(iDeviceId, sHumid, sComfort, "", "")
    Devices.Battery(iDeviceId, sBatt)
  Endif

End

' ENUM TEMP_HUM AS Integer
'     packetlength = 0
'     packettype = 1
'     subtype = 2
'     seqnbr = 3
'     id1 = 4
'     id2 = 5
'     temperatureh = 6    'bits 6-0
'     tempsign = 6        'bit 7
'     temperaturel = 7
'     humidity = 8
'     humidity_status = 9
'     battery_level = 10  'bits 3-0
'     rssi = 10           'bits 7-4
'     size = 10
' END ENUM

Private Sub Decode_TempHum()

  Dim sAddress, sType, sBatt, sTemp, sHumid, sComfort As String
  Dim iDeviceId As Integer

  Select Case RecBuf[2]
    Case sTypeTH1
      WriteMessage("Subtype       = TH1 - THGN122/123/132,THGR122/228/238/268")
      sType = "th1"
    Case sTypeTH2
      WriteMessage("Subtype       = TH2 - THGR810")
      sType = "th2"
    Case sTypeTH3
      WriteMessage("Subtype       = TH3 - RTGR328")
      sType = "th3"
    Case sTypeTH4
      WriteMessage("Subtype       = TH4 - THGR328")
      sType = "th4"
    Case sTypeTH5
      WriteMessage("Subtype       = TH5 - WTGR800")
      sType = "th5"
    Case sTypeTH6
      WriteMessage("Subtype       = TH6 - THGR918,THGRN228,THGN500")
      sType = "th6"
    Case sTypeTH7
      WriteMessage("Subtype       = TH7 - TFA TS34C")
      sType = "th7"
    Case sTypeTH8
      WriteMessage("Subtype       = TH8 - ESIC WT440H/450H")
      sType = "th8"
    Case Else
      WriteMessage("ERROR: Unknown Sub type for Packet type=" & Hex(RecBuf[1]) & ":" & Hex(RecBuf[2]))
      Return
  End Select
  WriteMessage("Sequence no.  = " & RecBuf[3])
  sAddress = ConvertAddress(sType & " " & (RecBuf[4] * 256 + RecBuf[5]))
  WriteMessage("ID            = " & sAddress)
  If (RecBuf[6] And &H80) = 0 Then
    sTemp = CStr((RecBuf[6] * 256 + RecBuf[7]) / 10)
  Else
    sTemp = "-" & CStr(((RecBuf[6] And &H7F) * 256 + RecBuf[7]) / 10)
  Endif
  WriteMessage("Temperature   = " & sTemp & " °C")
  sHumid = RecBuf[8]
  WriteMessage("Humidity      = " & sHumid & " %")
  Select Case RecBuf[9]
    Case &H0
      sComfort = "Dry"
    Case &H1
      sComfort = "Comfort"
    Case &H2
      sComfort = "Normal"
    Case &H3
      sComfort = "Wet"
  End Select
  WriteMessage("Status        = " & sComfort)
  WriteMessage("Signal level  = " & Lsr(RecBuf[10], 4))
  If RecBuf[2] = sTypeTH6 Then
    sBatt = (RecBuf[10] * 10) + 10
  Else
    If (RecBuf[10] And &HF) = 0 Then
      sBatt = "Low"
    Else
      sBatt = "OK"
    Endif
  Endif
  WriteMessage("Battery       = " & sBatt)
  iDeviceId = Devices.Find(sAddress, Devices.FindInterface("RFXCom Tranceiver"), UCase(sType))
  ' update value & battery status
  If iDeviceId Then
    If Main.sTemperature = "°C" Then
      ' temp °C
      Devices.ValueUpdate(iDeviceId, Format(CStr(sTemp), "#0.#"), sHumid, sComfort, "")
    Else
      ' temp °F
      Devices.ValueUpdate(iDeviceId, Format(CStr(sTemp * 1.8 + 32), "##.##"), sHumid, sComfort, "")
    Endif
    Devices.Battery(iDeviceId, sBatt)
  Endif

End

' ENUM TEMP_HUM_BARO AS Integer
'     packetlength = 0
'     packettype = 1
'     subtype = 2
'     seqnbr = 3
'     id1 = 4
'     id2 = 5
'     temperatureh = 6    'bits 6-0
'     tempsign = 6        'bit 7
'     temperaturel = 7
'     humidity = 8
'     humidity_status = 9
'     baroh = 10
'     barol = 11
'     forecast = 12
'     battery_level = 13  'bits 3-0
'     rssi = 13           'bits 7-4
'     size = 13
' END ENUM

Public Sub Decode_TempHumBaro()

  Dim sAddress, sType, sBatt, sTemp, sHumid, sComfort, sBaro, sForecast As String
  Dim iDeviceId As Integer

  Select Case RecBuf[2]
    Case sTypeTH1
      sType = "thb1"
      WriteMessage("Subtype       = THB1 - BTHR918")
    Case sTypeTH2
      sType = "thb2"
      WriteMessage("Subtype       = THB2 - BTHR918N, BTHR968")
    Case Else
      WriteMessage("ERROR: Unknown Sub type for Packet type=" & Hex(RecBuf[1]) & ":" & Hex(RecBuf[2]))
      Return
  End Select
  WriteMessage("Sequence no.  = " & CStr(RecBuf[3]))
  sAddress = ConvertAddress(sType & " " & (RecBuf[4] * 256 + RecBuf[5]))
  WriteMessage("ID            = " & sAddress)
  If (RecBuf[6] And &H80) = 0 Then
    sTemp = CStr((RecBuf[6] * 256 + RecBuf[7]) / 10)
    WriteMessage("Temperature   = " & sTemp & " °C")
  Else
    sTemp = "-" & CStr((RecBuf[6] * 256 + RecBuf[7]) / 10)
    WriteMessage("Temperature   = " & sTemp & " °C")
  Endif
  sHumid = CStr(RecBuf[8])
  WriteMessage("Humidity      = " & sHumid & " %")
  Select Case RecBuf[9]
    Case &H0
      sComfort = "Status        = Dry"
    Case &H1
      sComfort = "Status        = Comfort"
    Case &H2
      sComfort = "Status        = Normal"
    Case &H3
      sComfort = "Status        = Wet"
  End Select

  sBaro = CStr(RecBuf[10] * 256 + RecBuf[11])
  WriteMessage("Barometer     = " & sBaro)
  Select Case RecBuf[12]
    Case &H0
      sForecast = "No Info Avail"
    Case &H1
      sForecast = "Sunny"
    Case &H2
      sForecast = "Partly Cloudy"
    Case &H3
      sForecast = "Cloudy"
    Case &H4
      sForecast = "Rain"
  End Select
  WriteMessage("Forecast      = " & sForecast)
  WriteMessage("Signal level  = " & CStr(Lsr(RecBuf[13], 4)))
  If (RecBuf[13] And &HF) = 0 Then
    sBatt = "Low"
  Else
    sBatt = "OK"
  Endif
  WriteMessage("Battery       = " & sBatt)
  iDeviceId = Devices.Find(sAddress, Devices.FindInterface("RFXCom Tranceiver"), UCase(sType))
  ' update values & battery status
  If iDeviceId Then
    If Main.sTemperature = "°C" Then
      ' temp °C, hum %, baro hPa, forecast
      Devices.ValueUpdate(iDeviceId, Format(CStr(sTemp), "#0.#"), sHumid, sBaro, sForecast)
    Else
      ' temp °F, hum %, baro hPa, forecast
      Devices.ValueUpdate(iDeviceId, Format(CStr(sTemp * 1.8 + 32), "#0.#"), sHumid, sBaro, sForecast)
    Endif
    Devices.Battery(iDeviceId, sBatt)
  Endif

End

' ENUM UV AS Integer
'     packetlength = 0
'     packettype = 1
'     subtype = 2
'     seqnbr = 3
'     id1 = 4
'     id2 = 5
'     uv = 6
'     temperatureh = 7    'bits 6-0
'     tempsign = 7        'bit 7
'     temperaturel = 8
'     battery_level = 9   'bits 3-0
'     rssi = 9            'bits 7-4
'     size = 9
' END ENUM

Public Sub Decode_Uv()

  Dim sAddress, sType, sBatt, sLevel, sStatus, sTemp, sTypeTemp As String
  Dim iDeviceId As Integer

  Select Case RecBuf[2]
    Case sTypeUV1
      sType = "uv1"
      WriteMessage("Subtype       = UV1 - UVN128, UV138")
    Case sTypeUV2
      sType = "uv2"
      WriteMessage("Subtype       = UV2 - UVN800")
    Case sTypeUV3
      sType = "uv3"
      WriteMessage("Subtype       = UV3 - TFA")
    Case Else
      WriteMessage("ERROR: Unknown Sub type for Packet type=" & Hex(RecBuf[1]) & ":" & Hex(RecBuf[2]))
      Return
  End Select
  sAddress = ConvertAddress(sType & " " & (RecBuf[4] * 256 + RecBuf[5]))
  WriteMessage("Sequence no.  = " & CStr(RecBuf[3]))
  WriteMessage("ID            = " & sAddress)

  If RecBuf[2] = sTypeUV3 Then
    sTypeTemp = "uv3-temp"
    If (RecBuf[7] And &H80) = 0 Then
      sTemp = Round((RecBuf[7] * 256 + RecBuf[8]) / 10)
    Else
      sTemp = "-" & Round(((RecBuf[7] And &H7F) * 256 + RecBuf[8]) / 10)
    Endif
    WriteMessage("Temperature   = " & sTemp & " °C")
  Endif

  sLevel = CStr(RecBuf[6])
  WriteMessage("Level         = " & sLevel)
  If RecBuf[6] < 3 Then
    sStatus = "Low"
  Else If RecBuf[6] < 6
    sStatus = "Medium"
  Else If RecBuf[6] < 8
    sStatus = "High"
  Else If RecBuf[6] < 11
    sStatus = "Very High"
  Else
    sStatus = "Dangerous"
  Endif
  WriteMessage("Status        = " & sStatus)
  WriteMessage("Signal level  = " & CStr(Lsr(RecBuf[9], 4)))
  If (RecBuf[9] And &HF) = 0 Then
    sBatt = "Low"
  Else
    sbatt = "OK"
  Endif
  WriteMessage("Battery       = " & sBatt)
  iDeviceId = Devices.Find(sAddress, Devices.FindInterface("RFXCom Tranceiver"), UCase(sType))
  ' update values & battery status
  If iDeviceId Then
    ' uv level, status and temp if TFA
    Devices.ValueUpdate(iDeviceId, sLevel, sStatus, sTemp, "")
    Devices.Battery(iDeviceId, sBatt)
  Endif

  ' find second device for TFA temp
  iDeviceId = Devices.Find(sAddress, Devices.FindInterface("RFXCom Tranceiver"), UCase(sTypeTemp))
  ' update values & battery status
  If iDeviceId Then
    ' temp
    Devices.ValueUpdate(iDeviceId, sTemp, "", "", "")
    Devices.Battery(iDeviceId, sBatt)
  Endif

End

Public Sub Decode_Baro()

  WriteMessage("Not implemented")

End

Private Sub WriteMessage(sText As String, Optional bNoReturn As Boolean)

  If bRFXComTRXDebug Then
    If bNoReturn Then
      Main.WriteRFXDebugLog(sText, True)
    Else
      Main.WriteDebugLog("[RFXComTRX] " & sText)
    Endif
  Endif

End

' ENUM WIND AS Integer
'     packetlength = 0
'     packettype = 1
'     subtype = 2
'     seqnbr = 3
'     id1 = 4
'     id2 = 5
'     directionh = 6
'     directionl = 7
'     av_speedh = 8
'     av_speedl = 9
'     gusth = 10
'     gustl = 11
'     temperatureh = 12   'bits 6-0
'     tempsign = 12       'bit 7
'     temperaturel = 13
'     chillh = 14         'bits 6-0
'     chillsign = 14      'bit 7
'     chilll = 15
'     battery_level = 16  'bits 3-0
'     rssi = 16           'bits 7-4
'     size = 16
' END ENUM

Public Sub Decode_Wind()

  Dim sAddress, sType, sBatt, sDirection, sDirectionDescr, sAvgSpeed, sWindGust, sTemp, sChill, sTypeTemp As String
  Dim iDeviceId As Integer

  Select Case RecBuf[2]
    Case sTypeWIND1
      sType = "wind1"
      WriteMessage("Subtype       = WIND1 - WTGR800")
    Case sTypeWIND2
      sType = "wind2"
      WriteMessage("Subtype       = WIND2 - WGR800")
    Case sTypeWIND3
      sType = "wind3"
      WriteMessage("Subtype       = WIND3 - STR918, WGR918")
    Case sTypeWIND4
      sType = "wind4"
      WriteMessage("Subtype       = WIND4 - TFA")
    Case Else
      WriteMessage("ERROR: Unknown Sub type for Packet type=" & Hex(RecBuf[1]) & ":" & Hex(RecBuf[2]))
      Return
  End Select
  WriteMessage("Sequence no.  = " & CStr(RecBuf[3]))
  sAddress = ConvertAddress(sType & " " & (RecBuf[4] * 256 + RecBuf[5]))
  WriteMessage("ID            = " & sAddress)
  sDirection = CStr((RecBuf[6] * 256) + RecBuf[7])
  WriteMessage("Direction     = " & sDirection & " degrees")
  sDirectionDescr = WindDirection(sDirection)
  WriteMessage("Direction Desc= " & sDirectionDescr)
  sAvgSpeed = CStr(((RecBuf[8] * 256) + RecBuf[9]) / 10)
  WriteMessage("Average speed = " & sAvgSpeed & " mtr/sec")
  sWindGust = CStr(((RecBuf[10] * 256) + RecBuf[11]) / 10)
  WriteMessage("Wind gust     = " & sWindGust & " mtr/sec")
  WriteMessage("Signal level  = " & CStr(Lsr(RecBuf[16], 4)))

  If RecBuf[2] = sTypeWIND4 Then
    sTypeTemp = "wind4-temp"
    If (RecBuf[12] And &H80) = 0 Then
      sTemp = Round((RecBuf[12] * 256 + RecBuf[13]) / 10)
    Else
      sTemp = "-" & Round(((RecBuf[12] And &H7F) * 256 + RecBuf[13]) / 10)
    Endif
    WriteMessage("Temperature   = " & sTemp & " °C")
    If (RecBuf[14] And &H80) = 0 Then
      sChill = Round((RecBuf[14] * 256 + RecBuf[15]) / 10)
    Else
      sChill = "-" & Round(((RecBuf[14] And &H7F) * 256 + RecBuf[15]) / 10)
    Endif
    WriteMessage("Chill         = " & sChill & " °C")
  Endif
  If RecBuf[2] = sTypeWIND3 Then
    sBatt = (RecBuf[16] * 10) + 10
  Else
    If (RecBuf[16] And &HF) = 0 Then
      sBatt = "Low"
    Else
      sBatt = "OK"
    Endif
  Endif
  WriteMessage("Battery       = " & sBatt)
  ' find device id
  iDeviceId = Devices.Find(sAddress, Devices.FindInterface("RFXCom Tranceiver"), UCase(sType))
  ' update values & battery status
  If iDeviceId Then
    ' direction °, direction text, speed m/s, avg speed m/s
    Devices.ValueUpdate(iDeviceId, sDirection, sDirectionDescr, Format(sWindGust, "#0.##"), Format(sAvgSpeed, "#0.##"))
    Devices.Battery(iDeviceId, sBatt)
  Endif

  ' find second device for TFA temp
  iDeviceId = Devices.Find(sAddress, Devices.FindInterface("RFXCom Tranceiver"), UCase(sTypeTemp))
  ' update values & battery status
  If iDeviceId Then
    ' temp, chill
    Devices.ValueUpdate(iDeviceId, sTemp, sChill, "", "")
    Devices.Battery(iDeviceId, sBatt)
  Endif

End

Private Sub WindDirection(sDirection As String) As String

  Dim sDir As String
  Dim iDirection As Integer

  iDirection = Val(sDirection)
  If iDirection > 348.75 Or iDirection < 11.26 Then
    sDir = "N"
  Else If iDirection < 33.76 Then
    sDir = "NNE"
  Else If iDirection < 56.26 Then
    sDir = "NE"
  Else If iDirection < 78.76 Then
    sDir = "ENE"
  Else If iDirection < 101.26 Then
    sDir = "E"
  Else If iDirection < 123.76 Then
    sDir = "ESE"
  Else If iDirection < 146.26 Then
    sDir = "SE"
  Else If iDirection < 168.76 Then
    sDir = "SSE"
  Else If iDirection < 191.26 Then
    sDir = "S"
  Else If iDirection < 213.76 Then
    sDir = "SSW"
  Else If iDirection < 236.26 Then
    sDir = "SW"
  Else If iDirection < 258.76 Then
    sDir = "WSW"
  Else If iDirection < 281.26 Then
    sDir = "W"
  Else If iDirection < 303.76 Then
    sDir = "WNW"
  Else If iDirection < 326.26 Then
    sDir = "NW"
  Else
    sDir = "NNW"
  End If
  Return sDir

End

' ENUM DT AS Integer
'     packetlength = 0
'     packettype = 1
'     subtype = 2
'     seqnbr = 3
'     id1 = 4
'     id2 = 5
'     yy = 6
'     mm = 7
'     dd = 8
'     dow = 9
'     hr = 10
'     Min = 11
'     sec = 12
'     battery_level = 13  'bits 3-0
'     rssi = 13           'bits 7-4
'     size = 13
' END ENUM

Public Sub Decode_DateTime()

  WriteMessage("Not implemented")

End

' ENUM CURRENT AS Integer
'     packetlength = 0
'     packettype = 1
'     subtype = 2
'     seqnbr = 3
'     id1 = 4
'     id2 = 5
'     count = 6
'     ch1h = 7
'     ch1l = 8
'     ch2h = 9
'     ch2l = 10
'     ch3h = 11
'     ch3l = 12
'     battery_level = 13  'bits 3-0
'     rssi = 13           'bits 7-4
'     size = 13
' END ENUM

Public Sub Decode_Current()

  Dim sAddress, sType, sBatt, sCt1, sCt2, sCt3 As String
  Dim iDeviceId As Integer

  Select Case RecBuf[2]
    Case sTypeELEC1
      sType = "elec1"
      WriteMessage("Subtype       = ELEC1 - OWL CM113, Electrisave, cent-a-meter")
    Case Else
      WriteMessage("ERROR: Unknown Sub type for Packet type=" & Hex(RecBuf[1]) & ":" & Hex(RecBuf[2]))
      Return
  End Select
  WriteMessage("Sequence no.  = " & CStr(RecBuf[3]))
  sAddress = ConvertAddress(sType & " " & (RecBuf[4] * 256 + RecBuf[5]))
  WriteMessage("ID            = " & sAddress)
  WriteMessage("Count         = " & CStr(RecBuf[6]))
  sCt1 = CStr(((RecBuf[7] * 256) + RecBuf[8]) / 10)
  WriteMessage("Channel 1     = " & sCt1 & " ampere")
  sCt2 = CStr(((RecBuf[9] * 256) + RecBuf[10]) / 10)
  WriteMessage("Channel 2     = " & sCt2 & " ampere")
  sCt3 = CStr(((RecBuf[11] * 256) + RecBuf[12]) / 10)
  WriteMessage("Channel 3     = " & sCt3 & " ampere")
  WriteMessage("Signal level  = " & CStr(Lsr(RecBuf[13], 4)))
  If (RecBuf[13] And &HF) = 0 Then
    sBatt = "Low"
  Else
    sBatt = "OK"
  Endif
  WriteMessage("Battery       = " & sBatt)
  iDeviceId = Devices.Find(sAddress, Devices.FindInterface("RFXCom Tranceiver"), UCase(sType))
  ' update values & battery status
  If iDeviceId Then
    ' ct1 amp, ct2 amp, ct3 amp
    Devices.ValueUpdate(iDeviceId, Format(sCt1, "##.###"), Format(sCt2, "##.###"), Format(sCt3, "##.###"), "")
    Devices.Battery(iDeviceId, sBatt)
  Endif

End

' ENUM ENERGY AS Integer
'     packetlength = 0
'     packettype = 1
'     subtype = 2
'     seqnbr = 3
'     id1 = 4
'     id2 = 5
'     count = 6
'     instant1 = 7
'     instant2 = 8
'     instant3 = 9
'     instant4 = 10
'     total1 = 11
'     total2 = 12
'     total3 = 13
'     total4 = 14
'     total5 = 15
'     total6 = 16
'     battery_level = 17  'bits 3-0
'     rssi = 17           'bits 7-4
'     size = 17
' END ENUM

Public Sub Decode_Energy()

  Dim sAddress, sBatt, sType, sInstantUsage, sTotalUsage As String
  Dim iDeviceId As Integer

  Select Case RecBuf[2]
    Case sTypeELEC2
      sType = "elec2"
      WriteMessage("Subtype       = ELEC2 - OWL CM119, CM160")
    Case Else
      WriteMessage("ERROR: Unknown Sub type for Packet type=" & Hex(RecBuf[1]) & ":" & Hex(RecBuf[2]))
      Return
  End Select
  WriteMessage("Sequence no.  = " & CStr(RecBuf[3]))
  sAddress = ConvertAddress(sType & " " & (RecBuf[4] * 256 + RecBuf[5]))
  WriteMessage("ID            = " & sAddress)
  sInstantUsage = CStr(RecBuf[7] * 16777216 + RecBuf[8] * 65536 + RecBuf[9] * 256 + RecBuf[10])
  WriteMessage("Count         = " & CStr(RecBuf[6]))
  WriteMessage("Instant usage = " & sInstantUsage & " Watt")
  sTotalUsage = CStr(RecBuf[11] * 1099511627776 + RecBuf[12] * 4294967296 + RecBuf[13] * 16777216 + RecBuf[14] * 65536 + RecBuf[15] * 256 + RecBuf[16])
  WriteMessage("Total usage   = " & sTotalUsage & " Wh")
  WriteMessage("Signal level  = " & CStr(Lsr(RecBuf[17], 4)))
  If (RecBuf[17] And &HF) = 0 Then
    sBatt = "Low"
  Else
    sBatt = "OK"
  Endif
  WriteMessage("Battery       = " & sBatt)
  ' find device id
  iDeviceId = Devices.Find(sAddress, Devices.FindInterface("RFXCom Tranceiver"), UCase(sType))
  ' update values & battery status
  If iDeviceId Then
    ' power usage total in Wh and now in Watt
    Devices.ValueUpdate(iDeviceId, Format(sTotalUsage, "##.###"), sInstantUsage, "", "")
    Devices.Battery(iDeviceId, sBatt)
  Endif

End

Public Sub Decode_Gas()

  WriteMessage("Not implemented")

End

Public Sub Decode_Water()

  WriteMessage("Not implemented")

End

' ENUM WEIGHT AS Integer
'     packetlength = 0
'     packettype = 1
'     subtype = 2
'     seqnbr = 3
'     id1 = 4
'     id2 = 5
'     weighthigh = 6
'     weightlow = 7
'     filler = 8   'bits 3-0
'     rssi = 8            'bits 7-4
'     size = 8
' END ENUM

Public Sub Decode_Weight()

  Dim sAddress, sBatt, sType, sWeight As String
  Dim iDeviceId As Integer

  Select Case RecBuf[2]
    Case sTypeWEIGHT1
      sType = "weight1"
      WriteMessage("Subtype       = BWR102")
    Case sTypeWEIGHT2
      sType = "weight2"
      WriteMessage("Subtype       = GR101")
    Case Else
      WriteMessage("ERROR: Unknown Sub type for Packet type=" & Hex(RecBuf[1]) & ":" & Hex(RecBuf[2]))
      Return
  End Select
  WriteMessage("Sequence no.  = " & CStr(RecBuf[3]))
  sAddress = ConvertAddress(sType & " " & (RecBuf[4] * 256 + RecBuf[5]))
  WriteMessage("ID            = " & sAddress)
  sWeight = CStr((RecBuf[6] * 25.6) + RecBuf[7] / 10)
  WriteMessage("Weight        = " & sWeight & " kg")
  WriteMessage("Signal level  = " & CStr(Lsr(RecBuf[8], 4)))
  iDeviceId = Devices.Find(sAddress, Devices.FindInterface("RFXCom Tranceiver"), UCase(sType))
  ' update value in kg
  If iDeviceId Then Devices.ValueUpdate(iDeviceId, Format(sWeight, "##.###"), "", "", "")

End

' ENUM RFXSENSOR AS Integer
'     packetlength = 0
'     packettype = 1
'     subtype = 2
'     seqnbr = 3
'     id = 4
'     msg1 = 5
'     msg2 = 6
'     filler = 7  'bits 3-0
'     rssi = 7    'bits 7-4
'     size = 7
' END ENUM

Public Sub Decode_RFXSensor()

  Dim sAddress, sBatt, sType, sSubType, sValue As String
  Dim iDeviceId As Integer

  Select Case RecBuf[2]
    Case sTypeRFXSensorTemp
      sType = "rfxsensor"
      sSubType = "temp"
      WriteMessage("Subtype       = Temperature")
      WriteMessage("Sequence no.  = " & CStr(RecBuf[3]))
      sAddress = ConvertAddress(sType & " " & (RecBuf[4] * 256 + RecBuf[5]))
      WriteMessage("ID            = " & sAddress)
      sValue = CStr((RecBuf[5] * 256 + RecBuf[6]) / 100)
      WriteMessage("Msg           = " & sValue & " °C")
    Case sTypeRFXSensorAD
      sType = "rfxsensor"
      sSubType = "ad"
      WriteMessage("Subtype       = A/D")
      WriteMessage("Sequence no.  = " & CStr(RecBuf[3]))
      sAddress = ConvertAddress(sType & " " & (RecBuf[4] * 256 + RecBuf[5]))
      WriteMessage("ID            = " & sAddress)
      sValue = CStr(RecBuf[5] * 256 + RecBuf[6])
      WriteMessage("Msg           = " & sValue & " mV")
    Case sTypeRFXSensorVolt
      sType = "rfxsensor"
      sSubType = "volt"
      WriteMessage("Subtype       = Voltage")
      WriteMessage("Sequence no.  = " & CStr(RecBuf[3]))
      sAddress = ConvertAddress(sType & " " & (RecBuf[4] * 256 + RecBuf[5]))
      WriteMessage("ID            = " & sAddress)
      sValue = CStr(RecBuf[5] * 256 + RecBuf[6])
      WriteMessage("Msg           = " & sValue & " mV")
    Case sTypeRFXSensorMessage
      WriteMessage("Subtype       = Message")
      WriteMessage("Sequence no.  = " & CStr(RecBuf[3]))
      WriteMessage("ID            = " & CStr(RecBuf[4]))
      Select Case RecBuf[6]
        Case &H1
          WriteMessage("Msg           = sensor addresses incremented")
        Case &H2
          WriteMessage("Msg           = battery low detected")
        Case &H81
          WriteMessage("Msg           = no 1-wire device connected")
        Case &H82
          WriteMessage("Msg           = 1-Wire ROM CRC error")
        Case &H83
          WriteMessage("Msg           = 1-Wire device connected is not a DS18B20 or DS2438")
        Case &H84
          WriteMessage("Msg           = no end of read signal received from 1-Wire device")
        Case &H85
          WriteMessage("Msg           = 1-Wire scratchpad CRC error")
        Case Else
          WriteMessage("ERROR: Unknown message")
          Return
      End Select
      WriteMessage("Msg           = " & CStr(RecBuf[5] * 256 + RecBuf[6]))
    Case Else
      WriteMessage("ERROR: Unknown Sub type for Packet type=" & Hex(RecBuf[1]) & ":" & Hex(RecBuf[2]))
      Return
  End Select
  WriteMessage("Signal level  = " & CStr(Lsr(RecBuf[7], 4)))

  Select Case sSubType
    Case "ad", "volt"
      iDeviceId = Devices.Find(sAddress, Devices.FindInterface("RFXCom Tranceiver"), UCase(sType) & " " & UCase(sSubType))
      ' update value in mV
      If iDeviceId Then Devices.ValueUpdate(iDeviceId, CStr(sValue), "", "", "")
    Case "temp"
      iDeviceId = Devices.Find(sAddress, Devices.FindInterface("RFXCom Tranceiver"), UCase(sType) & " " & UCase(sSubType))
      ' update value
      If iDeviceId Then
        If Main.sTemperature = "°C" Then
          ' temp °C
          Devices.ValueUpdate(iDeviceId, CStr(sValue), "", "", "")
        Else
          ' temp °F
          Devices.ValueUpdate(iDeviceId, CStr((sValue) * 1.8 + 32), "", "", "")
        Endif
      Endif
  End Select

End

' ENUM RFXMETER AS Integer
'     packetlength = 0
'     packettype = 1
'     subtype = 2
'     seqnbr = 3
'     id1 = 4
'     id2 = 5
'     count1 = 6
'     count2 = 7
'     count3 = 8
'     count4 = 9
'     filler = 10 'bits 3-0
'     rssi = 10   'bits 7-4
'     size = 10
' END ENUM

Private Sub Decode_RFXMeter()

  Dim lCounter As Long
  Dim sAddress, sType As String
  Dim iDeviceId As Integer

  Select Case RecBuf[2]
    Case sTypeRFXMeterCount
      sType = "rfxmeter"
      sAddress = ConvertAddress(sType & " " & (RecBuf[4] * 256 + RecBuf[5]))
      WriteMessage("Subtype       = RFXMeter counter")
      WriteMessage("Sequence no.  = " & RecBuf[3])
      WriteMessage("ID            = " & sAddress)
      ' [GB2:CLNG] lCounter = Lsl(CLng(RecBuf[6]), 24) + Lsl(CLng(RecBuf[7]), 16) + Lsl(CLng(RecBuf[8]), 8) + RecBuf[9]
      lCounter = Lsl(CLong(RecBuf[6]), 24) + Lsl(CLong(RecBuf[7]), 16) + Lsl(CLong(RecBuf[8]), 8) + RecBuf[9]
      WriteMessage("Counter       = " & lCounter)
      WriteMessage("if RFXPwr     = " & CStr((lCounter / 1000)) & " kWh")
      sAddress = ConvertAddress(sType & " 0x" & (RecBuf[4] * 256 + RecBuf[5]))
      iDeviceId = Devices.Find(sAddress, Devices.FindInterface("RFXCom Tranceiver"), UCase(sType))
      If iDeviceId Then Devices.ValueUpdate(iDeviceId, CStr(lCounter), "", "", "")
    Case sTypeRFXMeterInterval
      sType = "rfxmeter"
      sAddress = ConvertAddress(sType & " 0x" & (RecBuf[4] * 256 + RecBuf[5]))
      WriteMessage("Subtype       = RFXMeter new interval time set")
      WriteMessage("Sequence no.  = " & RecBuf[3])
      WriteMessage("ID            = " & sAddress)
      WriteMessage("Interval time = ", False)
      Select Case RecBuf[8]
        Case &H1
          WriteMessage("30 seconds")
        Case &H2
          WriteMessage("1 minute")
        Case &H4
          WriteMessage("6 minutes")
        Case &H8
          WriteMessage("12 minutes")
        Case &H10
          WriteMessage("15 minutes")
        Case &H20
          WriteMessage("30 minutes")
        Case &H40
          WriteMessage("45 minutes")
        Case &H80
          WriteMessage("1 hour")
      End Select
    Case sTypeRFXMeterCalib
      sType = "rfxmeter"
      sAddress = ConvertAddress(sType & " 0x" & (RecBuf[4] * 256 + RecBuf[5]))
      Select Case (RecBuf[7] And &HC0)
        Case &H0
          WriteMessage("Subtype       = Calibrate mode for channel 1")
        Case &H40
          WriteMessage("Subtype       = Calibrate mode for channel 2")
        Case &H80
          WriteMessage("Subtype       = Calibrate mode for channel 3")
      End Select
      WriteMessage("ID            = " & sAddress)
      ' [GB2:CLNG] lCounter = Lsl(CLng(RecBuf[6]), 24) + Lsl(CLng(RecBuf[7]), 16) + Lsl(CLng(RecBuf[8]), 8) + RecBuf[9]
      lCounter = Lsl(CLong(RecBuf[6]), 24) + Lsl(CLong(RecBuf[7]), 16) + Lsl(CLong(RecBuf[8]), 8) + RecBuf[9]
      ' [GB2:CLNG] lCounter = (Lsl(CLng(RecBuf[7] AND &H3F), 16) + Lsl(CLng(RecBuf[8]), 8) + RecBuf[9]) / 1000
      lCounter = (Lsl(CLong(RecBuf[7] And &H3F), 16) + Lsl(CLong(RecBuf[8]), 8) + RecBuf[9]) / 1000
      WriteMessage("Calibrate cnt = " & lCounter & " msec")
      WriteMessage("RFXPwr        = " & CStr(Round(1 / ((16 * lCounter) / (3600000 / 62.5)), 3)) & " kW", False)
    Case sTypeRFXMeterAddr
      sAddress = ConvertAddress(sType & " 0x" & (RecBuf[4] * 256 + RecBuf[5]))
      WriteMessage("Subtype       = New address set, push button for next address")
      WriteMessage("Sequence no.  = " & CStr(RecBuf[3]))
      WriteMessage("ID            = " & sAddress)
    Case sTypeRFXMeterCounterReset
      sAddress = ConvertAddress(sType & " 0x" & (RecBuf[4] * 256 + RecBuf[5]))
      Select Case (RecBuf[7] And &HC0)
        Case &H0
          WriteMessage("Subtype       = Push the button for next mode within 5 seconds or else RESET COUNTER channel 1 will be executed")
        Case &H40
          WriteMessage("Subtype       = Push the button for next mode within 5 seconds or else RESET COUNTER channel 2 will be executed")
        Case &H80
          WriteMessage("Subtype       = Push the button for next mode within 5 seconds or else RESET COUNTER channel 3 will be executed")
      End Select
      WriteMessage("Sequence no.  = " & CStr(RecBuf[3]))
      WriteMessage("ID            = " & sAddress)
    Case sTypeRFXMeterCounterSet
      sAddress = ConvertAddress(sType & " 0x" & (RecBuf[4] * 256 + RecBuf[5]))
      Select Case (RecBuf[7] And &HC0)
        Case &H0
          WriteMessage("Subtype       = Counter channel 1 is reset to zero")
        Case &H40
          WriteMessage("Subtype       = Counter channel 2 is reset to zero")
        Case &H80
          WriteMessage("Subtype       = Counter channel 3 is reset to zero")
      End Select
      WriteMessage("Sequence no.  = " & CStr(RecBuf[3]))
      WriteMessage("ID            = " & sAddress)
      ' [GB2:CLNG] WriteMessage("Counter       = " & Lsl(CLng(RecBuf[6]), 24) + Lsl(CLng(RecBuf[7]), 16) + Lsl(CLng(RecBuf[8]), 8) + RecBuf[9])
      WriteMessage("Counter       = " & Lsl(CLong(RecBuf[6]), 24) + Lsl(CLong(RecBuf[7]), 16) + Lsl(CLong(RecBuf[8]), 8) + RecBuf[9])
    Case sTypeRFXMeterSetInterval
      sAddress = ConvertAddress(sType & " 0x" & (RecBuf[4] * 256 + RecBuf[5]))
      WriteMessage("Subtype       = Push the button for next mode within 5 seconds or else SET INTERVAL MODE will be entered")
      WriteMessage("Sequence no.  = " & CStr(RecBuf[3]))
      WriteMessage("ID            = " & sAddress)
    Case sTypeRFXMeterSetCalib
      sAddress = ConvertAddress(sType & " 0x" & (RecBuf[4] * 256 + RecBuf[5]))
      Select Case (RecBuf[7] And &HC0)
        Case &H0
          WriteMessage("Subtype       = Push the button for next mode within 5 seconds or else CALIBRATION mode for channel 1 will be executed")
        Case &H40
          WriteMessage("Subtype       = Push the button for next mode within 5 seconds or else CALIBRATION mode for channel 2 will be executed")
        Case &H80
          WriteMessage("Subtype       = Push the button for next mode within 5 seconds or else CALIBRATION mode for channel 3 will be executed")
    End Select
      WriteMessage("Sequence no.  = " & CStr(RecBuf[3]))
      WriteMessage("ID            = " & sAddress)
    Case sTypeRFXMeterSetAddr
      sAddress = ConvertAddress(sType & " 0x" & (RecBuf[4] * 256 + RecBuf[5]))
      WriteMessage("Subtype       = Push the button for next mode within 5 seconds or else SET ADDRESS MODE will be entered")
      WriteMessage("Sequence no.  = " & CStr(RecBuf[3]))
      WriteMessage("ID            = " & sAddress)
    Case sTypeRFXMeterIdent
      sAddress = ConvertAddress(sType & " 0x" & (RecBuf[4] * 256 + RecBuf[5]))
      WriteMessage("Subtype       = RFXMeter identification")
      WriteMessage("Sequence no.  = " & CStr(RecBuf[3]))
      WriteMessage("ID            = " & sAddress)
      WriteMessage("FW version    = " & Hex(RecBuf[8]))
      WriteMessage("Interval time = ", False)
      Select Case RecBuf[9]
        Case &H1
          WriteMessage("30 seconds")
        Case &H2
          WriteMessage("1 minute")
        Case &H4
          WriteMessage("6 minutes")
        Case &H8
          WriteMessage("12 minutes")
        Case &H10
          WriteMessage("15 minutes")
        Case &H20
          WriteMessage("30 minutes")
        Case &H40
          WriteMessage("45 minutes")
        Case &H80
          WriteMessage("1 hour")
      End Select
    Case Else
      WriteMessage("ERROR: Unknown Sub type for Packet type=" & Hex(RecBuf[1]) & ":" & Hex(RecBuf[2]))
      Return
  End Select
  WriteMessage("Signal level  = " & Lsr(RecBuf[10], 4))

End

' ENUM LIGHTING1 AS Integer
'     packetlength = 0
'     packettype = 1
'     subtype = 2
'     seqnbr = 3
'     housecode = 4
'     unitcode = 5
'     cmnd = 6
'     filler = 7 'bits 3-0
'     rssi = 7   'bits 7-4
'     size = 7
' END ENUM

' Lighting1
Public Sub Lighting1(sType As String, sAddress As String, sCommand As String, Optional bGroup As Boolean)

  ' [GB2:ARRD] DIM bBuf AS Byte[8]
  Dim bBuf As New Byte[8]
  Dim sCmd As String = UCase(sCommand)

  ' "X10", "ARC", "AB400", "Waveman", "EMW200", "Impuls"
  Select Case UCase(sType)
    Case "X10"
      bBuf[2] = 0
    Case "ARC"
      bBuf[2] = 1
    Case "AB400"
      bBuf[2] = 2
    Case "WAVEMAN"
      bBuf[2] = 3
    Case "EMW200"
      bBuf[2] = 4
    Case "IMPULS"
      bBuf[2] = 5
    Case Else
      WriteMessage("[RFXComTRX] Not a valid Lighting1 type : " & sType)
      Return
  End Select

  If (Len(sAddress) <> 3) Then
    WriteMessage("[RFXComTRX] Not a valid X10 address: " & sAddress)
    Return
  Endif

  Select Case sType
    Case sTypeX10, sTypeARC, sTypeAB400D, sTypeWaveman, sTypeIMPULS
      ' check A-P and 1-16
      If Not (Left$(sAddress, 1) Like "[A-P]") Or If Not (Right$(sAddress, 1) Like "[0-9]")
        WriteMessage("[RFXComTRX] Not a valid X10 address: " & sAddress)
        Return
      Endif
    Case sTypeEMW200
      ' check A-C and 1-4
      If Not (Left$(sAddress, 1) Like "[A-C]") Or If Not (Right$(sAddress, 1) Like "[1-4]")
        WriteMessage("[RFXComTRX] Not a valid EMW200 address: " & sAddress)
        Return
      Endif
  End Select

  bBuf[0] = 7
  bBuf[1] = pTypeLighting1
  bBuf[3] = iSeq
  bBuf[4] = Asc(Left$(sAddress, 1))
  bBuf[5] = Val(Right$(sAddress, 2))

  Select Case sCmd
    Case "OFF"
      bBuf[6] = IIf(bGroup, 5, 0)
    Case "ON"
      bBuf[6] = IIf(bGroup, 6, 1)
    Case "ALL OFF", "GROUP OFF"
      bBuf[6] = 5
    Case "ALL ON", "GROUP ON"
      bBuf[6] = 6
    Case "CHIME"
      bBuf[6] = 7
      bBuf[5] = 8
    Case Else
      Main.WriteDebugLog(("[RFXComTRX] Unknown Lighting1 command '") & UCase(sCmd) & ("' given!"))
      Return
  End Select
  bBuf[7] = 0

  WriteCommand(bBuf)

End

' ENUM LIGHTING2 AS Integer
'     packetlength = 0
'     packettype = 1
'     subtype = 2
'     seqnbr = 3
'     id1 = 4
'     id2 = 5
'     id3 = 6
'     id4 = 7
'     unitcode = 8
'     cmnd = 9
'     level = 10
'     filler = 11 'bits 3-0
'     rssi = 11   'bits 7-4
'     size = 11
' 
'     pType = &H11
'     sTypeAC = &H0
'     sTypeHEU = &H1
'     sTypeANSLUT = &H2
' END ENUM

' Lightning2
Public Sub Lighting2(sType As String, sAddress As String, sCommand As String, Optional bGroup As Boolean)

  ' [GB2:ARRD] DIM bBuf AS Byte[12]
  Dim bBuf As New Byte[12]
  Dim sCmd As String = UCase(sCommand)
  Dim aAddr As String[]
  Dim sUnit As String
  Dim iDim, iBrightness As Integer

  ' "AC", "HEEU", "Anslut"
  Select Case UCase(sType)
    Case "AC"
      bBuf[2] = 0
    Case "HEEU"
      bBuf[2] = 1
    Case "ANSLUT"
      bBuf[2] = 2
    Case Else
      WriteMessage("[RFXComTRX] Not a valid Lighting2 type : " & sType)
      Return
  End Select

  aAddr = Split(sAddress, " ")
  If aAddr.Count = 2 Then
    sAddress = aAddr[0]
    sUnit = aAddr[1]
    If LCase(sUnit) = "group" Then
      bGroup = True
      sUnit = 0
    Endif
  Else
    Main.WriteDebugLog(("[RFXComTRX] Address has wrong format, use '<Device> <Unit>'!"))
    Return
  Endif

  If Len(sAddress) = 9 And If Left(sAddress, 2) = "0x" Then
    sAddress = Right(sAddress, 7)
  Else If Len(sAddress) <> 7 Then
    Main.WriteDebugLog(("[RFXComTRX] Device address length must be 7 characters!"))
    Return
  Endif

  bBuf[0] = 11
  bBuf[1] = pTypeLighting2
  bBuf[3] = iSeq

  bBuf[4] = CByte(Left(sAddress, 1))
  bBuf[5] = CByte(Val("&H" & Mid(sAddress, 2, 2)))
  bBuf[6] = CByte(Val("&H" & Mid(sAddress, 4, 2)))
  bBuf[7] = CByte(Val("&H" & Mid(sAddress, 6, 2)))
  bBuf[8] = CByte(Val(sUnit))

  If InStr(sCmd, "ALL OFF") Or If InStr(sCmd, "GROUP OFF") Then
    bBuf[9] = 3
  Else If InStr(sCmd, "ALL ON") Or If InStr(sCmd, "GROUP ON") Then
    bBuf[9] = 4
  Else If InStr(sCmd, "ON") Or If InStr(sCmd, "DIM 100") Then
    bBuf[9] = IIf(bGroup, 4, 1)
  Else If InStr(sCmd, "OFF") Or If InStr(sCmd, "DIM 0") Then
    bBuf[9] = IIf(bGroup, 3, 0)
  Else If InStr(sCmd, "DIM ") Then ' DIM 1 - 99
    iBrightness = Val(Replace(sCmd, "DIM ", ""))
    If iBrightness > 0 Then
      iDim = Round(0.16 * iBrightness) ' 16 steps
      bBuf[10] = CByte(iDim)
    Endif
    bBuf[9] = IIf(bGroup, 5, 2)
  Else
    Main.WriteDebugLog(("[RFXComTRX] Unknown Lighting2 command '") & sCmd & ("' given!"))
    Return
  Endif
  bBuf[11] = 0
  WriteCommand(bBuf)

End

' ENUM LIGHTING5 AS Byte
' packetlength = 0
' packettype = 1
' subtype = 2
' seqnbr = 3
' id1 = 4
' id2 = 5
' id3 = 6
' unitcode = 7
' cmnd = 8
' filler = 9 'bits 3-0
' rssi = 9   'bits 7-4
' size = 9
'
' pType = &H14
' sTypeLightwaveRF = &H0
'
' sOff = 0
' sOn = 1
' sGroupOff = 2
' sMood1 = 3
' sMood2 = 4
' sMood3 = 5
' sUnlock = 6
' sLock = 7
' sAllLock = 8
' END ENUM

' Lightning5
Public Sub Lighting5(sType As String, sAddress As String, sCommand As String)

  ' [GB2:ARRD] DIM bBuf AS Byte[10]
  Dim bBuf As New Byte[10]
  Dim sCmd As String = UCase(sCommand)
  Dim aAddr As String[]
  Dim sUnit As String

  ' "LIGHTWAVERF"
  Select Case UCase(sType)
    Case "LIGHTWAVERF"
      bBuf[2] = 0
    Case Else
      WriteMessage("[RFXComTRX] Not a valid Lighting5 type : " & sType)
      Return
  End Select

  aAddr = Split(sAddress, " ")
  If aAddr.Count = 2 Then
    sAddress = aAddr[0]
    sUnit = aAddr[1]
  Else
    Main.WriteDebugLog(("[RFXComTRX] Lighting5 address has wrong format, use '<Device> <Unit>'!"))
    Return
  Endif

  If Len(sAddress) = 8 And If Left(sAddress, 2) = "0x" Then sAddress = Right(sAddress, 6)
  If Len(sAddress) <> 6 Then
    Main.WriteDebugLog(("[RFXComTRX] Lighting5 device address length must be 6 characters!"))
    Return
  Endif

  bBuf[0] = 9
  bBuf[1] = pTypeLighting5
  bBuf[3] = iSeq

  bBuf[4] = CByte(Val("&H" & Left(sAddress, 2)))
  bBuf[5] = CByte(Val("&H" & Mid(sAddress, 3, 2)))
  bBuf[6] = CByte(Val("&H" & Mid(sAddress, 5, 2)))
  bBuf[7] = CByte(Val(sUnit))

  Select Case sCmd
    Case "ON"
      bBuf[8] = 1
    Case "OFF"
      bBuf[8] = 0
    Case "ALL OFF", "GROUP OFF"
      bBuf[8] = 2
    Case "MOOD1"
      bBuf[8] = 3
    Case "MOOD2"
      bBuf[8] = 4
    Case "MOOD3"
      bBuf[8] = 5
    Case "UNLOCK"
      bBuf[8] = 6
    Case "LOCK"
      bBuf[8] = 7
    Case "ALL LOCK"
      bBuf[8] = 8
    Case Else
      Main.WriteDebugLog(("[RFXComTRX] Unknown Lighting5 command '") & sCmd & ("' given!"))
      Return
  End Select
  bBuf[9] = 0
  WriteCommand(bBuf)

End

' ENUM CURTAIN1 AS Integer
'   packetlength = 0
'   packettype = 1
'   subtype = 2
'   seqnbr = 3
'   housecode = 4
'   unitcode = 5
'   cmnd = 6
'   filler = 7
'   size = 7
'   pType = &H18
'   Harrison = &H0
' END ENUM

' Curtain1
Public Sub Curtain(sType As String, sAddress As String, sCommand As String)

  ' [GB2:ARRD] DIM bBuf AS Byte[8]
  Dim bBuf As New Byte[8]
  Dim sCmd As String = UCase(sCommand)

  ' "HARRISON"
  Select Case UCase(sType)
    Case "HARRISON"
      If Not (Left$(sAddress, 1) Like "[A-P]") Or If Not (Right$(sAddress, 1) Like "[0-9]")
        WriteMessage("[RFXComTRX] Not a valid Harrison address: " & sAddress)
        Return
      Endif
      bBuf[2] = &H0
    Case Else
      WriteMessage("[RFXComTRX] Not a valid Curtain type : " & sType)
      Return
  End Select

  bBuf[0] = 7
  bBuf[1] = pTypeCurtain
  bBuf[3] = iSeq
  bBuf[4] = Asc(Left$(sAddress, 1))
  bBuf[5] = Val(Right$(sAddress, 2))

  Select Case sCmd
    Case "OPEN"
      bBuf[6] = 0
    Case "CLOSE"
      bBuf[6] = 1
    Case "STOP"
      bBuf[6] = 2
    Case "PROGRAM"
      bBuf[6] = 3
    Case Else
      Main.WriteDebugLog(("[RFXComTRX] Unknown Curtain command '") & UCase(sCmd) & ("' given!"))
      Return
  End Select
  bBuf[7] = 0
  WriteCommand(bBuf)

End

' implement properties
Private Function TCPHost_Read() As String

  Return sTCPHost

End

Private Sub TCPHost_Write(Value As String)

  sTCPHost = Value

End

Private Function TCPPort_Read() As Integer

  Return iTCPPort

End

Private Sub TCPPort_Write(Value As Integer)

  iTCPPort = Value

End

Private Function Interface_Read() As String

  Return sInterface

End

Private Sub Interface_Write(Value As String)

  sInterface = Value

End

Private Function Baud_Read() As String

  Return sBaud

End

Private Sub Baud_Write(Value As String)

  sBaud = Value

End

Private Function SerPort_Read() As String

  Return sSerPort

End

Private Sub SerPort_Write(Value As String)

  sSerPort = Value

End

Private Function RFXComDebug_Read() As Boolean

  Return bRFXComTRXDebug

End

Private Sub RFXComDebug_Write(Value As Boolean)

  bRFXComTRXDebug = Value

End

Private Function RelayPort_Read() As Integer

  Return iRelayPort

End

Private Sub RelayPort_Write(Value As Integer)

  iRelayPort = Value

End

Private Function GlobalX10_Read() As Boolean

  Return bGlobalX10

End

Private Sub GlobalX10_Write(Value As Boolean)

  bGlobalX10 = Value

End

Private Function OldAddrFmt_Read() As Boolean

  Return bOldAddrFmt

End

Private Sub OldAddrFmt_Write(Value As Boolean)

  bOldAddrFmt = Value

End
