' Gambas class file

PRIVATE sCommand AS String
PRIVATE sAddress AS String
PRIVATE iValue AS Integer
PRIVATE sModelindex AS String = "0000"

PUBLIC SUB Form_Open()

  ME.Move(FMain.X + 50, FMain.Y + 70)
  LoadDevices()

END

PUBLIC SUB Run() AS Boolean

  RETURN NOT ME.ShowModal()

END

PUBLIC SUB btnCancel_Click()

  ME.Close

END

PUBLIC SUB cmbCommand_Click()

  sCommand = cmbCommand.Text

END

PUBLIC SUB spbTemp_Change()

  iValue = spbTemp.Value
  LCDNumber1.Value = spbTemp.value / 2

END

PUBLIC SUB btnSend_Click()

  DIM iDeviceId AS Integer

  iDeviceId = Devices.Find(sAddress, Devices.FindInterface("HomeMatic LAN Adapter"), txtModel.Text)
  IF iDeviceId THEN
    IF Main.hHM THEN Main.hHM.Sendcommand(sAddress, sCommand & " " & iValue, iDeviceId)
  ENDIF

END

PUBLIC SUB cmbDevices_Click()

  DIM sdevice AS String
  DIM rResult AS result

  sDevice = cmbDevices.Text
  TRY rResult = Main.hDB.Exec("SELECT address FROM devices WHERE name = &1", sDevice)
  IF NOT ERROR THEN
    sAddress = rResult!address
    LoadCommands(sDevice)
  ENDIF

END

PUBLIC SUB LoadDevices()

  DIM rResultDevices AS Result

  rResultDevices = Main.hDB.Exec("SELECT name FROM devices WHERE interface = 36 ORDER BY name")
  IF NOT ERROR THEN
    IF rResultDevices THEN
      IF rResultDevices.Count THEN
        cmbDevices.Clear
        cmbDevices.Refresh
        cmbDevices.Add("Select Device")
        FOR EACH rResultDevices
          cmbDevices.Add(rResultDevices!name)
        NEXT
      ENDIF
    ELSE
      Message(("No devices database table found!"))
    ENDIF
  ENDIF

END

PUBLIC SUB LoadCommands(sDevice AS String)

  DIM rResultDeviceinfo, rResult AS Result

  rResult = Main.hDB.Exec("SELECT module FROM devices WHERE name = &1", sDevice) ' 234
  rResultDeviceinfo = Main.hDB.Exec("SELECT type, type_code, commands FROM devicetypes_homematic WHERE moduleref = &1", rResult!module)
  cmbCommand.Add("Select Command")
  cmbCommand.list = Split(rResultDeviceinfo!commands)
  sModelindex = rResultDeviceinfo!type_code
  txtModel.text = rResultDeviceinfo!type

CATCH

END