' Gambas class file

' Description:
' FToolsSerialMon.class
' Serial Terminal

' Development Status:
' Works, but needs better error checking.

' DomotiGa - an open source home automation program.
' Copyright(C) 2008 Ron Klinkien

' Read file called COPYING for license details.

PUBLIC SUB Form_Close()

  IF Sport.Status = Net.Active THEN CLOSE Sport

END

PUBLIC SUB Check_Status()

  ChkDSR.Value = Sport.DSR
  ChkDTR.Value = Sport.DTR
  ChkCTS.Value = Sport.CTS
  ChkRTS.Value = Sport.RTS
  ChkDCD.Value = Sport.DCD
  ChkRNG.Value = Sport.RNG

END

PUBLIC SUB btnOpen_Click()

  IF Sport.Status = Net.Active THEN
    CLOSE Sport
    btnOpen.Text = "Open"
    Timer1.Stop
  ELSE
    ' line parameters
    Sport.PortName = TxtPort.Text
    Sport.Speed = CmbSpeed.Text
    Sport.Parity = CmbParity.Index
    Sport.DataBits = CmbData.Text
    Sport.StopBits = CmbStop.Text

    ' keep DTR on
    Sport.FlowControl = ComboBox1.Index
    Sport.Open()
    Check_Status()
    txtData.Text = "Port Opened : " & Sport.PortName & " Settings : " &
    Sport.Speed & "," & Sport.Parity & "," & Sport.DataBits & "," &
    Sport.StopBits & Chr(13) & Chr(10)
    btnOpen.Text = "Close"
    Timer1.Start
  END IF

END

PUBLIC SUB SPort_Read()

  DIM sString AS String

  READ #Sport, sString, Lof(Sport)

  txtData.Text = txtData.Text & sString
  txtData.Pos = Len(txtData.Text)

END

PUBLIC SUB SPort_RNGChange(iVal AS Boolean)

  ChkRng.Value = iVal

END

PUBLIC SUB SPort_DTRChange(iVal AS Boolean)

  ChkDTR.Value = iVal

END

PUBLIC SUB SPort_DSRChange(iVal AS Boolean)

  ChkDSR.Value = iVal

END

PUBLIC SUB SPort_CTSChange(iVal AS Boolean)

  ChkCTS.Value = iVal

END

PUBLIC SUB SPort_DCDChange(iVal AS Boolean)

  ChkDCD.Value = iVal

END

PUBLIC SUB SPort_RTSChange(iVal AS Boolean)

  ChkRTS.Value = iVal

END

PUBLIC SUB btnCR_Click()

  IF Sport.Status = Net.Inactive THEN
    Message("Open port first!")
  ELSE
    PRINT #Sport, txtSend.Text
  END IF

END

PUBLIC SUB ChkDTR_Click()

  Sport.DTR = ChkDTR.Value
  Check_Status

END

PUBLIC SUB ChkRTS_Click()

  Sport.RTS = ChkRTS.Value
  Check_Status

END

PUBLIC SUB ComboBox1_Click()

  Sport.Close()
  Sport.FlowControl = ComboBox1.Index

END

PUBLIC SUB Form_Open()

  ME.Move(FMain.X + 50, FMain.Y + 70)
  cmbSpeed.Index = cmbSpeed.Find("19200")

END

PUBLIC SUB btnClose_Click()

  TRY Timer1.Stop
  ME.Close

END
