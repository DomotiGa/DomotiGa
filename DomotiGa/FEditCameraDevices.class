' Gambas class file

' Description:
' FEditCameraDevices.class
' Support for creating and edit camera devices.

' Development Status:
' Just started.

' DomotiGa - an open source home automation program.
' Copyright(C) 2008-2012 Ron Klinkien

' Read file called COPYING for license details.

PUBLIC rResult AS Result
PUBLIC rResultDevices AS Result
PUBLIC bAddDevice AS Boolean

PUBLIC SUB Form_Open()

 'give focus to field
 txtName.SetFocus
 
  ME.Move(FMain.X + 50, FMain.Y + 70)
  LoadCameraDevice()

END

PUBLIC SUB LoadCameraDevice()

  DIM iId AS Integer

  ' fill camera types
  cmbType.Add("")
  cmbType.Add("Video4Linux")
  cmbType.Add("Fetch Image")
  cmbType.Add("Stream MJPEG")
  ' fill ptz types
  cmbPTZType.Add("")
  cmbPTZType.Add("Sony VISCA")
  cmbPTZType.Add("AXIS API")
  cmbPTZType.Add("Watchbot API")

  TRY iId = FSettingsCameras.tbvCameraDevices[FSettingsCameras.iCurRow, 0].Text
  IF NOT ERROR THEN
    ' get values
    rResult = Main.hDB.Exec("SELECT * FROM devices_camera WHERE id = &1", iId)
    IF rResult.Count >= 1 THEN
      cmbType.Text = rResult!type
      cmbType_Click()
      txtName.Text = rResult!name
      txtDescription.Text = rResult!description
      cmbPTZType.Text = rResult!ptztype
      cmbPTZType_Click()
      txtView.Text = rResult!viewstring
      txtGrab.Text = rResult!grabstring
      chkEnabled.Value = rResult!enabled
      txtPTZBaseUrl.Text = rResult!ptzbaseurl
      spVISCAAddress.Value = rResult!viscaaddress
      txtUser.Text = rResult!username
      txtPasswd.Text = rResult!passwd
      txtOptions.Text = rResult!cmdoptions
    END IF
  ELSE
    bAddDevice = TRUE
  END IF

END

PUBLIC SUB btnCancel_Click()

  ME.Close

END

PUBLIC SUB btnDelete_Click()

  Main.hDB.Exec("DELETE FROM devices_camera WHERE id = &1", rResult!id)
  ME.Close
  FSettingsCameras.FillCameraDevices()

END

PUBLIC SUB btnSave_Click()

  DIM rResultUpdate AS Result
  DIM iId AS Integer
  DIM sSql AS String

  IF NOT ValidInput() THEN RETURN

  IF bAddDevice THEN
    Main.hDB.Begin()
    rResult = Main.hDB.Create("devices_camera")
    rResult!description = txtDescription.Text
    rResult!name = txtName.Text
    rResult!type = cmbType.Text
    rResult!ptztype = cmbPTZType.Text
    rResult!viewstring = txtView.Text
    rResult!grabstring = txtGrab.Text
    rResult!enabled = chkEnabled.Value
    rResult!ptzbaseurl = txtPTZBaseUrl.Text
    rResult!viscaaddress = spVISCAAddress.Value
    rResult!username = txtUser.Text
    rResult!passwd = txtPasswd.Text
    rResult!cmdoptions = txtOptions.Text
    rResult.Update()
    Main.hDB.Commit()
    bAddDevice = FALSE
  ELSE
    ' save new camera device settings
    sSql = "UPDATE devices_camera SET description = &1, name = &2, type = &3,  enabled = &4, ptzbaseurl = &5, ptztype = &6, viewstring = &7, viscaaddress = &8, username = &9, passwd = &10, cmdoptions = &11, grabstring = &12 WHERE id = &13"
    rResultUpdate = Main.hDB.Exec(sSql, txtDescription.Text, txtName.Text, cmbType.Text, chkEnabled.Value, txtPTZBaseUrl.Text, cmbPTZType.Text, txtView.Text, spVISCAAddress.Value, txtUser.Text, txtPasswd.Text, txtOptions.Text, txtGrab.Text, rResult!id)
  END IF
  ME.Close
  FSettingsCameras.FillCameraDevices()

END

PUBLIC SUB txtDescription_KeyPress()

  btnSave.Enabled = TRUE

END

PUBLIC SUB txtName_KeyPress()

  btnSave.Enabled = TRUE

END

PUBLIC SUB txtOptions_KeyPress()

  btnSave.Enabled = TRUE

END

PUBLIC SUB txtUser_KeyPress()

  btnSave.Enabled = TRUE

END

PUBLIC SUB txtPasswd_KeyPress()

  btnSave.Enabled = TRUE

END

PUBLIC SUB cmbPTZType_Click()

  SELECT CASE cmbPTZType.Index
    CASE 0
      spVISCAAddress.Enabled = FALSE
      txtPTZBaseUrl.Enabled = FALSE
    CASE 1
      spVISCAAddress.Enabled = TRUE
      txtPTZBaseUrl.Enabled = FALSE
    CASE 2
      spVISCAAddress.Enabled = FALSE
      txtPTZBaseUrl.Enabled = TRUE
  END SELECT
  btnSave.Enabled = TRUE

END

PRIVATE SUB ValidInput() AS Boolean

  IF NOT txtName.Text THEN
    Balloon(("Please enter a name for this camera!"), txtName)
    RETURN FALSE
  END IF
  IF NOT cmbType.Text THEN
    Balloon(("Please select a camera type!"), cmbType)
    RETURN FALSE
  END IF
  IF cmbType.Index > 1 THEN
    IF NOT txtView.Text THEN
      Balloon(("Please give some input here!"), txtView)
      RETURN FALSE
    END IF
  END IF
  IF cmbType.Index = 1 THEN
    IF NOT txtOptions.Text THEN
      Balloon(("Please give some input here!"), txtOptions)
      RETURN FALSE
    END IF
  END IF
  IF cmbPTZType.Index = 2 THEN
    IF NOT txtPTZBaseUrl.Text THEN
      Balloon(("Please provide a base PTZ url!"), txtPTZBaseUrl)
      RETURN FALSE
    END IF
  END IF
  RETURN TRUE

END

PUBLIC SUB btnAdd_Click()

  bAddDevice = TRUE
  btnSave_Click()

END

PUBLIC SUB cmbType_Click()

  SELECT CASE cmbType.Index
    CASE 1
      textOptions.Text = ("VLC Options")
      textView.Text = ("")
      txtUser.Enabled = FALSE
      txtPasswd.Enabled = FALSE
      txtView.Enabled = FALSE
      txtGrab.Enabled = FALSE
    CASE 2
      textOptions.Text = ("Wget Options")
      textView.Text = ("Image URL")
      txtUser.Enabled = TRUE
      txtPasswd.Enabled = TRUE
      txtView.Enabled = TRUE
      txtGrab.Enabled = FALSE
    CASE 3
      textOptions.Text = ("VLC Options")
      textView.Text = ("Stream URL")
      txtUser.Enabled = TRUE
      txtPasswd.Enabled = TRUE
      txtView.Enabled = TRUE
      txtGrab.Enabled = FALSE
  END SELECT
  btnSave.Enabled = TRUE

END
