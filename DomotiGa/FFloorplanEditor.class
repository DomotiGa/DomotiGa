' Gambas class file

' Description:
' FFloorplanEditor.class
' Place devices on floorplan image to determine correct X and Y coordinates.

' Development Status:
' Just started, must be worked on.

' DomotiGa - an open source home automation program.
' Copyright(C) 2008-2011 Ron Klinkien

' Read file called COPYING for license details.

PUBLIC imgFloorPlanImage AS Image

PUBLIC SUB Form_Open()

  DIM rDevice AS Result

  ME.Move(FMain.X + 50, FMain.Y + 70)

  TRY rDevice = Main.hDB.Exec("SELECT * FROM devices WHERE id = &1", FDevices.tbvDevices[FDevices.iCurRow, 0].Text)
  IF rDevice.Count THEN
    pbIcon.Picture = Picture[Main.sBaseDir &/ "icons" &/ rDevice!onicon]
    txtX.Text = rDevice!x
    txtY.Text = rDevice!y
  ELSE
    pbIcon.Picture = Picture[Main.sBaseDir &/ "icons" &/ "phone.png"]
  ENDIF
  FFloorPlans.DisplayFloorplan(FDeviceEditor.GetFloorplan(), svFloorplanPict)

END

PUBLIC SUB Form_Resize()

  svFloorplanPict.Move(1, 1, ME.ClientWidth - 100, ME.ClientHeight - 2)
  frameIcon.Move(ME.ClientWidth - 94, 0)
  lblX.Move(ME.ClientWidth - 90, 84)
  lblY.Move(ME.ClientWidth - 90, 109)
  txtX.Move(ME.ClientWidth - 70, 84)
  txtY.Move(ME.ClientWidth - 70, 109)
  btnCancel.Move(ME.ClientWidth - 94, 159)
  btnSave.Move(ME.ClientWidth - 94, 195)

END

' provide drag/drop for deviceicon image
PUBLIC SUB DeviceIcon_MouseDrag()

  IF Mouse.Left THEN
    Drag.IconX = 0
    Drag.IconY = 0
    Drag.Icon = LAST.Picture
    LAST.Drag(LAST.Picture.Image)
  ENDIF

END

PUBLIC SUB PlanIcon_MouseDrag()

  IF Mouse.Left THEN
    Drag.IconX = 0
    Drag.IconY = 0
    Drag.Icon = LAST.Picture
    LAST.Drag(LAST.Picture.Image)
  ENDIF

END

PUBLIC SUB Plan_DragMove()

  Drag.Show(LAST)

END

PUBLIC SUB Plan_Drop()

  txtX.Text = Drag.X
  txtY.Text = Drag.Y
  AddToFloorPlan(Drag.Icon, Drag.X, Drag.Y)

END

PUBLIC SUB AddToFloorplan(imgIcon AS Picture, X AS Integer, Y AS Integer)

  DIM hPictureBox AS PictureBox

  ' recreate floorplan image
  hPictureBox = NEW PictureBox(svFloorplanPict) AS "FloorIcon"
  WITH hPictureBox
    .Picture = imgIcon
    .Height = imgIcon.Height
    .Width = imgIcon.Width
    .Drop = TRUE
    .Tag = "PlanIcon"
    .X = X
    .Y = Y
  END WITH

END

PUBLIC SUB btnSave_Click()

  FDeviceEditor.tbX.Text = txtX.Text
  FDeviceEditor.tbY.Text = txtY.Text
  ME.Close

END

PUBLIC SUB FloorIcon_MouseDrag()

  IF Mouse.Left THEN
    Drag.IconX = 0
    Drag.IconY = 0
    Drag.Icon = LAST.Picture
    LAST.Drag(LAST.Picture.Image)
  ENDIF

END

PUBLIC SUB FloorIcon_DragMove()

  Drag.Show(LAST)

END

PUBLIC SUB btnCancel_Click()

  ME.Close

END
