' Gambas class file

' Description:
' CZWave.class
' Support for Z-Wave protocol.

' Development Status:
' Reading node list and info from controller and switching and dimming of modules works, certainly not finished yet!
' Only tested with AEON Labs Z-Wave Stick and Duewi Dimmer and Switch module.

' Remarks:
' This code is put together with the use of the information found at these locations:
' http://wiki.linuxmce.org/index.php/ZWave_API
' http://svn.linuxmce.org/svn/trunk/src/ZWave
' http://wiki.micasaverde.com/index.php/ZWave_Command_Classes
' http://area26.no-ip.org/linked/zw_analysis.rtf
' http://code.google.com/p/open-zwave/

' Credits:
' Thanks to Willem-Jan of ezHome.nl.
' and Jaren for open-zwave wrapper code.

' DomotiGa - an open source home automation program.
' Copyright(C) 2011 Ron Klinkien

' Read file called COPYING for license details.

LIBRARY "libdomozwave"
EXTERN DomoZWave_Init(serialPort AS String, rpcPort AS Integer)
EXTERN DomoZWave_Destroy()
EXTERN DomoZWave_SetNodeOn(node AS Integer)
EXTERN DomoZWave_SetNodeOff(node AS Integer)
EXTERN DomoZWave_SetNodeLevel(node AS Integer, level AS Integer)
EXTERN DomoZWave_EnablePolling(node AS Integer)
EXTERN DomoZWave_DisablePolling(node AS Integer)
EXTERN DomoZWave_RequestNodeState(node AS Integer)

PROPERTY UseOZW AS Boolean
PROPERTY Port AS String
PROPERTY Baud AS String
PROPERTY ZWaveDebug AS Boolean
PROPERTY ReloadNodes AS Boolean

PRIVATE bUseOZW AS Boolean
PRIVATE sPort AS String
PRIVATE sBaud AS String
PRIVATE bZWaveDebug AS Boolean
PRIVATE bReloadNodes AS Boolean

PUBLIC hZWaveSer AS NEW SerialPort
PUBLIC tZWaveLED AS NEW Timer

PUBLIC sZWaveAPIVersion AS String
PUBLIC sZWaveZDKVersion AS String
PUBLIC sHomeID AS String
PUBLIC iSUCNodeID AS Integer
PUBLIC iControllerID AS Integer
PUBLIC sControllerChipType AS String
PUBLIC sControllerChipRev AS String
PUBLIC sControllerType AS String = ("Unknown")
PUBLIC bControllerCapabilities AS Byte[]

PRIVATE iCallback AS Integer
PRIVATE iTempNode AS Integer

' temp stuff
PRIVATE bAwaitAck AS Boolean
PUBLIC tZWavePoll AS NEW timer
PRIVATE bPolling AS Boolean
PRIVATE cRequestBuffer AS Collection

' Z-Wave constants
PRIVATE CONST SOF AS Byte = &H01
PRIVATE CONST ACK AS Byte = &H06
PRIVATE CONST NAK AS Byte = &H15
PRIVATE CONST CAN AS Byte = &H18
PRIVATE CONST REQUEST AS Byte = &H0
PRIVATE CONST RESPONSE AS Byte = &H1

PRIVATE CONST ZW_SUC_FUNC_NODEID_SERVER AS Byte = &H01
PRIVATE CONST ZW_GET_VERSION AS Byte = &H15
PRIVATE CONST ZW_MEMORY_GET_ID AS Byte = &H20

PRIVATE CONST FUNC_ID_SERIAL_API_GET_INIT_DATA AS Byte = &H02
PRIVATE CONST FUNC_ID_SERIAL_API_GET_CAPABILITIES AS Byte = &H07
PRIVATE CONST FUNC_ID_ZW_SEND_DATA AS Byte = &H13
PRIVATE CONST FUNC_ID_ZW_GET_NODE_PROTOCOL_INFO AS Byte = &H41
PRIVATE CONST FUNC_ID_ZW_ENABLE_SUC AS Byte = &H52
PRIVATE CONST FUNC_ID_ZW_SET_SUC_NODE_ID AS Byte = &H54
PRIVATE CONST FUNC_ID_ZW_GET_SUC_NODE_ID AS Byte = &H56
PRIVATE CONST FUNC_ID_APPLICATION_COMMAND_HANDLER AS Byte = &H04

PRIVATE CONST FUNC_ID_ZW_GET_NODE_CAPABILITIES AS Byte = &H60

PRIVATE CONST COMMAND_CLASS_MANUFACTURER_SPECIFIC AS Byte = &H72
PRIVATE CONST MANUFACTURER_SPECIFIC_GET AS Byte = &H04
PRIVATE CONST MANUFACTURER_SPECIFIC_REPORT AS Byte = &H05

PRIVATE CONST COMMAND_CLASS_BASIC AS Byte = &H20
PRIVATE CONST COMMAND_CLASS_SWITCH_MULTILEVEL AS Byte = &H26
PRIVATE CONST SWITCH_MULTILEVEL_SET AS Byte = &H01

PRIVATE CONST COMMAND_CLASS_MULTI_INSTANCE AS Byte = &H60
PRIVATE CONST MULTI_INSTANCE_REPORT AS Byte = &H05

PRIVATE CONST COMMAND_CLASS_VERSION AS Byte = &H86
PRIVATE CONST VERSION_GET AS Byte = &H11
PRIVATE CONST VERSION_REPORT AS Byte = &H12

PRIVATE CONST COMMAND_CLASS_METER AS Byte = &H32
PRIVATE CONST COMMAND_CLASS_SENSOR_MULTILEVEL AS Byte = &H31

PRIVATE CONST SENSOR_MULTILEVEL_GET AS Byte = &H04
PRIVATE CONST SENSOR_MULTILEVEL_REPORT AS Byte = &H05

PRIVATE CONST SENSOR_MULTILEVEL_PRECISION_MASK AS Byte = &HE0
PRIVATE CONST SENSOR_MULTILEVEL_SCALE_MASK AS Byte = &H18
PRIVATE CONST SENSOR_MULTILEVEL_SIZE_MASK AS Byte = &H07
PRIVATE CONST SENSOR_MULTILEVEL_PRECISION_SHIFT AS Byte = &H05
PRIVATE CONST SENSOR_MULTILEVEL_SCALE_SHIFT AS Byte = &H03
PRIVATE CONST SENSOR_TYPE_TEMPERATURE_SCALE_C AS Byte = &H00
PRIVATE CONST SENSOR_TYPE_TEMPERATURE_SCALE_F AS Byte = &H01
PRIVATE CONST SENSOR_TYPE_TEMPERATURE AS Byte = &H01

PRIVATE CONST METER_PULSE_VERSION AS Byte = &H01
PRIVATE CONST METER_PULSE_GET AS Byte = &H04
PRIVATE CONST METER_PULSE_REPORT AS Byte = &H05

PRIVATE CONST BASIC_SET AS Byte = &H01
PRIVATE CONST BASIC_GET AS Byte = &H02
PRIVATE CONST BASIC_REPORT AS Byte = &H03

PRIVATE CONST TRANSMIT_OPTION_ACK AS Byte = &H01
PRIVATE CONST TRANSMIT_OPTION_AUTO_ROUTE AS Byte = &H04

PRIVATE CONST BASIC_TYPE_CONTROLLER AS Byte = &H01
PRIVATE CONST BASIC_TYPE_STATIC_CONTROLLER AS Byte = &H02
PRIVATE CONST BASIC_TYPE_SLAVE AS Byte = &H03
PRIVATE CONST BASIC_TYPE_ROUTING_SLAVE AS Byte = &H04

PRIVATE CONST GENERIC_TYPE_GENERIC_CONTROLLER AS Byte = &H01
PRIVATE CONST GENERIC_TYPE_STATIC_CONTROLLER AS Byte = &H02
PRIVATE CONST GENERIC_TYPE_AV_CONTROL_POINT AS Byte = &H03
PRIVATE CONST GENERIC_TYPE_DISPLAY AS Byte = &H06
PRIVATE CONST GENERIC_TYPE_GARAGE_DOOR AS Byte = &H07
PRIVATE CONST GENERIC_TYPE_THERMOSTAT AS Byte = &H08
PRIVATE CONST GENERIC_TYPE_WINDOW_COVERING AS Byte = &H09
PRIVATE CONST GENERIC_TYPE_REPEATER_SLAVE AS Byte = &H0F
PRIVATE CONST GENERIC_TYPE_SWITCH_BINARY AS Byte = &H10
PRIVATE CONST GENERIC_TYPE_SWITCH_MULTILEVEL AS Byte = &H11
PRIVATE CONST GENERIC_TYPE_SWITCH_REMOTE AS Byte = &H12
PRIVATE CONST GENERIC_TYPE_SWITCH_TOGGLE AS Byte = &H13
PRIVATE CONST GENERIC_TYPE_ZIP_GATEWAY AS Byte = &H14
PRIVATE CONST GENERIC_TYPE_ZIP_NODE AS Byte = &H15
PRIVATE CONST GENERIC_TYPE_SENSOR_BINARY AS Byte = &H20
PRIVATE CONST GENERIC_TYPE_SENSOR_MULTILEVEL AS Byte = &H21
PRIVATE CONST GENERIC_TYPE_WATER_CONTROL AS Byte = &H22
PRIVATE CONST GENERIC_TYPE_METER_PULSE AS Byte = &H30
PRIVATE CONST GENERIC_TYPE_METER AS Byte = &H31 
PRIVATE CONST GENERIC_TYPE_ENTRY_CONTROL AS Byte = &H40
PRIVATE CONST GENERIC_TYPE_SEMI_INTEROPERABLE AS Byte = &H50
PRIVATE CONST GENERIC_TYPE_SENSOR_ALARM AS Byte = &HA1
PRIVATE CONST GENERIC_TYPE_NON_INTEROPERABLE AS Byte = &HFF

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' open serial port
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
PUBLIC FUNCTION Connect() AS Boolean

  IF bUseOZW THEN RETURN TRUE

  ' try to close the port
  TRY hZWaveSer.Close

  ' get a new one
  hZWaveSer = NEW Serialport AS "ZWaveSer"

  WITH hZWaveSer
    .PortName = sPort
    .Speed = sBaud
    .Parity = 0
    .DataBits = 8
    .StopBits = 1
    .FlowControl = 0
    .Open()
  END WITH

  ' start timer for Z-Wave status LED
  tZWaveLED = NEW Timer AS "tZWaveLED"
  tZWaveLED.Delay = 250
  tZWaveLED.Stop

  ' start poll timer for Z-Wave receive function
  tZWavePoll = NEW Timer AS "tZWavePoll"
  tZWavePoll.Delay = 1000
  tZWavePoll.Stop

  ' all ok
  RETURN TRUE

CATCH ' some errors
  Main.WriteLog(("Z-Wave Error: ") & ERROR.Text)
  RETURN FALSE

END

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' get information about version and nodes from stick
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
PUBLIC SUB InitZWave()

  DIM bBuf AS Byte[16]

  IF bUseOZW
    OZW_Init()
    RETURN
  ENDIF

  bBuf[0] = NAK
  WriteSerial(bBuf, 1)

  IF bZWaveDebug THEN Main.WriteDebugLog(("[Z-Wave] Get controller info"))
  bBuf[0] = ZW_GET_VERSION
  SendFunction(bBuf, 1, REQUEST, 0)

  IF bZWaveDebug THEN Main.WriteDebugLog(("[Z-Wave] Get home & controller IDs"))
  bBuf[0] = ZW_MEMORY_GET_ID
  SendFunction(bBuf, 1, REQUEST, 0)

  IF bZWaveDebug THEN Main.WriteDebugLog(("[Z-Wave] Get capabilities"))
  bBuf[0] = FUNC_ID_SERIAL_API_GET_CAPABILITIES
  SendFunction(bBuf, 1, REQUEST, 0)

  IF bZWaveDebug THEN Main.WriteDebugLog(("[Z-Wave] Get SUC node ID"))
  bBuf[0] = FUNC_ID_ZW_GET_SUC_NODE_ID
  SendFunction(bBuf, 1, REQUEST, 0)

  IF bZWaveDebug THEN Main.WriteDebugLog(("[Z-Wave] Get init data"))
  bBuf[0] = FUNC_ID_SERIAL_API_GET_INIT_DATA
  SendFunction(bBuf, 1, REQUEST, 0)

  ' find out type and manufacturer of each node
  ' and request their values
  QueryNodes()

END

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' called from devices module
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
PUBLIC SUB SendCommand(sAddress AS String, sCmd AS String)

  DIM ibrightness AS Integer

  IF bUseOZW
    OZW_SendCommand(sAddress, sCmd)
    RETURN
  ENDIF

  sCmd = UCase(sCmd)
  IF sCmd = "ON"
    ChangeSwitch(sAddress, &HFF)
  ELSE IF sCmd = "OFF"
    ChangeSwitch(sAddress, &H0)
  ELSE IF InStr(sCmd, "DIM ") THEN ' DIM 0-100
    iBrightness = Val(Replace(sCmd, "DIM ", ""))
    ChangeSwitchLevel(sAddress, iBrightness)
  ELSE
    Main.WriteDebugLog(("[Z-Wave] Only DIM and ON/OFF commands are supported!"))
  END IF

END

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' do the writes on the serial port
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
PUBLIC SUB WriteSerial(bBuffer AS Byte[], iLength AS Integer)

  DIM iCnt AS Integer
  DIM bByte AS Byte

  IF NOT bZWaveDebug THEN
    bBuffer.Write(hZWaveSer, 0, iLength)
    RETURN
  ENDIF

  Main.WriteDebugLog("[Z-Wave] >", TRUE)
  FOR EACH bByte IN bBuffer
    IF iCnt >= iLength THEN BREAK
    WRITE #hZWaveSer, CByte(bByte)
    Main.WriteRFXDebugLog(" " & Hex(bByte, 2), TRUE)
    INC iCnt
  NEXT
  Main.WriteRFXDebugLog("\n", TRUE)

END

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' create the correct packet frame to send
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
PUBLIC SUB SendFunction(bBuffer AS Byte[], iLength AS Integer, iType AS Integer, bResponse AS Boolean)

  DIM iPacketLen AS Integer = iLength + 2 + IIf(bResponse, 1, 0)

  IF iCallback = 254 THEN
    iCallback = 1
  ELSE
    INC iCallback
  ENDIF

  bBuffer.Add(SOF, 0) ' insert start of frame and length
  bBuffer.Add(iPacketLen, 1)
  bBuffer.Add(iType, 2)
  IF bResponse THEN bBuffer.Add(CByte(iCallback), iPacketLen) ' insert callback if we request a response
  bBuffer[iLength + 3 + IIf(bResponse, 1, 0)] = ChecksumZ(bBuffer, iPacketLen) ' insert checksum

  WriteSerial(bBuffer, iPacketLen + 2)
  ReceiveFunction()

END

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' switch a binary switch
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
PUBLIC SUB ChangeSwitch(iNodeID AS Integer, iLevel AS Integer)

  DIM bBuf AS Byte[10]

  IF bUseOZW
    OZW_ChangeSwitch(iNodeID, iLevel)
    RETURN
  ENDIF

  bBuf[0] = FUNC_ID_ZW_SEND_DATA
  bBuf[1] = iNodeID
  bBuf[2] = &H3
  bBuf[3] = COMMAND_CLASS_BASIC
  bBuf[4] = BASIC_SET
  bBuf[5] = iLevel
  bBuf[6] = TRANSMIT_OPTION_ACK OR TRANSMIT_OPTION_AUTO_ROUTE

  SendFunction(bBuf, 7, REQUEST, 1)

END

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' control a multilevel switch (dimmer)
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
PUBLIC SUB ChangeSwitchLevel(iNodeID AS String, iLevel AS Integer)

  DIM bBuf AS Byte[10]

  IF bUseOZW
    OZW_ChangeNodeLevel(iNodeID, iLevel)
    RETURN
  ENDIF

  bBuf[0] = FUNC_ID_ZW_SEND_DATA
  bBuf[1] = iNodeID
  bBuf[2] = &H3
  bBuf[3] = COMMAND_CLASS_SWITCH_MULTILEVEL
  bBuf[4] = SWITCH_MULTILEVEL_SET
  bBuf[5] = Val("&H" & Hex(iLevel)) ' max 100 (0x64)
  bBuf[6] = TRANSMIT_OPTION_ACK OR TRANSMIT_OPTION_AUTO_ROUTE

  SendFunction(bBuf, 7, REQUEST, 1)

END

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' request manufacturer and device type values from node
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
PUBLIC SUB RequestManufacturerSpecificReport(iNodeID AS Integer)

  DIM bBuf AS Byte[10]

  bBuf[0] = FUNC_ID_ZW_SEND_DATA
  bBuf[1] = iNodeID
  bBuf[2] = &H3
  bBuf[3] = COMMAND_CLASS_MANUFACTURER_SPECIFIC
  bBuf[4] = MANUFACTURER_SPECIFIC_GET
  bBuf[5] = MANUFACTURER_SPECIFIC_REPORT
  bBuf[6] = TRANSMIT_OPTION_ACK OR TRANSMIT_OPTION_AUTO_ROUTE

  IF bZWaveDebug THEN Main.WriteDebugLog(("[Z-Wave] Requesting Manufacturer Specific Report for Node ") & iNodeID)
  SendFunction(bBuf, 6, REQUEST, 0)

END

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' request multilevel sensor get from node
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
PUBLIC SUB RequestMultiLevelSensorReport(iNodeID AS Integer)

  DIM bBuf AS Byte[10]

  IF bUseOZW
    Main.WriteDebugLog("[Z-Wave] MultiLevelSensorReport not implemented for OpenZWave Mode yet. ")
    RETURN
  ENDIF

  bBuf[0] = FUNC_ID_ZW_SEND_DATA
  bBuf[1] = iNodeID
  bBuf[2] = &H3
  bBuf[3] = COMMAND_CLASS_SENSOR_MULTILEVEL
  bBuf[4] = SENSOR_MULTILEVEL_GET
  bBuf[5] = SENSOR_MULTILEVEL_REPORT
  bBuf[6] = TRANSMIT_OPTION_ACK OR TRANSMIT_OPTION_AUTO_ROUTE

  IF bZWaveDebug THEN Main.WriteDebugLog(("[Z-Wave] Requesting Multilevel Sensor Report for Node ") & iNodeID)
  SendFunction(bBuf, 6, REQUEST, 0)

END

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' request capabilities from node
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
PUBLIC SUB RequestNodeCapabilities(iNodeID AS Integer)

  DIM bBuf AS Byte[10]

  bBuf[0] = FUNC_ID_ZW_GET_NODE_CAPABILITIES
  bBuf[1] = iNodeID
  'bBuf[2] = TRANSMIT_OPTION_ACK OR TRANSMIT_OPTION_AUTO_ROUTE

  IF bZWaveDebug THEN Main.WriteDebugLog(("[Z-Wave] Requesting Capabilities for Node ") & iNodeID)
  SendFunction(bBuf, 2, REQUEST, 0)

END

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' send basic get to get node value
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
PUBLIC SUB RequestBasicReport(iNodeID AS Integer)

  DIM bBuf AS Byte[10]

  IF bUseOZW
    IF iNodeID == 255
      OZW_RequestAllNodeStates()
    ELSE
      OZW_RequestNodeState(iNodeID)
    ENDIF
    RETURN
  ENDIF

  bBuf[0] = FUNC_ID_ZW_SEND_DATA
  bBuf[1] = iNodeID
  bBuf[2] = &H2
  bBuf[3] = COMMAND_CLASS_BASIC
  bBuf[4] = BASIC_GET
  bBuf[5] = TRANSMIT_OPTION_ACK OR TRANSMIT_OPTION_AUTO_ROUTE

  IF bZWaveDebug THEN Main.WriteDebugLog(("[Z-Wave] Requesting basic report for Node ") & iNodeID)
  SendFunction(bBuf, 6, REQUEST, 1)

END

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' send version get to get node value
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
PUBLIC SUB RequestVersionReport(iNodeID AS Integer)

  DIM bBuf AS Byte[10]

  IF bUseOZW
    Main.WriteDebugLog("[Z-Wave] RequestVersionReport not implemented for OpenZWave mode yet. ")  
    RETURN
  ENDIF

  bBuf[0] = FUNC_ID_ZW_SEND_DATA
  bBuf[1] = iNodeID
  bBuf[2] = &H2
  bBuf[3] = COMMAND_CLASS_VERSION
  bBuf[4] = VERSION_GET
  bBuf[5] = TRANSMIT_OPTION_ACK OR TRANSMIT_OPTION_AUTO_ROUTE

  IF bZWaveDebug THEN Main.WriteDebugLog(("[Z-Wave] Requesting version report for Node ") & iNodeID)
  SendFunction(bBuf, 6, REQUEST, 1)

END

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' send meter get to get power usage
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
PUBLIC SUB RequestMeterReport(iNodeID AS Integer)

  DIM bBuf AS Byte[10]

  IF bUseOZW
    Main.WriteDebugLog("[Z-Wave] RequestMeterReport not implemented for OpenZWave mode yet. ")
    RETURN
  ENDIF

  bBuf[0] = FUNC_ID_ZW_SEND_DATA
  bBuf[1] = iNodeID
  bBuf[2] = &H2
  bBuf[3] = COMMAND_CLASS_METER
  bBuf[4] = METER_PULSE_GET
  bBuf[5] = TRANSMIT_OPTION_ACK OR TRANSMIT_OPTION_AUTO_ROUTE

  IF bZWaveDebug THEN Main.WriteDebugLog(("[Z-Wave] Requesting meter report for Node ") & iNodeID)
  SendFunction(bBuf, 6, REQUEST, 1)

END

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' calculate checksum of a frame
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
PUBLIC FUNCTION ChecksumZ(bBuffer AS Byte[], iLength AS Integer) AS Byte

  DIM iChecksum AS Byte = &HFF
  DIM iCnt AS Integer

  FOR iCnt = 1 TO iLength
    iChecksum = iChecksum XOR bBuffer[iCnt]
  NEXT

  RETURN iChecksum

END

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' handle incoming data
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
PUBLIC SUB ReceiveFunction()

  DIM bMyBuf AS Byte[512]
  DIM iLen, iCnt, iLoop AS Integer
  DIM bBuf AS Byte[8]

  bPolling = TRUE
  WHILE iLoop < 16384
    bMyBuf[0] = 0
    TRY READ #hZwaveSer, bMyBuf[0], 1 ' read the first byte
    IF NOT ERROR THEN
      Main.ControlLed("ZWave", "On")
      IF Main.bServer THEN tZWaveLED.Start
      iLen = 1
      SELECT bMyBuf[0]
        CASE SOF
          IF bZWaveDebug THEN Main.WriteDebugLog(("[Z-Wave] SOF found"))
          IF bAwaitAck THEN
            IF bZWaveDebug THEN Main.WriteRFXDebugLog(("[Z-Wave] ERROR: SOF found while awaiting ACK.. triggering resend"))
            bAwaitAck = FALSE
          END IF

          TRY READ #hZwaveSer, bMyBuf[0 + 1], 1 ' read the length byte
          IF NOT ERROR THEN
            INC iLen
            IF bZWaveDebug THEN
              Main.WriteDebugLog(("[Z-Wave] Packet Length = ") & bMyBuf[1])
              Main.WriteDebugLog("[Z-Wave] < " & Hex(bMyBuf[0], 2) & " " & Hex(bMyBuf[1], 2), TRUE)
            END IF
            FOR iCnt = 0 TO bMyBuf[1] - 1 ' read the rest of the frame
              TRY READ #hZwaveSer, bMyBuf[0 + 2 + iCnt], 1
              IF NOT ERROR THEN
                IF bZWaveDebug THEN Main.WriteRFXDebugLog(" " & Hex(bMyBuf[0 + 2 + iCnt], 2), TRUE)
              ELSE
                Main.WriteDebugLog(("[Z-Wave] ERROR reading frame!"))
              END IF
            NEXT
            IF bZWaveDebug THEN Main.WriteRFXDebugLog("\n", TRUE)
            iLen += bMyBuf[1]
            IF bMyBuf[iLen - 1] = ChecksumZ(bMyBuf, bMyBuf[1]) THEN ' verify checksum of received frame
              IF bZWaveDebug THEN Main.WriteDebugLog(("[Z-Wave] Checksum correct - sending an ACK"))
              ' WAIT 0.1 ' work around here, possible bug
              ' bBuf[0] = ACK
              ' WriteSerial(bBuf, 1)
              bBuf[0] = ACK
              WriteSerial(bBuf, 1)
              DecodeFrame(bMyBuf, iLen - 3) ' go and decode frame
            ELSE
              IF bZWaveDebug THEN Main.WriteDebugLog(("[Z-Wave] Checksum incorrect - sending an NAK"))
              bBuf[0] = NAK
              WriteSerial(bBuf, 1)
            END IF
          ELSE
            Main.WriteDebugLog(("[Z-Wave] ERROR reading length byte!"))
          END IF
          ' BREAK
        CASE CAN
          IF bZWaveDebug THEN Main.WriteDebugLog(("[Z-Wave] CAN Received"))
          bAwaitAck = FALSE
          ' BREAK
        CASE NAK
          IF bZWaveDebug THEN Main.WriteDebugLog(("[Z-Wave] NAK Received"))
          bAwaitAck = FALSE
          ' BREAK
        CASE ACK
          IF bZWaveDebug THEN Main.WriteDebugLog(("[Z-Wave] < 06 - Received ACK"))
          IF bAwaitAck THEN bAwaitAck = FALSE
          bBuf[0] = ACK
          WriteSerial(bBuf, 1)
          ' remove job from list
        DEFAULT
          IF bZWaveDebug THEN Main.WriteDebugLog(("[Z-Wave] ERROR frame out of sync! (") & bMyBuf[0] & ")")
          ' BREAK
      END SELECT
    ELSE
     ' nothing to read
    END IF
    INC iLoop
  WEND
  bPolling = FALSE

END

PUBLIC SUB tZWavePoll_Timer()

  IF NOT bPolling THEN
    ReceiveFunction()
  END IF

END

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' translate between API and ZDK version numbering
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
PUBLIC SUB ExpandVersion(sVersion AS String) AS String

  SELECT sVersion
    CASE "2.78"
      RETURN "5.02 Patch 3"
    CASE "2.64"
      RETURN "5.02 Patch 2"
    CASE "2.51"
      RETURN "5.02 Patch 1"
    CASE "2.48"
      RETURN "5.02"
    CASE "2.74"
      RETURN "4.50"
    CASE "2.67"
      RETURN "4.28"
    CASE "2.40"
      RETURN "4.27"
    DEFAULT
      RETURN "?"
    END SELECT

END

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' examine a received frame closely
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
PUBLIC SUB DecodeFrame(bBuffer AS Byte[], length AS Integer)

  DIM bBuf AS Byte[8]
  DIM iCnt, jCnt, cCnt AS Integer
  DIM bSleeping AS Boolean
  DIM iNodeID, iTypeBasic, iTypeGeneric, iTypeSpecific, iCapabilities, iSecurity, iDeviceId AS Integer
  DIM sManufacturer, sType, sModel, sClasses, sValue AS String

  IF (bBuffer[2] = RESPONSE) THEN
    IF bZWaveDebug THEN Main.WriteDebugLog(("[Z-Wave] Got response frame!"))

    SELECT bBuffer[3]
      CASE ZW_MEMORY_GET_ID
        sHomeID = Hex(bBuffer[4], 2) & Hex(bBuffer[5], 2) & Hex(bBuffer[6], 2) & Hex(bBuffer[7], 2)
        iControllerID = bBuffer[8]
        IF bZWaveDebug THEN
          Main.WriteDebugLog(("[Z-Wave] Home ID: ") & sHomeID)
          Main.WriteDebugLog(("[Z-Wave] Controller Node ID: ") & iControllerID)
        END IF
        Main.WriteLog("Z-Wave Home ID is " & sHomeID)

      CASE FUNC_ID_SERIAL_API_GET_INIT_DATA
        IF bZWaveDebug THEN Main.WriteDebugLog(("[Z-Wave] Got init data result back"))
        sControllerChipType = bBuffer[length]
        sControllerChipRev = Hex(bBuffer[length + 1], 2)
        IF bZWaveDebug THEN
          Main.WriteDebugLog(("[Z-Wave] Controller Chip Type: ") & sControllerChipType & " - " & ExpandChipType(sControllerChipType))
          Main.WriteDebugLog(("[Z-Wave] Controller Chip Revison: ") & sControllerChipRev)
        END IF
        RemoveNodes()
        IF (bBuffer[6] = 29) THEN
          FOR iCnt = 7 TO 35
            FOR jCnt = 0 TO 7
                IF (bBuffer[iCnt] AND Lsl(1, jCnt)) THEN ' get bits
                  IF bZWaveDebug THEN Main.WriteDebugLog(("[Z-Wave] Getting node protocol info for node: ") & ((((iCnt - 7) * 8) + 1) + jCnt))
                  iTempNode = ((((iCnt - 7) * 8) + 1) + jCnt)
                  bBuf[0] = FUNC_ID_ZW_GET_NODE_PROTOCOL_INFO
                  bBuf[1] = ((((iCnt - 7) * 8) + 1) + jCnt)
                  SendFunction(bBuf, 2, REQUEST, 0)
                END IF
            NEXT
          NEXT
        END IF
      CASE FUNC_ID_ZW_SEND_DATA
        SELECT bBuffer[4]
          CASE 1
          IF bZWaveDebug THEN Main.WriteDebugLog(("[Z-Wave] data delivered to Z-Wave device"))
          CASE 0
            IF bZWaveDebug THEN Main.WriteDebugLog(("[Z-Wave] ERROR: data could not be delivered to Z-Wave device!"))
          DEFAULT
            IF bZWaveDebug THEN Main.WriteDebugLog(("[Z-Wave] ERROR: response is invalid!"))
        END SELECT

      CASE ZW_GET_VERSION
        sZWaveAPIVersion = LTrim(Chr(bBuffer[10]) & Chr(bBuffer[11]) & Chr(bBuffer[12]) & Chr(bBuffer[13]) & Chr(bBuffer[14]))
        sZWaveZDKVersion = ExpandVersion(sZWaveAPIVersion)
        IF bZWaveDebug THEN
          Main.WriteDebugLog(("[Z-Wave] API libary version: ") & sZWaveAPIVersion)
          Main.WriteDebugLog(("[Z-Wave] ZDK version: ") & sZWaveZDKVersion)
        END IF
        Main.WriteLog(("Running Z-Wave API version ") & sZWaveAPIVersion & (" and ZDK version ") & sZWaveZDKVersion)
      CASE FUNC_ID_ZW_GET_SUC_NODE_ID
        IF bBuffer[4] THEN
          iSUCNodeID = bBuffer[4]
          IF bZWaveDebug THEN Main.WriteDebugLog(("[Z-Wave] SUC node ID: ") & iSUCNodeID)
        ELSE
          IF bZWaveDebug THEN Main.WriteDebugLog(("[Z-Wave] No SUC, we need to become SUC"))
          ' is this needed for AEON stick, needs checking.
          bBuf[0] = FUNC_ID_ZW_ENABLE_SUC
          bBuf[1] = 1 ' 0 = SUC, 1 = SIS
          bBuf[2] = ZW_SUC_FUNC_NODEID_SERVER
          SendFunction(bBuf, 3, REQUEST, 0)
          bBuf[0] = FUNC_ID_ZW_SET_SUC_NODE_ID
          bBuf[1] = iControllerID
          bBuf[2] = 1 ' we want to be SUC / SIS
          bBuf[3] = 0 ' no low power
          bBuf[4] = ZW_SUC_FUNC_NODEID_SERVER
          SendFunction(bBuf, 5, REQUEST, 1)
        END IF
        ' needs more work for other type of controllers
        IF (iSUCNodeID = iControllerID) THEN ' the controller is a SUC
          sControllerType = "Primary - SIS"
        ELSE
          sControllerType = "Unknown"
        END IF

      CASE FUNC_ID_ZW_ENABLE_SUC
        ' placeholder
      CASE FUNC_ID_ZW_SET_SUC_NODE_ID
        ' placeholder
      CASE FUNC_ID_SERIAL_API_GET_CAPABILITIES
        IF bZWaveDebug THEN Main.WriteDebugLog(("[Z-Wave] TODO: Handle get capabilities"))
      CASE FUNC_ID_ZW_GET_NODE_PROTOCOL_INFO
        IF bBuffer[8] THEN
          IF bZWaveDebug THEN Main.WriteDebugLog(("[Z-Wave] Received node protocol info for node: ") & iTempNode)
          iCapabilities = bBuffer[4]
          iSecurity = bBuffer[5]
          iTypeBasic = bBuffer[7]
          iTypeGeneric = bBuffer[8]
          iTypeSpecific = bBuffer[9]

          IF ((bBuffer[4]) AND (Lsl(&H01, 7))) THEN
            IF bZWaveDebug THEN Main.WriteDebugLog(("[Z-Wave] Listening node"))
            bSleeping = FALSE
          ELSE
            IF bZWaveDebug THEN Main.WriteDebugLog(("[Z-Wave] Sleeping node"))
            bSleeping = TRUE
          END IF
          IF ((bBuffer[5]) AND (Lsl(&H01, 7))) THEN
            IF bZWaveDebug THEN Main.WriteDebugLog(("[Z-Wave] Optional functionality"))
          END IF

          IF bZWaveDebug THEN Main.WriteDebugLog(("[Z-Wave] Basic Type: ") & ExpandBasicType(bBuffer[7]))
          IF bZWaveDebug THEN Main.WriteDebugLog(("[Z-Wave] Generic Type: ") & ExpandGenericType(bBuffer[8]))
          IF bZWaveDebug THEN Main.WriteDebugLog(("[Z-Wave] Specific Type: ") & bBuffer[9])
          CreateNode(iTempNode, iTypeBasic, iTypeGeneric, iTypeSpecific, iCapabilities, iSecurity, bSleeping)
          INC iTempNode
        ELSE
          IF bZWaveDebug THEN Main.WriteDebugLog(("[Z-Wave] Invalid generic class ") & Hex(bBuffer[8], 2) & (", ignoring device!"))
        END IF
      ' catch unimplemented types
      DEFAULT
        IF bZWaveDebug THEN Main.WriteDebugLog(("[Z-Wave] TODO: handle response for ") & Hex(bBuffer[3], 2))
    END SELECT

  ELSE IF (bBuffer[2] = REQUEST) THEN
    IF bZWaveDebug THEN Main.WriteDebugLog(("[Z-Wave] Got request frame!"))

    SELECT bBuffer[3]
      CASE FUNC_ID_ZW_SEND_DATA
        IF bZWaveDebug THEN Main.WriteDebugLog(("[Z-Wave] response with callback ") & bBuffer[4] & " received")
        bAwaitAck = FALSE
      CASE FUNC_ID_APPLICATION_COMMAND_HANDLER
        IF bZWaveDebug THEN Main.WriteDebugLog(("[Z-Wave] Application command handler response with callback ") & bBuffer[4] & " received")
        SELECT bBuffer[7]
          CASE COMMAND_CLASS_BASIC
            IF bZWaveDebug THEN Main.WriteDebugLog(("[Z-Wave] Received COMMAND_CLASS_BASIC data"))
            SELECT bBuffer[8]
              CASE BASIC_REPORT
                IF bZWaveDebug THEN Main.WriteDebugLog(("[Z-Wave] Got BASIC_REPORT from node ") & bBuffer[5] & (", value: ") & bBuffer[9])
                IF bZWaveDebug THEN Main.WriteDebugLog(("[Z-Wave] Value changed, saving new value for node ") & bBuffer[5])
                UpdateValueNode(bBuffer[5], bBuffer[9])
                iDeviceId = Devices.Find(bBuffer[5], Devices.FindInterface("Z-Wave Controller"), "Z-Wave Device")
                ' update value
                IF iDeviceId THEN
                  SELECT bBuffer[9]
                    ' on/off/dim etc
                    CASE 255
                      sValue = "On"
                    CASE 0
                      sValue = "Off"
                    DEFAULT
                      sValue = "Dim " & bBuffer[9]
                  END SELECT
                  Devices.ValueUpdate(iDeviceId, sValue, "", "", "")
                END IF
                ' IF FToolsZWaveCmdr.Visible THEN FToolsZWaveCmdr.FillNodeTable()
              CASE BASIC_SET
                IF bZWaveDebug THEN Main.WriteDebugLog(("[Z-Wave] Got BASIC_SET from node ") & bBuffer[5] & (", value: ") & bBuffer[9])
              DEFAULT
              IF bZWaveDebug THEN Main.WriteDebugLog(("[Z-Wave] Got unsupported COMMAND_CLASS_BASIC type: ") & Hex(bBuffer[8], 2) & (", ignoring"))
            END SELECT
          CASE COMMAND_CLASS_MULTI_INSTANCE
            IF bZWaveDebug THEN Main.WriteDebugLog(("[Z-Wave] Got COMMAND_CLASS_MULTI_INSTANCE"))
            IF bBuffer[8] = MULTI_INSTANCE_REPORT THEN
              IF bZWaveDebug THEN Main.WriteDebugLog(("[Z-Wave] Got MULTI_INSTANCE_REPORT from node ") & bBuffer[5] & (" Command Class ") & bBuffer[9] & (", instance count: ") & bBuffer[10])
            END IF
          CASE COMMAND_CLASS_VERSION
            IF bZWaveDebug THEN Main.WriteDebugLog(("[Z-Wave] Got COMMAND_CLASS_VERSION from node "))
            IF bBuffer[8] = VERSION_REPORT THEN
              IF bZWaveDebug THEN Main.WriteDebugLog(("[Z-Wave] REPORT: Lib type: ") & bBuffer[9] & (", Lib: ") & bBuffer[10] & "." & bBuffer[11] & (" App: ") & bBuffer[12] & "." & bBuffer[13])
            END IF
          CASE COMMAND_CLASS_MANUFACTURER_SPECIFIC
            IF bZWaveDebug THEN Main.WriteDebugLog(("[Z-Wave] Manufacturer Report response received"))
            sType = Hex(bBuffer[11], 2) & Hex(bBuffer[12], 2)
            SELECT Hex(bBuffer[9], 2) & Hex(bBuffer[10], 2) ' manufacturers low and high byte
              CASE "0001"
                sManufacturer = "Act"
              CASE "0002"
                sManufacturer = "Danfoss"
              CASE "0008"
                sManufacturer = "Wayne Dalton"
              CASE "001D"
                sManufacturer = "Leviton"
                IF sType = "0101" THEN sModel = "RZP15-1LW" ' switch
                IF sType = "0201" THEN sModel = "RZP03-1LW" ' dimmer
                IF sType = "0301" THEN sModel = "RZS15" ' switch wall plate
              CASE "001E"
                sManufacturer = "Homeseer"
                IF sType = "0002" THEN sModel = "HSM100" ' motion detector
              CASE "0005"
                sManufacturer = "Intermatic"
                IF sType = "0004" THEN sModel = "HA04C" ' switch
              CASE "0012"
                sManufacturer = "E.Housekeeper"
              CASE "0033"
                sManufacturer = "ESI Electronic Solutions"
              CASE "0059"
                sManufacturer = "Horstmann"
              CASE "0060"
                sManufacturer = "Everspring"
              CASE "0064"
                sManufacturer = "Popp/Duwi"
                IF sType = "3001" THEN sModel = "ZS 3500" ' switch
                IF sType = "1001" THEN sModel = "ZDAN 300" ' dimmer
              CASE "0077"
                sManufacturer = "Innovus"
                IF sType = "0011" THEN sModel = "RAone SmartDimmer"
              CASE "007A"
                sManufacturer = "Merten"
              DEFAULT
                sManufacturer = ("Unknown (") & Hex(bBuffer[9], 2) & " " & Hex(bBuffer[10], 2) & ")"
            END SELECT
            IF NOT sModel THEN sModel = ("Unknown (") & Hex(bBuffer[11], 2) & " " & Hex(bBuffer[12], 2) & ")"
            IF bZWaveDebug THEN
              Main.WriteDebugLog(("[Z-Wave] Node: ") & bBuffer[5])
              Main.WriteDebugLog(("[Z-Wave] Manufacturer: ") & sManufacturer)
              Main.WriteDebugLog(("[Z-Wave] Model: ") & sModel)
            END IF
            UpdateManufacturersNode(Hex(bBuffer[5], 2), sManufacturer, sModel)
          DEFAULT
            IF bZWaveDebug THEN Main.WriteDebugLog(("[Z-Wave] Got unsupported FUNC_ID_APPLICATION_COMMAND_HANDLER type: ") & Hex(bBuffer[7], 2) & (", ignoring"))
        END SELECT
      CASE &H49
        IF bZWaveDebug THEN Main.WriteDebugLog(("[Z-Wave] Classes supported by Node ") & bBuffer[5] & (" are:"))
        FOR iCnt = 10 TO 6 + bBuffer[6]
          IF bZWaveDebug THEN Main.WriteDebugLog("[Z-Wave] " & ExpandClass(Hex(bBuffer[iCnt], 2)))
          sClasses &= ExpandClass(Hex(bBuffer[iCnt], 2)) & " "
        NEXT
        UpdateClassesNode(bBuffer[5], sClasses)
      DEFAULT
        IF bZWaveDebug THEN Main.WriteDebugLog(("[Z-Wave] TODO: handle request for ") & Hex(bBuffer[3], 2))
    END SELECT
  END IF

END

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' translate chip type byte to text
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
PUBLIC SUB ExpandChipType(iTypeChip AS Integer) AS String

  SELECT iTypeChip
    CASE 1
      RETURN "ZW0102"
    CASE 2
      RETURN "ZW0201"
    CASE 3
      RETURN "ZW0301"
    DEFAULT
      RETURN "Unknown"
  END SELECT

END

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' translate basic type byte to text
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
PUBLIC SUB ExpandBasicType(iTypeBasic AS Integer) AS String

  SELECT iTypeBasic
    CASE BASIC_TYPE_CONTROLLER
      RETURN "Controller"
    CASE BASIC_TYPE_STATIC_CONTROLLER
      RETURN "Static Controller"
    CASE BASIC_TYPE_SLAVE
      RETURN "Slave"
    CASE BASIC_TYPE_ROUTING_SLAVE
      RETURN "Routing Slave"
    DEFAULT
      RETURN "Unknown (" & Hex(iTypeBasic, 2) & ")"
  END SELECT

END

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' translate class byte to text
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
PUBLIC SUB ExpandClass(sByte AS String) AS String

  SELECT CASE sByte
    CASE "20"
      RETURN "COMMAND_CLASS_BASIC"
    CASE "21"
      RETURN "COMMAND_CLASS_CONTROLLER_REPLICATION"
    CASE "22"
      RETURN "COMMAND_CLASS_APPLICATION_STATUS"
    CASE "23"
      RETURN "COMMAND_CLASS_ZIP_SERVICES"
    CASE "24"
      RETURN "COMMAND_CLASS_ZIP_SERVER"
    CASE "25"
      RETURN "COMMAND_CLASS_SWITCH_BINARY"
    CASE "26"
      RETURN "COMMAND_CLASS_SWITCH_MULTILEVEL"
    CASE "27"
      RETURN "COMMAND_CLASS_SWITCH_ALL"
    CASE "28"
      RETURN "COMMAND_CLASS_SWITCH_TOGGLE_BINARY"
    CASE "29"
      RETURN "COMMAND_CLASS_SWITCH_TOGGLE_MULTILEVEL"
    CASE "2A"
      RETURN "COMMAND_CLASS_CHIMNEY_FAN"
    CASE "2B"
      RETURN "COMMAND_CLASS_SCENE_ACTIVATION"
    CASE "2C"
      RETURN "COMMAND_CLASS_SCENE_ACTUATOR_CONF"
    CASE "2D"
      RETURN "COMMAND_CLASS_SCENE_CONTROLLER_CONF"
    CASE "2E"
      RETURN "COMMAND_CLASS_ZIP_CLIENT"
    CASE "2F"
      RETURN "COMMAND_CLASS_ZIP_ADV_SERVICES"
    CASE "30"
      RETURN "COMMAND_CLASS_SENSOR_BINARY"
    CASE "31"
      RETURN "COMMAND_CLASS_SENSOR_MULTILEVEL"
    CASE "32"
      RETURN "COMMAND_CLASS_METER"
    CASE "33"
      RETURN "COMMAND_CLASS_ZIP_ADV_SERVER"
    CASE "34"
      RETURN "COMMAND_CLASS_ZIP_ADV_CLIENT"
    CASE "35"
      RETURN "COMMAND_CLASS_METER_PULSE"
    CASE "36"
      RETURN "COMMAND_CLASS_BASIC_TARIFF_INFO"
    CASE "38"
      RETURN "COMMAND_CLASS_THERMOSTAT_HEATING"
    CASE "40"
      RETURN "COMMAND_CLASS_THERMOSTAT_MODE"
    CASE "42"
      RETURN "COMMAND_CLASS_THERMOSTAT_OPERATING_STATE"
    CASE "43"
      RETURN "COMMAND_CLASS_THERMOSTAT_SETPOINT"
    CASE "44"
      RETURN "COMMAND_CLASS_THERMOSTAT_FAN_MODE"
    CASE "45"
      RETURN "COMMAND_CLASS_THERMOSTAT_FAN_STATE"
    CASE "46"
      RETURN "COMMAND_CLASS_CLIMATE_CONTROL_SCHEDULE"
    CASE "47"
      RETURN "COMMAND_CLASS_THERMOSTAT_SETBACK"
    CASE "50"
      RETURN "COMMAND_CLASS_BASIC_WINDOW_COVERING"
    CASE "51"
      RETURN "COMMAND_CLASS_MTP_WINDOW_COVERING"
    CASE "60"
      RETURN "COMMAND_CLASS_MULTI_INSTANCE"
    CASE "62"
      RETURN "COMMAND_CLASS_DOOR_LOCK"
    CASE "63"
      RETURN "COMMAND_CLASS_USER_CODE"
    CASE "70"
      RETURN "COMMAND_CLASS_CONFIGURATION"
    CASE "71"
      RETURN "COMMAND_CLASS_ALARM"
    CASE "72"
      RETURN "COMMAND_CLASS_MANUFACTURER_SPECIFIC"
    CASE "73"
      RETURN "COMMAND_CLASS_POWERLEVEL"
    CASE "75"
      RETURN "COMMAND_CLASS_PROTECTION"
    CASE "76"
      RETURN "COMMAND_CLASS_LOCK"
    CASE "77"
      RETURN "COMMAND_CLASS_NODE_NAMING"
    CASE "7A"
      RETURN "COMMAND_CLASS_FIRMWARE_UPDATE_MD"
    CASE "7B"
      RETURN "COMMAND_CLASS_GROUPING_NAME"
    CASE "7C"
      RETURN "COMMAND_CLASS_REMOTE_ASSOCIATION_ACTIVATE"
    CASE "7D"
      RETURN "COMMAND_CLASS_REMOTE_ASSOCIATION"
    CASE "80"
      RETURN "COMMAND_CLASS_BATTERY"
    CASE "81"
      RETURN "COMMAND_CLASS_CLOCK"
    CASE "82"
      RETURN "COMMAND_CLASS_HAIL"
    CASE "84"
      RETURN "COMMAND_CLASS_WAKE_UP"
    CASE "85"
      RETURN "COMMAND_CLASS_ASSOCIATION"
    CASE "86"
      RETURN "COMMAND_CLASS_VERSION"
    CASE "87"
      RETURN "COMMAND_CLASS_INDICATOR"
    CASE "88"
      RETURN "COMMAND_CLASS_PROPRIETARY"
    CASE "89"
      RETURN "COMMAND_CLASS_LANGUAGE"
    CASE "8A"
      RETURN "COMMAND_CLASS_TIME"
    CASE "8B"
      RETURN "COMMAND_CLASS_TIME_PARAMETERS"
    CASE "8C"
      RETURN "COMMAND_CLASS_GEOGRAPHIC_LOCATION"
    CASE "8E"
      RETURN "COMMAND_CLASS_MULTI_INSTANCE_ASSOCIATION"
    CASE "8F"
      RETURN "COMMAND_CLASS_MULTI_CMD"
    CASE "90"
      RETURN "COMMAND_CLASS_ENERGY_PRODUCTION"
    CASE "91"
      RETURN "COMMAND_CLASS_MANUFACTURER_PROPRIETARY"
    CASE "92"
      RETURN "COMMAND_CLASS_SCREEN_MD"
    CASE "93"
      RETURN "COMMAND_CLASS_SCREEN_ATTRIBUTES"
    CASE "94"
      RETURN "COMMAND_CLASS_SIMPLE_AV_CONTROL"
    CASE "95"
      RETURN "COMMAND_CLASS_AV_CONTENT_DIRECTORY_MD"
    CASE "96"
      RETURN "COMMAND_CLASS_AV_RENDERER_STATUS"
    CASE "97"
      RETURN "COMMAND_CLASS_AV_CONTENT_SEARCH_MD"
    CASE "98"
      RETURN "COMMAND_CLASS_SECURITY"
    CASE "99"
      RETURN "COMMAND_CLASS_AV_TAGGING_MD"
    CASE "9A"
      RETURN "COMMAND_CLASS_IP_CONFIGURATION"
    CASE "9B"
      RETURN "COMMAND_CLASS_ASSOCIATION_COMMAND_CONFIGURATION"
    CASE "9C"
      RETURN "COMMAND_CLASS_SENSOR_ALARM"
    CASE "9D"
      RETURN "COMMAND_CLASS_SILENCE_ALARM"
    CASE "9E"
      RETURN "COMMAND_CLASS_SENSOR_CONFIGURATION"
    CASE "EF"
      RETURN "COMMAND_CLASS_MARK"
    CASE "F0"
      RETURN "COMMAND_CLASS_NON_INTEROPERABLE"
    DEFAULT
      RETURN sByte
  END SELECT

END

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' translate generic type byte to text
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
PUBLIC SUB ExpandGenericType(iTypeGeneric AS Integer) AS String

  SELECT iTypeGeneric
    CASE GENERIC_TYPE_GENERIC_CONTROLLER
      RETURN "Generic Controller"
    CASE GENERIC_TYPE_STATIC_CONTROLLER
      RETURN "Static Controller"
    CASE GENERIC_TYPE_THERMOSTAT
      RETURN "Thermostat"
    CASE GENERIC_TYPE_SWITCH_MULTILEVEL
      RETURN "Multilevel Switch"
    CASE GENERIC_TYPE_SWITCH_REMOTE
      RETURN "Remote Switch"
    CASE GENERIC_TYPE_SWITCH_BINARY
      RETURN "Binary Switch"
    CASE GENERIC_TYPE_SENSOR_BINARY
      RETURN "Sensor Binary"
    CASE GENERIC_TYPE_WINDOW_COVERING
      RETURN "Window Covering"
    DEFAULT
      RETURN "Unknown (" & Hex(iTypeGeneric, 2) & ")"
  END SELECT

END

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' create a record with node information in database
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
PUBLIC SUB CreateNode(iNodeID AS Integer, iTypeBasic AS Integer, iTypeGeneric AS Integer, iTypeSpecific AS Integer, iCapabilities AS Integer, iSecurity AS Integer, bSleeping AS Boolean)

  DIM rResult AS Result

  ' write node to the database table
  Main.hDB.Begin()
  rResult = Main.hDB.Create("devices_zwave")
  rResult!nodeid = iNodeID
  rResult!typebasic = iTypeBasic
  rResult!typegeneric = iTypeGeneric
  rResult!typespecific = iTypeSpecific
  rResult!capabilities = iCapabilities
  rResult!security = iSecurity
  rResult!sleeping = bSleeping
  rResult.Update()
  Main.hDB.Commit()

END

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' clear nodes table from database
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
PUBLIC SUB RemoveNodes()

  Main.hDB.Exec("TRUNCATE TABLE devices_zwave")

END

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' find nodes and query them for more info
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
PUBLIC SUB QueryNodes()

  DIM rResultNodes AS Result

  rResultNodes = Main.hDB.Exec("SELECT * from devices_zwave WHERE sleeping is FALSE")
  IF rResultNodes THEN
    IF (rResultNodes.Count >= 1) THEN
      FOR EACH rResultNodes
        IF rResultNodes!nodeid <> Main.hZWave.iControllerID THEN ' we cannot query ourselves
          RequestManufacturerSpecificReport(rResultNodes!nodeid)
          RequestNodeCapabilities(rResultNodes!nodeid)
        END IF
      NEXT
    ELSE
      IF Main.bZWaveDebug THEN Main.WriteDebugLog(("[Z-Wave] No nodes found to sent query!"))
    END IF
  END IF
  RequestBasicReport(255)

END

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' update a record with manufacturers information
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
PUBLIC SUB UpdateManufacturersNode(iNodeID AS Integer, sManufacturer AS String, sModel AS String) AS Boolean

  DIM rResult AS Result

  rResult = Main.hDB.Exec("UPDATE devices_zwave SET manufacturer = &1, model = &2 WHERE nodeid = &3", sManufacturer, sModel, iNodeID)
  IF NOT rResult.Available THEN
    RETURN FALSE
  ELSE
    RETURN TRUE
  END IF

END

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' get value from node
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
PUBLIC SUB GetCurrentValueNode(iNodeID AS Integer) AS String

  DIM rResult AS Result

  rResult = Main.hDB.Exec("SELECT * FROM devices_zwave WHERE nodeid = &1", iNodeID)
  IF NOT rResult.Available THEN
    IF Main.bZWaveDebug THEN Main.WriteDebugLog(("[Z-Wave] Node with nodeid '") & iNodeID & ("' not found in database!"))
    RETURN 0
  ELSE
    RETURN rResult!value
  END IF

END

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' update a node record with value
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
PUBLIC SUB UpdateValueNode(iNodeID AS Integer, sValue AS String) AS Boolean

  DIM rResult AS Result

  rResult = Main.hDB.Exec("UPDATE devices_zwave SET value = &1 WHERE nodeid = &2", sValue, iNodeID)
  IF NOT rResult.Available THEN
    IF Main.bZWaveDebug THEN Main.WriteDebugLog(("[Z-Wave] Node with id '") & iNodeID & ("' not found in database!"))
    RETURN FALSE
  ELSE
    RETURN TRUE
  END IF

END

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' update a node record with supported classes
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
PUBLIC SUB UpdateClassesNode(iNodeID AS Integer, sClasses AS String) AS Boolean

  DIM rResult AS Result

  rResult = Main.hDB.Exec("UPDATE devices_zwave SET classes = &1 WHERE nodeid = &2", sClasses, iNodeID)
  IF NOT rResult.Available THEN
    IF Main.bZWaveDebug THEN Main.WriteDebugLog(("[Z-Wave] Node with id '") & iNodeID & ("' not found in database!"))
    RETURN FALSE
  ELSE
    RETURN TRUE
  END IF

END

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' reset led status in main status bar
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
PUBLIC SUB tZWaveLED_Timer()

  Main.ControlLed("ZWave", "Off")
  tZWaveLED.Stop

END

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' close serial port
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
PUBLIC FUNCTION Disconnect() AS Boolean

  IF bUseOZW
    OZW_Disconnect()
    RETURN
  ENDIF

  ' try to close the connection
  TRY hZWaveSer.Close
  Main.WriteLog(("Z-Wave serial port close."))

  ' all ok
  RETURN TRUE

CATCH ' some errors
  Main.WriteLog(("Z-Wave Error: ") & ERROR.Text)
  RETURN FALSE

END

''''''''''''''''''''''''''''''''''''
' OpenZWave Interface Functions
''''''''''''''''''''''''''''''''''''
PRIVATE FUNCTION OZW_Init()

  DomoZWave_Init(sPort, Main.hXMLRPC.HTTPPort)

CATCH ' some errors
  Main.WriteLog(("Z-Wave Error: ") & ERROR.Text & (" at ") & ERROR.Where)

END

PUBLIC SUB OZW_SendCommand(sAddress AS String, sCmd AS String)

  DIM ibrightness AS Integer

  sCmd = UCase(sCmd)
  IF sCmd = "ON"
    OZW_TurnNodeOn(sAddress)
  ELSE IF sCmd = "OFF"
    OZW_TurnNodeOff(sAddress)
  ELSE IF InStr(sCmd, "DIM ") THEN ' DIM 0-100
    iBrightness = Val(Replace(sCmd, "DIM ", ""))
    OZW_ChangeNodeLevel(sAddress, iBrightness)
  ELSE
    Main.WriteDebugLog(("[Z-Wave] Only DIM and ON/OFF commands are supported!"))
  ENDIF

END

PUBLIC SUB OZW_TurnNodeOn(iNodeID AS Integer)

  DomoZWave_SetNodeOn(iNodeID)

END

PUBLIC SUB OZW_TurnNodeOff(iNodeID AS Integer)

  DomoZWave_SetNodeOff(iNodeID)

END

PUBLIC SUB OZW_ChangeSwitch(iNodeID AS Integer, iLevel AS Integer)

  IF iLevel == &HFF
    OZW_TurnNodeOn(iNodeID)
  ELSE IF ilevel == &H0
    OZW_TurnNodeOff(iNodeID)
  ELSE
    OZW_ChangeNodeLevel(iNodeID, iLevel)
  ENDIF

END

PUBLIC SUB OZW_ChangeNodeLevel(iNodeID AS Integer, iLevel AS Integer)

  DomoZWave_SetNodeLevel(iNodeID, iLevel)

END

PUBLIC SUB OZW_RequestNodeState(iNodeID AS Integer)

  DomoZWave_RequestNodeState(iNodeID)

END

PUBLIC SUB OZW_RequestAllNodeStates()

  DIM rResultNodes AS Result

  rResultNodes = Main.hDB.Exec("SELECT * from devices_zwave WHERE sleeping is FALSE")
  IF rResultNodes THEN
    IF (rResultNodes.Count >= 1) THEN
      FOR EACH rResultNodes
        IF rResultNodes!nodeid <> Main.hZWave.iControllerID THEN ' we cannot query ourselves
          DomoZWave_RequestNodeState(rResultNodes!nodeid)
        ENDIF
      NEXT
    ENDIF
  ENDIF

END

PUBLIC SUB OZW_SetIds(homeId AS Integer, controllerId AS Integer)

  sHomeID = homeId
  iControllerID = controllerId

END

PUBLIC SUB OZW_BasicReport(homeId AS Integer, nodeId AS Integer, value AS Integer)

  DIM deviceId AS Integer
  DIM sValue AS String

  UpdateValueNode(nodeId, value)
  ' update value
  IF nodeId THEN
    SELECT value
      ' on/off/dim etc
      CASE 255
      CASE 99
        sValue = "On"
      CASE 0
        sValue = "Off"
      DEFAULT
        sValue = "Dim " & value
    END SELECT
    deviceId = Devices.Find(nodeId, Devices.FindInterface("Z-Wave Controller"), "Z-Wave Device")
    Devices.ValueUpdate(deviceId, sValue, "", "", "")
  ENDIF

END

PUBLIC SUB OZW_AllQueried()

  DIM rResultNodes AS Result

  rResultNodes = Main.hDB.Exec("SELECT * from devices_zwave WHERE sleeping is FALSE")
  IF rResultNodes THEN
    IF (rResultNodes.Count >= 1) THEN
      FOR EACH rResultNodes
        IF rResultNodes!nodeid <> Main.hZWave.iControllerID THEN ' we cannot query ourselves
          DomoZWave_EnablePolling(rResultNodes!nodeid)
        ENDIF
      NEXT
    ENDIF
  ENDIF

END

PUBLIC FUNCTION OZW_Disconnect() AS Boolean

  DomoZWave_Destroy()

END

' implement properties
FUNCTION Port_Read() AS String

  RETURN sPort

END

SUB Port_Write(Value AS String)

  sPort = Value

END

PRIVATE FUNCTION Baud_Read() AS String

  RETURN sBaud

END

PRIVATE SUB Baud_Write(Value AS String)

  sBaud = Value

END

PRIVATE FUNCTION ZWaveDebug_Read() AS Boolean

  RETURN bZWaveDebug

END

PRIVATE SUB ZWaveDebug_Write(Value AS Boolean)

  bZWaveDebug = Value

END

PRIVATE FUNCTION ReloadNodes_Read() AS Boolean

  RETURN bReloadNodes

END

PRIVATE SUB ReloadNodes_Write(Value AS Boolean)

  bReloadNodes = Value

END

PRIVATE FUNCTION UseOZW_Read() AS Boolean

  RETURN bUseOZW

END

PRIVATE SUB UseOZW_Write(Value AS Boolean)

  bUseOZW = Value

END