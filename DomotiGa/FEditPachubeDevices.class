' Gambas class file

' Description:
' FEditPachubeDevices.class
' Support for creating and edit pachube devices.

' Development Status:
' Finished and working.

' DomotiGa - an open source home automation program.
' Copyright(C) 2008-2009 Ron Klinkien

' Read file called COPYING for license details.

PUBLIC rResult AS Result
PUBLIC rResultDevices AS Result
PUBLIC bAddDevice AS Boolean

PUBLIC SUB Form_Open()

  ME.Move(FMain.X + 50, FMain.Y + 70)
  LoadPachubeDevice()

END

PUBLIC SUB LoadPachubeDevice()

  DIM iId AS Integer

  ' fill combo with available devices
  cmbDevices.Add("")
  rResultDevices = Main.hDB.Exec("SELECT * FROM devices WHERE enabled is TRUE")
  IF rResultDevices.Available THEN
    IF rResultDevices.Count THEN
      FOR EACH rResultDevices
        cmbDevices.Add(rResultDevices!name)
      NEXT
    END IF
  ELSE
    Message.Info(("Error: couldn't find devices details!"))
    RETURN
  END IF

  TRY iId = FSettingsPachube.tbvPachubeDevices[FSettingsPachube.iCurRow, 0].Text
  IF NOT ERROR THEN
    ' get values
    rResult = Main.hDB.Exec("SELECT * FROM devices_pachube WHERE id = &1", iId)
    IF rResult.Count >= 1 THEN
      txtID.Text = rResult!datastreamid
      cmbDevices.Text = rResult!devicename
      txtTags.Text = rResult!tags
      txtUnits.Text = rResult!units
      SELECT CASE rResult!value
        CASE 2
          cmbValue.Text = ("Value2")
        CASE 3
          cmbValue.Text = ("Value3")
        CASE 4
          cmbValue.Text = ("Value4")
        CASE ELSE
          cmbValue.Text = ("Value")
      END SELECT
      cmbLabel.Text = rResult!devicelabel
      cmbUnitType.Text = rResult!unittype
    END IF
  ELSE
    bAddDevice = TRUE
  END IF
  FillExample()

END

PUBLIC SUB btnCancel_Click()

  ME.Close

END

PUBLIC SUB btnDelete_Click()

  Main.hDB.Exec("DELETE FROM devices_pachube WHERE id = &1", rResult!id)
  ME.Close
  FSettingsPachube.FillPachubeDevices()

END

PUBLIC SUB btnSave_Click()

  DIM rResultUpdate AS Result
  DIM iId AS Integer

  IF NOT ValidInput() THEN RETURN

  iId = GetDeviceId(cmbDevices.Text)

  IF bAddDevice THEN
    Main.hDB.Begin()
    rResult = Main.hDB.Create("devices_pachube")
    rResult!datastreamid = txtID.Text
    rResult!tags = txtTags.Text
    rResult!devicename = cmbDevices.Text
    rResult!deviceid = iId
    rResult!devicelabel = cmbLabel.Text
    rResult!value = cmbValue.Index
    rResult!units = txtUnits.Text
    rResult!unittype = cmbUnitType.Text
    rResult.Update()
    Main.hDB.Commit()
    bAddDevice = FALSE
  ELSE
    ' save new bwired device settings
    rResultUpdate = Main.hDB.Exec("UPDATE devices_pachube SET tags = &1, devicename = &2, deviceid = &3, devicelabel = &4, value = &5, datastreamid = &6, units = &7, unittype = &8 WHERE id = &9", txtTags.Text, cmbDevices.Text, iId, cmbLabel.Text, cmbValue.Index, txtID.Text, txtUnits.Text, cmbUnitType.Text, rResult!id)
  END IF
  ME.Close
  FSettingsPachube.FillPachubeDevices()

END

PUBLIC SUB GetDeviceId(sName AS String) AS Integer

  DIM rDevice AS Result

  TRY rDevice = Main.hDB.Exec("SELECT id FROM devices WHERE name = &1", sName)
  IF rDevice.Count THEN
    RETURN rDevice!id
  END IF

END

PUBLIC SUB txtTags_KeyPress()

  btnSave.Enabled = TRUE

END

PUBLIC SUB cmbDevices_Click()

  btnSave.Enabled = TRUE
  FillExample()

END

PUBLIC SUB cmbValue_Click()

  btnSave.Enabled = TRUE
  FillExample()

END

PRIVATE SUB ValidInput() AS Boolean

  IF NOT txtID.Text THEN
    Balloon(("Please enter a datastream ID!"), txtID)
    RETURN FALSE
  END IF
  IF NOT txtTags.Text THEN
    Balloon(("Please enter a description!"), txtID)
    RETURN FALSE
  END IF
  IF NOT cmbDevices.Text THEN
    Balloon(("Please select a device!"), cmbDevices)
    RETURN FALSE
  END IF
  IF NOT cmbValue.Text THEN
    Balloon(("Please select a value field!"), cmbValue)
    RETURN FALSE
  END IF
  RETURN TRUE

END

PUBLIC SUB btnAdd_Click()

  bAddDevice = TRUE
  btnSave_Click()

END

PUBLIC SUB FillExample()

  DIM iId AS Integer

  IF cmbValue.Text AND cmbDevices.Text THEN 
    iId = GetDeviceId(cmbDevices.Text)
    IF iId THEN
      SELECT cmbValue.Text
        CASE "Value"
          txtDeviceValue.Text = Devices.GetCurrentValueForDevice(iId) & " " & cmbLabel.Text
        CASE "Value2"
          txtDeviceValue.Text = Devices.GetCurrentValue2ForDevice(iId) & " " & cmbLabel.Text
        CASE "Value3"
          txtDeviceValue.Text = Devices.GetCurrentValue3ForDevice(iId) & " " & cmbLabel.Text
        CASE "Value4"
          txtDeviceValue.Text = Devices.GetCurrentValue3ForDevice(iId) & " " & cmbLabel.Text
      END SELECT
    END IF
  END IF

END

PUBLIC SUB cmbLabel_Click()

  btnSave.Enabled = TRUE
  FillExample()

END

PUBLIC SUB cmbLabel_Change()

  btnSave.Enabled = TRUE
  FillExample()

END

PUBLIC SUB txtUnits_KeyPress()

  btnSave.Enabled = TRUE

END

PUBLIC SUB cmbUnitType_Change()

  btnSave.Enabled = TRUE

END
