' Gambas class file

' Description:
' FDatabaseMaint.class
' Support to backup db or delete some tables, use with care!

' Development Status:
' Finished, make backup async/background job.

' DomotiGa - an open source home automation program.
' Copyright(C) 2008 Ron Klinkien

' Read file called COPYING for license details.

PUBLIC SUB Form_Open()

  ME.Move(FMain.X + 50, FMain.Y + 70)

END

PUBLIC SUB btnClose_Click()

  ME.Close

END

PUBLIC SUB YesNo(sText AS String) AS Boolean

  SELECT Message.Question(sText, "Yes", "No")
    CASE 1
    SELECT Message.Question("Last Time: " & sText, "Yes", "No")
    CASE 1
      RETURN TRUE
    END SELECT
    RETURN FALSE
  END SELECT
  RETURN FALSE

END

PUBLIC SUB btnDelCaptures_Click()

  IF YesNo("Are you very sure that you want to Erase all the Captured images?") THEN
    VideoServer.InitTables()
  END IF

END

PUBLIC SUB btnDelPowerUsage_Click()

  IF YesNo("Are you very sure that you want to Erase all Power Usage history?") THEN
    Energy.InitTable()
  END IF

END

PUBLIC SUB btnDelDevices_Click()

  IF YesNo("Are you very sure that you want to Erase all Devices?") THEN
    Devices.InitTable()
  END IF

END

PUBLIC SUB btnBackupDB_Click()

  DIM sExt AS String[]

  ' only show sql or compressed files
  Dialog.Filter = ["*.tar.gz", "MySQL Backup Files Compressed", "*.sql", "MySQL Backup Files"]
  Dialog.Title = "Backup Database"
  Dialog.Path = User.Home &/ Lower(Application.Name) & "-" & Format$(Now(), "yyyy-mm-dd") & ".sql.tar.gz"

  IF NOT (Dialog.SaveFile() = TRUE) THEN
    ' set program status to busy
    INC Application.Busy
    ' save backup to temp file first
    SHELL "mysqldump -u " & Main.sSQLUser & " --routines --password=" & Main.sSQLPass & " --databases " & Main.sSQLDatabase & " > " & "/tmp" &/ Lower(Application.Name) & ".sql" WAIT

    ' check selected extension
    sExt = Split(Dialog.Path, ".")
    IF (Lower$(sExt[sExt.count - 1]) = "gz") THEN
      ' compress file
      SHELL "tar -cvzf " & Dialog.Path & " -C /tmp " & Lower(Application.Name) & ".sql >/dev/null" WAIT
    ELSE
      ' copy file
      SHELL "cp " & "/tmp" &/ Lower(Application.Name) & ".sql " & Dialog.Path 
    END IF
    SHELL "rm " & "/tmp" &/ Lower(Application.Name) & ".sql"
    ' set program status to free
    DEC Application.Busy
    Message.Info("Database Backup Finished!")
  END IF

END

PUBLIC SUB btnDelContacts_Click()

  IF YesNo("Are you very sure that you want to Erase all Contacts?") THEN
    FEditContacts.InitTable()
  END IF

END
