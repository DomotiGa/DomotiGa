' Gambas class file

' Description:
' FLocations.class
' Display devices locations.

' Development Status:
' Just started.

' DomotiGa - an open source home automation program.
' Copyright(C) 2008 Ron Klinkien

' Read file called COPYING for license details.

PRIVATE cLocations AS Collection
PRIVATE sLocation AS String
PRIVATE tRefresh AS Timer

PUBLIC SUB Form_Open()

  PopulateButtons()
  RefreshPage()

  ' create refresh timer
  tRefresh = NEW Timer AS "tRefresh"
  tRefresh.Delay = 30000 ' 30 seconds
  tRefresh.Start

END

PUBLIC SUB Form_Close()

  tRefresh.Stop

END

PUBLIC SUB Form_Resize()

  vbLocations.Width = 86
  vbLocations.Height = ME.Height - 10
  svLocation.Move(100, 5, ME.ClientWidth - 108, ME.ClientHeight - 18)

END

PUBLIC SUB PopulateButtons()

  DIM rDevice AS Result
  DIM rLocation AS Result
  DIM hButton AS Button
  DIM sLocation AS String

  cLocations = NEW Collection

  TRY rDevice = Main.hDB.Exec("SELECT * FROM devices")
  IF rDevice.Count THEN
    FOR EACH rDevice
      TRY rLocation = Main.hDB.Exec("SELECT * FROM locations WHERE id='" & rDevice!location & "'")
      IF rLocation.Count THEN
        IF NOT rLocation!name THEN CONTINUE
        ' get unique list of used location
        cLocations.Add(rLocation!name, rLocation!id)
      END IF
    NEXT
  END IF
  FOR EACH sLocation IN cLocations
    hButton = NEW Button(vbLocations) AS "LocationButton"
     WITH hButton
    .Text = sLocation
    .Height = 28
    .Width = 84
    .Tag = sLocation
    .Font = Font["Sans Serif, 7, Normal"]
    END WITH
  NEXT
END

PUBLIC SUB LocationButton_Click()

  sLocation = LAST.Tag
  Main.DisplayLocation(sLocation, FLocations.vpnlLocation)

END

PUBLIC SUB RefreshPage()

  IF NOT sLocation THEN RETURN 

  Main.DisplayLocation(sLocation, FLocations.vpnlLocation)

END

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' refresh contents
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
PUBLIC SUB tRefresh_Timer()

  RefreshPage()

END

PUBLIC SUB btnRefresh_Click()

  RefreshPage()

END
