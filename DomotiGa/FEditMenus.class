' Gambas class file

' Description:
' FMenuEditor.class
' Edit program menu's.

' Development Status:
' Just build, possibly bugs ahead.

' DomotiGa - an open source home automation program.
' Copyright (C) Ron Klinkien, The Netherlands.

' Read file called COPYING for license details.

PUBLIC hToolButton AS ToolButton
PUBLIC iId AS Integer

PUBLIC SUB Form_Open()

  ME.Move(FMain.X + 50, FMain.Y + 70)
  FillCombo()
  RefreshMenu()

END

PUBLIC SUB RefreshMenu()

  DIM rResult, rResultMenu, rResultLocation AS Result
  DIM iCount, iPanel AS Integer

  VBoxAvailMenu1.Height = 0
  VBoxAvailMenu2.Height = 0
  VBoxAvailMenu3.Height = 0
  VBoxAvailMenu4.Height = 0

  ' fill combo with available locations
  rResultLocation = Main.hDB.Exec("SELECT * FROM locations")
  IF rResultLocation THEN
    FOR EACH rResultLocation
      cmbLocation.Add(rResultLocation!name)
    NEXT
  ENDIF
  ' fill combo with available menu names
  rResultMenu = Main.hDB.Exec("SELECT * FROM menu_names")
  IF rResultMenu THEN
    IF (rResultMenu.Count >= 1) THEN
      FOR EACH rResultMenu
        ToolPanelAvail[iPanel].Text = rResultMenu!name
        SELECT iPanel
          CASE 0
            txtMenu1.Text = rResultMenu!name
          CASE 1
            txtMenu2.Text = rResultMenu!name
          CASE 2
            txtMenu3.Text = rResultMenu!name
          CASE 3
            txtMenu4.Text = rResultMenu!name
        END SELECT
        rResult = Main.hDB.Exec("SELECT * FROM menu WHERE menu = &1 ORDER BY position", rResultMenu!id)
        IF NOT rResult THEN
          Message.Info(("Error: table 'menu' not found!"))
          RETURN
        END IF
        FOR iCount = 0 TO rResult.Max
          IF rResult!menu = 1 THEN
            hToolButton = NEW ToolButton(VBoxAvailMenu1) AS "AvailToolButton"
            VBoxAvailMenu1.Height = VBoxAvailMenu1.Height + 42
          ELSE IF rResult!menu = 2 THEN
            hToolButton = NEW ToolButton(VBoxAvailMenu2) AS "AvailToolButton"
            VBoxAvailMenu2.Height = VBoxAvailMenu2.Height + 42
          ELSE IF rResult!menu = 3 THEN
            hToolButton = NEW ToolButton(VBoxAvailMenu3) AS "AvailToolButton"
            VBoxAvailMenu3.Height = VBoxAvailMenu3.Height + 42
          ELSE
            hToolButton = NEW ToolButton(VBoxAvailMenu4) AS "AvailToolButton"
            VBoxAvailMenu4.Height = VBoxAvailMenu4.Height + 42
          END IF
          WITH hToolButton
            .Name = rResult!id
            .Text = rResult!name
            .Background = Color.TextBackground
            IF NOT rResult!enabled THEN .Foreground = Color.LightGray
            .Font = Font["-1"]
            .Height = 42
            .Width = 111
            .Picture = Picture["images" &/ rResult!icon]
            .Tag = rResult!id
          END WITH
          rResult.MoveNext
        NEXT
        INC iPanel
      NEXT
    ELSE
      Message(("No menu names found!"))
    END IF
  ELSE
    Message.Info(("Error: table 'menu_names' not found!"))
  END IF

END

PUBLIC SUB FillCombo()

  DIM rResultMenu AS Result

  rResultMenu = Main.hDB.Exec("SELECT * FROM menu_names")
  IF rResultMenu THEN
    IF (rResultMenu.Count >= 1) THEN
      FOR EACH rResultMenu
        cmbMenus.Add(rResultMenu!name)
      NEXT
    END IF
  END IF

END

PUBLIC SUB AvailToolbutton_Click()

  DIM rResult, rResultMenu AS Result

  iId = LAST.tag
  ' get values
  rResult = Main.hDB.Exec("SELECT * FROM menu WHERE id = &1", iId)
  IF rResult.Count >= 1 THEN
    txtName.Text = rResult!name
    TRY rResultMenu = Main.hDB.Exec("SELECT name FROM menu_names WHERE id = &1", rResult!menu)
    IF NOT ERROR THEN cmbMenus.Text = rResultMenu!name
    txtPosition.Text = rResult!position
    cmbVisible.Text = Main.DisplayBool(rResult!enabled)
  END IF

END

PUBLIC SUB AvailToolbutton_DblClick()

  DIM rResult AS Result

  iId = LAST.tag
  ' get values
  rResult = Main.hDB.Exec("SELECT * FROM menu WHERE id = &1", iId)
  IF rResult.Count >= 1 THEN
    FMain.OpenMenu(rResult!item)
  END IF

END

PUBLIC SUB SaveMenuItem()

  DIM rResultUpdate AS Result

  ' save new menu settings
  rResultUpdate = Main.hDB.Exec("UPDATE menu_names SET name = &1 WHERE id = 1", txtMenu1.Text)
  rResultUpdate = Main.hDB.Exec("UPDATE menu_names SET name = &1 WHERE id = 2", txtMenu2.Text)
  rResultUpdate = Main.hDB.Exec("UPDATE menu_names SET name = &1 WHERE id = 3", txtMenu3.Text)
  rResultUpdate = Main.hDB.Exec("UPDATE menu_names SET name = &1 WHERE id = 4", txtMenu4.Text)
  rResultUpdate = Main.hDB.Exec("UPDATE menu SET menu = &1, position = &2, enabled = &3, name = &4 WHERE id = &5", GetMenuId(cmbMenus.Text), txtPosition.Text, GetVisible(), txtName.Text, iId)

END

PUBLIC SUB GetMenuId(sMenu AS String) AS Integer

  DIM rResultMenu AS Result

  TRY rResultMenu = Main.hDB.Exec("SELECT id FROM menu_names WHERE name = &1", sMenu)
  IF NOT ERROR THEN RETURN rResultMenu!id

END

PUBLIC SUB GetVisible() AS Boolean

  IF cmbVisible.Text = "True" THEN
    RETURN TRUE
  ELSE
    RETURN FALSE
  END IF

END

PUBLIC SUB btnSave_Click()

  DIM oObject AS Object

  SaveMenuItem()

  ' delete previous menu items first
  FOR EACH oObject IN VBoxAvailMenu1.Children
    oObject.Delete()
  NEXT
  FOR EACH oObject IN VBoxAvailMenu2.Children
    oObject.Delete()
  NEXT
  FOR EACH oObject IN VBoxAvailMenu3.Children
    oObject.Delete()
  NEXT
  FOR EACH oObject IN VBoxAvailMenu4.Children
    oObject.Delete()
  NEXT
  RefreshMenu()

  ' delete previous menu items first
  FOR EACH oObject IN FMain.VBoxMenu1.Children
    oObject.Delete()
  NEXT
  FOR EACH oObject IN FMain.VBoxMenu2.Children
    oObject.Delete()
  NEXT
  FOR EACH oObject IN FMain.VBoxMenu3.Children
    oObject.Delete()
  NEXT
  FOR EACH oObject IN FMain.VBoxMenu4.Children
    oObject.Delete()
  NEXT
  FMain.RefreshMenu()

END

PUBLIC SUB btnClose_Click()

  ME.Close

END

PUBLIC SUB cmbMenus_Change()

  btnSave.Enabled = TRUE

END

PUBLIC SUB txtPosition_Change()

  btnSave.Enabled = TRUE

END

PUBLIC SUB cmbVisible_Change()

  btnSave.Enabled = TRUE

END

PUBLIC SUB txtMenu1_Change()

  btnSave.Enabled = TRUE

END

PUBLIC SUB txtMenu2_Change()

  btnSave.Enabled = TRUE

END

PUBLIC SUB txtMenu3_Change()

  btnSave.Enabled = TRUE

END

PUBLIC SUB txtMenu4_Change()

  btnSave.Enabled = TRUE

END
