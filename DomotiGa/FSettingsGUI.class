' Gambas class file

' Description:
' FSettingsGUI.class
' Settings form for GUI related items.

' Development Status:
' Works.

' DomotiGa - an open source home automation program.
' Copyright (C) Ron Klinkien, The Netherlands.

' Read file called COPYING for license details.

PRIVATE bRestartClicked AS Boolean

PUBLIC SUB Form_Open()

  ME.Move(FMain.X + 50, FMain.Y + 70)

  txtLogBuffer.Text = Main.iLogBuffer
  chkAuth.Value = Main.bAuthEnabled
  cmbStartPage.Text = Main.sStartpage
  txtXMLRPCHost.Text = Main.sXMLRPCHost
  txtXMLRPCPort.Text = Main.iXMLRPCPort
  txtGraphsUrl.Text = Main.sGraphsUrl

  IF Main.bServerCurrent THEN
    cmbProgramMode.Text = ("Server")
  ELSE
    cmbProgramMode.Text = ("Client")
  END IF
  EnableXMLRPCFields()
  SELECT CASE Main.sLanguage
    CASE "en_US.UTF-8"
      cmbLanguage.Text = ("English")
      pbLanguage.Picture = Picture["icons/en.png"]
    CASE "nl_NL.UTF-8"
      cmbLanguage.Text = ("Dutch")
      pbLanguage.Picture = Picture["icons/nl.png"]
    CASE "fr_FR.UTF-8"
      cmbLanguage.Text = ("French")
      pbLanguage.Picture = Picture["icons/fr.png"]
    CASE "de_DE.UTF-8"
      cmbLanguage.Text = ("German")
      pbLanguage.Picture = Picture["icons/de.png"]
    CASE "ru_RU.UTF-8"
      cmbLanguage.Text = ("Russian")
      pbLanguage.Picture = Picture["icons/ru.png"]
  END SELECT

  btnSave.Enabled = FALSE

END

PUBLIC SUB btnCancel_Click()

  ME.Close

END

PUBLIC SUB btnDefaults_Click()

  DIM rResult AS Result

  rResult = Main.GetSettingTable("main", TRUE) ' get defaults
  IF rResult.Count THEN
    txtLogBuffer.text = rResult!logbuffer
    chkAuth.Value = rResult!authentication
    cmbStartPage.Text = rResult!startpage
  END IF
  btnSave.Enabled = TRUE

END

PUBLIC SUB cmbStartPage_Click()

  btnSave.Enabled = TRUE

END

PUBLIC SUB EnableXMLRPCFields()

  IF cmbProgramMode.Index = 0 THEN
    txtXMLRPCHost.Enabled = FALSE
    txtXMLRPCPort.Enabled = FALSE
  ELSE
    txtXMLRPCHost.Enabled = TRUE
    txtXMLRPCPort.Enabled = TRUE
  END IF

END

PUBLIC SUB cmbProgramMode_Click()

  EnableXMLRPCFields()
  bRestartClicked = TRUE
  btnSave.Enabled = TRUE

END

PUBLIC SUB chkAuth_Click()

  btnSave.Enabled = TRUE

END

PUBLIC SUB txtLogBuffer_KeyPress()

  btnSave.Enabled = TRUE

END

PUBLIC SUB btnSave_Click()

  DIM rResult AS Result

  ' save new settings
  rResult = Main.hDB.Exec("UPDATE settings_main SET logbuffer = &1, authentication = &2, startpage = &3 WHERE id = 1", txtLogBuffer.Text, chkAuth.Value, cmbStartPage.Text)
  SELECT CASE cmbLanguage.Index
    CASE 0
      Main.sLanguage = "en_US.UTF-8"
      pbLanguage.Picture = Picture["icons/en.png"]
    CASE 1
      Main.sLanguage = "nl_NL.UTF-8"
      pbLanguage.Picture = Picture["icons/nl.png"]
    CASE 2
      Main.sLanguage = "fr_FR.UTF-8"
      pbLanguage.Picture = Picture["icons/fr.png"]
    CASE 3
      Main.sLanguage = "de_DE.UTF-8"
      pbLanguage.Picture = Picture["icons/de.png"]
    CASE 4
      Main.sLanguage = "ru_RU.UTF-8"
      pbLanguage.Picture = Picture["icons/ru.png"]
  END SELECT
  SELECT CASE cmbProgramMode.index
    CASE 0
      Main.bServerCurrent = TRUE
    CASE 1
      Main.bServerCurrent = FALSE
  END SELECT
  Main.sXMLRPCHost = txtXMLRPCHost.Text
  Main.iXMLRPCPort = txtXMLRPCPort.Text
  Main.sGraphsUrl = txtGraphsUrl.Text
  Main.SetConfig()
  rResult = Main.GetSettingTable("main") ' reload settings
  Main.iLogBuffer = rResult!logbuffer
  Main.bAuthEnabled = rResult!authentication
  Main.sStartPage = rResult!startpage
  Main.GetConfig()
  IF bRestartClicked THEN Message.Info(("You need to restart DomotiGa to activate changes."))

  ME.Close

END

PUBLIC SUB cmbLanguage_Click()

  btnSave.Enabled = TRUE
  SELECT CASE cmbLanguage.Index
    CASE 0
      pbLanguage.Picture = Picture["icons/en.png"]
    CASE 1
      pbLanguage.Picture = Picture["icons/nl.png"]
    CASE 2
      pbLanguage.Picture = Picture["icons/fr.png"]
    CASE 3
      pbLanguage.Picture = Picture["icons/de.png"]
    CASE 4
      pbLanguage.Picture = Picture["icons/ru.png"]
  END SELECT
  bRestartClicked = TRUE

END

PUBLIC SUB txtXMLRPCHost_KeyPress()

  btnSave.Enabled = TRUE

END

PUBLIC SUB txtXMLRPCPort_KeyPress()

  btnSave.Enabled = TRUE

END

PUBLIC SUB txtGraphsUrl_KeyPress()

  btnSave.Enabled = TRUE

END
