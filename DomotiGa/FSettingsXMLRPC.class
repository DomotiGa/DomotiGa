' Gambas class file

' Description:
' FSettingsXMLRPC.class
' Settings form for XMLRPC server support.

' Development Status:
' Just started, needs Gambas patch (RpcServer.class)

' DomotiGa - an open source home automation program.
' Copyright(C) 2008 Ron Klinkien

' Read file called COPYING for license details.

PUBLIC SUB Form_Open()

  ME.Move(FMain.X + 50, FMain.Y + 70)

  txtMaxConn.Text = Main.iXMLRPCMaxConn
  txtHTTPPort.Text = Main.iXMLRPCHTTPPort
  chkDebug.Value = Main.bXMLRPCDebug
  chkEnabled.Value = Main.bXMLRPCEnabled
  btnSave.Enabled = FALSE

  IF Main.bXMLRPCEnabled = FALSE THEN
    txtMaxConn.Enabled = FALSE
    txtHTTPPort.Enabled = FALSE
    chkDebug.Enabled = FALSE
  END IF

END

PUBLIC SUB btnSave_Click()

  DIM rResult AS Result

  IF chkEnabled.Value AND CheckReq() THEN
    Message.Info("You need Gambas version 2.12 or higher to use XML-RPC.\nAnd you are running version " & Main.GetGambasVersion() & ". XML-RPC disabled.")
    chkEnabled.Value = FALSE
  END IF

  ' save new XMLRPC settings
  rResult = Main.hDB.Exec("UPDATE settings_xmlrpc SET debug = &1, maxconn = &2, httpport = &3, enabled = &4 WHERE id = 1", chkDebug.Value, txtMaxConn.Text, txtHTTPPort.Text, chkEnabled.Value)
  rResult = Main.GetSettingTable("xmlrpc") ' reload settings
  IF rResult.Count THEN
    Main.bXMLRPCEnabled = rResult!enabled
    Main.iXMLRPCMaxConn = rResult!maxconn
    Main.iXMLRPCHTTPPort = rResult!httpport
    Main.bXMLRPCDebug = rResult!debug
  END IF
  Main.Restart_XMLRPC()

  ME.Close

END

PUBLIC SUB btnCancel_Click()

  ME.Close

END

PUBLIC SUB chkDebug_Click()

  btnSave.Enabled = TRUE

END

PUBLIC SUB btnDefaults_Click()

  DIM rResult AS Result

  rResult = Main.GetSettingTable("xmlrpc", TRUE) ' get defaults
  IF rResult.Count THEN
    chkEnabled.Value = rResult!enabled
    txtMaxConn.text = rResult!maxconn
    txtHTTPPort.text = rResult!httpport
    chkDebug.Value = rResult!debug
  END IF
  btnSave.Enabled = TRUE

END

PUBLIC SUB chkEnabled_Click()

  txtMaxConn.Enabled = chkEnabled.Value
  txtHTTPPort.Enabled = chkEnabled.Value
  chkDebug.Enabled = chkEnabled.Value
  btnSave.Enabled = TRUE

END

PUBLIC SUB txtMaxConn_KeyPress()

  btnSave.Enabled = TRUE

END

PUBLIC SUB txtHTTPPort_KeyPress()

  btnSave.Enabled = TRUE

END

PRIVATE SUB CheckReq() AS Boolean

  DIM iVer AS Integer

  iVer = Val(Replace(Main.GetGambasVersion(), ".", ""))
  IF iVer >= 212 THEN
    RETURN FALSE
  ELSE
    RETURN TRUE
  END IF

END
