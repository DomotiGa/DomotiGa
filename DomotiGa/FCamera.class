' Gambas class file

' Description:
' FCameraControl.class
' Support for VISCA and Axis PTZ camera control, see CVISCA.class for more.

' Development Status:
' GUI design and code finished, needs better error checking.

' DomotiGa - an open source home automation program.
' Copyright(C) 2008-2011 Ron Klinkien

' Read file called COPYING for license details.

PUBLIC bPowerState AS Boolean = TRUE
PUBLIC bBacklight AS Boolean = FALSE

PRIVATE rCamera AS Result
PRIVATE hProcess AS Process
PRIVATE oObject AS Object
PUBLIC hFetch AS HttpClient

PUBLIC SUB Form_Close()

  IF hProcess THEN
    PRINT #hProcess, "q";
  END IF

END

PUBLIC SUB Form_Open()

  IF Main.hVISCA THEN
    rbPresetRecall.Value = TRUE
    rbPresetSet.Value = FALSE
    rbPresetReset.Value = FALSE
    IF Main.bVISCAEnabled THEN Main.hVISCA.AddressSet()
  ELSE
    DisableControls()
  END IF
  FillCameraCombo()

END

PRIVATE SUB DisableControls()

  ' no connection to camera, or disabled so disable control buttons
  FOR EACH oObject IN ME.Children
    oObject.Enabled = FALSE
  NEXT
  frameStream.Enabled = TRUE
  FOR EACH oObject IN frameStream.Children
    oObject.Enabled = TRUE
  NEXT
  frameCamera.Enabled = TRUE
  FOR EACH oObject IN frameCamera.Children
    oObject.Enabled = TRUE
  NEXT

END

PUBLIC SUB cmbCameras_Click()

  TRY rCamera = Main.hDB.Exec("SELECT * FROM devices_camera WHERE name = &1", cmbCameras.Text)
  IF NOT ERROR THEN lblView.Text = rCamera!viewstring

END

PRIVATE SUB FillCameraCombo()

  DIM iCount AS Integer
  DIM rResult AS Result

  rResult = Main.hDB.Exec("SELECT * FROM devices_camera WHERE enabled is TRUE")
  IF rResult.Available THEN
    FOR iCount = 0 TO rResult.Max
      cmbCameras.Add(rResult!name)
      rResult.MoveNext
    NEXT
  ELSE
    btnOpen.Enabled = FALSE
  END IF
  cmbCameras_Click()

END

PUBLIC SUB btnOpen_Click()

  DIM sCmd AS String

  IF NOT Main.ProgramExist("mplayer") THEN
    lblStatus.Text = ("Couldn't find mplayer command, did you install it?")
    RETURN
  END IF

  IF hProcess THEN
    PRINT #hProcess, "q";
    btnOpen.Text = ("View")
    lblMoviePlayer.Hide
    cmbCameras.Enabled = TRUE
    RETURN
  END IF
  btnOpen.Text = ("Stop")
  lblStatus.Text = ("Opening, please wait ...")
  cmbCameras.Enabled = FALSE

  ' enable PTZ functions if needed
  SELECT CASE rCamera!ptztype
    CASE "AXIS API"
      DisableControls()
      frameDirection.Enabled = TRUE
      FOR EACH oObject IN frameDirection.Children
        oObject.Enabled = TRUE
      NEXT
      frameZoom.Enabled = TRUE
      FOR EACH oObject IN frameZoom.Children
        oObject.Enabled = TRUE
      NEXT
      frameBacklight.Enabled = TRUE
      FOR EACH oObject IN frameBacklight.Children
        oObject.Enabled = TRUE
      NEXT
      frameSpeed.Enabled = TRUE
      FOR EACH oObject IN frameSpeed.Children
        oObject.Enabled = TRUE
      NEXT
      slZoom.MaxValue = 9999
      slZoom.Step = 500
      slPan.MaxValue = 180
      slPan.MinValue = -180
      slPan.Step = 20
      slPan.Value = 0
      slTilt.MaxValue = 180
      slTilt.MinValue = -180
      slTilt.Step = 20
      slTilt.Value = 0
      slTilt.Enabled = TRUE
      slPan.Enabled = TRUE
      slPanSpeed.MaxValue = 100
      slPanSpeed.MinValue = 1
      slPanSpeed.Step = 10
      slTiltSpeed.Enabled = FALSE
    CASE "Sony VISCA"
      slZoom.MaxValue = 8
      slZoom.Step = 1
      slPan.MaxValue = 18
      slPan.MinValue = 1
      slPan.Step = 1
      slTilt.MaxValue = 14
      slTilt.MinValue = 1
      slTilt.Step = 1
      slTilt.Enabled = TRUE
      slPan.Enabled = TRUE
    CASE ELSE
      DisableControls()
  END SELECT

  lblMoviePlayer.Show
  lblMoviePlayer.Enabled = FALSE

  SELECT CASE rCamera!type
    CASE "Video4Linux"
      sCmd = "mplayer -wid " & lblMoviePlayer.Handle & " " & rCamera!cmdoptions
      hProcess = SHELL sCmd FOR READ WRITE AS "PlayerProcess"
    CASE "Stream MJPEG"
      sCmd = "mplayer -wid " & lblMoviePlayer.Handle & IIf(Len(rCamera!username) OR Len(rCamera!passwd), " -user " & rCamera!username & " -passwd " & rCamera!passwd, "") & " " & rCamera!cmdoptions & " " & rCamera!viewstring 
      hProcess = SHELL sCmd FOR READ WRITE AS "PlayerProcess"
    CASE ELSE
      lblStatus.Text = ("Unknown camera type!")
      btnOpen.Text = ("View")
      cmbCameras.Enabled = TRUE
      RETURN
  END SELECT
  Main.WriteDebugLog("[Cameras] " & sCmd)

END

PRIVATE SUB PTZControl(sCmd AS String) AS Boolean

  DIM sUrl AS String

  IF rCamera!ptztype = "Sony VISCA" AND IF Main.hVISCA THEN
    SELECT CASE LCase(sCmd)
      CASE "up"
        Main.hVISCA.Direction("up", FCamera.slPanSpeed.Value, FCamera.slTiltSpeed.Value)
      CASE "down"
        Main.hVISCA.Direction("down", FCamera.slPanSpeed.Value, FCamera.slTiltSpeed.Value)
      CASE "left"
        Main.hVISCA.Direction("left", FCamera.slPanSpeed.Value, FCamera.slTiltSpeed.Value)
      CASE "right"
        Main.hVISCA.Direction("right", FCamera.slPanSpeed.Value, FCamera.slTiltSpeed.Value)
      CASE "upleft"
        Main.hVISCA.Direction("upleft", FCamera.slPanSpeed.Value, FCamera.slTiltSpeed.Value)
      CASE "upright"
        Main.hVISCA.Direction("upright", FCamera.slPanSpeed.Value, FCamera.slTiltSpeed.Value)
      CASE "downleft"
        Main.hVISCA.Direction("downleft", FCamera.slPanSpeed.Value, FCamera.slTiltSpeed.Value)
      CASE "downright"
        Main.hVISCA.Direction("downright", FCamera.slPanSpeed.Value, FCamera.slTiltSpeed.Value)
      CASE "home"
        Main.hVISCA.Home()
      CASE "tele"
        Main.hVISCA.Zoom("tele", FCamera.slZoom.Value)
      CASE "wide"
        Main.hVISCA.Zoom("wide", FCamera.slZoom.Value)
      CASE "backlight=off"
        Main.hVISCA.Backlight("off")
      CASE "backlight=on"
        Main.hVISCA.Backlight("on")
      CASE "power=on"
        Main.hVISCA.Power("on")
      CASE "power=off"
        Main.hVISCA.Power("off")
      CASE "stop"
        Main.hVISCA.Direction("stop", FCamera.slPanSpeed.Value, FCamera.slTiltSpeed.Value)
      CASE "autofocus=on"
        Main.hVISCA.Focus("auto")
      CASE "autofocus=off"
        Main.hVISCA.Focus("manual")
      CASE "preset=0"
        Main.hVISCA.Memory("0", FCamera.rbPresetRecall.Value, FCamera.rbPresetSet.Value)
      CASE "preset=1"
        Main.hVISCA.Memory("1", FCamera.rbPresetRecall.Value, FCamera.rbPresetSet.Value)
      CASE "preset=2"
        Main.hVISCA.Memory("2", FCamera.rbPresetRecall.Value, FCamera.rbPresetSet.Value)
      CASE "preset=3"
        Main.hVISCA.Memory("3", FCamera.rbPresetRecall.Value, FCamera.rbPresetSet.Value)
      CASE "preset=4"
        Main.hVISCA.Memory("4", FCamera.rbPresetRecall.Value, FCamera.rbPresetSet.Value)
      CASE "preset=5"
        Main.hVISCA.Memory("5", FCamera.rbPresetRecall.Value, FCamera.rbPresetSet.Value)
    END SELECT
  ELSE IF rCamera!ptztype = "AXIS API" THEN
    SELECT CASE sCmd
      CASE "up"
        FetchPTZUrl("move=up")
      CASE "down"
        FetchPTZUrl("move=down")
      CASE "left"
        FetchPTZUrl("move=left")
      CASE "right"
        FetchPTZUrl("move=right")
      CASE "upleft"
        FetchPTZUrl("move=upleft")
      CASE "upright"
        FetchPTZUrl("move=upright")
      CASE "downleft"
        FetchPTZUrl("move=downleft")
      CASE "downright"
        FetchPTZUrl("move=downright")
      CASE "home"
        FetchPTZUrl("move=home")
      CASE "tele"
        FetchPTZUrl("zoom=9999")
      CASE "wide"
        FetchPTZUrl("zoom=1")
      CASE "zoom"
        FetchPTZUrl("zoom=" & slZoom.Value)
      CASE "backlight=off"
        FetchPTZUrl("backlight=off")
      CASE "backlight=on"
        FetchPTZUrl("backlight=on")
      CASE "pan"
        FetchPTZUrl("pan=" & slPan.Value)
      CASE "tilt"
        FetchPTZUrl("tilt=" & slTilt.Value)
      CASE "speed"
        FetchPTZUrl("speed=" & slPanSpeed.Value)
      CASE "autofocus=on"
        FetchPTZUrl("autofocus=on")
      CASE "autofocus=off"
        FetchPTZUrl("autofocus=off")
      CASE "preset=0"
        FetchPTZUrl("gotodevicepreset=0")
      CASE "preset=1"
        FetchPTZUrl("gotodevicepreset=1")
      CASE "preset=2"
        FetchPTZUrl("gotodevicepreset=2")
      CASE "preset=3"
        FetchPTZUrl("gotodevicepreset=3")
      CASE "preset=4"
        FetchPTZUrl("gotodevicepreset=4")
      CASE "preset=5"
        FetchPTZUrl("gotodevicepreset=5")
    END SELECT
  END IF

END

PUBLIC SUB FetchPTZUrl(sCmd AS String) AS Boolean

  DIM sUrl AS String

  sUrl = rCamera!ptzbaseurl & sCmd

  hFetch = NEW HttpClient AS "hFetchUrl"
  hFetch.URL = sUrl
  hFetch.TimeOut = 5
  IF Len(rCamera!username) THEN
    hFetch.User = rCamera!username
    hFetch.Password = rCamera!passwd
  END IF
  hFetch.Async = TRUE
  hFetch.Get()

END

PUBLIC SUB hFetchUrl_Finished()

  DIM iCount AS Integer

  SELECT hFetch.Code
    CASE 0
      lblStatus.Text = (hFetch.Headers[0])
    CASE 401
      lblStatus.Text = ("Error authenticating!")
    CASE 404
      lblStatus.Text = ("Error page not found!")
    CASE ELSE
      lblStatus.Text = ("Unknown error occured!")
  END SELECT

END

PUBLIC SUB PlayerProcess_Read()

  DIM sData AS String

  READ #LAST, sData, -255

  IF InStr(sData, "format detected") THEN
    lblStatus.Text = ("Stream format detected ...")
  ELSE IF InStr(sData, "Cache")
    lblStatus.Text = ("Building cache ...")
  ELSE IF InStr(sData, "Connecting")
    lblStatus.Text = ("Connecting ...")
  END IF

END

PUBLIC SUB PlayerProcess_Kill()

  DIM iRc AS Integer

  iRc = LAST.Value
  hProcess = NULL
  lblMoviePlayer.Hide
  btnOpen.Text = ("View")
  cmbCameras.Enabled = TRUE
  lblstatus.Text = ("Stopped ...") & IIf(iRc, (" Return code = ") & iRc, "")

END

PUBLIC SUB btnBL_Click()

  IF bBackLight THEN
    PTZControl("backlight=off")
    btnBL.Text = "On"
    bBackLight = FALSE
  ELSE
    PTZControl("backlight=on")
    btnBL.Text = "Off"
    bBackLight = TRUE
  END IF

END

PUBLIC SUB btnWBAuto_Click()

  FCamera.btnWBIndoor.Enabled = TRUE
  FCamera.btnWBOutdoor.Enabled = TRUE
  FCamera.btnWBOnePush.Enabled = TRUE
  FCamera.btnWBTrigger.Enabled = TRUE
  Main.hVISCA.WhiteBalance("auto")
  FCamera.btnWBAuto.Enabled = FALSE

END

PUBLIC SUB btnWBIndoor_Click()

  FCamera.btnWBAuto.Enabled = TRUE
  FCamera.btnWBOutdoor.Enabled = TRUE
  FCamera.btnWBOnePush.Enabled = TRUE
  FCamera.btnWBTrigger.Enabled = TRUE
  Main.hVISCA.WhiteBalance("indoor")
  FCamera.btnWBIndoor.Enabled = FALSE

END

PUBLIC SUB btnWBOutdoor_Click()

  FCamera.btnWBAuto.Enabled = TRUE
  FCamera.btnWBIndoor.Enabled = TRUE
  FCamera.btnWBOnePush.Enabled = TRUE
  FCamera.btnWBTrigger.Enabled = TRUE
  Main.hVISCA.WhiteBalance("outdoor")
  FCamera.btnWBOutdoor.Enabled = FALSE

END

PUBLIC SUB btnWBOnePush_Click()

  FCamera.btnWBAuto.Enabled = TRUE
  FCamera.btnWBIndoor.Enabled = TRUE
  FCamera.btnWBOutdoor.Enabled = TRUE
  FCamera.btnWBTrigger.Enabled = TRUE
  Main.hVISCA.WhiteBalance("onepush")
  FCamera.btnWBOnePush.Enabled = FALSE

END

PUBLIC SUB btnWBTrigger_Click()

  FCamera.btnWBAuto.Enabled = TRUE
  FCamera.btnWBIndoor.Enabled = TRUE
  FCamera.btnWBOutdoor.Enabled = TRUE
  FCamera.btnWBTrigger.Enabled = TRUE
  FCamera.btnWBOnePush.Enabled = TRUE
  Main.hVISCA.WhiteBalance("trigger")
  FCamera.btnWBTrigger.Enabled = FALSE

END

PUBLIC SUB btnAEAuto_Click()

  Main.hVISCA.AutoExposure("auto")
  btnAEAuto.Enabled = FALSE
  btnAEShutter.Enabled = TRUE
  btnAEBright.Enabled = TRUE
  btnAEManual.Enabled = TRUE
  btnAEIris.Enabled = TRUE
  btnAEGain.Enabled = TRUE
  btnMin.Enabled = FALSE
  btnPlus.Enabled = FALSE
  btnReset.Enabled = FALSE

END

PUBLIC SUB btnAEManual_Click()

  Main.hVISCA.AutoExposure("manual")
  btnAEManual.Enabled = FALSE
  btnAEShutter.Enabled = TRUE
  btnAEBright.Enabled = TRUE
  btnAEIris.Enabled = TRUE
  btnAEGain.Enabled = TRUE
  btnMin.Enabled = TRUE
  btnPlus.Enabled = TRUE
  btnReset.Enabled = TRUE

END

PUBLIC SUB btnAEShutter_Click()

  Main.hVISCA.AutoExposure("shutter")
  btnAEShutter.Enabled = FALSE
  btnAEManual.Enabled = FALSE
  btnAEBright.Enabled = TRUE
  btnAEIris.Enabled = TRUE
  btnAEGain.Enabled = TRUE
  btnMin.Enabled = TRUE
  btnPlus.Enabled = TRUE
  btnReset.Enabled = TRUE

END

PUBLIC SUB btnAEIris_Click()

  Main.hVISCA.AutoExposure("iris")
  btnAEIris.Enabled = FALSE
  btnAEManual.Enabled = FALSE
  btnAEShutter.Enabled = TRUE
  btnAEBright.Enabled = TRUE
  btnAEGain.Enabled = TRUE
  btnMin.Enabled = TRUE
  btnPlus.Enabled = TRUE
  btnReset.Enabled = TRUE

END

PUBLIC SUB btnAEBright_Click()

  Main.hVISCA.AutoExposure("bright")
  btnAEBright.Enabled = FALSE
  btnAEManual.Enabled = FALSE
  btnAEShutter.Enabled = TRUE
  btnAEIris.Enabled = TRUE
  btnAEGain.Enabled = TRUE
  btnMin.Enabled = TRUE
  btnPlus.Enabled = TRUE
  btnReset.Enabled = TRUE

END

PUBLIC SUB btnAEGain_Click()

  btnAEGain.Enabled = FALSE
  btnAEManual.Enabled = FALSE
  btnAEShutter.Enabled = TRUE
  btnAEIris.Enabled = TRUE
  btnAEBright.Enabled = TRUE
  btnMin.Enabled = TRUE
  btnPlus.Enabled = TRUE
  btnReset.Enabled = TRUE

END

PUBLIC SUB btnPower_Click()

  IF bPowerState THEN
    PTZControl("power=off")
    btnPower.Text = "On"
    bPowerState = FALSE
  ELSE
    PTZControl("power=on")
    btnPower.Text = "Off"
    bPowerState = TRUE
  END IF

END

PUBLIC SUB btnUp_MouseDown()

  PTZControl("up")

END

PUBLIC SUB btnDown_MouseDown()

  PTZControl("down")

END

PUBLIC SUB btnRight_MouseDown()

  PTZControl("right")

END

PUBLIC SUB btnLeft_MouseDown()

  PTZControl("left")

END

PUBLIC SUB btnHome_MouseDown()

  PTZControl("home")

END

PUBLIC SUB btnUpLeft_MouseDown()

  PTZControl("upleft")

END

PUBLIC SUB btnUpRight_MouseDown()

  PTZControl("upright")

END

PUBLIC SUB btnDownRight_MouseDown()

  PTZControl("downright")

END

PUBLIC SUB btnDownLeft_MouseDown()

  PTZControl("downleft")

END

PUBLIC SUB slPan_MouseUp()

  PTZControl("pan")

END

PUBLIC SUB slTilt_MouseUp()

  PTZControl("tilt")

END

PUBLIC SUB slPanSpeed_MouseUp()

  PTZControl("speed")

END

PUBLIC SUB slTiltSpeed_MouseUp()

  PTZControl("speed")

END

PUBLIC SUB rbPresetRecall_Click()

  rbPresetRecall.Value = TRUE
  rbPresetSet.Value = FALSE
  rbPresetReset.Value = FALSE

END

PUBLIC SUB rbPresetSet_Click()

  rbPresetRecall.Value = FALSE
  rbPresetSet.Value = TRUE
  rbPresetReset.Value = FALSE

END

PUBLIC SUB rbPresetReset_Click()

  rbPresetRecall.Value = FALSE
  rbPresetSet.Value = FALSE
  rbPresetReset.Value = TRUE

END

PUBLIC SUB btnPreset1_Click()

  PTZControl("preset=0")

END

PUBLIC SUB btnPreset2_Click()

  PTZControl("preset=1")

END

PUBLIC SUB btnPreset3_Click()

  PTZControl("preset=2")

END

PUBLIC SUB btnPreset4_Click()

  PTZControl("preset=3")

END

PUBLIC SUB btnPreset5_Click()

  PTZControl("preset=4")

END

PUBLIC SUB btnPreset6_Click()

  PTZControl("preset=5")

END

PUBLIC SUB btnUp_MouseUp()

  PTZControl("stop")

END

PUBLIC SUB btnDown_MouseUp()

  PTZControl("stop")

END

PUBLIC SUB btnLeft_MouseUp()

  PTZControl("stop")

END

PUBLIC SUB btnRight_MouseUp()

  PTZControl("stop")

END

PUBLIC SUB btnUpLeft_MouseUp()

  PTZControl("stop")

END

PUBLIC SUB btnUpRight_MouseUp()

  PTZControl("stop")

END

PUBLIC SUB btnDownLeft_MouseUp()

  PTZControl("stop")

END

PUBLIC SUB btnDownRight_MouseUp()

  PTZControl("stop")

END

PUBLIC SUB btnPlus_Click()

  DIM sMode AS String

  IF btnAEShutter.Enabled = FALSE THEN
    sMode = "shutter"
  ELSE IF btnAEIris.Enabled = FALSE THEN
    sMode = "iris"
  ELSE IF btnAEBright.Enabled = FALSE THEN
    sMode = "bright"
  ELSE IF btnAEGain.Enabled = FALSE THEN
    sMode = "gain"
  END IF
  Main.hVISCA.ManualExposure(sMode, "+")

END

PUBLIC SUB btnMin_Click()

  DIM sMode AS String

  IF btnAEShutter.Enabled = FALSE THEN
    sMode = "shutter"
  ELSE IF btnAEIris.Enabled = FALSE THEN
    sMode = "iris"
  ELSE IF btnAEBright.Enabled = FALSE THEN
    sMode = "bright"
  ELSE IF btnAEGain.Enabled = FALSE THEN
    sMode = "gain"
  END IF
  Main.hVISCA.ManualExposure(sMode, "-")

END

PUBLIC SUB btnReset_Click()

  DIM sMode AS String

  IF btnAEShutter.Enabled = FALSE THEN
    sMode = "shutter"
  ELSE IF btnAEIris.Enabled = FALSE THEN
    sMode = "iris"
  ELSE IF btnAEBright.Enabled = FALSE THEN
    sMode = "bright"
  ELSE IF btnAEGain.Enabled = FALSE THEN
    sMode = "gain"
  END IF
  Main.hVISCA.ManualExposure(sMode, "reset")

END

PUBLIC SUB btnFocusAuto_Click()

  btnFocusAuto.Enabled = FALSE
  btnFocusManual.Enabled = TRUE
  btnFocusNear.Enabled = FALSE
  btnFocusFar.Enabled = FALSE
  PTZControl("autofocus=on")

END

PUBLIC SUB btnFocusManual_Click()

  btnFocusManual.Enabled = FALSE
  btnFocusAuto.Enabled = TRUE
  btnFocusNear.Enabled = TRUE
  btnFocusFar.Enabled = TRUE
  PTZControl("autofocus=off")

END

PUBLIC SUB btnFocusNear_Click()

  btnFocusNear.Enabled = FALSE
  btnFocusManual.Enabled = FALSE
  btnFocusAuto.Enabled = TRUE
  btnFocusFar.Enabled = TRUE
  Main.hVISCA.Focus("near")

END

PUBLIC SUB btnFocusFar_Click()

  btnFocusFar.Enabled = FALSE
  btnFocusManual.Enabled = FALSE
  btnFocusNear.Enabled = TRUE
  btnFocusAuto.Enabled = TRUE
  Main.hVISCA.Focus("far")

END

PUBLIC SUB btnTele_Click()

  PTZControl("tele")

END

PUBLIC SUB btnWide_Click()

  PTZControl("wide")

END

PUBLIC SUB slZoom_Change()

  PTZControl("zoom")

END

PUBLIC SUB btnTele_MouseUp()

  PTZControl("stop")

END

PUBLIC SUB btnWide_MouseUp()

  PTZControl("stop")

END
