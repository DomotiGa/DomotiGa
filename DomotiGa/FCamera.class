' Gambas class file

' Description:
' FCameraControl.class
' Support for VISCA camera control, see CVISCA.class for more.

' Development Status:
' GUI design and code finished, needs better error checking.

' DomotiGa - an open source home automation program.
' Copyright(C) 2008-2009 Ron Klinkien

' Read file called COPYING for license details.

PUBLIC bPowerState AS Boolean = TRUE
PUBLIC bBacklight AS Boolean = FALSE
PUBLIC tVideo AS NEW Timer

PRIVATE hProcess AS Process

PUBLIC SUB Form_Close()

  IF hProcess THEN
    hProcess.Kill
    tVideo.Stop
  END IF

END

PUBLIC SUB Form_Open()

  DIM oObject AS Object

  IF Main.hVISCA THEN
    rbPresetRecall.Value = TRUE
    rbPresetSet.Value = FALSE
    rbPresetReset.Value = FALSE
    IF Main.bVISCAEnabled THEN Main.hVISCA.AddressSet()
    spAddress.Value = Main.iVISCACameraAddress
    cmbVideoDevice.Text = Main.sVISCAVideoDevice

    ' start timer for video capture
    tVideo = NEW Timer AS "tVideo"
    tVideo.Delay = 500
  ELSE
    ' no connection to camera, or disabled so disable control buttons
    FOR EACH oOBject IN ME.Children
      oObject.Enabled = FALSE
    NEXT
    frameStream.Enabled = TRUE
    FOR EACH oOBject IN frameStream.Children
      oObject.Enabled = TRUE
    NEXT
    frameDevice.Enabled = TRUE
    FOR EACH oOBject IN frameDevice.Children
      oObject.Enabled = TRUE
    NEXT
  END IF

END

PUBLIC SUB btnOpen_Click()

  IF NOT Main.ProgramExist("mplayer") THEN
    Message.Info(("Couldn't find mplayer command, did you install it?"))
    RETURN
  END IF

  IF hProcess THEN
    hProcess.Kill
    tVideo.Stop
    btnOpen.Text = ("Open")
    lblMoviePlayer.Hide
    RETURN
  END IF
  btnOpen.Text = ("Close")

  WITH lblMoviePlayer
    .Show
    .Enabled = FALSE
  END WITH

  hProcess = EXEC ["mplayer", "-wid", lblMoviePlayer.Handle, "tv://", "-tv", "norm=auto:input=" & IIf(rbInput0.Value, 0, 1) & ":device=" & cmbVideoDevice.Text] FOR READ WRITE

  lblMoviePlayer.Hide
  tVideo.Enabled = TRUE

END

PUBLIC SUB tVideo_Timer()

  lblMoviePlayer.Show
  tVideo.Enabled = FALSE

END

PUBLIC SUB Process_Read()

  DIM sData AS String

  READ #LAST, sData, -255

END

PUBLIC SUB Process_Kill()

  hProcess = NULL
  tVideo.Enabled = FALSE
  lblMoviePlayer.Hide
  btnOpen.Text = ("Open")

END

PUBLIC SUB btnBL_Click()

  IF bBackLight THEN
    Main.hVISCA.Backlight("Off")
    btnBL.Text = "On"
    bBackLight = FALSE
  ELSE
    Main.hVISCA.Backlight("On")
    btnBL.Text = "Off"
    bBackLight = TRUE
  END IF

END

PUBLIC SUB btnWBAuto_Click()

  Main.hVISCA.WhiteBalance("Auto")

END

PUBLIC SUB btnWBIndoor_Click()

  Main.hVISCA.WhiteBalance("Indoor")

END

PUBLIC SUB btnWBOutdoor_Click()

  Main.hVISCA.WhiteBalance("Outdoor")

END

PUBLIC SUB btnWBOnePush_Click()

  Main.hVISCA.WhiteBalance("OnePush")

END

PUBLIC SUB btnWBTrigger_Click()

  Main.hVISCA.WhiteBalance("Trigger")

END

PUBLIC SUB btnAEAuto_Click()

  Main.hVISCA.AutoExposure("Auto")
  btnAEAuto.Enabled = FALSE
  btnAEShutter.Enabled = TRUE
  btnAEBright.Enabled = TRUE
  btnAEManual.Enabled = TRUE
  btnAEIris.Enabled = TRUE
  btnAEGain.Enabled = TRUE
  btnMin.Enabled = FALSE
  btnPlus.Enabled = FALSE
  btnReset.Enabled = FALSE

END

PUBLIC SUB btnAEManual_Click()

  Main.hVISCA.AutoExposure("Manual")
  btnAEManual.Enabled = FALSE
  btnMin.Enabled = TRUE
  btnPlus.Enabled = TRUE
  btnReset.Enabled = TRUE
  btnAEShutter.Enabled = TRUE
  btnAEBright.Enabled = TRUE
  btnAEIris.Enabled = TRUE
  btnAEGain.Enabled = TRUE

END

PUBLIC SUB btnAEShutter_Click()

  Main.hVISCA.AutoExposure("Shutter")
  btnAEShutter.Enabled = FALSE
  btnMin.Enabled = TRUE
  btnPlus.Enabled = TRUE
  btnReset.Enabled = TRUE
  btnAEManual.Enabled = FALSE
  btnAEBright.Enabled = TRUE
  btnAEIris.Enabled = TRUE
  btnAEGain.Enabled = TRUE

END

PUBLIC SUB btnAEIris_Click()

  Main.hVISCA.AutoExposure("Iris")
  btnAEIris.Enabled = FALSE
  btnMin.Enabled = TRUE
  btnPlus.Enabled = TRUE
  btnReset.Enabled = TRUE
  btnAEManual.Enabled = FALSE
  btnAEShutter.Enabled = TRUE
  btnAEBright.Enabled = TRUE
  btnAEGain.Enabled = TRUE

END

PUBLIC SUB btnAEBright_Click()

  Main.hVISCA.AutoExposure("Bright")
  btnAEBright.Enabled = FALSE
  btnMin.Enabled = TRUE
  btnPlus.Enabled = TRUE
  btnReset.Enabled = TRUE
  btnAEManual.Enabled = FALSE
  btnAEShutter.Enabled = TRUE
  btnAEIris.Enabled = TRUE
  btnAEGain.Enabled = TRUE

END

PUBLIC SUB btnAEGain_Click()

  btnAEGain.Enabled = FALSE
  btnMin.Enabled = TRUE
  btnPlus.Enabled = TRUE
  btnReset.Enabled = TRUE
  btnAEManual.Enabled = FALSE
  btnAEShutter.Enabled = TRUE
  btnAEIris.Enabled = TRUE
  btnAEBright.Enabled = TRUE

END

PUBLIC SUB btnPower_Click()

  IF bPowerState THEN
    Main.hVISCA.Power("Off")
    btnPower.Text = "On"
    bPowerState = FALSE
  ELSE 
    Main.hVISCA.Power("On")
    btnPower.Text = "Off"
    bPowerState = TRUE
  END IF

END

PUBLIC SUB btnUp_MouseDown()

  Main.hVISCA.Direction("Up")

END

PUBLIC SUB btnDown_MouseDown()

  Main.hVISCA.Direction("Down")

END

PUBLIC SUB btnRight_MouseDown()

  Main.hVISCA.Direction("Right")

END

PUBLIC SUB btnLeft_MouseDown()

  Main.hVISCA.Direction("Left")

END

PUBLIC SUB btnHome_MouseDown()

  Main.hVISCA.Home()

END

PUBLIC SUB btnUpLeft_MouseDown()

  Main.hVISCA.Direction("UpLeft")

END

PUBLIC SUB btnUpRight_MouseDown()

  Main.hVISCA.Direction("UpRight")

END

PUBLIC SUB btnDownRight_MouseDown()

  Main.hVISCA.Direction("DownRight")

END

PUBLIC SUB btnDownLeft_MouseDown()

  Main.hVISCA.Direction("DownLeft")

END

PUBLIC SUB rbPresetRecall_Click()

  rbPresetRecall.Value = TRUE
  rbPresetSet.Value = FALSE
  rbPresetReset.Value = FALSE

END

PUBLIC SUB rbPresetSet_Click()

  rbPresetRecall.Value = FALSE
  rbPresetSet.Value = TRUE
  rbPresetReset.Value = FALSE

END

PUBLIC SUB rbPresetReset_Click()

  rbPresetRecall.Value = FALSE
  rbPresetSet.Value = FALSE
  rbPresetReset.Value = TRUE

END

PUBLIC SUB btnPreset1_Click()

  Main.hVISCA.Memory("0")

END

PUBLIC SUB btnPreset2_Click()

  Main.hVISCA.Memory("1")

END

PUBLIC SUB btnPreset3_Click()

  Main.hVISCA.Memory("2")

END

PUBLIC SUB btnPreset4_Click()

  Main.hVISCA.Memory("3")

END

PUBLIC SUB btnPreset5_Click()

  Main.hVISCA.Memory("4")

END

PUBLIC SUB btnPreset6_Click()

  Main.hVISCA.Memory("5")

END

PUBLIC SUB btnUp_MouseUp()

  Main.hVISCA.Direction("Stop")

END

PUBLIC SUB btnDown_MouseUp()

  Main.hVISCA.Direction("Stop")

END

PUBLIC SUB btnLeft_MouseUp()

  Main.hVISCA.Direction("Stop")

END

PUBLIC SUB btnRight_MouseUp()

  Main.hVISCA.Direction("Stop")

END

PUBLIC SUB btnUpLeft_MouseUp()

  Main.hVISCA.Direction("Stop")

END

PUBLIC SUB btnUpRight_MouseUp()

  Main.hVISCA.Direction("Stop")

END

PUBLIC SUB btnDownLeft_MouseUp()

  Main.hVISCA.Direction("Stop")

END

PUBLIC SUB btnDownRight_MouseUp()

  Main.hVISCA.Direction("Stop")

END

PUBLIC SUB btnPlus_Click()

  DIM sMode AS String

  IF btnAEShutter.Enabled = FALSE THEN 
    sMode = "Shutter"
  ELSE IF btnAEIris.Enabled = FALSE THEN 
    sMode = "Iris"
  ELSE IF btnAEBright.Enabled = FALSE THEN 
    sMode = "Bright"
  ELSE IF btnAEGain.Enabled = FALSE THEN 
    sMode = "Gain"
  END IF
  Main.hVISCA.ManualExposure(sMode, "+")

END

PUBLIC SUB btnMin_Click()

  DIM sMode AS String

  IF btnAEShutter.Enabled = FALSE THEN 
    sMode = "Shutter"
  ELSE IF btnAEIris.Enabled = FALSE THEN 
    sMode = "Iris"
  ELSE IF btnAEBright.Enabled = FALSE THEN 
    sMode = "Bright"
  ELSE IF btnAEGain.Enabled = FALSE THEN 
    sMode = "Gain"
  END IF
  Main.hVISCA.ManualExposure(sMode, "-")

END

PUBLIC SUB btnReset_Click()

  DIM sMode AS String

  IF btnAEShutter.Enabled = FALSE THEN 
    sMode = "Shutter"
  ELSE IF btnAEIris.Enabled = FALSE THEN 
    sMode = "Iris"
  ELSE IF btnAEBright.Enabled = FALSE THEN 
    sMode = "Bright"
  ELSE IF btnAEGain.Enabled = FALSE THEN 
    sMode = "Gain"
  END IF
  Main.hVISCA.ManualExposure(sMode, "Reset")

END

PUBLIC SUB btnFocusAuto_Click()

  btnFocusAuto.Enabled = FALSE
  btnFocusManual.Enabled = TRUE
  btnFocusNear.Enabled = FALSE
  btnFocusFar.Enabled = FALSE
  Main.hVISCA.Focus("Auto")

END

PUBLIC SUB btnFocusManual_Click()

  btnFocusManual.Enabled = FALSE
  btnFocusAuto.Enabled = TRUE
  btnFocusNear.Enabled = TRUE
  btnFocusFar.Enabled = TRUE
  Main.hVISCA.Focus("Manual")

END

PUBLIC SUB btnFocusNear_Click()

  btnFocusNear.Enabled = FALSE
  btnFocusManual.Enabled = FALSE
  btnFocusAuto.Enabled = TRUE
  btnFocusFar.Enabled = TRUE
  Main.hVISCA.Focus("Near")

END

PUBLIC SUB btnFocusFar_Click()

  btnFocusFar.Enabled = FALSE
  btnFocusManual.Enabled = FALSE
  btnFocusNear.Enabled = TRUE
  btnFocusAuto.Enabled = TRUE
  Main.hVISCA.Focus("Far")

END

PUBLIC SUB btnTele_Click()

  Main.hVISCA.Zoom("Tele")

END

PUBLIC SUB btnWide_Click()

  Main.hVISCA.Zoom("Wide")

END

PUBLIC SUB btnTele_MouseUp()

  Main.hVISCA.Zoom("Stop")

END

PUBLIC SUB btnWide_MouseUp()

  Main.hVISCA.Zoom("Stop")

END

PUBLIC SUB spAddress_Change()

  Main.hVISCA.ChangeAddress()

END

PUBLIC SUB rbInput0_Click()

  rbInput1.Value = FALSE

END

PUBLIC SUB rbInput1_Click()

  rbInput0.Value = FALSE

END