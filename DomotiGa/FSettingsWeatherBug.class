' Gambas class file

' Description:
' FSettingsWeatherBug.class
' Settings form for WeatherBug API support.

' Development Status:
' Development just started.

' Links:
' http://www.weatherbug.com

' DomotiGa - an open source home automation program.
' Copyright(C) 2008-2010 Ron Klinkien

' Read file called COPYING for license details.

PRIVATE sCity AS NEW String[]
PRIVATE sCityCode AS NEW String[]
PRIVATE sCountry AS NEW String[]

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' initialize buttons and fill in current values
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
PUBLIC SUB Form_Open()

  ME.Move(FMain.X + 50, FMain.Y + 70)

  chkEnabled.Value = Main.bWeatherBugEnabled
  txtWeatherBugID.Text = Main.sWeatherBugID
  txtCity.Text = Main.sWeatherBugCity
  txtCityCode.Text = Main.sWeatherBugCityCode
  chkDebug.Value = Main.bWeatherBugDebug

  IF Main.bWeatherBugEnabled = FALSE THEN
    txtCity.Enabled = FALSE
    txtCityCode.Enabled = FALSE
    chkDebug.Enabled = FALSE
    txtWeatherBugID.Enabled = FALSE
    cmbCities.Enabled = FALSE
    txtCitySearch.Enabled = FALSE
    btnCitySearch.Enabled = FALSE
  END IF
  btnSave.Enabled = FALSE

END

PUBLIC SUB btnCancel_Click()

  ME.Close

END

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' load defaults from database
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
PUBLIC SUB btnDefaults_Click()

  DIM rResult AS Result

  rResult = Main.GetSettingTable("weatherbug", TRUE) ' get defaults
  IF rResult.Count THEN
    chkEnabled.Value = rResult!enabled
    txtCity.Text = rResult!city
    txtCityCode.Text = rResult!citycode
    chkDebug.Value = rResult!debug
    txtWeatherBugID.Text = rResult!weatherbugid
  END IF
  btnSave.Enabled = TRUE

END

PUBLIC SUB chkEnabled_Click()

  txtCity.Enabled = chkEnabled.Value
  txtCityCode.Enabled = chkEnabled.Value
  txtWeatherBugID.Enabled = chkEnabled.Value
  chkDebug.Enabled = chkEnabled.Value
  btnCitySearch.Enabled = chkEnabled.Value
  cmbCities.Enabled = chkEnabled.Value
  txtCitySearch.Enabled = chkEnabled.Value
  btnSave.Enabled = TRUE

END

PUBLIC SUB btnCitySearch_Click()

  '--- declare variables ---
  DIM sFile, sLine AS String
  DIM hFile AS File
  DIM iI AS Integer

  cmbCities.Clear
  sCity.Clear
  sCountry.Clear
  sCityCode.Clear
  txtCityCode.text = ""

  '--- get info from weatherbug site ---
  sFile = XMLParser.ParseXML("http://api.wxbug.net/getLocationsXML.aspx?ACode=" & Trim(txtWeatherbugID.Text) & "&SearchString=" & txtCitySearch.text)
  IF Len(sFile) > 0 THEN
    '--- put all retrieved cities in an array ---
    hFile = OPEN sFile FOR INPUT
    WHILE NOT Eof(hFile)
      LINE INPUT #hFile, sLine
      IF Left(sLine, 47) = "aws:weatheraws:locationsaws:locationcityname|=|" THEN
        sCity.add(Right(sLine, Len(sLine) - 47))
      END IF
      IF Left(sLine, 50) = "aws:weatheraws:locationsaws:locationcountryname|=|" THEN
        sCountry.add(Right(sLine, Len(sLine) - 50))
      END IF
      IF Left(sLine, 47) = "aws:weatheraws:locationsaws:locationcitycode|=|" THEN
        sCityCode.add(Right(sLine, Len(sLine) - 47))
      END IF
    WEND
    hFile.Close
    hFile = NULL
    KILL sFile
    '--- put array in combobox ---
    FOR iI = 0 TO sCity.Count - 1
      IF Len(Trim(sCityCode[iI])) > 1 THEN ' special code, we only use non-US cities
        cmbCities.Add(sCity[iI] & " [" & sCountry[iI] & "]")
      END IF
    NEXT
    cmbCities_Click
  END IF

END

PUBLIC SUB txtCitySearch_KeyPress()

  btnSave.Enabled = TRUE
  cmbCities.Clear

END

PUBLIC SUB txtCityCode_KeyPress()

  btnSave.Enabled = TRUE

END

PUBLIC SUB txtWeatherBugID_KeyPress()

  btnSave.Enabled = TRUE

END

PUBLIC SUB cmbCities_Click()

  '--- declare variables ---
  DIM iI AS Integer
  DIM sCityTmp, sCountryTmp AS String

  btnSave.Enabled = TRUE

  IF cmbCities.Index > -1 THEN
    sCityTmp = Trim(Main.ParseTag(cmbCities.text, 1, "["))
    sCountryTmp = Trim(Main.ParseTag(cmbCities.Text, 2, "["))
    sCountryTmp = Left(sCountryTmp, Len(sCountryTmp) - 1)
    FOR iI = 0 TO sCity.Count - 1
      IF sCity[iI] = sCityTmp AND IF sCountry[iI] = sCountryTmp THEN
        txtCityCode.Text = sCityCode[iI]
        txtCity.Text = sCity[iI]
        RETURN
      END IF
    NEXT
  END IF

END

PUBLIC SUB chkDebug_Click()

  btnSave.Enabled = TRUE

END

PRIVATE SUB ValidInput() AS Boolean

  IF NOT txtCity.Text THEN
    Balloon(("Please select a city!"), txtCity)
    RETURN FALSE
  END IF
  IF NOT txtCityCode.Text THEN
    Balloon(("Please select a city!"), txtCity)
    RETURN FALSE
  END IF
  IF NOT txtWeatherBugID.Text THEN
    Balloon(("Please enter your weatherbug id!"), txtWeatherBugID)
    RETURN FALSE
  END IF
  RETURN TRUE

END

PUBLIC SUB btnSave_Click()

  DIM rResult AS Result
  DIM sCountryName AS String

  IF NOT ValidInput() THEN RETURN

  sCountryName = Trim(Main.ParseTag(CmbCities.Text, 2, "["))
  sCountryName = Left(sCountryName, Len(sCountryName) - 1)

  '--- save new WeatherBug settings ---
  rResult = Main.hDB.Exec("UPDATE settings_weatherbug SET debug = &1, city = &2, citycode = &3, countryname = &4, enabled = &5, weatherbugid = &6 WHERE id = 1", chkDebug.Value, txtCity.Text, txtCityCode.Text, sCountryName, chkEnabled.Value, txtWeatherBugID.Text)
  rResult = Main.GetSettingTable("weatherbug") ' reload settings
  IF rResult.Count THEN
    Main.bWeatherBugEnabled = rResult!enabled
    Main.sWeatherBugCity = rResult!city
    Main.sWeatherBugCityCode = rResult!citycode
    Main.bWeatherBugDebug = rResult!debug
    Main.sWeatherBugID = rResult!weatherbugid
  END IF
  IF Main.bStandalone THEN
    Main.Restart_WeatherBug()
  ELSE
    XMLClient.ModuleRestart("WeatherBug")
  END IF
  ME.Close

END