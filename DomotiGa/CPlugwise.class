' Gambas class file

' Description:
' CPlugwise.class
' Use Plugwise to control devices.

' Development Status:
' Only serial settings are done, protocol has to be decoded yet.

' Links:
' http://www.plugwise.nl

' DomotiGa - an open source home automation program.
' Copyright(C) 2008 Ron Klinkien

' Read file called COPYING for license details.

PROPERTY Port AS String
PROPERTY PlugwiseDebug AS Boolean

PRIVATE sPort AS String
PRIVATE bPlugwiseDebug AS Boolean

PUBLIC hPlugwise AS NEW SerialPort

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' open serial port
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
PUBLIC FUNCTION Connect() AS Boolean

  ' try to close the port
  TRY hPlugwise.Close

  ' get a new one
  hPlugwise = NEW Serialport AS "Plugwise"

  WITH hPlugwise
    .PortName = sPort
    .Speed = 115200
    .Parity = 0
    .DataBits = 8
    .StopBits = 1
    .Open()
  END WITH

  ' all ok
  RETURN TRUE

CATCH ' some errors
  Main.WriteLog("Plugwise Error: " & ERROR.Text)
  RETURN FALSE

END

PUBLIC FUNCTION Run() AS Boolean

  ' init device

END

PUBLIC SUB Plugwise_Read()

  DIM sData AS Byte

  READ #hPlugwise, sData
  ProcessReceivedChar(sData)

END

PRIVATE SUB ProcessReceivedChar(sComChar AS Byte)

 IF Main.bPlugwiseDebug THEN Main.WriteDebugLog("[Plugwise] Received " & sComChar, TRUE)

END

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' close port
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
PUBLIC FUNCTION Disconnect() AS Boolean

  ' try to close the connection
  TRY hPlugwise.Close
  Main.WriteLog("Plugwise serial port close.")

  ' all ok
  RETURN TRUE

CATCH ' some errors
  Main.WriteLog("Plugwise Error: " & ERROR.Text)
  RETURN FALSE

END

' implement properties
FUNCTION Port_Read() AS String

  RETURN sPort

END

SUB Port_Write(Value AS String)

  sPort = Value

END

PRIVATE FUNCTION PlugwiseDebug_Read() AS Boolean

  RETURN bPlugwiseDebug

END

PRIVATE SUB PlugwiseDebug_Write(Value AS Boolean)

  bPlugwiseDebug = Value

END
