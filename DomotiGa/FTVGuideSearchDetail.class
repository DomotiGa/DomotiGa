' Gambas class file

' Description:
' FTVGuideSearchDetail.class
' Form for showing searched details.

' Development Status:
' Imported from Kris's own project, needs testing.

' DomotiGa - an open source home automation program.
' Copyright(C) 2008-2010 Ron Klinkien

' This module is written by and Copyright(C) 2009 Kris Wauters on February, 17th - 2010
' For more info or help, mailto: kris@digitalplayground.be

' Read file called COPYING for license details.

PUBLIC SUB Form_Open()

  '--- declare variables ---
  DIM rRes AS Result

  rRes = Main.hDB.Exec(Main.ParseTag(ME.tag, 1, "|"))
  IF rRes THEN
    IF rRes.Count > 0 THEN
      rRes.MoveFirst
      PreInit(rRes)
      ShowData(rRes)
    ELSE
      Message.Info(("No results found for your search-criteria !"))
      ME.Close
    END IF
  END IF

END

'--- show form-title, column-headers etc ... ---
PRIVATE SUB PreInit(rRes AS Result)

  '--- declare variables ---
  DIM StrFile AS String
  DIM rResMaxDate AS Result

  '--- doe FormTitle ---
  rResMaxDate = Main.hDB.Exec("SELECT MAX(EndPoint) as MaxDate FROM tv_programs")
  IF rResMaxDate THEN
    IF rResMaxDate.Count > 0 THEN
      rResMaxDate.Movefirst
      ME.Title = CStr(rRes.Count) & " " & ("Results for search [") & Main.ParseTag(ME.tag, 3, "|") & "] "
      ME.Title = ME.title & ("In the period") & " " & Main.DateFromSQLToApp(Main.ParseTag(ME.tag, 2, "|")) & " - " & Main.DateFromSQLToApp(Left(rResMaxDate!MaxDate, 8))
    END IF
  END IF
  '--- do columnheaders ---
  ColVw.Columns.count = 4
  ColVw.Columns[0].Text = LblTitle1.Text
  ColVw.Columns[0].Width = LblTitle1.Width
  ColVw.Columns[1].Text = LblTitle2.Text
  ColVw.Columns[1].Width = LblTitle2.Width
  ColVw.Columns[2].Text = LblTitle3.Text
  ColVw.Columns[2].Width = LblTitle3.Width
  ColVw.Columns[3].Text = LblTitle4.Text
  ColVw.Columns[3].Width = LblTitle4.Width
END

'--- initialises everything onscreen ---
PRIVATE SUB ShowData(rRes AS Result)

  '--- declare variables ---
  DIM StrText, StrFile AS String
  DIM IntI, IntCount AS Integer

  ColVw.Clear
  ColVw.Columns[0].Width = LblTitle1.Width
  ColVw.Columns[1].Width = LblTitle2.Width
  ColVw.Columns[2].Width = LblTitle3.Width
  ColVw.Columns[3].Width = LblTitle4.Width

  FOR EACH rRes
    IF Len(rRes!BLOBlogo.data) > 10 THEN
      StrFile = Main.BlobFromDB("SELECT * FROM tv_channels where RecID=" & rRes!RecID, "BLOBlogo", "EXTlogo")
      '--- if logo, then show logo instead of channel name ---
      ColVw.Add("P" & rRes!RecID & "_" & rRes!StartPoint, "", Picture.Load(StrFile))
    ELSE
      ColVw.Add("P" & rRes!RecID & "_" & rRes!StartPoint, rRes!ChannelName)
    ENDIF
    ColVw.MoveTo("P" & rRes!RecID & "_" & rRes!StartPoint)
    ColVw.Item[1] = rRes!ProgramName
    ColVw.Item[2] = Main.DateTimeFromSqlToApp(rRes!StartPoint)
    ColVw.Item[3] = Main.DateTimeFromSqlToApp(rRes!EndPoint)
    '--- next, add category & programdescription to child-node ---
    ColVw.Add("C" & rRes!RecID & "_" & rRes!StartPoint & "_CAT", "[" & rRes!CategoryName & " - " & rRes!SubCategoryName & "]",, "P" & rRes!RecID & "_" & rRes!StartPoint)
    ColVw.MoveTo("C" & rRes!RecID & "_" & rRes!StartPoint & "_CAT")
    StrText = Main.Wrapit(rRes!ProgramDescription, LblTitle2.Width - 25, ME)
    IntCount = 0
    FOR IntI = 1 TO Len(StrText)
      IF Mid$(StrText, IntI, 1) = gb.newline THEN IntCount = IntCount + 1
    NEXT
    FOR IntI = 1 TO IntCount + 1
      IF IntI = 1 THEN
        ColVw.Item[1] = Main.ParseTag(StrText, IntI, gb.newline)
      ELSE
        ColVw.Add("C" & rRes!RecID & "_" & rRes!StartPoint & "_" & CStr(IntI), "",, "P" & rRes!RecID & "_" & rRes!StartPoint)
        ColVw.MoveTo("C" & rRes!RecID & "_" & rRes!StartPoint & "_" & CStr(IntI))
        ColVw.Item[1] = Main.ParseTag(StrText, IntI, gb.newline)
      END IF
    NEXT
  NEXT

END