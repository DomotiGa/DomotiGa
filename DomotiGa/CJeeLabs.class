' Gambas class file

' Description:
' CJeeLabs.class
' Support for JeeLabs JeeLinks interface and Sensors and KAKU commands

' Development Status:
' Working for JeeNodes.
' JLink needs to be loaded with RF12 DEMO sketch for
' KAKU control support.

' Links:
' http://jeelabs.org

' Credits:
' Thanks to Jean-Claude Wippler,
' Wouter Wolkers and Andy van Dongen.

' DomotiGa - an open source home automation program.
' Copyright(C) 2009-2011 Ron Klinkien.

' Read file called COPYING for license details.

PROPERTY Port AS String
PROPERTY Baud AS String
PROPERTY JeeLabsDebug AS Boolean

PRIVATE sPort AS String
PRIVATE sBaud AS String
PRIVATE bJeeLabsDebug AS Boolean

PUBLIC hJeeLabs AS NEW SerialPort
PRIVATE sBuffer AS String

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' open serial port
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
PUBLIC FUNCTION Connect() AS Boolean

  ' try to close the port
  TRY hJeeLabs.Close

  ' get a new one
  hJeeLabs = NEW Serialport AS "JeeLabs"

  WITH hJeeLabs
    .PortName = sPort
    .Speed = sBaud
    .Parity = 0
    .DataBits = 8
    .StopBits = 1
    .FlowControl = 0
    .Open()
  END WITH

  ' all ok
  RETURN TRUE

CATCH ' some errors
  Main.WriteLog(("JeeLabs Error: ") & ERROR.Text)
  RETURN FALSE

END

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' close port
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
PUBLIC FUNCTION Disconnect() AS Boolean

  ' try to close the connection
  TRY hJeeLabs.Close
  Main.WriteLog(("JeeLabs serial port close."))

  ' all ok
  RETURN TRUE

CATCH ' some errors
  Main.WriteLog(("JeeLabs Error: ") & ERROR.Text)
  RETURN FALSE

END

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' called from devices module
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
PUBLIC SUB SendCommand(sAddress AS String, sCmd AS String)

  DIM iDeviceId AS Integer
  DIM sType, sJeeCmd, sOnOff AS String

  iDeviceId = Devices.Find(sAddress, Devices.FindInterface("JeeLabs Interface"))
  IF iDeviceId THEN
    sType = Devices.FindTypeForDevice(iDeviceId)
  ELSE
    RETURN
  ENDIF

  IF Main.bJeeLabsDebug THEN Main.WriteDebugLog(("[JeeLabs] SendCommand (sAddress='" & sAddress & "', sCmd = '" & sCmd & "')"))

  SELECT sType
    CASE "ARC", "KAKU" ' KlikAanKlikUit with CodeWheel, NEXA, Domia Lite, Proove, ByeByeStandby, ELRO AB600, Intertechno, Duwi
      IF Left$(sAddress, 1) LIKE "[A-Z]" AND Right$(sAddress, 1) LIKE "[0-9]" THEN
        KAKU(sAddress, sCmd, iDeviceId)
      ELSE
        Main.WriteDebugLog(("[JeeLabs] Invalid ARC or KAKU address '") & sAddress & ("' given!"))
      ENDIF
    CASE ELSE 
      Main.WriteDebugLog(("[JeeLabs] unsupported device type in SendCommand. (" & sType & ")"))
  END SELECT
END

PRIVATE SUB KAKU(sAddress AS String, sCmd AS String, OPTIONAL iDeviceId AS Integer)

  DIM iDevice, iUnit, iStatus AS Integer

  iUnit = Asc(Left$(sAddress, 1)) - &H40
  iDevice = Right$(sAddress, 2)

  SELECT UCase(sCmd)
    CASE "ON"
      iStatus = "1"
    CASE "OFF"
      iStatus = "0"
    DEFAULT
      Main.WriteDebugLog(("[JeeLabs] Unknown KAKU command '") & UCase(sCmd) & ("' given!"))
      RETURN
  END SELECT

  IF Main.bJeeLabsDebug THEN Main.WriteDebugLog(("[JeeLabs] Sending kaku command: " & iUnit & "," & iDevice & "," & iStatus & " k"))
  TRY PRINT #hJeeLabs, iUnit & "," & iDevice & "," & iStatus & " k"
  IF ERROR THEN Main.WriteDebugLog(("[JeeLabs] Error writing data to the serial port! -> ") & Error.Text)

END

PUBLIC SUB JeeLabs_Read()

  DIM sData AS String

  TRY READ #hJeeLabs, sData, 1
  IF ERROR THEN Main.WriteDebugLog(("[JeeLabs] Error reading data from serial port! -> ") & Error.Text)
  IF sData = Chr(10) THEN ' buffer until linefeed then parse
    IF Len(sBuffer) > 1 AND IF Left(sBuffer, 2) = "OK" THEN ParseLine(Left(sBuffer, Len(sBuffer) - 1))
    sBuffer = NULL
  ELSE
    sBuffer &= sData
  END IF

END

PRIVATE SUB ParseLine(sData AS String)

  DIM sLine, sMotion, sLowBat AS String
  DIM aScan AS String[]
  DIM iDeviceId, iSensorId, iLDR, iHumi, iTemp, iLowBat AS Integer
  DIM bPIR AS Boolean

  IF Main.bJeeLabsDebug THEN Main.WriteDebugLog("[JeeLabs] " & sData)

  ' parse each line
  FOR EACH sLine IN Split(sData, "\n")
    ' parse sensor data
    aScan = Scan(sLine, "* * * * * *")
    IF aScan.Count = 6 THEN
      iSensorId = aScan[1]
      iSensorId = IIf(iSensorId > 31, iSensorId - 32, iSensorId)
      iLDR = aScan[2]
      bPIR = BTst(CInt(aScan[3]), 0)
      iHumi = Lsr(CInt(aScan[3]), 1)
      iTemp = (((256 * (CInt(aScan[5]) AND 3) + CInt(aScan[4])) XOR 512) - 512)
      iLowBat = Lsr(CInt(aScan[5]), 2) AND 1
      sLowBat = If(iLowBat, "Empty", "OK")
      sMotion = IIf(bPIR, "Motion", "No Motion")
      IF Main.bJeeLabsDebug THEN
        Main.WriteDebugLog("[JeeLabs] Sensor ID: " & iSensorId)
        Main.WriteDebugLog("[JeeLabs] LDR      : " & iLDR)
        Main.WriteDebugLog("[JeeLabs] PIR      : " & sMotion)
        Main.WriteDebugLog("[JeeLabs] Humi     : " & iHumi)
        Main.WriteDebugLog("[JeeLabs] Temp     : " & iTemp)
        Main.WriteDebugLog("[JeeLabs] LowBat   : " & iLowBat & " (" & sLowBat & ")")
      ENDIF
      ' try to find device with address, and correct interface type.
      iDeviceId = Devices.Find(iSensorId, Devices.FindInterface("JeeLabs Interface"), "JEELABS NODE")
      ' if found then update it's value
      IF iDeviceId THEN
        Devices.ValueUpdate(iDeviceId, iTemp, iHumi, iLDR, sMotion)
        Devices.Battery(iDeviceId, sLowBat)
      ENDIF
    ENDIF
  NEXT

END

' implement properties
FUNCTION Port_Read() AS String

  RETURN sPort

END

SUB Port_Write(Value AS String)

  sPort = Value

END

PRIVATE FUNCTION Baud_Read() AS String

  RETURN sBaud

END

PRIVATE SUB Baud_Write(Value AS String)

  sBaud = Value

END

PRIVATE FUNCTION JeeLabsDebug_Read() AS Boolean

  RETURN bJeeLabsDebug

END

PRIVATE SUB JeeLabsDebug_Write(Value AS Boolean)

  bJeeLabsDebug = Value

END
