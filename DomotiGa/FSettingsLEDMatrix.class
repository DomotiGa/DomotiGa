' Gambas class file

' Description:
' FSettingsLEDMatrix.class
' Settings form for LED Matrix support.

' Development Status:
' Done.

' DomotiGa - an open source home automation program.
' Copyright(C) 2008-2010 Ron Klinkien

' Read file called COPYING for license details.

PUBLIC hForm AS Form
PUBLIC hSendButton AS Button
PUBLIC hTextBox AS TextBox

PUBLIC SUB Form_Open()

  ME.Move(FMain.X + 50, FMain.Y + 70)

  txtSerialPort.Text = Main.sLEDMatrixSerialPort
  chkDebug.Value = Main.bLEDMatrixDebug
  cmbSpeed.Index = Main.iLEDMatrixSpeed
  cmbColor.Index = Main.iLEDMatrixColor
  vbID.Value = Main.sLEDMatrixID
  chkEnabled.Value = Main.bLEDMatrixEnabled
  btnSave.Enabled = FALSE

  IF Main.bLEDMatrixEnabled = FALSE THEN
    txtSerialPort.Enabled = FALSE
    cmbSpeed.Enabled = FALSE
    cmbColor.Enabled = FALSE
    vbID.Enabled = FALSE
    chkDebug.Enabled = FALSE
    btnTest.Enabled = FALSE
  END IF
  IF NOT Main.bServer THEN btnSetClock.Enabled = FALSE

END

PUBLIC SUB btnCancel_Click()

  ME.Close

END

PUBLIC SUB txtSerialPort_KeyPress()

  btnSave.Enabled = TRUE

END

PUBLIC SUB chkDebug_Click()

  btnSave.Enabled = TRUE

END

PUBLIC SUB btnSave_Click()

  DIM rResult AS Result

  ' save new LED Matrix settings
  rResult = Main.hDB.Exec("UPDATE settings_ledmatrix SET debug = &1, serialport = &2, enabled = &3, color = &4, speed = &5, displayid = &6 WHERE id = 1", chkDebug.Value, txtSerialPort.Text, chkEnabled.Value, cmbColor.Index, cmbSpeed.Index, vbID.Value)
  rResult = Main.GetSettingTable("ledmatrix") ' reload settings
  IF rResult.Count THEN
    Main.bLEDMatrixEnabled = rResult!enabled
    Main.sLEDMatrixSerialPort = rResult!serialport
    Main.iLEDMatrixColor = rResult!color
    Main.iLEDMatrixSpeed = rResult!speed
    Main.sLEDMatrixID = rResult!displayid
    Main.bLEDMatrixDebug = rResult!debug
  END IF
  IF Main.bServer THEN
    Main.Restart_LEDMatrix()
  ELSE
    XMLClient.ModuleRestart("LEDMatrix")
  END IF
  ME.Close

END

PUBLIC SUB btnDefaults_Click()

  DIM rResult AS Result

  rResult = Main.GetSettingTable("ledmatrix", TRUE) ' get defaults
  IF rResult.Count THEN
    chkEnabled.Value = rResult!enabled
    txtSerialPort.text = rResult!serialport
    cmbColor.Index = rResult!Color
    cmbSpeed.Index = rResult!speed
    vbID.Value = rResult!displayid
    chkDebug.Value = rResult!debug
  END IF
  btnSave.Enabled = TRUE

END

PUBLIC SUB chkEnabled_Click()

  txtSerialPort.Enabled = chkEnabled.Value
  chkDebug.Enabled = chkEnabled.Value
  cmbColor.Enabled = chkEnabled.Value
  cmbSpeed.Enabled = chkEnabled.Value
  vbID.Enabled = chkEnabled.Value
  btnTest.Enabled = chkEnabled.Value
  btnSave.Enabled = TRUE

END

PUBLIC SUB vbID_Click()

  btnSave.Enabled = TRUE

END

PUBLIC SUB cmbColor_Click()

  btnSave.Enabled = TRUE

END

PUBLIC SUB cmbSpeed_Click()

  btnSave.Enabled = TRUE

END

PUBLIC SUB btnSetClock_Click()

  IF Main.bServer THEN Main.hLEDMatrix.SetClock(Main.sLEDMatrixID)

END

PUBLIC SUB EnterMessage()

  hForm = NEW Form
  WITH hForm
    .X = FMain.X + 50
    .Y = FMain.Y + 70
    .BackColor = Color.TextBackground
    .Height = 36
    .Width = 500
    .Text = "Enter your message"
  END WITH
  hTextBox = NEW TextBox(hForm) AS "MessageBox"
  WITH hTextBox
    .X = 7
    .Y = 7
    .Height = 21
    .Width = 430
  END WITH
  hSendButton = NEW Button(hForm) AS "SendButton"
  WITH hSendButton
    .X = 445
    .Y = 7
    .Width = 49
    .Height = 21
    .Text = "Send"
  END WITH
  hForm.Show

END

PUBLIC SUB SendButton_Click()

  IF Len(hTextBox.Text) < 2 THEN
    Balloon(("Please type some text first!"), hTextBox)
  ELSE
    IF Main.bServer THEN
      Main.hLEDMatrix.DisplayMessage(Main.sLEDMatrixID, hTextBox.Text)
    ELSE
      XMLClient.DisplayLEDMessage(Main.sLEDMatrixID, hTextBox.Text)
    ENDIF
    hForm.Close
  ENDIF

END

PUBLIC SUB btnTest_Click()

  EnterMessage()

END
