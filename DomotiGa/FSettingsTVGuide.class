' Gambas class file

' Description:
' FSettingsTVGuide.class
' Settings form for XMLTV TVGuide support.

' Development Status:
' Just started.

' DomotiGa - an open source home automation program.
' Copyright(C) 2008 Ron Klinkien

' Read file called LICENSE for license details.

PUBLIC SUB Form_Open()

  ME.Move(FMain.X + 50, FMain.Y + 70)
  LoadSettings()
  btnSave.Enabled = FALSE

  IF Main.bTVGuideEnabled = FALSE THEN 
    txtGrabCommand.Enabled = FALSE
    txtGrabConfig.Enabled = FALSE
    txtGrabDays.Enabled = FALSE
    chkCache.Enabled = FALSE
    btnFetchChannels.Enabled = FALSE
    btnFetchGuide.Enabled = FALSE
    chkDebug.Enabled = FALSE
  END IF

END

PUBLIC SUB chkDebug_Click()

  btnSave.Enabled = TRUE

END

PUBLIC SUB chkEnabled_Click()

  txtGrabCommand.Enabled = chkEnabled.Value
  txtGrabConfig.Enabled = chkEnabled.Value
  txtGrabDays.Enabled = chkEnabled.Value
  chkDebug.Enabled = chkEnabled.Value
  chkCache.Enabled = chkEnabled.Value
  btnFetchChannels.Enabled = chkEnabled.Value
  btnFetchGuide.Enabled = chkEnabled.Value
  btnSave.Enabled = TRUE

END

PUBLIC SUB btnDefaults_Click()

  DIM rResult AS Result

  rResult = Main.GetSettingTable("tvguide", TRUE) ' get defaults
  IF rResult.Count THEN
    chkEnabled.Value = rResult!enabled
    txtGrabCommand.Text = rResult!grabcmd
    txtGrabConfig.Text = rResult!grabconf
    txtGrabDays.Text = rResult!grabdays
    chkDebug.Value = rResult!debug
    chkDebug.Enabled = rResult!usecache
  END IF
  btnSave.Enabled = TRUE

END

PUBLIC SUB btnSave_Click()

  DIM rResult AS Result

  ' save new TVGuide settings
  rResult = Main.hDB.Exec("UPDATE settings_tvguide SET debug = &1, grabcmd = &2, grabconf = &3, grabdays = &4, usecache = &5, enabled = &6 WHERE id = 1", chkDebug.Value, txtGrabCommand.Text, txtGrabConfig.Text, txtGrabDays.Text, chkCache.Value, chkEnabled.Value)
  LoadSettings()
  Main.Restart_TVGuide()

  ME.Close

END

PUBLIC SUB btnFetchChannels_Click()

  TVGuide.GrabChannels()

END

PUBLIC SUB btnFetchGuide_Click()

  TVGuide.GrabGuide()

END

PUBLIC SUB btnCancel_Click()

  ME.Close

END

PUBLIC SUB chkCache_Click()

  btnSave.Enabled = TRUE

END

PUBLIC SUB LoadSettings()

  DIM rResult AS Result

  rResult = Main.GetSettingTable("tvguide") ' reload settings
  IF rResult.Count THEN
    Main.bTVGuideEnabled = rResult!enabled
    Main.sTVGuideGrabCommand = rResult!grabcmd
    Main.sTVGuideGrabConfig = rResult!grabconf
    Main.iTVGuideGrabDays = rResult!grabdays
    Main.bTVGuideDebug = rResult!debug
    Main.bTVGuideUseCache = rResult!usecache
  END IF

  txtGrabCommand.Text = Main.sTVGuideGrabCommand
  txtGrabConfig.Text = Main.sTVGuideGrabConfig
  txtGrabDays.Text = Main.iTVGuideGrabDays
  chkCache.Value = Main.bTVGuideUseCache
  chkDebug.Value = Main.bTVGuideDebug
  chkEnabled.Value = Main.bTVGuideEnabled

END
