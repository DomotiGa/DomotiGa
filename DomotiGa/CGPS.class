' Gambas class file

' Description:
' CGPS.class
' u-blox AG MS1E GPS module (NMEA) support to get GPS time, precise position, and altitude
' GPS module version: $Version 1.3.4P00283 uBlx308

' Development Status:
' Reads serial data, needs parsing to be implemented.
' Wrote it for fun, no seriuos purpose for a non mobile server.

' Links:
' http://aprs.gids.nl/nmea/

' DomotiGa - an open source home automation program.
' Copyright(C) 2008 Ron Klinkien

' Read file called COPYING for license details.

' Notes:
' NMEA sentences: 
' $GPBOD - Bearing, origin TO destination
' $GPBWC - Bearing AND distance TO waypoint, great circle
' $GPGGA - Global Positioning System Fix Data
' $GPGLL - Geographic position, latitude / longitude
' $GPGSA - GPS DOP AND active satellites 
' $GPGSV - GPS Satellites IN view
' $GPHDT - Heading, TRUE
' $GPR00 - List OF waypoints IN currently active route
' $GPRMA - Recommended minimum specific Loran - C data
' $GPRMB - Recommended minimum navigation info
' $GPRMC - Recommended minimum specific GPS / Transit data
' $GPRTE - Routes
' $GPTRF - Transit Fix Data
' $GPSTN - Multiple Data ID
' $GPVBW - Dual Ground / Water Speed
' $GPVTG - Track made good AND ground speed
' $GPWPL - Waypoint location
' $GPXTE - Cross - track ERROR , Measured
' $GPZDA - Date & Time

PROPERTY Port AS String
PROPERTY Baud AS String
PROPERTY GPSDebug AS Boolean

PRIVATE sPort AS String
PRIVATE sBaud AS String
PRIVATE bGPSDebug AS Boolean

PUBLIC hGPS AS NEW SerialPort

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' open serial port
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
PUBLIC FUNCTION Connect() AS Boolean

  ' try to close the port
  TRY hGPS.Close

  ' get a new one
  hGPS = NEW Serialport AS "GPS"
  WITH hGPS
    .PortName = sPort
    .Speed = sBaud
    .Parity = 0
    .DataBits = 8
    .StopBits = 1
    .FlowControl = 0
    .Open()
  END WITH

  ' all ok
  RETURN TRUE

CATCH ' some errors
  Main.WriteLog("GPS Error: " & ERROR.Text)
  RETURN FALSE

END

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' close port
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
PUBLIC FUNCTION Disconnect() AS Boolean

  ' try to close the connection
  TRY hGPS.Close
  Main.WriteLog("GPS serial port close.")

  ' all ok
  RETURN TRUE

CATCH ' some errors
  Main.WriteLog("GPS Error: " & ERROR.Text & "")
  RETURN FALSE

END

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' got data input
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
PUBLIC SUB GPS_Read()

  DIM sData AS String

  LINE INPUT #hGPS, sData
  IF String.InStr(sData, "$GPGLL") THEN ' position info
  'IF String.InStr(sData, "$GPZDA") THEN ' date & time info
    IF Main.bGPSDebug THEN Main.WriteDebugLog("[GPS] " & sData)
  END IF

END

' implement the properties
PRIVATE FUNCTION Port_Read() AS String

  RETURN sPort

END

PRIVATE SUB Port_Write(sValue AS String)

  sPort = sValue

END

PRIVATE FUNCTION Baud_Read() AS String

  RETURN sBaud

END

PRIVATE SUB Baud_Write(sValue AS String)

  sBaud = sValue

END

PRIVATE FUNCTION GPSDebug_Read() AS Boolean

  RETURN bGPSDebug

END

PRIVATE SUB GPSDebug_Write(sValue AS Boolean)

  bGPSDebug = sValue

END
