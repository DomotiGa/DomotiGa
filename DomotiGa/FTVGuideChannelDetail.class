' Gambas class file

' Description:
' FTVGuideChannelDetail.class
' Form for showing TV channel details.

' Development Status:
' Imported from Kris's own project, needs testing.

' DomotiGa - an open source home automation program.
' Copyright(C) 2008-2010 Ron Klinkien

' This module is written by and Copyright(C) 2009 Kris Wauters on February, 16th - 2010
' For more info or help, mailto: kris@digitalplayground.be

' Read file called COPYING for license details.

PUBLIC SUB Form_Open()

  PreInit()
  ShowData()

END

'--- initialises everything onscreen ---
PRIVATE SUB ShowData()

  '--- declare variables ---
  DIM StrSQLDate, StrText AS String
  DIM rRes, rResDate AS Result
  DIM IntI, IntCount AS Integer

  ColVw.Clear
  ColVw.Columns[0].Width = LblTitle1.Width
  ColVw.Columns[1].Width = LblTitle2.Width
  ColVw.Columns[2].Width = LblTitle3.Width
  ColVw.Columns[3].Width = LblTitle4.Width
  StrSQLDate = Main.ParseTag(ME.tag, 2, "|")
  '--- fillup the programlist ---
  rRes = Main.hDB.Exec("SELECT * FROM tv_programs WHERE ChannelID = '" & Main.ParseTag(ME.tag, 1, "|") & "' AND (left(StartPoint,8) = '" & StrSQLDate & "' OR left(EndPoint,8) = '" & StrSQLDate & "') ORDER BY StartPoint")
  IF rRes THEN
    IF rRes.Count > 0 THEN
      FOR EACH rRes
        ColVw.Add("P" & rRes!StartPoint, rRes!ProgramName)
        ColVw.MoveTo("P" & rRes!StartPoint)
        ColVw.Item[1] = rRes!CategoryName
        ColVw.Item[2] = Main.DateTimeFromSqlToApp(rRes!StartPoint)
        ColVw.Item[3] = Main.DateTimeFromSqlToApp(rRes!EndPoint)
        StrText = Main.Wrapit(rRes!ProgramDescription, LblTitle1.Width - 25, ME)
        IntCount = 0
        FOR IntI = 1 TO Len(StrText)
          IF Mid$(StrText, IntI, 1) = gb.newline THEN IntCount = IntCount + 1
        NEXT
        FOR IntI = 1 TO IntCount + 1
          ColVw.Add("C" & rRes!StartPoint & "_" & CStr(IntI), Main.ParseTag(StrText, IntI, gb.newline), "", "P" & rRes!StartPoint)
        NEXT
      NEXT
    END IF
  END IF
  '--- next, set date-labels, and check if next/previous-buttons needs to be enabled/disabled ---
  LblDate.Text = Main.DateFromSQLToApp(StrSqlDate)
  LblDateDay.Text = Format(Date(CInt(Left(StrSQLDate, 4)), CInt(Mid(StrSQLDate, 5, 2)), CInt(Mid(StrSQLDate, 7, 2))), "dddd")
  rResDate = Main.hDB.Exec("SELECT MIN(StartPoint) as MinDate,MAX(EndPoint) as MaxDate FROM tv_programs WHERE ChannelID = '" & Main.ParseTag(ME.tag, 1, "|") & "'")
  IF rResDate THEN
    IF rResDate.Count > 0 THEN
      rResDate.MoveFirst
      IF Left(rResDate!MinDate, 8) < StrSQLDate THEN
        BtnPrevious.Enabled = TRUE
      ELSE
        BtnPrevious.Enabled = FALSE
      END IF
      IF Left(rResDate!MaxDate, 8) > StrSQLDate THEN
        BtnNext.Enabled = TRUE
      ELSE
        BtnNext.Enabled = FALSE
      END IF
    END IF
  END IF

END

'--- show icon, channel-name etc ... ---
PRIVATE SUB PreInit()

  '--- declare variables ---
  DIM rRes AS Result
  DIM StrFile AS String

  rRes = Main.hDB.Exec("SELECT * FROM tv_channels WHERE ChannelID = '" & Main.ParseTag(ME.tag, 1, "|") & "'")
  IF rRes THEN
    IF rRes.count > 0 THEN
      rRes.MoveFirst
      ME.LblChannel.text = rRes!ChannelName
      IF Len(rRes!BLOBlogo.data) > 10 THEN
        StrFile = Main.BlobFromDB("SELECT * FROM tv_channels WHERE RecID=" & rRes!RecID, "BLOBlogo", "EXTlogo")
        ME.PicLogo.Picture = Picture.Load(StrFile)
      END IF
    END IF
  END IF
  rRes = NULL
  '--- do columnheaders ---
  ColVw.Columns.count = 4
  ColVw.Columns[0].Text = LblTitle1.Text
  ColVw.Columns[0].Width = LblTitle1.Width
  ColVw.Columns[1].Text = LblTitle2.Text
  ColVw.Columns[1].Width = LblTitle2.Width
  ColVw.Columns[2].Text = LblTitle3.Text
  ColVw.Columns[2].Width = LblTitle3.Width
  ColVw.Columns[3].Text = LblTitle4.Text
  ColVw.Columns[3].Width = LblTitle4.Width

END

'--- goto previous day ---
PUBLIC SUB BtnPrevious_Click()

  '--- declare variables ---
  DIM StrSQLDate AS String

  StrSQLDate = Main.ParseTag(ME.tag, 2, "|")
  ME.tag = Main.ParseTag(ME.tag, 1, "|") & "|" & Format(DateAdd(Date(CInt(Left(StrSQLDate, 4)), CInt(Mid(StrSQLDate, 5, 2)), CInt(Mid(StrSQLDate, 7, 2))), gb.day, -1), "yyyymmdd")
  ShowData()

END

'--- goto next day ---
PUBLIC SUB BtnNext_Click()

  '--- declare variables ---
  DIM StrSQLDate AS String

  StrSQLDate = Main.ParseTag(ME.tag, 2, "|")
  ME.tag = Main.ParseTag(ME.tag, 1, "|") & "|" & Format(DateAdd(Date(CInt(Left(StrSQLDate, 4)), CInt(Mid(StrSQLDate, 5, 2)), CInt(Mid(StrSQLDate, 7, 2))), gb.day, 1), "yyyymmdd")
  ShowData()

END